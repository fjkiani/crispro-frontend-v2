---
alwaysApply: false
description: PrecisionRad Co-Pilot – Execution Doctrine (Aug 2025). Concrete steps, endpoints, and tests for radiosensitivity prediction using our S/P/E+insights stack.
globs: 
---
# PrecisionRad Co-Pilot – Execution Doctrine (Aug 2025)

This rule converts the prior concept into an execution-ready plan that reuses our current Oncology Co‑Pilot stack to produce radiosensitivity hypotheses and toxicity risk signals with transparent provenance.

## What we can deliver today (research-grade)
- Radiosensitivity hypothesis per case using the existing S/P/E + insights pipeline:
  - **Sequence (S)**: Evo2 magnitudes + gene calibration via `predict_gene_essentiality` and `predict_protein_functionality_change`.
  - **Pathway (P)**: Map mutations to DNA damage response (DDR), cell cycle, apoptosis pathways aligned to radiation MoA.
  - **Evidence (E)**: Literature/ClinVar evidence; shows badges and tier.
  - **Insights**: Functionality, Chromatin (Enformer/Borzoi when configured), Essentiality, Regulatory.
- Output surfaced like drugs: `efficacy_score` (label as “Radiosensitivity”), `confidence`, `evidence_tier`, `badges`, `insights`, `rationale`, `citations`.

## Where the code lives (reused components)
- Insights router: `[insights.py](mdc:oncology-coPilot/oncology-backend-minimal/api/routers/insights.py)`
  - `POST /api/insights/predict_gene_essentiality` (Evo2 multi/exon + calibration)
  - `POST /api/insights/predict_protein_functionality_change` (hotspot-aware lift)
  - `POST /api/insights/predict_chromatin_accessibility` (Enformer/Borzoi or heuristic)
  - `POST /api/insights/predict_splicing_regulatory` (noncoding proxy)
- Efficacy orchestrator: `[efficacy.py](mdc:oncology-coPilot/oncology-backend-minimal/api/routers/efficacy.py)`
  - Currently ranks systemic drugs; reuse scoring style to compute a radiosensitivity score.
- Evo proxy and safety: `[evo.py](mdc:oncology-coPilot/oncology-backend-minimal/api/routers/evo.py)`
- Frontend evidence UI examples: `[evidenceIntelligence.js](mdc:oncology-coPilot/oncology-frontend/src/components/dossier/data/evidenceIntelligence.js)`

## How to run a radiosensitivity assessment now
Use the same orchestrator endpoint and interpret the returned score for radiation context. Provide disease and mutation; include coordinates for Regulatory/Chromatin.

Example (lung, TP53 R175H):
```bash
curl -sS -X POST http://127.0.0.1:8000/api/efficacy/predict \
  -H 'Content-Type: application/json' \
  -d '{
    "model_id":"evo2_7b",
    "mutations":[{"gene":"TP53","hgvs_p":"R175H","chrom":"17","pos":7673803,"ref":"C","alt":"T","build":"hg38"}],
    "disease":"non-small cell lung cancer",
    "options":{"adaptive":true,"ensemble":true},
    "api_base":"http://127.0.0.1:8000"
  }'
```
Then, in the UI, filter the returned items to radiation-aligned MoA (DNA damage/DDR) or display a dedicated “Radiosensitivity” card using the aggregated S/P/E + insights and evidence tier.

## Chromatin configuration (to avoid heuristic fallback)
Set these in backend `.env` to enable first‑class chromatin scores:
```
ENFORMER_URL=http://127.0.0.1:7001
BORZOI_URL=http://127.0.0.1:7002
```
Each must expose `/predict` accepting `{ chrom, start, end }` and returning `{ accessibility_score }`.

## Methodology (S/P/E + radiosensitivity mapping)
- **Sequence (S)**: Evo2 multi/exon absolute magnitudes with gene‑specific calibration snapshots; hotspot lift for functionality.
- **Pathway (P)**: Weight DDR (ATM/ATR, BRCA1/2, TP53, CHEK2), apoptosis (BAX/BCL2), replication stress, proteostasis for combined modality contexts.
- **Evidence (E)**: Literature agent scoped by disease and MoA terms: [“radiation therapy”, “radiosensitivity”, “radioresistance”, “DNA damage response”].
- **Insights lifts (bounded)**: +functionality, +chromatin, +essentiality, +regulatory when ≥ thresholds (transparent in provenance).

## Frontend integration (no schema change required)
- Read from `/api/efficacy/predict` and render:
  - `efficacy_score` (label as “Radiosensitivity” in RadOnc view), `confidence`, `evidence_tier`, `badges`.
  - `insights` chips: Functionality, Chromatin, Essentiality, Regulatory.
  - `rationale` list and `citations`/`provenance`.
- Streamlit demo page reference: `[3_☢️_RadOnc_Co-Pilot.py](mdc:src/app/3_☢️_RadOnc_Co-Pilot.py)` and backend data endpoint example in `[main.py](mdc:oncology-coPilot/oncology-backend/main.py)`.

## Roadmap to exceed capability
1) Dedicated RadOnc orchestrator (backwards compatible):
   - New endpoint: `POST /api/radonc/predict` → `{ radiosensitivity_score, confidence, evidence_tier, insights, rationale }`.
   - Internally reuse insights and evidence services; add DDR‑specific pathway weights.
2) Toxicity risk (NTCP proxy):
   - New endpoint: `POST /api/radonc/predict_toxicity` consuming germline variants in radiosensitivity genes; return `{ toxicity_risk_score, confidence, rationale }`.
3) Imaging hooks (phase II):
   - Add radiomics extractor and optional CBCT change detection stubs; surface as additional evidence/insight.
4) Evidence hardening:
   - Provider keys + caching to lift literature recall; add guideline/RCT badges for radiation.
5) Stabilize chromatin:
   - Run real Enformer/Borzoi services; maintain fallback to heuristic only on failure.

## Quick test flows
- Chromatin (with Enformer/Borzoi):
```bash
curl -sS -X POST http://127.0.0.1:8000/api/insights/predict_chromatin_accessibility \
  -H 'Content-Type: application/json' \
  -d '{"chrom":"7","pos":140453136,"radius":500}'
```
- Essentiality:
```bash
curl -sS -X POST http://127.0.0.1:8000/api/insights/predict_gene_essentiality \
  -H 'Content-Type: application/json' \
  -d '{"gene":"TP53","variants":[{"gene":"TP53","chrom":"17","pos":7673803,"ref":"C","alt":"T","consequence":"missense_variant"}],"model_id":"evo2_7b"}'
```
- Radiosensitivity (via efficacy orchestrator for now): see example above.

## Current limitations (transparent)
- Literature agent may return sparse results in local dev → lowers evidence tier and confidence.
- Evo service intermittency (404/500) can cause partial S instability; proxy includes fallbacks.
- Chromatin defaults to heuristic unless Enformer/Borzoi URLs are live.

## Success criteria
- Consistent, transparent radiosensitivity hypotheses with clear rationale and bounded confidence.
- Frontend chips and badges reflecting all four insights and evidence tier.
- When Enformer/Borzoi and stronger literature are on, confidence lifts by ~0.05–0.10.


## Guidance-first build plan (next)

We now prioritize clinical guidance (tiered recommendations with on-label status and citations) over pure hypothesis. This section specifies exactly what to build across backend and frontend.

### Backend – Guidance Router
- Add a new router: `api/routers/guidance.py`; include it in `api/main.py` under `/api/guidance`.

- `POST /api/guidance/chemo`
  - Input:
    - `{ disease: string, drug_or_class: string, mutations: [{ gene, hgvs_p, chrom?, pos?, ref?, alt?, build? }], options?: { adaptive?: bool, ensemble?: bool }, api_base?: string, moa_terms?: string[] }`
  - Behavior:
    - Calls existing `/api/efficacy/predict` with provided mutations/disease and seeds `moa_terms` from `drug_or_class` when missing.
    - Filters returned `drugs[*]` to the requested `drug_or_class` (case-insensitive match on name/MoA).
    - Applies clinical gates (see below) and returns a guidance object.
  - Output (focused object):
    - `{ therapy: string, disease: string, on_label: boolean, tier: "I"|"II"|"III"|"research", strength: "strong"|"moderate"|"weak", efficacy_score: number, confidence: number, insights: {...}, rationale: string[], citations: string[], evidence_tier: string, badges: string[], provenance: {...}, caveats?: string[] }`

- `POST /api/guidance/radonc`
  - Input:
    - `{ disease?: string, mutations: [...same as above...], options?: {...}, api_base?: string }`
  - Behavior:
    - Calls `/api/efficacy/predict` and aggregates the result as "Radiosensitivity".
    - Applies clinical gates specialized to radiation (guidelines/RCTs in disease, DDR-aligned biology).
  - Output:
    - `{ modality: "radiation", disease?: string, on_label: boolean, tier: "I"|"II"|"III"|"research", strength: "strong"|"moderate"|"weak", radiosensitivity_score: number, confidence: number, insights: {...}, rationale: string[], citations: string[], evidence_tier: string, badges: string[], provenance: {...}, caveats?: string[] }`

### Clinical gates (server-side)
- Data sources available now: PubMed evidence bundle (publication types, counts), evidence_tier/badges, ClinVar prior/classification, MoA alignment, on/off-label (initially via curated rules; later via FDA/DailyMed integration).
- Gate rules (conservative, deterministic):
  1) Tier I (Guidance):
     - On-label in disease context OR disease guideline present (detected in evidence as Guideline/Practice guidance), AND at least moderate evidence strength (e.g., ≥1 guideline/RCT/meta-analysis).
  2) Tier II (Consider):
     - ≥1 RCT/meta-analysis/systematic review in disease context OR strong consensus reviews with MoA alignment; not on-label but no contraindication.
  3) Tier III (Hypothesis with supportive evidence):
     - Mechanistic alignment + supportive literature (cohort/case series/case reports) AND insights supportive (e.g., functionality/chromatin ≥ thresholds).
  4) Research:
     - Insufficient literature or misaligned MoA; keep as research hypothesis only.
- Strength mapping:
  - strong: guideline or ≥2 high-quality RCT/meta/systematic reviews in disease
  - moderate: ≥1 high-quality RCT/meta OR multiple consistent reviews
  - weak: case series/case reports/limited reviews only

### Quick curl tests (local)
- Chemo guidance (example; replace fields):
```bash
curl -sS -X POST http://127.0.0.1:8000/api/guidance/chemo \
  -H 'Content-Type: application/json' \
  -d '{
    "disease":"multiple myeloma",
    "drug_or_class":"proteasome inhibitor",
    "mutations":[{"gene":"BRAF","hgvs_p":"V600E","chrom":"7","pos":140453136,"ref":"T","alt":"A"}],
    "options":{"adaptive":true,"ensemble":true},
    "api_base":"http://127.0.0.1:8000"
  }'
```

- Radiation guidance:
```bash
curl -sS -X POST http://127.0.0.1:8000/api/guidance/radonc \
  -H 'Content-Type: application/json' \
  -d '{
    "disease":"non-small cell lung cancer",
    "mutations":[{"gene":"TP53","hgvs_p":"R175H","chrom":"17","pos":7673803,"ref":"C","alt":"T","build":"hg38"}],
    "options":{"adaptive":true,"ensemble":true},
    "api_base":"http://127.0.0.1:8000"
  }'
```

### Frontend – Guidance UI
- Add a Guidance card (CoPilot) that renders the guidance object:
  - Tier badge (I/II/III/Research), on‑label/off‑label chip, strength, efficacy/radiosensitivity score, confidence.
  - Insights chips (Functionality, Chromatin, Essentiality, Regulatory), rationale list, citations with links, badges.
  - Explicit disclaimer banner (research tool; not medical advice).
- Quick actions:
  - "Get Chemo Guidance" → collects disease, mutation(s), drug/class → calls `/api/guidance/chemo`.
  - "Get Radiation Guidance" → collects disease, mutation(s) → calls `/api/guidance/radonc`.

### Implementation notes
- Backend façade reuses `/api/efficacy/predict` and existing evidence; all gating happens server-side for consistency and auditability.
- For on‑label detection, start with a minimal curated ruleset (JSON) keyed by `{disease, drug_or_class}` with citations; later integrate FDA/DailyMed.
- Preserve backward compatibility; FE can still call `/api/efficacy/predict` directly.

### Optional assisting agent (if needed)
To raise guidance quality without blocking core delivery, we can attach a lightweight "Guidance Evidence Agent" behind the guidance router. It operates as a separate microservice and provides curated signals the router consumes. This keeps the FE unchanged.

- Responsibilities
  - Guideline harvester: detect and summarize disease‑specific guidelines (NCCN/ESMO or open equivalents where licenses permit).
  - Label checker: determine on‑label/off‑label status using a curated ruleset first; later call FDA/DailyMed.
  - Trial/rationale summarizer: extract RCT/meta/systematic‑review indicators and produce a compact rationale with citations.

- Service API (HTTP)
  - `POST /guidelines/query`
    - Input: `{ disease, therapy, gene?, variant? }`
    - Output: `{ has_guideline: boolean, sources: [{title,url,year}], notes?: string }`
  - `POST /label/onlabel_status`
    - Input: `{ disease, therapy }`
    - Output: `{ on_label: boolean, source: {type:"ruleset"|"fda"|"dailymed", ref?: string} }`
  - `POST /trials/summarize`
    - Input: `{ disease, therapy, citations?: string[] }`
    - Output: `{ rct_count: number, meta_count: number, systematic_review_count: number, strength: "strong"|"moderate"|"weak", key_citations: string[] }`

- Integration in guidance router
  - Guidance endpoints call the agent in parallel after `/api/efficacy/predict` returns.
  - Merge signals into gates:
    - Tier I requires `on_label==true` OR `has_guideline==true` with ≥ moderate strength.
    - Tier II requires any high‑quality review/RCT signals with MoA alignment.
  - Timeouts: 2–3s per agent call; degrade gracefully to ruleset/evidence only.

- Deployment
  - FastAPI microservice, containerized; env vars: `GUIDANCE_AGENT_URL` used by backend.
  - Start with rule‑ and evidence‑based stubs; later enable FDA/DailyMed integrations.


