---
description: Complete guide to SAE biomarker discovery for platinum response prediction - accessible explanation for anyone
alwaysApply: false
---

# ðŸ§¬ SAE Biomarker Discovery for Platinum Response Prediction - Explained

## What This System Does

**In Simple Terms**: We've built a system that analyzes DNA mutations from cancer patients to predict which patients will respond to platinum chemotherapy (like Carboplatin/Cisplatin).

**The Problem**: 
- Ovarian cancer patients get platinum chemotherapy as standard care
- But ~40% don't respond (treatment fails, disease progresses)
- Traditional methods (looking for BRCA1/BRCA2 mutations) only predict ~20% of cases
- We need better ways to predict who will respond BEFORE starting treatment

**Our Solution**: 
- Use AI (Evo2 DNA language model) to find hidden patterns in patient genomes
- Extract "SAE features" - interpretable signals from DNA sequences
- Discover which SAE features predict platinum response
- Use these biomarkers to personalize drug scoring

---

## The Complete Pipeline

### **Phase 1: Extract SAE Features from Patient Variants**

**What**: For each DNA mutation, we extract 32,768 "SAE features" that capture what the AI learned about that mutation.

**How**:
1. Patient has mutation: `13:25060373 T>C` (chromosome 13, position 25,060,373, Tâ†’C change)
2. System fetches DNA sequence around mutation from Ensembl
3. Evo2 model processes sequence â†’ generates "activations" (hidden representations)
4. Sparse Autoencoder (SAE) compresses these â†’ 32K interpretable features
5. We keep top 64 most active features per variant

**Current Status**: âœ… **COMPLETE**
- 69 patients processed
- 2,897 variants with SAE features extracted
- 55 sensitive, 14 resistant/refractory

**Files**:
- Extraction script: `scripts/sae/extract_sae_features_cohort.py`
- Output: `data/validation/sae_cohort/sae_features_tcga_ov_platinum.json`
- Modal service: `src/services/sae_service/main.py` (deployed)

---

### **Phase 2: Discover Biomarkers** (READY TO RUN)

**What**: Find which of the 32,768 SAE features are predictive of platinum response.

**How**:
1. For each SAE feature (1-32,768):
   - Extract feature activation levels across all 69 patients
   - Compute correlation with outcome (sensitive=1.0, resistant=0.5, refractory=0.0)
   - Run statistical tests:
     - **Pearson correlation**: Linear relationship strength
     - **Spearman correlation**: Non-parametric robustness
     - **Chi-square test**: Categorical association
     - **Cohen's d**: Effect size (how different sensitive vs resistant)
     - **Cross-validation**: Stability across data splits
     - **Bootstrap CI**: Confidence intervals (uncertainty bounds)
   - Apply multiple testing correction (FDR - Benjamini-Hochberg)

2. Rank features by:
   - Statistical significance (p < 0.01)
   - Effect size (Cohen's d â‰¥ 0.3)
   - Cross-validation stability (selected in â‰¥60% of folds)

3. Output: Top 100 features with full statistics

**Files**:
- Service: `oncology-coPilot/oncology-backend-minimal/api/services/biomarker_correlation_service.py`
- Execution script: `scripts/sae/analyze_biomarkers.py`
- Output: `data/validation/sae_cohort/sae_tcga_ov_platinum_biomarkers.json`

**Example Result**:
```json
{
  "feature_index": 15847,
  "pearson_r": 0.73,
  "pearson_p": 0.0001,
  "spearman_r": 0.70,
  "cohen_d": 0.85,
  "cv_stability": 0.80,
  "bootstrap_ci_lower": 0.65,
  "bootstrap_ci_upper": 0.81,
  "interpretation": "Strong positive correlation with platinum sensitivity"
}
```

**Meaning**: When SAE feature #15,847 is active â†’ 73% higher chance of platinum sensitivity (highly significant, large effect size).

---

### **Phase 3: Integrate into WIWFM Drug Scoring** (FUTURE)

**What**: Use discovered biomarkers to personalize drug efficacy scores.

**How**:
1. **Biomarker â†’ Drug Mapping**:
   - "SAE feature #15,847 predicts platinum response" â†’ Boost Carboplatin/Cisplatin scores
   - "SAE feature #12,099 predicts resistance" â†’ Reduce platinum drug scores

2. **Personalized Scoring**:
   - When patient's NGS results arrive â†’ Extract SAE features from their variants
   - Check which biomarker features are active in their genome
   - Apply weights to drug scores based on biomarker activity

3. **Clinical Output**:
   - Before: "Carboplatin: 0.72 score" (generic)
   - After: "Carboplatin: 0.89 score (SAE biomarker #15,847 detected - high platinum sensitivity signal)"

**Files**:
- Integration plan: `.cursor/rules/AYESHA_SAE_WIWFM_INTEGRATION_PLAN.mdc`
- WIWFM orchestrator: `api/services/efficacy_orchestrator/`
- Patient orchestrator: `api/routers/ayesha_orchestrator_v2.py`

---

## Key Concepts Explained

### **What are SAE Features?**

**Sparse Autoencoders (SAE)** are neural networks that:
1. Take complex, high-dimensional data (Evo2 activations: 1,920 dimensions)
2. Compress it into interpretable "features" (32,768 dimensions, but sparse - only ~64 active)
3. Each feature captures a specific pattern the AI learned from DNA sequences

**Why They Matter**:
- **Interpretable**: Unlike raw activations, SAE features can be studied and understood
- **Sparse**: Only ~0.2% of features activate per variant (highly selective)
- **Predictive**: Patterns discovered in training data generalize to new patients

### **Why Evo2?**

**Evo2** is a DNA language model (like GPT for DNA):
- Trained on 286 billion DNA sequences
- Understands evolutionary patterns, protein structure, regulatory signals
- Can extract meaning from DNA that human experts miss

**How We Use It**:
- Layer 24/25 activations capture sequence-to-function understanding
- SAE compresses these into interpretable features
- Features are then correlated with clinical outcomes

### **Statistical Rigor**

**Why So Many Tests?**
- **Pearson r**: Detects linear relationships
- **Spearman Ï**: Robust to outliers, non-linear patterns
- **Chi-square**: Categorical associations (high/low feature splits)
- **Cohen's d**: Effect size (is the difference clinically meaningful?)
- **Cross-validation**: Ensures features aren't overfitting to training data
- **Bootstrap CI**: Quantifies uncertainty in estimates
- **FDR correction**: Controls false discovery rate when testing 32K features

**Thresholds**:
- P-value: < 0.01 (1% chance of false positive)
- Effect size: Cohen's d â‰¥ 0.3 (small to medium effect)
- CV stability: â‰¥ 0.6 (selected in 60%+ of data folds)
- Top N: 100 features (most significant)

---

## Current Status

### âœ… **Completed**
1. SAE feature extraction pipeline (Modal service deployed)
2. Cohort extraction (69 patients, 2,897 variants)
3. Biomarker correlation service (statistical engine ready)

### ðŸŽ¯ **Ready to Execute**
1. Run biomarker analysis on extracted features
2. Generate visualization plots
3. Review top 100 features

### ðŸ“‹ **Future Work**
1. Integrate biomarkers into WIWFM drug scoring
2. Test on new patient cohorts
3. Validate predictions in clinical trials

---

## How to Run Biomarker Analysis

```bash
cd /Users/fahadkiani/Desktop/development/crispr-assistant-main

# Run biomarker discovery
python3 scripts/sae/analyze_biomarkers.py \
  --input data/validation/sae_cohort/sae_features_tcga_ov_platinum.json \
  --output data/validation/sae_cohort/sae_tcga_ov_platinum_biomarkers.json \
  --plots-dir data/validation/sae_cohort/plots
```

**Expected Output**:
- `sae_tcga_ov_platinum_biomarkers.json`: Top 100 features with full statistics
- `plots/correlation_distribution.png`: Distribution of correlations
- `plots/top_features_barplot.png`: Top 10 features visualization
- `plots/cv_stability.png`: Cross-validation stability scores

**Time**: ~10-30 minutes (depends on 32K feature computations)

---

## Clinical Impact

### **For Patients Like Ayesha**:
1. **Before NGS**: Generic drug scores based on pathway analysis
2. **After NGS**: Personalized scores using SAE biomarkers
3. **Result**: More accurate predictions of which drugs will work

### **For Oncologists**:
1. **Evidence-based**: Statistical rigor (p-values, effect sizes, cross-validation)
2. **Interpretable**: SAE features can be mapped to biological pathways
3. **Actionable**: Direct integration into drug scoring workflow

### **For Research**:
1. **Discovery**: Finds patterns invisible to traditional methods
2. **Generalizable**: Works across mutation types (not just BRCA1/BRCA2)
3. **Scalable**: Can be applied to other cancer types and drugs

---

## Technical Architecture

### **Data Flow**:
```
Patient Variants â†’ Evo2 Model â†’ SAE Features â†’ Biomarker Analysis â†’ Drug Scores
     â†“               â†“              â†“                  â†“                â†“
  NGS Results   Modal Service   32K Features    Correlation Stats   WIWFM
```

### **Key Services**:
1. **Modal SAE Service**: Extracts SAE features from variants (cloud-deployed)
2. **Biomarker Correlation Service**: Computes statistical correlations
3. **WIWFM Orchestrator**: Integrates biomarkers into drug scoring

### **File Structure**:
```
scripts/sae/
  â”œâ”€â”€ extract_sae_features_cohort.py    # Cohort extraction
  â””â”€â”€ analyze_biomarkers.py              # Biomarker discovery

api/services/
  â””â”€â”€ biomarker_correlation_service.py   # Statistical engine

data/validation/sae_cohort/
  â”œâ”€â”€ sae_features_tcga_ov_platinum.json          # Extracted features
  â”œâ”€â”€ sae_tcga_ov_platinum_biomarkers.json        # Discovered biomarkers
  â””â”€â”€ plots/                                       # Visualizations
```

---

## Guardrails & Safety

### **RUO Only** (Research Use Only):
- Not for clinical decision-making without validation
- Requires manager approval before integration
- Must pass statistical rigor checks

### **Cost Controls**:
- Circuit breaker at 30% error rate
- Max patients/variants per run
- Checkpoint system prevents data loss

### **Statistical Rigor**:
- Multiple testing correction (FDR)
- Cross-validation to prevent overfitting
- Bootstrap confidence intervals
- Effect size thresholds

---

## References

- **Integration Plan**: [AYESHA_SAE_WIWFM_INTEGRATION_PLAN.mdc](mdc:.cursor/rules/AYESHA_SAE_WIWFM_INTEGRATION_PLAN.mdc)
- **Technical Blog**: [SAE_PRECISION_ONCOLOGY_TECHNICAL_BLOG.mdc](mdc:.cursor/rules/SAE_PRECISION_ONCOLOGY_TECHNICAL_BLOG.mdc)
- **Lessons Learned**: [SAE_TECHNICAL_LESSONS.mdc](mdc:.cursor/rules/SAE_TECHNICAL_LESSONS.mdc)
