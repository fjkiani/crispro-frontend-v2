# Mission: TMB Prediction - Production Build

> **Priority**: HIGH | **Estimated Time**: 6-8 hours | **Type**: Full-Stack Feature

---

## Mission Objective

Build TMB (Tumor Mutational Burden) prediction as a **production-ready feature** integrated across the full stack: backend API â†’ frontend UI â†’ clinical workflow.

---

## Architecture Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           TMB PREDICTION FLOW                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  Frontend (oncology-frontend)                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ TumorQuickIntake.jsx    â”‚ OR â”‚ NGS Upload Component                    â”‚ â”‚
â”‚  â”‚ (Manual TMB entry)      â”‚    â”‚ (Upload VCF/MAF â†’ Auto-calculate TMB)   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚               â”‚                                     â”‚                       â”‚
â”‚               â–¼                                     â–¼                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                    SporadicContext (tumorContext)                       â”‚â”‚
â”‚  â”‚  {                                                                      â”‚â”‚
â”‚  â”‚    tmb: 12.3,                    // â† Calculated value                  â”‚â”‚
â”‚  â”‚    tmb_source: "calculated",     // â† NEW: "manual" | "calculated"      â”‚â”‚
â”‚  â”‚    tmb_validation: {             // â† NEW: Validation metadata          â”‚â”‚
â”‚  â”‚      correlation: 0.933,                                                â”‚â”‚
â”‚  â”‚      accuracy: 0.954,                                                   â”‚â”‚
â”‚  â”‚      source: "TCGA Pan-Immune"                                          â”‚â”‚
â”‚  â”‚    },                                                                   â”‚â”‚
â”‚  â”‚    io_eligible: true,            // â† NEW: TMB â‰¥10 â†’ IO eligible        â”‚â”‚
â”‚  â”‚    msi_status: "MSS",                                                   â”‚â”‚
â”‚  â”‚    hrd_score: 42.0                                                      â”‚â”‚
â”‚  â”‚  }                                                                      â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚               â”‚                                                             â”‚
â”‚               â–¼                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ BiomarkerSummaryWidget.jsx                                              â”‚â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚â”‚
â”‚  â”‚ â”‚ TMB: 12.3 mut/Mb â”‚ â”‚ MSI: MSS         â”‚ â”‚ HRD: 42.0        â”‚         â”‚â”‚
â”‚  â”‚ â”‚ âœ“ TMB-H (â‰¥10)    â”‚ â”‚ âœ— Not MSI-H      â”‚ â”‚ âœ“ HRD-High       â”‚         â”‚â”‚
â”‚  â”‚ â”‚ ðŸ“Š Validated     â”‚ â”‚                  â”‚ â”‚                  â”‚         â”‚â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚               â”‚                                                             â”‚
â”‚               â–¼                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ Trial Matching & IO Eligibility                                         â”‚â”‚
â”‚  â”‚ - IO trials boosted for TMB-H patients                                  â”‚â”‚
â”‚  â”‚ - Mechanism vector: IO pathway = 1.0 if TMB â‰¥10                         â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  Backend (oncology-backend)                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ NEW: POST /api/biomarkers/tmb                                           â”‚â”‚
â”‚  â”‚                                                                         â”‚â”‚
â”‚  â”‚ Request:                                                                â”‚â”‚
â”‚  â”‚ {                                                                       â”‚â”‚
â”‚  â”‚   "mutations": [                                                        â”‚â”‚
â”‚  â”‚     {"gene": "TP53", "variant_classification": "Missense_Mutation"},    â”‚â”‚
â”‚  â”‚     {"gene": "KRAS", "variant_classification": "Frame_Shift_Del"},      â”‚â”‚
â”‚  â”‚     ...                                                                 â”‚â”‚
â”‚  â”‚   ],                                                                    â”‚â”‚
â”‚  â”‚   "exome_size_mb": 38.0  // Optional                                    â”‚â”‚
â”‚  â”‚ }                                                                       â”‚â”‚
â”‚  â”‚                                                                         â”‚â”‚
â”‚  â”‚ Response:                                                               â”‚â”‚
â”‚  â”‚ {                                                                       â”‚â”‚
â”‚  â”‚   "tmb": 12.3,                                                          â”‚â”‚
â”‚  â”‚   "tmb_classification": "TMB-H",                                        â”‚â”‚
â”‚  â”‚   "io_eligible": true,                                                  â”‚â”‚
â”‚  â”‚   "nonsynonymous_count": 468,                                           â”‚â”‚
â”‚  â”‚   "validation": {                                                       â”‚â”‚
â”‚  â”‚     "pearson_r": 0.933,                                                 â”‚â”‚
â”‚  â”‚     "accuracy": 0.954,                                                  â”‚â”‚
â”‚  â”‚     "source": "TCGA Pan-Immune (n=1,895)"                               â”‚â”‚
â”‚  â”‚   },                                                                    â”‚â”‚
â”‚  â”‚   "mechanism_vector_update": {                                          â”‚â”‚
â”‚  â”‚     "io_pathway": 1.0                                                   â”‚â”‚
â”‚  â”‚   }                                                                     â”‚â”‚
â”‚  â”‚ }                                                                       â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Deliverables

### Phase 1: Backend API (2-3 hours)

#### 1.1 Create Biomarker Router

**Location**: `oncology-coPilot/oncology-backend/backend/api/biomarkers.py`

```python
from fastapi import APIRouter, HTTPException
from pydantic import BaseModel, Field
from typing import List, Optional, Dict, Any

router = APIRouter()

# Constants
TMB_HIGH_THRESHOLD = 10.0  # Mutations per Mb
TCGA_EXOME_SIZE_MB = 38.0

# Validated metrics from TCGA Pan-Immune validation
VALIDATION_METRICS = {
    "pearson_r": 0.933,
    "spearman_rho": 0.877,
    "accuracy": 0.954,
    "sensitivity": 0.960,
    "specificity": 0.952,
    "source": "TCGA Pan-Immune (n=1,895)",
    "ground_truth_file": "mutation-load_updated.txt"
}

NONSYNONYMOUS_CLASSIFICATIONS = {
    "Missense_Mutation", "Nonsense_Mutation", "Frame_Shift_Del",
    "Frame_Shift_Ins", "In_Frame_Del", "In_Frame_Ins",
    "Splice_Site", "Splice_Region", "Translation_Start_Site",
    "Nonstop_Mutation"
}

class MutationInput(BaseModel):
    gene: str
    variant_classification: str
    protein_change: Optional[str] = None
    hgvs_p: Optional[str] = None

class TMBRequest(BaseModel):
    mutations: List[MutationInput]
    exome_size_mb: Optional[float] = Field(default=TCGA_EXOME_SIZE_MB)

class TMBResponse(BaseModel):
    tmb: float
    tmb_classification: str
    io_eligible: bool
    nonsynonymous_count: int
    total_mutations: int
    exome_size_mb: float
    validation: Dict[str, Any]
    mechanism_vector_update: Dict[str, float]

def count_nonsynonymous_mutations(mutations: List[MutationInput]) -> int:
    """Count nonsynonymous mutations using validated methodology."""
    count = 0
    for mut in mutations:
        classification = mut.variant_classification.strip()
        protein_change = mut.protein_change or mut.hgvs_p or ""
        
        # Check MAF-style classifications
        if classification in NONSYNONYMOUS_CLASSIFICATIONS:
            count += 1
            continue
        
        # Handle simplified classifications (cBioPortal format)
        if protein_change and protein_change.strip():
            if "=" in protein_change:  # Silent mutation
                continue
            classification_upper = classification.upper()
            if classification_upper in ["SNP", "DEL", "INS", "ONP"]:
                count += 1
    
    return count

@router.post("/tmb", response_model=TMBResponse)
async def calculate_tmb(request: TMBRequest):
    """
    Calculate TMB from mutation list.
    
    Validated against TCGA Pan-Immune ground truth (r=0.933, 95.4% accuracy).
    """
    try:
        nonsynonymous_count = count_nonsynonymous_mutations(request.mutations)
        tmb = nonsynonymous_count / request.exome_size_mb
        tmb_classification = "TMB-H" if tmb >= TMB_HIGH_THRESHOLD else "TMB-L"
        io_eligible = tmb >= TMB_HIGH_THRESHOLD
        
        return TMBResponse(
            tmb=round(tmb, 2),
            tmb_classification=tmb_classification,
            io_eligible=io_eligible,
            nonsynonymous_count=nonsynonymous_count,
            total_mutations=len(request.mutations),
            exome_size_mb=request.exome_size_mb,
            validation=VALIDATION_METRICS,
            mechanism_vector_update={
                "io_pathway": 1.0 if io_eligible else 0.0
            }
        )
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"TMB calculation failed: {str(e)}")

@router.get("/tmb/validation")
async def get_tmb_validation_metrics():
    """Return TMB validation metrics for transparency."""
    return {
        "validation": VALIDATION_METRICS,
        "methodology": {
            "exome_size": "38 Mb (TCGA standard)",
            "threshold": "10 mut/Mb (FDA-approved pembrolizumab cutoff)",
            "classifications_counted": list(NONSYNONYMOUS_CLASSIFICATIONS)
        }
    }
```

#### 1.2 Register Router in main.py

**Location**: `oncology-coPilot/oncology-backend/main.py`

```python
# Add import
from backend.api import biomarkers as biomarkers_router

# Add router registration (near other router registrations)
app.include_router(biomarkers_router.router, prefix="/api/biomarkers", tags=["biomarkers"])
```

#### 1.3 Create TMB Calculator Service

**Location**: `oncology-coPilot/oncology-backend/backend/services/tmb_calculator.py`

```python
"""
TMB Calculator Service - Production Implementation

Validated against TCGA Pan-Immune ground truth:
- Pearson r: 0.933
- Classification accuracy: 95.4%
"""

from typing import List, Dict, Optional

NONSYNONYMOUS_CLASSIFICATIONS = {
    "Missense_Mutation", "Nonsense_Mutation", "Frame_Shift_Del",
    "Frame_Shift_Ins", "In_Frame_Del", "In_Frame_Ins",
    "Splice_Site", "Splice_Region", "Translation_Start_Site",
    "Nonstop_Mutation"
}

class TMBCalculator:
    def __init__(self, exome_size_mb: float = 38.0):
        self.exome_size_mb = exome_size_mb
        self.tmb_high_threshold = 10.0
        self.tmb_very_high_threshold = 20.0
    
    def count_nonsynonymous(self, mutations: List[Dict]) -> int:
        """Count nonsynonymous mutations."""
        count = 0
        for mut in mutations:
            classification = mut.get("variant_classification", "").strip()
            protein_change = mut.get("protein_change", "") or mut.get("hgvs_p", "")
            
            if classification in NONSYNONYMOUS_CLASSIFICATIONS:
                count += 1
                continue
            
            if protein_change and protein_change.strip() and "=" not in protein_change:
                if classification.upper() in ["SNP", "DEL", "INS", "ONP"]:
                    count += 1
        
        return count
    
    def calculate(self, mutations: List[Dict]) -> Dict:
        """Calculate TMB and return classification."""
        nonsynonymous_count = self.count_nonsynonymous(mutations)
        tmb = nonsynonymous_count / self.exome_size_mb
        
        if tmb >= self.tmb_very_high_threshold:
            classification = "TMB-Very-High"
        elif tmb >= self.tmb_high_threshold:
            classification = "TMB-H"
        else:
            classification = "TMB-L"
        
        return {
            "tmb": round(tmb, 2),
            "classification": classification,
            "io_eligible": tmb >= self.tmb_high_threshold,
            "nonsynonymous_count": nonsynonymous_count,
            "total_mutations": len(mutations),
            "exome_size_mb": self.exome_size_mb
        }
```

---

### Phase 2: Frontend Integration (2-3 hours)

#### 2.1 Create useTMBCalculation Hook

**Location**: `oncology-coPilot/oncology-frontend/src/hooks/useTMBCalculation.js`

```javascript
import { useState, useCallback } from 'react';
import { useApiClient } from './useApiClient';

/**
 * Hook for TMB calculation from mutations
 * Integrates with backend /api/biomarkers/tmb endpoint
 */
export const useTMBCalculation = () => {
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);
  const [result, setResult] = useState(null);
  const api = useApiClient();

  const calculateTMB = useCallback(async (mutations, exomeSizeMb = 38.0) => {
    setLoading(true);
    setError(null);
    
    try {
      const response = await api.post('/api/biomarkers/tmb', {
        mutations: mutations.map(m => ({
          gene: m.gene || m.Hugo_Symbol,
          variant_classification: m.variant_classification || m.Variant_Classification,
          protein_change: m.protein_change || m.HGVSp_Short,
          hgvs_p: m.hgvs_p
        })),
        exome_size_mb: exomeSizeMb
      });
      
      setResult(response.data);
      return response.data;
    } catch (err) {
      setError(err.message || 'TMB calculation failed');
      throw err;
    } finally {
      setLoading(false);
    }
  }, [api]);

  const reset = useCallback(() => {
    setResult(null);
    setError(null);
  }, []);

  return {
    calculateTMB,
    result,
    loading,
    error,
    reset,
    // Computed
    isIOEligible: result?.io_eligible || false,
    tmbClassification: result?.tmb_classification || null,
    validation: result?.validation || null
  };
};
```

#### 2.2 Create TMBValidationBadge Component

**Location**: `oncology-coPilot/oncology-frontend/src/components/sporadic/TMBValidationBadge.jsx`

```jsx
import React from 'react';
import { Chip, Tooltip, Box, Typography } from '@mui/material';
import VerifiedIcon from '@mui/icons-material/Verified';
import CalculateIcon from '@mui/icons-material/Calculate';

/**
 * TMBValidationBadge - Shows TMB calculation source and validation status
 * 
 * Props:
 * - tmbSource: "manual" | "calculated"
 * - validation: { pearson_r, accuracy, source } from API
 */
export default function TMBValidationBadge({ tmbSource, validation }) {
  if (tmbSource === 'manual') {
    return (
      <Chip
        icon={<CalculateIcon />}
        label="Manual Entry"
        size="small"
        variant="outlined"
        sx={{ fontSize: '0.7rem' }}
      />
    );
  }

  if (tmbSource === 'calculated' && validation) {
    return (
      <Tooltip
        title={
          <Box sx={{ p: 1 }}>
            <Typography variant="subtitle2" sx={{ fontWeight: 600, mb: 1 }}>
              ðŸ”¬ Validated TMB Calculation
            </Typography>
            <Typography variant="body2">
              Pearson r: {validation.pearson_r?.toFixed(3) || 'N/A'}
            </Typography>
            <Typography variant="body2">
              Accuracy: {((validation.accuracy || 0) * 100).toFixed(1)}%
            </Typography>
            <Typography variant="body2" sx={{ mt: 1, fontSize: '0.75rem', color: 'text.secondary' }}>
              Source: {validation.source}
            </Typography>
          </Box>
        }
      >
        <Chip
          icon={<VerifiedIcon />}
          label="Validated (r=0.93)"
          size="small"
          color="success"
          sx={{ fontSize: '0.7rem' }}
        />
      </Tooltip>
    );
  }

  return null;
}
```

#### 2.3 Update BiomarkerSummaryWidget

**Location**: `oncology-coPilot/oncology-frontend/src/components/sporadic/BiomarkerSummaryWidget.jsx`

Add TMB validation badge:

```jsx
// Import the new badge
import TMBValidationBadge from './TMBValidationBadge';

// In the TMB section, add:
<Box sx={{ minWidth: 150 }}>
  <Typography variant="caption" color="text.secondary" sx={{ display: 'block', mb: 0.5 }}>
    TMB (mutations/Mb)
  </Typography>
  <Stack direction="row" spacing={1} alignItems="center">
    <Chip
      label={tmb !== null && tmb !== undefined ? `${tmb.toFixed(1)} - ${tmbCategory.label}` : 'Unknown'}
      size="small"
      color={tmbCategory.color}
      sx={{ fontSize: '0.75rem' }}
    />
    <TMBValidationBadge 
      tmbSource={tumorContext?.tmb_source} 
      validation={tumorContext?.tmb_validation}
    />
  </Stack>
</Box>
```

#### 2.4 Create MutationUpload Component

**Location**: `oncology-coPilot/oncology-frontend/src/components/sporadic/MutationUpload.jsx`

```jsx
import React, { useState, useCallback } from 'react';
import { 
  Box, Button, Typography, Paper, CircularProgress,
  Alert, Stack, Chip
} from '@mui/material';
import CloudUploadIcon from '@mui/icons-material/CloudUpload';
import { useTMBCalculation } from '../../hooks/useTMBCalculation';
import { useSporadic } from '../../context/SporadicContext';

/**
 * MutationUpload - Upload VCF/MAF file for automatic TMB calculation
 */
export default function MutationUpload() {
  const [file, setFile] = useState(null);
  const [parsedMutations, setParsedMutations] = useState([]);
  const { calculateTMB, result, loading, error } = useTMBCalculation();
  const { updateTumorContext, tumorContext } = useSporadic();

  const handleFileChange = useCallback(async (event) => {
    const uploadedFile = event.target.files[0];
    if (!uploadedFile) return;
    
    setFile(uploadedFile);
    
    // Parse MAF/VCF file
    const text = await uploadedFile.text();
    const mutations = parseMAF(text); // Implement parser
    setParsedMutations(mutations);
    
    // Calculate TMB
    try {
      const tmbResult = await calculateTMB(mutations);
      
      // Update tumor context with calculated TMB
      updateTumorContext({
        ...tumorContext,
        tumor_context: {
          ...tumorContext,
          tmb: tmbResult.tmb,
          tmb_source: 'calculated',
          tmb_validation: tmbResult.validation,
          io_eligible: tmbResult.io_eligible
        }
      });
    } catch (err) {
      console.error('TMB calculation failed:', err);
    }
  }, [calculateTMB, updateTumorContext, tumorContext]);

  return (
    <Paper sx={{ p: 3, mb: 3 }}>
      <Typography variant="h6" gutterBottom>
        ðŸ§¬ Upload Mutation Data for TMB Calculation
      </Typography>
      
      <Typography variant="body2" color="text.secondary" sx={{ mb: 2 }}>
        Upload a MAF or VCF file to automatically calculate TMB.
        Validated against TCGA (r=0.93, 95.4% accuracy).
      </Typography>

      <Box sx={{ display: 'flex', alignItems: 'center', gap: 2 }}>
        <Button
          variant="outlined"
          component="label"
          startIcon={<CloudUploadIcon />}
          disabled={loading}
        >
          Upload MAF/VCF
          <input
            type="file"
            hidden
            accept=".maf,.vcf,.tsv"
            onChange={handleFileChange}
          />
        </Button>
        
        {loading && <CircularProgress size={24} />}
        
        {file && (
          <Typography variant="body2" color="text.secondary">
            {file.name} ({parsedMutations.length} mutations)
          </Typography>
        )}
      </Box>

      {error && (
        <Alert severity="error" sx={{ mt: 2 }}>
          {error}
        </Alert>
      )}

      {result && (
        <Alert severity="success" sx={{ mt: 2 }}>
          <Stack direction="row" spacing={2} alignItems="center">
            <Typography variant="body2">
              TMB: <strong>{result.tmb.toFixed(1)} mut/Mb</strong>
            </Typography>
            <Chip 
              label={result.tmb_classification} 
              color={result.io_eligible ? 'success' : 'default'}
              size="small"
            />
            {result.io_eligible && (
              <Chip label="IO Eligible" color="success" variant="outlined" size="small" />
            )}
          </Stack>
        </Alert>
      )}
    </Paper>
  );
}

// Simple MAF parser
function parseMAF(text) {
  const lines = text.split('\n');
  const mutations = [];
  let headers = [];
  
  for (const line of lines) {
    if (line.startsWith('#')) continue;
    if (line.startsWith('Hugo_Symbol') || line.startsWith('gene')) {
      headers = line.split('\t');
      continue;
    }
    
    const values = line.split('\t');
    if (values.length < 2) continue;
    
    const mutation = {};
    headers.forEach((h, i) => {
      mutation[h] = values[i];
    });
    
    mutations.push({
      gene: mutation.Hugo_Symbol || mutation.gene,
      variant_classification: mutation.Variant_Classification || mutation.variant_classification,
      protein_change: mutation.HGVSp_Short || mutation.protein_change
    });
  }
  
  return mutations;
}
```

#### 2.5 Update SporadicContext

**Location**: `oncology-coPilot/oncology-frontend/src/context/SporadicContext.jsx`

Add TMB-related fields:

```jsx
// Add to tumorContext state shape
const [tumorContext, setTumorContext] = useState({
  tmb: null,
  tmb_source: null,  // "manual" | "calculated"
  tmb_validation: null,  // { pearson_r, accuracy, source }
  io_eligible: false,
  msi_status: null,
  hrd_score: null,
  completeness_score: 0
});
```

---

### Phase 3: Integration & Testing (1-2 hours)

#### 3.1 Mechanism Vector Integration

**Location**: `oncology-coPilot/oncology-backend/backend/services/pathway_to_mechanism_vector.py`

Update to use validated TMB:

```python
def convert_pathway_scores_to_mechanism_vector(
    pathway_scores: Dict,
    tmb: Optional[float] = None,
    msi_status: Optional[str] = None
) -> List[float]:
    """
    Convert pathway scores to 7D mechanism vector.
    Uses validated TMB for IO pathway.
    """
    ddr = pathway_scores.get('ddr', 0.0)
    mapk = pathway_scores.get('mapk', 0.0)
    pi3k = pathway_scores.get('pi3k', 0.0)
    vegf = pathway_scores.get('vegf', 0.0)
    her2 = pathway_scores.get('her2', 0.0)
    efflux = pathway_scores.get('efflux', 0.0)
    
    # IO pathway from validated TMB calculation
    io_eligible_tmb = tmb is not None and tmb >= 10.0
    io_eligible_msi = msi_status in ['MSI-H', 'MSI-High']
    io_score = 1.0 if (io_eligible_tmb or io_eligible_msi) else 0.0
    
    return [ddr, mapk, pi3k, vegf, her2, io_score, efflux]
```

#### 3.2 Trial Matching Integration

**Location**: Update trial matching to boost IO trials for TMB-H patients

```python
# In trial ranking logic
if patient_tmb and patient_tmb >= 10.0:
    # Boost IO trials
    if trial_is_immunotherapy(trial):
        trial['io_boost'] = 1.5
        trial['io_eligibility_reason'] = f"TMB-H ({patient_tmb:.1f} mut/Mb) â†’ IO Eligible"
```

#### 3.3 Unit Tests

**Location**: `oncology-coPilot/oncology-backend/tests/test_biomarkers.py`

```python
import pytest
from backend.api.biomarkers import count_nonsynonymous_mutations, TMBRequest, MutationInput

def test_tmb_calculation_basic():
    """Test basic TMB calculation."""
    mutations = [
        MutationInput(gene="TP53", variant_classification="Missense_Mutation"),
        MutationInput(gene="KRAS", variant_classification="Frame_Shift_Del"),
    ]
    request = TMBRequest(mutations=mutations, exome_size_mb=38.0)
    
    count = count_nonsynonymous_mutations(mutations)
    assert count == 2
    
    tmb = count / request.exome_size_mb
    assert abs(tmb - 0.053) < 0.001

def test_tmb_high_classification():
    """Test TMB-H classification at threshold."""
    # 380 mutations / 38 Mb = 10.0 mut/Mb = TMB-H
    mutations = [
        MutationInput(gene=f"GENE{i}", variant_classification="Missense_Mutation")
        for i in range(380)
    ]
    
    count = count_nonsynonymous_mutations(mutations)
    tmb = count / 38.0
    
    assert tmb >= 10.0
    assert "TMB-H" == ("TMB-H" if tmb >= 10.0 else "TMB-L")

def test_silent_mutations_excluded():
    """Test that silent mutations are excluded."""
    mutations = [
        MutationInput(gene="TP53", variant_classification="Silent"),
        MutationInput(gene="KRAS", variant_classification="Missense_Mutation"),
    ]
    
    count = count_nonsynonymous_mutations(mutations)
    assert count == 1  # Only the missense mutation
```

---

## Implementation Checklist

### Backend
- [ ] Create `backend/api/biomarkers.py` with TMB endpoint
- [ ] Create `backend/services/tmb_calculator.py` service
- [ ] Register biomarkers router in `main.py`
- [ ] Add validation metrics constant
- [ ] Write unit tests for TMB calculation
- [ ] Update pathway_to_mechanism_vector.py with TMB integration

### Frontend
- [ ] Create `hooks/useTMBCalculation.js`
- [ ] Create `components/sporadic/TMBValidationBadge.jsx`
- [ ] Create `components/sporadic/MutationUpload.jsx`
- [ ] Update `BiomarkerSummaryWidget.jsx` with validation badge
- [ ] Update `SporadicContext.jsx` with TMB fields
- [ ] Add MAF/VCF parser utility

### Integration
- [ ] Update trial matching to use TMB
- [ ] Update mechanism vector generation
- [ ] End-to-end test: Upload â†’ Calculate â†’ Display â†’ Trial Matching

### Documentation
- [ ] API documentation for /api/biomarkers/tmb
- [ ] Update README with TMB feature
- [ ] Add validation methodology documentation

---

## Files to Create

| File | Type | Description |
|------|------|-------------|
| `backend/api/biomarkers.py` | Backend | TMB API endpoint |
| `backend/services/tmb_calculator.py` | Backend | TMB calculation service |
| `tests/test_biomarkers.py` | Backend | Unit tests |
| `src/hooks/useTMBCalculation.js` | Frontend | TMB calculation hook |
| `src/components/sporadic/TMBValidationBadge.jsx` | Frontend | Validation badge component |
| `src/components/sporadic/MutationUpload.jsx` | Frontend | File upload component |

## Files to Modify

| File | Type | Changes |
|------|------|---------|
| `main.py` | Backend | Add biomarkers router |
| `pathway_to_mechanism_vector.py` | Backend | Add TMB parameter |
| `BiomarkerSummaryWidget.jsx` | Frontend | Add validation badge |
| `SporadicContext.jsx` | Frontend | Add TMB fields |

---

## Acceptance Criteria

- [ ] POST /api/biomarkers/tmb returns correct TMB for test mutations
- [ ] TMB classification matches ground truth (r > 0.90)
- [ ] Frontend displays TMB with validation badge
- [ ] File upload calculates TMB automatically
- [ ] IO eligibility updates mechanism vector
- [ ] Trial matching prioritizes IO trials for TMB-H patients
- [ ] All unit tests pass

---

## Success Metrics

| Metric | Target | Validation |
|--------|--------|------------|
| TMB Correlation | r > 0.90 | Against TCGA ground truth |
| Classification Accuracy | > 95% | TMB-H/TMB-L classification |
| API Response Time | < 500ms | For 200 mutations |
| Frontend Load Time | < 2s | With TMB calculation |
| Test Coverage | > 80% | Backend tests |

---

## Notes for Agent

1. **Backend is in main repo**: `/Users/fahadkiani/Desktop/development/crispr-assistant-main/oncology-coPilot/oncology-backend/`
2. **Frontend is in main repo**: `/Users/fahadkiani/Desktop/development/crispr-assistant-main/oncology-coPilot/oncology-frontend/`
3. **Use existing patterns**: Follow existing router structure (oracle.py, forge.py)
4. **Validation is key**: Always show r=0.933, 95.4% accuracy prominently
5. **Test with real data**: Use TCGA mutations for validation

---
---

## Mission Objective

Build TMB (Tumor Mutational Burden) prediction as a **production-ready feature** integrated across the full stack: backend API â†’ frontend UI â†’ clinical workflow.

---

## Architecture Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           TMB PREDICTION FLOW                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  Frontend (oncology-frontend)                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ TumorQuickIntake.jsx    â”‚ OR â”‚ NGS Upload Component                    â”‚ â”‚
â”‚  â”‚ (Manual TMB entry)      â”‚    â”‚ (Upload VCF/MAF â†’ Auto-calculate TMB)   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚               â”‚                                     â”‚                       â”‚
â”‚               â–¼                                     â–¼                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                    SporadicContext (tumorContext)                       â”‚â”‚
â”‚  â”‚  {                                                                      â”‚â”‚
â”‚  â”‚    tmb: 12.3,                    // â† Calculated value                  â”‚â”‚
â”‚  â”‚    tmb_source: "calculated",     // â† NEW: "manual" | "calculated"      â”‚â”‚
â”‚  â”‚    tmb_validation: {             // â† NEW: Validation metadata          â”‚â”‚
â”‚  â”‚      correlation: 0.933,                                                â”‚â”‚
â”‚  â”‚      accuracy: 0.954,                                                   â”‚â”‚
â”‚  â”‚      source: "TCGA Pan-Immune"                                          â”‚â”‚
â”‚  â”‚    },                                                                   â”‚â”‚
â”‚  â”‚    io_eligible: true,            // â† NEW: TMB â‰¥10 â†’ IO eligible        â”‚â”‚
â”‚  â”‚    msi_status: "MSS",                                                   â”‚â”‚
â”‚  â”‚    hrd_score: 42.0                                                      â”‚â”‚
â”‚  â”‚  }                                                                      â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚               â”‚                                                             â”‚
â”‚               â–¼                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ BiomarkerSummaryWidget.jsx                                              â”‚â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚â”‚
â”‚  â”‚ â”‚ TMB: 12.3 mut/Mb â”‚ â”‚ MSI: MSS         â”‚ â”‚ HRD: 42.0        â”‚         â”‚â”‚
â”‚  â”‚ â”‚ âœ“ TMB-H (â‰¥10)    â”‚ â”‚ âœ— Not MSI-H      â”‚ â”‚ âœ“ HRD-High       â”‚         â”‚â”‚
â”‚  â”‚ â”‚ ðŸ“Š Validated     â”‚ â”‚                  â”‚ â”‚                  â”‚         â”‚â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚               â”‚                                                             â”‚
â”‚               â–¼                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ Trial Matching & IO Eligibility                                         â”‚â”‚
â”‚  â”‚ - IO trials boosted for TMB-H patients                                  â”‚â”‚
â”‚  â”‚ - Mechanism vector: IO pathway = 1.0 if TMB â‰¥10                         â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  Backend (oncology-backend)                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ NEW: POST /api/biomarkers/tmb                                           â”‚â”‚
â”‚  â”‚                                                                         â”‚â”‚
â”‚  â”‚ Request:                                                                â”‚â”‚
â”‚  â”‚ {                                                                       â”‚â”‚
â”‚  â”‚   "mutations": [                                                        â”‚â”‚
â”‚  â”‚     {"gene": "TP53", "variant_classification": "Missense_Mutation"},    â”‚â”‚
â”‚  â”‚     {"gene": "KRAS", "variant_classification": "Frame_Shift_Del"},      â”‚â”‚
â”‚  â”‚     ...                                                                 â”‚â”‚
â”‚  â”‚   ],                                                                    â”‚â”‚
â”‚  â”‚   "exome_size_mb": 38.0  // Optional                                    â”‚â”‚
â”‚  â”‚ }                                                                       â”‚â”‚
â”‚  â”‚                                                                         â”‚â”‚
â”‚  â”‚ Response:                                                               â”‚â”‚
â”‚  â”‚ {                                                                       â”‚â”‚
â”‚  â”‚   "tmb": 12.3,                                                          â”‚â”‚
â”‚  â”‚   "tmb_classification": "TMB-H",                                        â”‚â”‚
â”‚  â”‚   "io_eligible": true,                                                  â”‚â”‚
â”‚  â”‚   "nonsynonymous_count": 468,                                           â”‚â”‚
â”‚  â”‚   "validation": {                                                       â”‚â”‚
â”‚  â”‚     "pearson_r": 0.933,                                                 â”‚â”‚
â”‚  â”‚     "accuracy": 0.954,                                                  â”‚â”‚
â”‚  â”‚     "source": "TCGA Pan-Immune (n=1,895)"                               â”‚â”‚
â”‚  â”‚   },                                                                    â”‚â”‚
â”‚  â”‚   "mechanism_vector_update": {                                          â”‚â”‚
â”‚  â”‚     "io_pathway": 1.0                                                   â”‚â”‚
â”‚  â”‚   }                                                                     â”‚â”‚
â”‚  â”‚ }                                                                       â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Deliverables

### Phase 1: Backend API (2-3 hours)

#### 1.1 Create Biomarker Router

**Location**: `oncology-coPilot/oncology-backend/backend/api/biomarkers.py`

```python
from fastapi import APIRouter, HTTPException
from pydantic import BaseModel, Field
from typing import List, Optional, Dict, Any

router = APIRouter()

# Constants
TMB_HIGH_THRESHOLD = 10.0  # Mutations per Mb
TCGA_EXOME_SIZE_MB = 38.0

# Validated metrics from TCGA Pan-Immune validation
VALIDATION_METRICS = {
    "pearson_r": 0.933,
    "spearman_rho": 0.877,
    "accuracy": 0.954,
    "sensitivity": 0.960,
    "specificity": 0.952,
    "source": "TCGA Pan-Immune (n=1,895)",
    "ground_truth_file": "mutation-load_updated.txt"
}

NONSYNONYMOUS_CLASSIFICATIONS = {
    "Missense_Mutation", "Nonsense_Mutation", "Frame_Shift_Del",
    "Frame_Shift_Ins", "In_Frame_Del", "In_Frame_Ins",
    "Splice_Site", "Splice_Region", "Translation_Start_Site",
    "Nonstop_Mutation"
}

class MutationInput(BaseModel):
    gene: str
    variant_classification: str
    protein_change: Optional[str] = None
    hgvs_p: Optional[str] = None

class TMBRequest(BaseModel):
    mutations: List[MutationInput]
    exome_size_mb: Optional[float] = Field(default=TCGA_EXOME_SIZE_MB)

class TMBResponse(BaseModel):
    tmb: float
    tmb_classification: str
    io_eligible: bool
    nonsynonymous_count: int
    total_mutations: int
    exome_size_mb: float
    validation: Dict[str, Any]
    mechanism_vector_update: Dict[str, float]

def count_nonsynonymous_mutations(mutations: List[MutationInput]) -> int:
    """Count nonsynonymous mutations using validated methodology."""
    count = 0
    for mut in mutations:
        classification = mut.variant_classification.strip()
        protein_change = mut.protein_change or mut.hgvs_p or ""
        
        # Check MAF-style classifications
        if classification in NONSYNONYMOUS_CLASSIFICATIONS:
            count += 1
            continue
        
        # Handle simplified classifications (cBioPortal format)
        if protein_change and protein_change.strip():
            if "=" in protein_change:  # Silent mutation
                continue
            classification_upper = classification.upper()
            if classification_upper in ["SNP", "DEL", "INS", "ONP"]:
                count += 1
    
    return count

@router.post("/tmb", response_model=TMBResponse)
async def calculate_tmb(request: TMBRequest):
    """
    Calculate TMB from mutation list.
    
    Validated against TCGA Pan-Immune ground truth (r=0.933, 95.4% accuracy).
    """
    try:
        nonsynonymous_count = count_nonsynonymous_mutations(request.mutations)
        tmb = nonsynonymous_count / request.exome_size_mb
        tmb_classification = "TMB-H" if tmb >= TMB_HIGH_THRESHOLD else "TMB-L"
        io_eligible = tmb >= TMB_HIGH_THRESHOLD
        
        return TMBResponse(
            tmb=round(tmb, 2),
            tmb_classification=tmb_classification,
            io_eligible=io_eligible,
            nonsynonymous_count=nonsynonymous_count,
            total_mutations=len(request.mutations),
            exome_size_mb=request.exome_size_mb,
            validation=VALIDATION_METRICS,
            mechanism_vector_update={
                "io_pathway": 1.0 if io_eligible else 0.0
            }
        )
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"TMB calculation failed: {str(e)}")

@router.get("/tmb/validation")
async def get_tmb_validation_metrics():
    """Return TMB validation metrics for transparency."""
    return {
        "validation": VALIDATION_METRICS,
        "methodology": {
            "exome_size": "38 Mb (TCGA standard)",
            "threshold": "10 mut/Mb (FDA-approved pembrolizumab cutoff)",
            "classifications_counted": list(NONSYNONYMOUS_CLASSIFICATIONS)
        }
    }
```

#### 1.2 Register Router in main.py

**Location**: `oncology-coPilot/oncology-backend/main.py`

```python
# Add import
from backend.api import biomarkers as biomarkers_router

# Add router registration (near other router registrations)
app.include_router(biomarkers_router.router, prefix="/api/biomarkers", tags=["biomarkers"])
```

#### 1.3 Create TMB Calculator Service

**Location**: `oncology-coPilot/oncology-backend/backend/services/tmb_calculator.py`

```python
"""
TMB Calculator Service - Production Implementation

Validated against TCGA Pan-Immune ground truth:
- Pearson r: 0.933
- Classification accuracy: 95.4%
"""

from typing import List, Dict, Optional

NONSYNONYMOUS_CLASSIFICATIONS = {
    "Missense_Mutation", "Nonsense_Mutation", "Frame_Shift_Del",
    "Frame_Shift_Ins", "In_Frame_Del", "In_Frame_Ins",
    "Splice_Site", "Splice_Region", "Translation_Start_Site",
    "Nonstop_Mutation"
}

class TMBCalculator:
    def __init__(self, exome_size_mb: float = 38.0):
        self.exome_size_mb = exome_size_mb
        self.tmb_high_threshold = 10.0
        self.tmb_very_high_threshold = 20.0
    
    def count_nonsynonymous(self, mutations: List[Dict]) -> int:
        """Count nonsynonymous mutations."""
        count = 0
        for mut in mutations:
            classification = mut.get("variant_classification", "").strip()
            protein_change = mut.get("protein_change", "") or mut.get("hgvs_p", "")
            
            if classification in NONSYNONYMOUS_CLASSIFICATIONS:
                count += 1
                continue
            
            if protein_change and protein_change.strip() and "=" not in protein_change:
                if classification.upper() in ["SNP", "DEL", "INS", "ONP"]:
                    count += 1
        
        return count
    
    def calculate(self, mutations: List[Dict]) -> Dict:
        """Calculate TMB and return classification."""
        nonsynonymous_count = self.count_nonsynonymous(mutations)
        tmb = nonsynonymous_count / self.exome_size_mb
        
        if tmb >= self.tmb_very_high_threshold:
            classification = "TMB-Very-High"
        elif tmb >= self.tmb_high_threshold:
            classification = "TMB-H"
        else:
            classification = "TMB-L"
        
        return {
            "tmb": round(tmb, 2),
            "classification": classification,
            "io_eligible": tmb >= self.tmb_high_threshold,
            "nonsynonymous_count": nonsynonymous_count,
            "total_mutations": len(mutations),
            "exome_size_mb": self.exome_size_mb
        }
```

---

### Phase 2: Frontend Integration (2-3 hours)

#### 2.1 Create useTMBCalculation Hook

**Location**: `oncology-coPilot/oncology-frontend/src/hooks/useTMBCalculation.js`

```javascript
import { useState, useCallback } from 'react';
import { useApiClient } from './useApiClient';

/**
 * Hook for TMB calculation from mutations
 * Integrates with backend /api/biomarkers/tmb endpoint
 */
export const useTMBCalculation = () => {
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);
  const [result, setResult] = useState(null);
  const api = useApiClient();

  const calculateTMB = useCallback(async (mutations, exomeSizeMb = 38.0) => {
    setLoading(true);
    setError(null);
    
    try {
      const response = await api.post('/api/biomarkers/tmb', {
        mutations: mutations.map(m => ({
          gene: m.gene || m.Hugo_Symbol,
          variant_classification: m.variant_classification || m.Variant_Classification,
          protein_change: m.protein_change || m.HGVSp_Short,
          hgvs_p: m.hgvs_p
        })),
        exome_size_mb: exomeSizeMb
      });
      
      setResult(response.data);
      return response.data;
    } catch (err) {
      setError(err.message || 'TMB calculation failed');
      throw err;
    } finally {
      setLoading(false);
    }
  }, [api]);

  const reset = useCallback(() => {
    setResult(null);
    setError(null);
  }, []);

  return {
    calculateTMB,
    result,
    loading,
    error,
    reset,
    // Computed
    isIOEligible: result?.io_eligible || false,
    tmbClassification: result?.tmb_classification || null,
    validation: result?.validation || null
  };
};
```

#### 2.2 Create TMBValidationBadge Component

**Location**: `oncology-coPilot/oncology-frontend/src/components/sporadic/TMBValidationBadge.jsx`

```jsx
import React from 'react';
import { Chip, Tooltip, Box, Typography } from '@mui/material';
import VerifiedIcon from '@mui/icons-material/Verified';
import CalculateIcon from '@mui/icons-material/Calculate';

/**
 * TMBValidationBadge - Shows TMB calculation source and validation status
 * 
 * Props:
 * - tmbSource: "manual" | "calculated"
 * - validation: { pearson_r, accuracy, source } from API
 */
export default function TMBValidationBadge({ tmbSource, validation }) {
  if (tmbSource === 'manual') {
    return (
      <Chip
        icon={<CalculateIcon />}
        label="Manual Entry"
        size="small"
        variant="outlined"
        sx={{ fontSize: '0.7rem' }}
      />
    );
  }

  if (tmbSource === 'calculated' && validation) {
    return (
      <Tooltip
        title={
          <Box sx={{ p: 1 }}>
            <Typography variant="subtitle2" sx={{ fontWeight: 600, mb: 1 }}>
              ðŸ”¬ Validated TMB Calculation
            </Typography>
            <Typography variant="body2">
              Pearson r: {validation.pearson_r?.toFixed(3) || 'N/A'}
            </Typography>
            <Typography variant="body2">
              Accuracy: {((validation.accuracy || 0) * 100).toFixed(1)}%
            </Typography>
            <Typography variant="body2" sx={{ mt: 1, fontSize: '0.75rem', color: 'text.secondary' }}>
              Source: {validation.source}
            </Typography>
          </Box>
        }
      >
        <Chip
          icon={<VerifiedIcon />}
          label="Validated (r=0.93)"
          size="small"
          color="success"
          sx={{ fontSize: '0.7rem' }}
        />
      </Tooltip>
    );
  }

  return null;
}
```

#### 2.3 Update BiomarkerSummaryWidget

**Location**: `oncology-coPilot/oncology-frontend/src/components/sporadic/BiomarkerSummaryWidget.jsx`

Add TMB validation badge:

```jsx
// Import the new badge
import TMBValidationBadge from './TMBValidationBadge';

// In the TMB section, add:
<Box sx={{ minWidth: 150 }}>
  <Typography variant="caption" color="text.secondary" sx={{ display: 'block', mb: 0.5 }}>
    TMB (mutations/Mb)
  </Typography>
  <Stack direction="row" spacing={1} alignItems="center">
    <Chip
      label={tmb !== null && tmb !== undefined ? `${tmb.toFixed(1)} - ${tmbCategory.label}` : 'Unknown'}
      size="small"
      color={tmbCategory.color}
      sx={{ fontSize: '0.75rem' }}
    />
    <TMBValidationBadge 
      tmbSource={tumorContext?.tmb_source} 
      validation={tumorContext?.tmb_validation}
    />
  </Stack>
</Box>
```

#### 2.4 Create MutationUpload Component

**Location**: `oncology-coPilot/oncology-frontend/src/components/sporadic/MutationUpload.jsx`

```jsx
import React, { useState, useCallback } from 'react';
import { 
  Box, Button, Typography, Paper, CircularProgress,
  Alert, Stack, Chip
} from '@mui/material';
import CloudUploadIcon from '@mui/icons-material/CloudUpload';
import { useTMBCalculation } from '../../hooks/useTMBCalculation';
import { useSporadic } from '../../context/SporadicContext';

/**
 * MutationUpload - Upload VCF/MAF file for automatic TMB calculation
 */
export default function MutationUpload() {
  const [file, setFile] = useState(null);
  const [parsedMutations, setParsedMutations] = useState([]);
  const { calculateTMB, result, loading, error } = useTMBCalculation();
  const { updateTumorContext, tumorContext } = useSporadic();

  const handleFileChange = useCallback(async (event) => {
    const uploadedFile = event.target.files[0];
    if (!uploadedFile) return;
    
    setFile(uploadedFile);
    
    // Parse MAF/VCF file
    const text = await uploadedFile.text();
    const mutations = parseMAF(text); // Implement parser
    setParsedMutations(mutations);
    
    // Calculate TMB
    try {
      const tmbResult = await calculateTMB(mutations);
      
      // Update tumor context with calculated TMB
      updateTumorContext({
        ...tumorContext,
        tumor_context: {
          ...tumorContext,
          tmb: tmbResult.tmb,
          tmb_source: 'calculated',
          tmb_validation: tmbResult.validation,
          io_eligible: tmbResult.io_eligible
        }
      });
    } catch (err) {
      console.error('TMB calculation failed:', err);
    }
  }, [calculateTMB, updateTumorContext, tumorContext]);

  return (
    <Paper sx={{ p: 3, mb: 3 }}>
      <Typography variant="h6" gutterBottom>
        ðŸ§¬ Upload Mutation Data for TMB Calculation
      </Typography>
      
      <Typography variant="body2" color="text.secondary" sx={{ mb: 2 }}>
        Upload a MAF or VCF file to automatically calculate TMB.
        Validated against TCGA (r=0.93, 95.4% accuracy).
      </Typography>

      <Box sx={{ display: 'flex', alignItems: 'center', gap: 2 }}>
        <Button
          variant="outlined"
          component="label"
          startIcon={<CloudUploadIcon />}
          disabled={loading}
        >
          Upload MAF/VCF
          <input
            type="file"
            hidden
            accept=".maf,.vcf,.tsv"
            onChange={handleFileChange}
          />
        </Button>
        
        {loading && <CircularProgress size={24} />}
        
        {file && (
          <Typography variant="body2" color="text.secondary">
            {file.name} ({parsedMutations.length} mutations)
          </Typography>
        )}
      </Box>

      {error && (
        <Alert severity="error" sx={{ mt: 2 }}>
          {error}
        </Alert>
      )}

      {result && (
        <Alert severity="success" sx={{ mt: 2 }}>
          <Stack direction="row" spacing={2} alignItems="center">
            <Typography variant="body2">
              TMB: <strong>{result.tmb.toFixed(1)} mut/Mb</strong>
            </Typography>
            <Chip 
              label={result.tmb_classification} 
              color={result.io_eligible ? 'success' : 'default'}
              size="small"
            />
            {result.io_eligible && (
              <Chip label="IO Eligible" color="success" variant="outlined" size="small" />
            )}
          </Stack>
        </Alert>
      )}
    </Paper>
  );
}

// Simple MAF parser
function parseMAF(text) {
  const lines = text.split('\n');
  const mutations = [];
  let headers = [];
  
  for (const line of lines) {
    if (line.startsWith('#')) continue;
    if (line.startsWith('Hugo_Symbol') || line.startsWith('gene')) {
      headers = line.split('\t');
      continue;
    }
    
    const values = line.split('\t');
    if (values.length < 2) continue;
    
    const mutation = {};
    headers.forEach((h, i) => {
      mutation[h] = values[i];
    });
    
    mutations.push({
      gene: mutation.Hugo_Symbol || mutation.gene,
      variant_classification: mutation.Variant_Classification || mutation.variant_classification,
      protein_change: mutation.HGVSp_Short || mutation.protein_change
    });
  }
  
  return mutations;
}
```

#### 2.5 Update SporadicContext

**Location**: `oncology-coPilot/oncology-frontend/src/context/SporadicContext.jsx`

Add TMB-related fields:

```jsx
// Add to tumorContext state shape
const [tumorContext, setTumorContext] = useState({
  tmb: null,
  tmb_source: null,  // "manual" | "calculated"
  tmb_validation: null,  // { pearson_r, accuracy, source }
  io_eligible: false,
  msi_status: null,
  hrd_score: null,
  completeness_score: 0
});
```

---

### Phase 3: Integration & Testing (1-2 hours)

#### 3.1 Mechanism Vector Integration

**Location**: `oncology-coPilot/oncology-backend/backend/services/pathway_to_mechanism_vector.py`

Update to use validated TMB:

```python
def convert_pathway_scores_to_mechanism_vector(
    pathway_scores: Dict,
    tmb: Optional[float] = None,
    msi_status: Optional[str] = None
) -> List[float]:
    """
    Convert pathway scores to 7D mechanism vector.
    Uses validated TMB for IO pathway.
    """
    ddr = pathway_scores.get('ddr', 0.0)
    mapk = pathway_scores.get('mapk', 0.0)
    pi3k = pathway_scores.get('pi3k', 0.0)
    vegf = pathway_scores.get('vegf', 0.0)
    her2 = pathway_scores.get('her2', 0.0)
    efflux = pathway_scores.get('efflux', 0.0)
    
    # IO pathway from validated TMB calculation
    io_eligible_tmb = tmb is not None and tmb >= 10.0
    io_eligible_msi = msi_status in ['MSI-H', 'MSI-High']
    io_score = 1.0 if (io_eligible_tmb or io_eligible_msi) else 0.0
    
    return [ddr, mapk, pi3k, vegf, her2, io_score, efflux]
```

#### 3.2 Trial Matching Integration

**Location**: Update trial matching to boost IO trials for TMB-H patients

```python
# In trial ranking logic
if patient_tmb and patient_tmb >= 10.0:
    # Boost IO trials
    if trial_is_immunotherapy(trial):
        trial['io_boost'] = 1.5
        trial['io_eligibility_reason'] = f"TMB-H ({patient_tmb:.1f} mut/Mb) â†’ IO Eligible"
```

#### 3.3 Unit Tests

**Location**: `oncology-coPilot/oncology-backend/tests/test_biomarkers.py`

```python
import pytest
from backend.api.biomarkers import count_nonsynonymous_mutations, TMBRequest, MutationInput

def test_tmb_calculation_basic():
    """Test basic TMB calculation."""
    mutations = [
        MutationInput(gene="TP53", variant_classification="Missense_Mutation"),
        MutationInput(gene="KRAS", variant_classification="Frame_Shift_Del"),
    ]
    request = TMBRequest(mutations=mutations, exome_size_mb=38.0)
    
    count = count_nonsynonymous_mutations(mutations)
    assert count == 2
    
    tmb = count / request.exome_size_mb
    assert abs(tmb - 0.053) < 0.001

def test_tmb_high_classification():
    """Test TMB-H classification at threshold."""
    # 380 mutations / 38 Mb = 10.0 mut/Mb = TMB-H
    mutations = [
        MutationInput(gene=f"GENE{i}", variant_classification="Missense_Mutation")
        for i in range(380)
    ]
    
    count = count_nonsynonymous_mutations(mutations)
    tmb = count / 38.0
    
    assert tmb >= 10.0
    assert "TMB-H" == ("TMB-H" if tmb >= 10.0 else "TMB-L")

def test_silent_mutations_excluded():
    """Test that silent mutations are excluded."""
    mutations = [
        MutationInput(gene="TP53", variant_classification="Silent"),
        MutationInput(gene="KRAS", variant_classification="Missense_Mutation"),
    ]
    
    count = count_nonsynonymous_mutations(mutations)
    assert count == 1  # Only the missense mutation
```

---

## Implementation Checklist

### Backend
- [ ] Create `backend/api/biomarkers.py` with TMB endpoint
- [ ] Create `backend/services/tmb_calculator.py` service
- [ ] Register biomarkers router in `main.py`
- [ ] Add validation metrics constant
- [ ] Write unit tests for TMB calculation
- [ ] Update pathway_to_mechanism_vector.py with TMB integration

### Frontend
- [ ] Create `hooks/useTMBCalculation.js`
- [ ] Create `components/sporadic/TMBValidationBadge.jsx`
- [ ] Create `components/sporadic/MutationUpload.jsx`
- [ ] Update `BiomarkerSummaryWidget.jsx` with validation badge
- [ ] Update `SporadicContext.jsx` with TMB fields
- [ ] Add MAF/VCF parser utility

### Integration
- [ ] Update trial matching to use TMB
- [ ] Update mechanism vector generation
- [ ] End-to-end test: Upload â†’ Calculate â†’ Display â†’ Trial Matching

### Documentation
- [ ] API documentation for /api/biomarkers/tmb
- [ ] Update README with TMB feature
- [ ] Add validation methodology documentation

---

## Files to Create

| File | Type | Description |
|------|------|-------------|
| `backend/api/biomarkers.py` | Backend | TMB API endpoint |
| `backend/services/tmb_calculator.py` | Backend | TMB calculation service |
| `tests/test_biomarkers.py` | Backend | Unit tests |
| `src/hooks/useTMBCalculation.js` | Frontend | TMB calculation hook |
| `src/components/sporadic/TMBValidationBadge.jsx` | Frontend | Validation badge component |
| `src/components/sporadic/MutationUpload.jsx` | Frontend | File upload component |

## Files to Modify

| File | Type | Changes |
|------|------|---------|
| `main.py` | Backend | Add biomarkers router |
| `pathway_to_mechanism_vector.py` | Backend | Add TMB parameter |
| `BiomarkerSummaryWidget.jsx` | Frontend | Add validation badge |
| `SporadicContext.jsx` | Frontend | Add TMB fields |

---

## Acceptance Criteria

- [ ] POST /api/biomarkers/tmb returns correct TMB for test mutations
- [ ] TMB classification matches ground truth (r > 0.90)
- [ ] Frontend displays TMB with validation badge
- [ ] File upload calculates TMB automatically
- [ ] IO eligibility updates mechanism vector
- [ ] Trial matching prioritizes IO trials for TMB-H patients
- [ ] All unit tests pass

---

## Success Metrics

| Metric | Target | Validation |
|--------|--------|------------|
| TMB Correlation | r > 0.90 | Against TCGA ground truth |
| Classification Accuracy | > 95% | TMB-H/TMB-L classification |
| API Response Time | < 500ms | For 200 mutations |
| Frontend Load Time | < 2s | With TMB calculation |
| Test Coverage | > 80% | Backend tests |

---

## Notes for Agent

1. **Backend is in main repo**: `/Users/fahadkiani/Desktop/development/crispr-assistant-main/oncology-coPilot/oncology-backend/`
2. **Frontend is in main repo**: `/Users/fahadkiani/Desktop/development/crispr-assistant-main/oncology-coPilot/oncology-frontend/`
3. **Use existing patterns**: Follow existing router structure (oracle.py, forge.py)
4. **Validation is key**: Always show r=0.933, 95.4% accuracy prominently
5. **Test with real data**: Use TCGA mutations for validation

---
---

## Mission Objective

Build TMB (Tumor Mutational Burden) prediction as a **production-ready feature** integrated across the full stack: backend API â†’ frontend UI â†’ clinical workflow.

---

## Architecture Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           TMB PREDICTION FLOW                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  Frontend (oncology-frontend)                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ TumorQuickIntake.jsx    â”‚ OR â”‚ NGS Upload Component                    â”‚ â”‚
â”‚  â”‚ (Manual TMB entry)      â”‚    â”‚ (Upload VCF/MAF â†’ Auto-calculate TMB)   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚               â”‚                                     â”‚                       â”‚
â”‚               â–¼                                     â–¼                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                    SporadicContext (tumorContext)                       â”‚â”‚
â”‚  â”‚  {                                                                      â”‚â”‚
â”‚  â”‚    tmb: 12.3,                    // â† Calculated value                  â”‚â”‚
â”‚  â”‚    tmb_source: "calculated",     // â† NEW: "manual" | "calculated"      â”‚â”‚
â”‚  â”‚    tmb_validation: {             // â† NEW: Validation metadata          â”‚â”‚
â”‚  â”‚      correlation: 0.933,                                                â”‚â”‚
â”‚  â”‚      accuracy: 0.954,                                                   â”‚â”‚
â”‚  â”‚      source: "TCGA Pan-Immune"                                          â”‚â”‚
â”‚  â”‚    },                                                                   â”‚â”‚
â”‚  â”‚    io_eligible: true,            // â† NEW: TMB â‰¥10 â†’ IO eligible        â”‚â”‚
â”‚  â”‚    msi_status: "MSS",                                                   â”‚â”‚
â”‚  â”‚    hrd_score: 42.0                                                      â”‚â”‚
â”‚  â”‚  }                                                                      â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚               â”‚                                                             â”‚
â”‚               â–¼                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ BiomarkerSummaryWidget.jsx                                              â”‚â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚â”‚
â”‚  â”‚ â”‚ TMB: 12.3 mut/Mb â”‚ â”‚ MSI: MSS         â”‚ â”‚ HRD: 42.0        â”‚         â”‚â”‚
â”‚  â”‚ â”‚ âœ“ TMB-H (â‰¥10)    â”‚ â”‚ âœ— Not MSI-H      â”‚ â”‚ âœ“ HRD-High       â”‚         â”‚â”‚
â”‚  â”‚ â”‚ ðŸ“Š Validated     â”‚ â”‚                  â”‚ â”‚                  â”‚         â”‚â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚               â”‚                                                             â”‚
â”‚               â–¼                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ Trial Matching & IO Eligibility                                         â”‚â”‚
â”‚  â”‚ - IO trials boosted for TMB-H patients                                  â”‚â”‚
â”‚  â”‚ - Mechanism vector: IO pathway = 1.0 if TMB â‰¥10                         â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  Backend (oncology-backend)                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ NEW: POST /api/biomarkers/tmb                                           â”‚â”‚
â”‚  â”‚                                                                         â”‚â”‚
â”‚  â”‚ Request:                                                                â”‚â”‚
â”‚  â”‚ {                                                                       â”‚â”‚
â”‚  â”‚   "mutations": [                                                        â”‚â”‚
â”‚  â”‚     {"gene": "TP53", "variant_classification": "Missense_Mutation"},    â”‚â”‚
â”‚  â”‚     {"gene": "KRAS", "variant_classification": "Frame_Shift_Del"},      â”‚â”‚
â”‚  â”‚     ...                                                                 â”‚â”‚
â”‚  â”‚   ],                                                                    â”‚â”‚
â”‚  â”‚   "exome_size_mb": 38.0  // Optional                                    â”‚â”‚
â”‚  â”‚ }                                                                       â”‚â”‚
â”‚  â”‚                                                                         â”‚â”‚
â”‚  â”‚ Response:                                                               â”‚â”‚
â”‚  â”‚ {                                                                       â”‚â”‚
â”‚  â”‚   "tmb": 12.3,                                                          â”‚â”‚
â”‚  â”‚   "tmb_classification": "TMB-H",                                        â”‚â”‚
â”‚  â”‚   "io_eligible": true,                                                  â”‚â”‚
â”‚  â”‚   "nonsynonymous_count": 468,                                           â”‚â”‚
â”‚  â”‚   "validation": {                                                       â”‚â”‚
â”‚  â”‚     "pearson_r": 0.933,                                                 â”‚â”‚
â”‚  â”‚     "accuracy": 0.954,                                                  â”‚â”‚
â”‚  â”‚     "source": "TCGA Pan-Immune (n=1,895)"                               â”‚â”‚
â”‚  â”‚   },                                                                    â”‚â”‚
â”‚  â”‚   "mechanism_vector_update": {                                          â”‚â”‚
â”‚  â”‚     "io_pathway": 1.0                                                   â”‚â”‚
â”‚  â”‚   }                                                                     â”‚â”‚
â”‚  â”‚ }                                                                       â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Deliverables

### Phase 1: Backend API (2-3 hours)

#### 1.1 Create Biomarker Router

**Location**: `oncology-coPilot/oncology-backend/backend/api/biomarkers.py`

```python
from fastapi import APIRouter, HTTPException
from pydantic import BaseModel, Field
from typing import List, Optional, Dict, Any

router = APIRouter()

# Constants
TMB_HIGH_THRESHOLD = 10.0  # Mutations per Mb
TCGA_EXOME_SIZE_MB = 38.0

# Validated metrics from TCGA Pan-Immune validation
VALIDATION_METRICS = {
    "pearson_r": 0.933,
    "spearman_rho": 0.877,
    "accuracy": 0.954,
    "sensitivity": 0.960,
    "specificity": 0.952,
    "source": "TCGA Pan-Immune (n=1,895)",
    "ground_truth_file": "mutation-load_updated.txt"
}

NONSYNONYMOUS_CLASSIFICATIONS = {
    "Missense_Mutation", "Nonsense_Mutation", "Frame_Shift_Del",
    "Frame_Shift_Ins", "In_Frame_Del", "In_Frame_Ins",
    "Splice_Site", "Splice_Region", "Translation_Start_Site",
    "Nonstop_Mutation"
}

class MutationInput(BaseModel):
    gene: str
    variant_classification: str
    protein_change: Optional[str] = None
    hgvs_p: Optional[str] = None

class TMBRequest(BaseModel):
    mutations: List[MutationInput]
    exome_size_mb: Optional[float] = Field(default=TCGA_EXOME_SIZE_MB)

class TMBResponse(BaseModel):
    tmb: float
    tmb_classification: str
    io_eligible: bool
    nonsynonymous_count: int
    total_mutations: int
    exome_size_mb: float
    validation: Dict[str, Any]
    mechanism_vector_update: Dict[str, float]

def count_nonsynonymous_mutations(mutations: List[MutationInput]) -> int:
    """Count nonsynonymous mutations using validated methodology."""
    count = 0
    for mut in mutations:
        classification = mut.variant_classification.strip()
        protein_change = mut.protein_change or mut.hgvs_p or ""
        
        # Check MAF-style classifications
        if classification in NONSYNONYMOUS_CLASSIFICATIONS:
            count += 1
            continue
        
        # Handle simplified classifications (cBioPortal format)
        if protein_change and protein_change.strip():
            if "=" in protein_change:  # Silent mutation
                continue
            classification_upper = classification.upper()
            if classification_upper in ["SNP", "DEL", "INS", "ONP"]:
                count += 1
    
    return count

@router.post("/tmb", response_model=TMBResponse)
async def calculate_tmb(request: TMBRequest):
    """
    Calculate TMB from mutation list.
    
    Validated against TCGA Pan-Immune ground truth (r=0.933, 95.4% accuracy).
    """
    try:
        nonsynonymous_count = count_nonsynonymous_mutations(request.mutations)
        tmb = nonsynonymous_count / request.exome_size_mb
        tmb_classification = "TMB-H" if tmb >= TMB_HIGH_THRESHOLD else "TMB-L"
        io_eligible = tmb >= TMB_HIGH_THRESHOLD
        
        return TMBResponse(
            tmb=round(tmb, 2),
            tmb_classification=tmb_classification,
            io_eligible=io_eligible,
            nonsynonymous_count=nonsynonymous_count,
            total_mutations=len(request.mutations),
            exome_size_mb=request.exome_size_mb,
            validation=VALIDATION_METRICS,
            mechanism_vector_update={
                "io_pathway": 1.0 if io_eligible else 0.0
            }
        )
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"TMB calculation failed: {str(e)}")

@router.get("/tmb/validation")
async def get_tmb_validation_metrics():
    """Return TMB validation metrics for transparency."""
    return {
        "validation": VALIDATION_METRICS,
        "methodology": {
            "exome_size": "38 Mb (TCGA standard)",
            "threshold": "10 mut/Mb (FDA-approved pembrolizumab cutoff)",
            "classifications_counted": list(NONSYNONYMOUS_CLASSIFICATIONS)
        }
    }
```

#### 1.2 Register Router in main.py

**Location**: `oncology-coPilot/oncology-backend/main.py`

```python
# Add import
from backend.api import biomarkers as biomarkers_router

# Add router registration (near other router registrations)
app.include_router(biomarkers_router.router, prefix="/api/biomarkers", tags=["biomarkers"])
```

#### 1.3 Create TMB Calculator Service

**Location**: `oncology-coPilot/oncology-backend/backend/services/tmb_calculator.py`

```python
"""
TMB Calculator Service - Production Implementation

Validated against TCGA Pan-Immune ground truth:
- Pearson r: 0.933
- Classification accuracy: 95.4%
"""

from typing import List, Dict, Optional

NONSYNONYMOUS_CLASSIFICATIONS = {
    "Missense_Mutation", "Nonsense_Mutation", "Frame_Shift_Del",
    "Frame_Shift_Ins", "In_Frame_Del", "In_Frame_Ins",
    "Splice_Site", "Splice_Region", "Translation_Start_Site",
    "Nonstop_Mutation"
}

class TMBCalculator:
    def __init__(self, exome_size_mb: float = 38.0):
        self.exome_size_mb = exome_size_mb
        self.tmb_high_threshold = 10.0
        self.tmb_very_high_threshold = 20.0
    
    def count_nonsynonymous(self, mutations: List[Dict]) -> int:
        """Count nonsynonymous mutations."""
        count = 0
        for mut in mutations:
            classification = mut.get("variant_classification", "").strip()
            protein_change = mut.get("protein_change", "") or mut.get("hgvs_p", "")
            
            if classification in NONSYNONYMOUS_CLASSIFICATIONS:
                count += 1
                continue
            
            if protein_change and protein_change.strip() and "=" not in protein_change:
                if classification.upper() in ["SNP", "DEL", "INS", "ONP"]:
                    count += 1
        
        return count
    
    def calculate(self, mutations: List[Dict]) -> Dict:
        """Calculate TMB and return classification."""
        nonsynonymous_count = self.count_nonsynonymous(mutations)
        tmb = nonsynonymous_count / self.exome_size_mb
        
        if tmb >= self.tmb_very_high_threshold:
            classification = "TMB-Very-High"
        elif tmb >= self.tmb_high_threshold:
            classification = "TMB-H"
        else:
            classification = "TMB-L"
        
        return {
            "tmb": round(tmb, 2),
            "classification": classification,
            "io_eligible": tmb >= self.tmb_high_threshold,
            "nonsynonymous_count": nonsynonymous_count,
            "total_mutations": len(mutations),
            "exome_size_mb": self.exome_size_mb
        }
```

---

### Phase 2: Frontend Integration (2-3 hours)

#### 2.1 Create useTMBCalculation Hook

**Location**: `oncology-coPilot/oncology-frontend/src/hooks/useTMBCalculation.js`

```javascript
import { useState, useCallback } from 'react';
import { useApiClient } from './useApiClient';

/**
 * Hook for TMB calculation from mutations
 * Integrates with backend /api/biomarkers/tmb endpoint
 */
export const useTMBCalculation = () => {
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);
  const [result, setResult] = useState(null);
  const api = useApiClient();

  const calculateTMB = useCallback(async (mutations, exomeSizeMb = 38.0) => {
    setLoading(true);
    setError(null);
    
    try {
      const response = await api.post('/api/biomarkers/tmb', {
        mutations: mutations.map(m => ({
          gene: m.gene || m.Hugo_Symbol,
          variant_classification: m.variant_classification || m.Variant_Classification,
          protein_change: m.protein_change || m.HGVSp_Short,
          hgvs_p: m.hgvs_p
        })),
        exome_size_mb: exomeSizeMb
      });
      
      setResult(response.data);
      return response.data;
    } catch (err) {
      setError(err.message || 'TMB calculation failed');
      throw err;
    } finally {
      setLoading(false);
    }
  }, [api]);

  const reset = useCallback(() => {
    setResult(null);
    setError(null);
  }, []);

  return {
    calculateTMB,
    result,
    loading,
    error,
    reset,
    // Computed
    isIOEligible: result?.io_eligible || false,
    tmbClassification: result?.tmb_classification || null,
    validation: result?.validation || null
  };
};
```

#### 2.2 Create TMBValidationBadge Component

**Location**: `oncology-coPilot/oncology-frontend/src/components/sporadic/TMBValidationBadge.jsx`

```jsx
import React from 'react';
import { Chip, Tooltip, Box, Typography } from '@mui/material';
import VerifiedIcon from '@mui/icons-material/Verified';
import CalculateIcon from '@mui/icons-material/Calculate';

/**
 * TMBValidationBadge - Shows TMB calculation source and validation status
 * 
 * Props:
 * - tmbSource: "manual" | "calculated"
 * - validation: { pearson_r, accuracy, source } from API
 */
export default function TMBValidationBadge({ tmbSource, validation }) {
  if (tmbSource === 'manual') {
    return (
      <Chip
        icon={<CalculateIcon />}
        label="Manual Entry"
        size="small"
        variant="outlined"
        sx={{ fontSize: '0.7rem' }}
      />
    );
  }

  if (tmbSource === 'calculated' && validation) {
    return (
      <Tooltip
        title={
          <Box sx={{ p: 1 }}>
            <Typography variant="subtitle2" sx={{ fontWeight: 600, mb: 1 }}>
              ðŸ”¬ Validated TMB Calculation
            </Typography>
            <Typography variant="body2">
              Pearson r: {validation.pearson_r?.toFixed(3) || 'N/A'}
            </Typography>
            <Typography variant="body2">
              Accuracy: {((validation.accuracy || 0) * 100).toFixed(1)}%
            </Typography>
            <Typography variant="body2" sx={{ mt: 1, fontSize: '0.75rem', color: 'text.secondary' }}>
              Source: {validation.source}
            </Typography>
          </Box>
        }
      >
        <Chip
          icon={<VerifiedIcon />}
          label="Validated (r=0.93)"
          size="small"
          color="success"
          sx={{ fontSize: '0.7rem' }}
        />
      </Tooltip>
    );
  }

  return null;
}
```

#### 2.3 Update BiomarkerSummaryWidget

**Location**: `oncology-coPilot/oncology-frontend/src/components/sporadic/BiomarkerSummaryWidget.jsx`

Add TMB validation badge:

```jsx
// Import the new badge
import TMBValidationBadge from './TMBValidationBadge';

// In the TMB section, add:
<Box sx={{ minWidth: 150 }}>
  <Typography variant="caption" color="text.secondary" sx={{ display: 'block', mb: 0.5 }}>
    TMB (mutations/Mb)
  </Typography>
  <Stack direction="row" spacing={1} alignItems="center">
    <Chip
      label={tmb !== null && tmb !== undefined ? `${tmb.toFixed(1)} - ${tmbCategory.label}` : 'Unknown'}
      size="small"
      color={tmbCategory.color}
      sx={{ fontSize: '0.75rem' }}
    />
    <TMBValidationBadge 
      tmbSource={tumorContext?.tmb_source} 
      validation={tumorContext?.tmb_validation}
    />
  </Stack>
</Box>
```

#### 2.4 Create MutationUpload Component

**Location**: `oncology-coPilot/oncology-frontend/src/components/sporadic/MutationUpload.jsx`

```jsx
import React, { useState, useCallback } from 'react';
import { 
  Box, Button, Typography, Paper, CircularProgress,
  Alert, Stack, Chip
} from '@mui/material';
import CloudUploadIcon from '@mui/icons-material/CloudUpload';
import { useTMBCalculation } from '../../hooks/useTMBCalculation';
import { useSporadic } from '../../context/SporadicContext';

/**
 * MutationUpload - Upload VCF/MAF file for automatic TMB calculation
 */
export default function MutationUpload() {
  const [file, setFile] = useState(null);
  const [parsedMutations, setParsedMutations] = useState([]);
  const { calculateTMB, result, loading, error } = useTMBCalculation();
  const { updateTumorContext, tumorContext } = useSporadic();

  const handleFileChange = useCallback(async (event) => {
    const uploadedFile = event.target.files[0];
    if (!uploadedFile) return;
    
    setFile(uploadedFile);
    
    // Parse MAF/VCF file
    const text = await uploadedFile.text();
    const mutations = parseMAF(text); // Implement parser
    setParsedMutations(mutations);
    
    // Calculate TMB
    try {
      const tmbResult = await calculateTMB(mutations);
      
      // Update tumor context with calculated TMB
      updateTumorContext({
        ...tumorContext,
        tumor_context: {
          ...tumorContext,
          tmb: tmbResult.tmb,
          tmb_source: 'calculated',
          tmb_validation: tmbResult.validation,
          io_eligible: tmbResult.io_eligible
        }
      });
    } catch (err) {
      console.error('TMB calculation failed:', err);
    }
  }, [calculateTMB, updateTumorContext, tumorContext]);

  return (
    <Paper sx={{ p: 3, mb: 3 }}>
      <Typography variant="h6" gutterBottom>
        ðŸ§¬ Upload Mutation Data for TMB Calculation
      </Typography>
      
      <Typography variant="body2" color="text.secondary" sx={{ mb: 2 }}>
        Upload a MAF or VCF file to automatically calculate TMB.
        Validated against TCGA (r=0.93, 95.4% accuracy).
      </Typography>

      <Box sx={{ display: 'flex', alignItems: 'center', gap: 2 }}>
        <Button
          variant="outlined"
          component="label"
          startIcon={<CloudUploadIcon />}
          disabled={loading}
        >
          Upload MAF/VCF
          <input
            type="file"
            hidden
            accept=".maf,.vcf,.tsv"
            onChange={handleFileChange}
          />
        </Button>
        
        {loading && <CircularProgress size={24} />}
        
        {file && (
          <Typography variant="body2" color="text.secondary">
            {file.name} ({parsedMutations.length} mutations)
          </Typography>
        )}
      </Box>

      {error && (
        <Alert severity="error" sx={{ mt: 2 }}>
          {error}
        </Alert>
      )}

      {result && (
        <Alert severity="success" sx={{ mt: 2 }}>
          <Stack direction="row" spacing={2} alignItems="center">
            <Typography variant="body2">
              TMB: <strong>{result.tmb.toFixed(1)} mut/Mb</strong>
            </Typography>
            <Chip 
              label={result.tmb_classification} 
              color={result.io_eligible ? 'success' : 'default'}
              size="small"
            />
            {result.io_eligible && (
              <Chip label="IO Eligible" color="success" variant="outlined" size="small" />
            )}
          </Stack>
        </Alert>
      )}
    </Paper>
  );
}

// Simple MAF parser
function parseMAF(text) {
  const lines = text.split('\n');
  const mutations = [];
  let headers = [];
  
  for (const line of lines) {
    if (line.startsWith('#')) continue;
    if (line.startsWith('Hugo_Symbol') || line.startsWith('gene')) {
      headers = line.split('\t');
      continue;
    }
    
    const values = line.split('\t');
    if (values.length < 2) continue;
    
    const mutation = {};
    headers.forEach((h, i) => {
      mutation[h] = values[i];
    });
    
    mutations.push({
      gene: mutation.Hugo_Symbol || mutation.gene,
      variant_classification: mutation.Variant_Classification || mutation.variant_classification,
      protein_change: mutation.HGVSp_Short || mutation.protein_change
    });
  }
  
  return mutations;
}
```

#### 2.5 Update SporadicContext

**Location**: `oncology-coPilot/oncology-frontend/src/context/SporadicContext.jsx`

Add TMB-related fields:

```jsx
// Add to tumorContext state shape
const [tumorContext, setTumorContext] = useState({
  tmb: null,
  tmb_source: null,  // "manual" | "calculated"
  tmb_validation: null,  // { pearson_r, accuracy, source }
  io_eligible: false,
  msi_status: null,
  hrd_score: null,
  completeness_score: 0
});
```

---

### Phase 3: Integration & Testing (1-2 hours)

#### 3.1 Mechanism Vector Integration

**Location**: `oncology-coPilot/oncology-backend/backend/services/pathway_to_mechanism_vector.py`

Update to use validated TMB:

```python
def convert_pathway_scores_to_mechanism_vector(
    pathway_scores: Dict,
    tmb: Optional[float] = None,
    msi_status: Optional[str] = None
) -> List[float]:
    """
    Convert pathway scores to 7D mechanism vector.
    Uses validated TMB for IO pathway.
    """
    ddr = pathway_scores.get('ddr', 0.0)
    mapk = pathway_scores.get('mapk', 0.0)
    pi3k = pathway_scores.get('pi3k', 0.0)
    vegf = pathway_scores.get('vegf', 0.0)
    her2 = pathway_scores.get('her2', 0.0)
    efflux = pathway_scores.get('efflux', 0.0)
    
    # IO pathway from validated TMB calculation
    io_eligible_tmb = tmb is not None and tmb >= 10.0
    io_eligible_msi = msi_status in ['MSI-H', 'MSI-High']
    io_score = 1.0 if (io_eligible_tmb or io_eligible_msi) else 0.0
    
    return [ddr, mapk, pi3k, vegf, her2, io_score, efflux]
```

#### 3.2 Trial Matching Integration

**Location**: Update trial matching to boost IO trials for TMB-H patients

```python
# In trial ranking logic
if patient_tmb and patient_tmb >= 10.0:
    # Boost IO trials
    if trial_is_immunotherapy(trial):
        trial['io_boost'] = 1.5
        trial['io_eligibility_reason'] = f"TMB-H ({patient_tmb:.1f} mut/Mb) â†’ IO Eligible"
```

#### 3.3 Unit Tests

**Location**: `oncology-coPilot/oncology-backend/tests/test_biomarkers.py`

```python
import pytest
from backend.api.biomarkers import count_nonsynonymous_mutations, TMBRequest, MutationInput

def test_tmb_calculation_basic():
    """Test basic TMB calculation."""
    mutations = [
        MutationInput(gene="TP53", variant_classification="Missense_Mutation"),
        MutationInput(gene="KRAS", variant_classification="Frame_Shift_Del"),
    ]
    request = TMBRequest(mutations=mutations, exome_size_mb=38.0)
    
    count = count_nonsynonymous_mutations(mutations)
    assert count == 2
    
    tmb = count / request.exome_size_mb
    assert abs(tmb - 0.053) < 0.001

def test_tmb_high_classification():
    """Test TMB-H classification at threshold."""
    # 380 mutations / 38 Mb = 10.0 mut/Mb = TMB-H
    mutations = [
        MutationInput(gene=f"GENE{i}", variant_classification="Missense_Mutation")
        for i in range(380)
    ]
    
    count = count_nonsynonymous_mutations(mutations)
    tmb = count / 38.0
    
    assert tmb >= 10.0
    assert "TMB-H" == ("TMB-H" if tmb >= 10.0 else "TMB-L")

def test_silent_mutations_excluded():
    """Test that silent mutations are excluded."""
    mutations = [
        MutationInput(gene="TP53", variant_classification="Silent"),
        MutationInput(gene="KRAS", variant_classification="Missense_Mutation"),
    ]
    
    count = count_nonsynonymous_mutations(mutations)
    assert count == 1  # Only the missense mutation
```

---

## Implementation Checklist

### Backend
- [ ] Create `backend/api/biomarkers.py` with TMB endpoint
- [ ] Create `backend/services/tmb_calculator.py` service
- [ ] Register biomarkers router in `main.py`
- [ ] Add validation metrics constant
- [ ] Write unit tests for TMB calculation
- [ ] Update pathway_to_mechanism_vector.py with TMB integration

### Frontend
- [ ] Create `hooks/useTMBCalculation.js`
- [ ] Create `components/sporadic/TMBValidationBadge.jsx`
- [ ] Create `components/sporadic/MutationUpload.jsx`
- [ ] Update `BiomarkerSummaryWidget.jsx` with validation badge
- [ ] Update `SporadicContext.jsx` with TMB fields
- [ ] Add MAF/VCF parser utility

### Integration
- [ ] Update trial matching to use TMB
- [ ] Update mechanism vector generation
- [ ] End-to-end test: Upload â†’ Calculate â†’ Display â†’ Trial Matching

### Documentation
- [ ] API documentation for /api/biomarkers/tmb
- [ ] Update README with TMB feature
- [ ] Add validation methodology documentation

---

## Files to Create

| File | Type | Description |
|------|------|-------------|
| `backend/api/biomarkers.py` | Backend | TMB API endpoint |
| `backend/services/tmb_calculator.py` | Backend | TMB calculation service |
| `tests/test_biomarkers.py` | Backend | Unit tests |
| `src/hooks/useTMBCalculation.js` | Frontend | TMB calculation hook |
| `src/components/sporadic/TMBValidationBadge.jsx` | Frontend | Validation badge component |
| `src/components/sporadic/MutationUpload.jsx` | Frontend | File upload component |

## Files to Modify

| File | Type | Changes |
|------|------|---------|
| `main.py` | Backend | Add biomarkers router |
| `pathway_to_mechanism_vector.py` | Backend | Add TMB parameter |
| `BiomarkerSummaryWidget.jsx` | Frontend | Add validation badge |
| `SporadicContext.jsx` | Frontend | Add TMB fields |

---

## Acceptance Criteria

- [ ] POST /api/biomarkers/tmb returns correct TMB for test mutations
- [ ] TMB classification matches ground truth (r > 0.90)
- [ ] Frontend displays TMB with validation badge
- [ ] File upload calculates TMB automatically
- [ ] IO eligibility updates mechanism vector
- [ ] Trial matching prioritizes IO trials for TMB-H patients
- [ ] All unit tests pass

---

## Success Metrics

| Metric | Target | Validation |
|--------|--------|------------|
| TMB Correlation | r > 0.90 | Against TCGA ground truth |
| Classification Accuracy | > 95% | TMB-H/TMB-L classification |
| API Response Time | < 500ms | For 200 mutations |
| Frontend Load Time | < 2s | With TMB calculation |
| Test Coverage | > 80% | Backend tests |

---

## Notes for Agent

1. **Backend is in main repo**: `/Users/fahadkiani/Desktop/development/crispr-assistant-main/oncology-coPilot/oncology-backend/`
2. **Frontend is in main repo**: `/Users/fahadkiani/Desktop/development/crispr-assistant-main/oncology-coPilot/oncology-frontend/`
3. **Use existing patterns**: Follow existing router structure (oracle.py, forge.py)
4. **Validation is key**: Always show r=0.933, 95.4% accuracy prominently
5. **Test with real data**: Use TCGA mutations for validation

---
---

## Mission Objective

Build TMB (Tumor Mutational Burden) prediction as a **production-ready feature** integrated across the full stack: backend API â†’ frontend UI â†’ clinical workflow.

---

## Architecture Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           TMB PREDICTION FLOW                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  Frontend (oncology-frontend)                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ TumorQuickIntake.jsx    â”‚ OR â”‚ NGS Upload Component                    â”‚ â”‚
â”‚  â”‚ (Manual TMB entry)      â”‚    â”‚ (Upload VCF/MAF â†’ Auto-calculate TMB)   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚               â”‚                                     â”‚                       â”‚
â”‚               â–¼                                     â–¼                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                    SporadicContext (tumorContext)                       â”‚â”‚
â”‚  â”‚  {                                                                      â”‚â”‚
â”‚  â”‚    tmb: 12.3,                    // â† Calculated value                  â”‚â”‚
â”‚  â”‚    tmb_source: "calculated",     // â† NEW: "manual" | "calculated"      â”‚â”‚
â”‚  â”‚    tmb_validation: {             // â† NEW: Validation metadata          â”‚â”‚
â”‚  â”‚      correlation: 0.933,                                                â”‚â”‚
â”‚  â”‚      accuracy: 0.954,                                                   â”‚â”‚
â”‚  â”‚      source: "TCGA Pan-Immune"                                          â”‚â”‚
â”‚  â”‚    },                                                                   â”‚â”‚
â”‚  â”‚    io_eligible: true,            // â† NEW: TMB â‰¥10 â†’ IO eligible        â”‚â”‚
â”‚  â”‚    msi_status: "MSS",                                                   â”‚â”‚
â”‚  â”‚    hrd_score: 42.0                                                      â”‚â”‚
â”‚  â”‚  }                                                                      â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚               â”‚                                                             â”‚
â”‚               â–¼                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ BiomarkerSummaryWidget.jsx                                              â”‚â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚â”‚
â”‚  â”‚ â”‚ TMB: 12.3 mut/Mb â”‚ â”‚ MSI: MSS         â”‚ â”‚ HRD: 42.0        â”‚         â”‚â”‚
â”‚  â”‚ â”‚ âœ“ TMB-H (â‰¥10)    â”‚ â”‚ âœ— Not MSI-H      â”‚ â”‚ âœ“ HRD-High       â”‚         â”‚â”‚
â”‚  â”‚ â”‚ ðŸ“Š Validated     â”‚ â”‚                  â”‚ â”‚                  â”‚         â”‚â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚               â”‚                                                             â”‚
â”‚               â–¼                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ Trial Matching & IO Eligibility                                         â”‚â”‚
â”‚  â”‚ - IO trials boosted for TMB-H patients                                  â”‚â”‚
â”‚  â”‚ - Mechanism vector: IO pathway = 1.0 if TMB â‰¥10                         â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  Backend (oncology-backend)                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ NEW: POST /api/biomarkers/tmb                                           â”‚â”‚
â”‚  â”‚                                                                         â”‚â”‚
â”‚  â”‚ Request:                                                                â”‚â”‚
â”‚  â”‚ {                                                                       â”‚â”‚
â”‚  â”‚   "mutations": [                                                        â”‚â”‚
â”‚  â”‚     {"gene": "TP53", "variant_classification": "Missense_Mutation"},    â”‚â”‚
â”‚  â”‚     {"gene": "KRAS", "variant_classification": "Frame_Shift_Del"},      â”‚â”‚
â”‚  â”‚     ...                                                                 â”‚â”‚
â”‚  â”‚   ],                                                                    â”‚â”‚
â”‚  â”‚   "exome_size_mb": 38.0  // Optional                                    â”‚â”‚
â”‚  â”‚ }                                                                       â”‚â”‚
â”‚  â”‚                                                                         â”‚â”‚
â”‚  â”‚ Response:                                                               â”‚â”‚
â”‚  â”‚ {                                                                       â”‚â”‚
â”‚  â”‚   "tmb": 12.3,                                                          â”‚â”‚
â”‚  â”‚   "tmb_classification": "TMB-H",                                        â”‚â”‚
â”‚  â”‚   "io_eligible": true,                                                  â”‚â”‚
â”‚  â”‚   "nonsynonymous_count": 468,                                           â”‚â”‚
â”‚  â”‚   "validation": {                                                       â”‚â”‚
â”‚  â”‚     "pearson_r": 0.933,                                                 â”‚â”‚
â”‚  â”‚     "accuracy": 0.954,                                                  â”‚â”‚
â”‚  â”‚     "source": "TCGA Pan-Immune (n=1,895)"                               â”‚â”‚
â”‚  â”‚   },                                                                    â”‚â”‚
â”‚  â”‚   "mechanism_vector_update": {                                          â”‚â”‚
â”‚  â”‚     "io_pathway": 1.0                                                   â”‚â”‚
â”‚  â”‚   }                                                                     â”‚â”‚
â”‚  â”‚ }                                                                       â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Deliverables

### Phase 1: Backend API (2-3 hours)

#### 1.1 Create Biomarker Router

**Location**: `oncology-coPilot/oncology-backend/backend/api/biomarkers.py`

```python
from fastapi import APIRouter, HTTPException
from pydantic import BaseModel, Field
from typing import List, Optional, Dict, Any

router = APIRouter()

# Constants
TMB_HIGH_THRESHOLD = 10.0  # Mutations per Mb
TCGA_EXOME_SIZE_MB = 38.0

# Validated metrics from TCGA Pan-Immune validation
VALIDATION_METRICS = {
    "pearson_r": 0.933,
    "spearman_rho": 0.877,
    "accuracy": 0.954,
    "sensitivity": 0.960,
    "specificity": 0.952,
    "source": "TCGA Pan-Immune (n=1,895)",
    "ground_truth_file": "mutation-load_updated.txt"
}

NONSYNONYMOUS_CLASSIFICATIONS = {
    "Missense_Mutation", "Nonsense_Mutation", "Frame_Shift_Del",
    "Frame_Shift_Ins", "In_Frame_Del", "In_Frame_Ins",
    "Splice_Site", "Splice_Region", "Translation_Start_Site",
    "Nonstop_Mutation"
}

class MutationInput(BaseModel):
    gene: str
    variant_classification: str
    protein_change: Optional[str] = None
    hgvs_p: Optional[str] = None

class TMBRequest(BaseModel):
    mutations: List[MutationInput]
    exome_size_mb: Optional[float] = Field(default=TCGA_EXOME_SIZE_MB)

class TMBResponse(BaseModel):
    tmb: float
    tmb_classification: str
    io_eligible: bool
    nonsynonymous_count: int
    total_mutations: int
    exome_size_mb: float
    validation: Dict[str, Any]
    mechanism_vector_update: Dict[str, float]

def count_nonsynonymous_mutations(mutations: List[MutationInput]) -> int:
    """Count nonsynonymous mutations using validated methodology."""
    count = 0
    for mut in mutations:
        classification = mut.variant_classification.strip()
        protein_change = mut.protein_change or mut.hgvs_p or ""
        
        # Check MAF-style classifications
        if classification in NONSYNONYMOUS_CLASSIFICATIONS:
            count += 1
            continue
        
        # Handle simplified classifications (cBioPortal format)
        if protein_change and protein_change.strip():
            if "=" in protein_change:  # Silent mutation
                continue
            classification_upper = classification.upper()
            if classification_upper in ["SNP", "DEL", "INS", "ONP"]:
                count += 1
    
    return count

@router.post("/tmb", response_model=TMBResponse)
async def calculate_tmb(request: TMBRequest):
    """
    Calculate TMB from mutation list.
    
    Validated against TCGA Pan-Immune ground truth (r=0.933, 95.4% accuracy).
    """
    try:
        nonsynonymous_count = count_nonsynonymous_mutations(request.mutations)
        tmb = nonsynonymous_count / request.exome_size_mb
        tmb_classification = "TMB-H" if tmb >= TMB_HIGH_THRESHOLD else "TMB-L"
        io_eligible = tmb >= TMB_HIGH_THRESHOLD
        
        return TMBResponse(
            tmb=round(tmb, 2),
            tmb_classification=tmb_classification,
            io_eligible=io_eligible,
            nonsynonymous_count=nonsynonymous_count,
            total_mutations=len(request.mutations),
            exome_size_mb=request.exome_size_mb,
            validation=VALIDATION_METRICS,
            mechanism_vector_update={
                "io_pathway": 1.0 if io_eligible else 0.0
            }
        )
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"TMB calculation failed: {str(e)}")

@router.get("/tmb/validation")
async def get_tmb_validation_metrics():
    """Return TMB validation metrics for transparency."""
    return {
        "validation": VALIDATION_METRICS,
        "methodology": {
            "exome_size": "38 Mb (TCGA standard)",
            "threshold": "10 mut/Mb (FDA-approved pembrolizumab cutoff)",
            "classifications_counted": list(NONSYNONYMOUS_CLASSIFICATIONS)
        }
    }
```

#### 1.2 Register Router in main.py

**Location**: `oncology-coPilot/oncology-backend/main.py`

```python
# Add import
from backend.api import biomarkers as biomarkers_router

# Add router registration (near other router registrations)
app.include_router(biomarkers_router.router, prefix="/api/biomarkers", tags=["biomarkers"])
```

#### 1.3 Create TMB Calculator Service

**Location**: `oncology-coPilot/oncology-backend/backend/services/tmb_calculator.py`

```python
"""
TMB Calculator Service - Production Implementation

Validated against TCGA Pan-Immune ground truth:
- Pearson r: 0.933
- Classification accuracy: 95.4%
"""

from typing import List, Dict, Optional

NONSYNONYMOUS_CLASSIFICATIONS = {
    "Missense_Mutation", "Nonsense_Mutation", "Frame_Shift_Del",
    "Frame_Shift_Ins", "In_Frame_Del", "In_Frame_Ins",
    "Splice_Site", "Splice_Region", "Translation_Start_Site",
    "Nonstop_Mutation"
}

class TMBCalculator:
    def __init__(self, exome_size_mb: float = 38.0):
        self.exome_size_mb = exome_size_mb
        self.tmb_high_threshold = 10.0
        self.tmb_very_high_threshold = 20.0
    
    def count_nonsynonymous(self, mutations: List[Dict]) -> int:
        """Count nonsynonymous mutations."""
        count = 0
        for mut in mutations:
            classification = mut.get("variant_classification", "").strip()
            protein_change = mut.get("protein_change", "") or mut.get("hgvs_p", "")
            
            if classification in NONSYNONYMOUS_CLASSIFICATIONS:
                count += 1
                continue
            
            if protein_change and protein_change.strip() and "=" not in protein_change:
                if classification.upper() in ["SNP", "DEL", "INS", "ONP"]:
                    count += 1
        
        return count
    
    def calculate(self, mutations: List[Dict]) -> Dict:
        """Calculate TMB and return classification."""
        nonsynonymous_count = self.count_nonsynonymous(mutations)
        tmb = nonsynonymous_count / self.exome_size_mb
        
        if tmb >= self.tmb_very_high_threshold:
            classification = "TMB-Very-High"
        elif tmb >= self.tmb_high_threshold:
            classification = "TMB-H"
        else:
            classification = "TMB-L"
        
        return {
            "tmb": round(tmb, 2),
            "classification": classification,
            "io_eligible": tmb >= self.tmb_high_threshold,
            "nonsynonymous_count": nonsynonymous_count,
            "total_mutations": len(mutations),
            "exome_size_mb": self.exome_size_mb
        }
```

---

### Phase 2: Frontend Integration (2-3 hours)

#### 2.1 Create useTMBCalculation Hook

**Location**: `oncology-coPilot/oncology-frontend/src/hooks/useTMBCalculation.js`

```javascript
import { useState, useCallback } from 'react';
import { useApiClient } from './useApiClient';

/**
 * Hook for TMB calculation from mutations
 * Integrates with backend /api/biomarkers/tmb endpoint
 */
export const useTMBCalculation = () => {
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);
  const [result, setResult] = useState(null);
  const api = useApiClient();

  const calculateTMB = useCallback(async (mutations, exomeSizeMb = 38.0) => {
    setLoading(true);
    setError(null);
    
    try {
      const response = await api.post('/api/biomarkers/tmb', {
        mutations: mutations.map(m => ({
          gene: m.gene || m.Hugo_Symbol,
          variant_classification: m.variant_classification || m.Variant_Classification,
          protein_change: m.protein_change || m.HGVSp_Short,
          hgvs_p: m.hgvs_p
        })),
        exome_size_mb: exomeSizeMb
      });
      
      setResult(response.data);
      return response.data;
    } catch (err) {
      setError(err.message || 'TMB calculation failed');
      throw err;
    } finally {
      setLoading(false);
    }
  }, [api]);

  const reset = useCallback(() => {
    setResult(null);
    setError(null);
  }, []);

  return {
    calculateTMB,
    result,
    loading,
    error,
    reset,
    // Computed
    isIOEligible: result?.io_eligible || false,
    tmbClassification: result?.tmb_classification || null,
    validation: result?.validation || null
  };
};
```

#### 2.2 Create TMBValidationBadge Component

**Location**: `oncology-coPilot/oncology-frontend/src/components/sporadic/TMBValidationBadge.jsx`

```jsx
import React from 'react';
import { Chip, Tooltip, Box, Typography } from '@mui/material';
import VerifiedIcon from '@mui/icons-material/Verified';
import CalculateIcon from '@mui/icons-material/Calculate';

/**
 * TMBValidationBadge - Shows TMB calculation source and validation status
 * 
 * Props:
 * - tmbSource: "manual" | "calculated"
 * - validation: { pearson_r, accuracy, source } from API
 */
export default function TMBValidationBadge({ tmbSource, validation }) {
  if (tmbSource === 'manual') {
    return (
      <Chip
        icon={<CalculateIcon />}
        label="Manual Entry"
        size="small"
        variant="outlined"
        sx={{ fontSize: '0.7rem' }}
      />
    );
  }

  if (tmbSource === 'calculated' && validation) {
    return (
      <Tooltip
        title={
          <Box sx={{ p: 1 }}>
            <Typography variant="subtitle2" sx={{ fontWeight: 600, mb: 1 }}>
              ðŸ”¬ Validated TMB Calculation
            </Typography>
            <Typography variant="body2">
              Pearson r: {validation.pearson_r?.toFixed(3) || 'N/A'}
            </Typography>
            <Typography variant="body2">
              Accuracy: {((validation.accuracy || 0) * 100).toFixed(1)}%
            </Typography>
            <Typography variant="body2" sx={{ mt: 1, fontSize: '0.75rem', color: 'text.secondary' }}>
              Source: {validation.source}
            </Typography>
          </Box>
        }
      >
        <Chip
          icon={<VerifiedIcon />}
          label="Validated (r=0.93)"
          size="small"
          color="success"
          sx={{ fontSize: '0.7rem' }}
        />
      </Tooltip>
    );
  }

  return null;
}
```

#### 2.3 Update BiomarkerSummaryWidget

**Location**: `oncology-coPilot/oncology-frontend/src/components/sporadic/BiomarkerSummaryWidget.jsx`

Add TMB validation badge:

```jsx
// Import the new badge
import TMBValidationBadge from './TMBValidationBadge';

// In the TMB section, add:
<Box sx={{ minWidth: 150 }}>
  <Typography variant="caption" color="text.secondary" sx={{ display: 'block', mb: 0.5 }}>
    TMB (mutations/Mb)
  </Typography>
  <Stack direction="row" spacing={1} alignItems="center">
    <Chip
      label={tmb !== null && tmb !== undefined ? `${tmb.toFixed(1)} - ${tmbCategory.label}` : 'Unknown'}
      size="small"
      color={tmbCategory.color}
      sx={{ fontSize: '0.75rem' }}
    />
    <TMBValidationBadge 
      tmbSource={tumorContext?.tmb_source} 
      validation={tumorContext?.tmb_validation}
    />
  </Stack>
</Box>
```

#### 2.4 Create MutationUpload Component

**Location**: `oncology-coPilot/oncology-frontend/src/components/sporadic/MutationUpload.jsx`

```jsx
import React, { useState, useCallback } from 'react';
import { 
  Box, Button, Typography, Paper, CircularProgress,
  Alert, Stack, Chip
} from '@mui/material';
import CloudUploadIcon from '@mui/icons-material/CloudUpload';
import { useTMBCalculation } from '../../hooks/useTMBCalculation';
import { useSporadic } from '../../context/SporadicContext';

/**
 * MutationUpload - Upload VCF/MAF file for automatic TMB calculation
 */
export default function MutationUpload() {
  const [file, setFile] = useState(null);
  const [parsedMutations, setParsedMutations] = useState([]);
  const { calculateTMB, result, loading, error } = useTMBCalculation();
  const { updateTumorContext, tumorContext } = useSporadic();

  const handleFileChange = useCallback(async (event) => {
    const uploadedFile = event.target.files[0];
    if (!uploadedFile) return;
    
    setFile(uploadedFile);
    
    // Parse MAF/VCF file
    const text = await uploadedFile.text();
    const mutations = parseMAF(text); // Implement parser
    setParsedMutations(mutations);
    
    // Calculate TMB
    try {
      const tmbResult = await calculateTMB(mutations);
      
      // Update tumor context with calculated TMB
      updateTumorContext({
        ...tumorContext,
        tumor_context: {
          ...tumorContext,
          tmb: tmbResult.tmb,
          tmb_source: 'calculated',
          tmb_validation: tmbResult.validation,
          io_eligible: tmbResult.io_eligible
        }
      });
    } catch (err) {
      console.error('TMB calculation failed:', err);
    }
  }, [calculateTMB, updateTumorContext, tumorContext]);

  return (
    <Paper sx={{ p: 3, mb: 3 }}>
      <Typography variant="h6" gutterBottom>
        ðŸ§¬ Upload Mutation Data for TMB Calculation
      </Typography>
      
      <Typography variant="body2" color="text.secondary" sx={{ mb: 2 }}>
        Upload a MAF or VCF file to automatically calculate TMB.
        Validated against TCGA (r=0.93, 95.4% accuracy).
      </Typography>

      <Box sx={{ display: 'flex', alignItems: 'center', gap: 2 }}>
        <Button
          variant="outlined"
          component="label"
          startIcon={<CloudUploadIcon />}
          disabled={loading}
        >
          Upload MAF/VCF
          <input
            type="file"
            hidden
            accept=".maf,.vcf,.tsv"
            onChange={handleFileChange}
          />
        </Button>
        
        {loading && <CircularProgress size={24} />}
        
        {file && (
          <Typography variant="body2" color="text.secondary">
            {file.name} ({parsedMutations.length} mutations)
          </Typography>
        )}
      </Box>

      {error && (
        <Alert severity="error" sx={{ mt: 2 }}>
          {error}
        </Alert>
      )}

      {result && (
        <Alert severity="success" sx={{ mt: 2 }}>
          <Stack direction="row" spacing={2} alignItems="center">
            <Typography variant="body2">
              TMB: <strong>{result.tmb.toFixed(1)} mut/Mb</strong>
            </Typography>
            <Chip 
              label={result.tmb_classification} 
              color={result.io_eligible ? 'success' : 'default'}
              size="small"
            />
            {result.io_eligible && (
              <Chip label="IO Eligible" color="success" variant="outlined" size="small" />
            )}
          </Stack>
        </Alert>
      )}
    </Paper>
  );
}

// Simple MAF parser
function parseMAF(text) {
  const lines = text.split('\n');
  const mutations = [];
  let headers = [];
  
  for (const line of lines) {
    if (line.startsWith('#')) continue;
    if (line.startsWith('Hugo_Symbol') || line.startsWith('gene')) {
      headers = line.split('\t');
      continue;
    }
    
    const values = line.split('\t');
    if (values.length < 2) continue;
    
    const mutation = {};
    headers.forEach((h, i) => {
      mutation[h] = values[i];
    });
    
    mutations.push({
      gene: mutation.Hugo_Symbol || mutation.gene,
      variant_classification: mutation.Variant_Classification || mutation.variant_classification,
      protein_change: mutation.HGVSp_Short || mutation.protein_change
    });
  }
  
  return mutations;
}
```

#### 2.5 Update SporadicContext

**Location**: `oncology-coPilot/oncology-frontend/src/context/SporadicContext.jsx`

Add TMB-related fields:

```jsx
// Add to tumorContext state shape
const [tumorContext, setTumorContext] = useState({
  tmb: null,
  tmb_source: null,  // "manual" | "calculated"
  tmb_validation: null,  // { pearson_r, accuracy, source }
  io_eligible: false,
  msi_status: null,
  hrd_score: null,
  completeness_score: 0
});
```

---

### Phase 3: Integration & Testing (1-2 hours)

#### 3.1 Mechanism Vector Integration

**Location**: `oncology-coPilot/oncology-backend/backend/services/pathway_to_mechanism_vector.py`

Update to use validated TMB:

```python
def convert_pathway_scores_to_mechanism_vector(
    pathway_scores: Dict,
    tmb: Optional[float] = None,
    msi_status: Optional[str] = None
) -> List[float]:
    """
    Convert pathway scores to 7D mechanism vector.
    Uses validated TMB for IO pathway.
    """
    ddr = pathway_scores.get('ddr', 0.0)
    mapk = pathway_scores.get('mapk', 0.0)
    pi3k = pathway_scores.get('pi3k', 0.0)
    vegf = pathway_scores.get('vegf', 0.0)
    her2 = pathway_scores.get('her2', 0.0)
    efflux = pathway_scores.get('efflux', 0.0)
    
    # IO pathway from validated TMB calculation
    io_eligible_tmb = tmb is not None and tmb >= 10.0
    io_eligible_msi = msi_status in ['MSI-H', 'MSI-High']
    io_score = 1.0 if (io_eligible_tmb or io_eligible_msi) else 0.0
    
    return [ddr, mapk, pi3k, vegf, her2, io_score, efflux]
```

#### 3.2 Trial Matching Integration

**Location**: Update trial matching to boost IO trials for TMB-H patients

```python
# In trial ranking logic
if patient_tmb and patient_tmb >= 10.0:
    # Boost IO trials
    if trial_is_immunotherapy(trial):
        trial['io_boost'] = 1.5
        trial['io_eligibility_reason'] = f"TMB-H ({patient_tmb:.1f} mut/Mb) â†’ IO Eligible"
```

#### 3.3 Unit Tests

**Location**: `oncology-coPilot/oncology-backend/tests/test_biomarkers.py`

```python
import pytest
from backend.api.biomarkers import count_nonsynonymous_mutations, TMBRequest, MutationInput

def test_tmb_calculation_basic():
    """Test basic TMB calculation."""
    mutations = [
        MutationInput(gene="TP53", variant_classification="Missense_Mutation"),
        MutationInput(gene="KRAS", variant_classification="Frame_Shift_Del"),
    ]
    request = TMBRequest(mutations=mutations, exome_size_mb=38.0)
    
    count = count_nonsynonymous_mutations(mutations)
    assert count == 2
    
    tmb = count / request.exome_size_mb
    assert abs(tmb - 0.053) < 0.001

def test_tmb_high_classification():
    """Test TMB-H classification at threshold."""
    # 380 mutations / 38 Mb = 10.0 mut/Mb = TMB-H
    mutations = [
        MutationInput(gene=f"GENE{i}", variant_classification="Missense_Mutation")
        for i in range(380)
    ]
    
    count = count_nonsynonymous_mutations(mutations)
    tmb = count / 38.0
    
    assert tmb >= 10.0
    assert "TMB-H" == ("TMB-H" if tmb >= 10.0 else "TMB-L")

def test_silent_mutations_excluded():
    """Test that silent mutations are excluded."""
    mutations = [
        MutationInput(gene="TP53", variant_classification="Silent"),
        MutationInput(gene="KRAS", variant_classification="Missense_Mutation"),
    ]
    
    count = count_nonsynonymous_mutations(mutations)
    assert count == 1  # Only the missense mutation
```

---

## Implementation Checklist

### Backend
- [ ] Create `backend/api/biomarkers.py` with TMB endpoint
- [ ] Create `backend/services/tmb_calculator.py` service
- [ ] Register biomarkers router in `main.py`
- [ ] Add validation metrics constant
- [ ] Write unit tests for TMB calculation
- [ ] Update pathway_to_mechanism_vector.py with TMB integration

### Frontend
- [ ] Create `hooks/useTMBCalculation.js`
- [ ] Create `components/sporadic/TMBValidationBadge.jsx`
- [ ] Create `components/sporadic/MutationUpload.jsx`
- [ ] Update `BiomarkerSummaryWidget.jsx` with validation badge
- [ ] Update `SporadicContext.jsx` with TMB fields
- [ ] Add MAF/VCF parser utility

### Integration
- [ ] Update trial matching to use TMB
- [ ] Update mechanism vector generation
- [ ] End-to-end test: Upload â†’ Calculate â†’ Display â†’ Trial Matching

### Documentation
- [ ] API documentation for /api/biomarkers/tmb
- [ ] Update README with TMB feature
- [ ] Add validation methodology documentation

---

## Files to Create

| File | Type | Description |
|------|------|-------------|
| `backend/api/biomarkers.py` | Backend | TMB API endpoint |
| `backend/services/tmb_calculator.py` | Backend | TMB calculation service |
| `tests/test_biomarkers.py` | Backend | Unit tests |
| `src/hooks/useTMBCalculation.js` | Frontend | TMB calculation hook |
| `src/components/sporadic/TMBValidationBadge.jsx` | Frontend | Validation badge component |
| `src/components/sporadic/MutationUpload.jsx` | Frontend | File upload component |

## Files to Modify

| File | Type | Changes |
|------|------|---------|
| `main.py` | Backend | Add biomarkers router |
| `pathway_to_mechanism_vector.py` | Backend | Add TMB parameter |
| `BiomarkerSummaryWidget.jsx` | Frontend | Add validation badge |
| `SporadicContext.jsx` | Frontend | Add TMB fields |

---

## Acceptance Criteria

- [ ] POST /api/biomarkers/tmb returns correct TMB for test mutations
- [ ] TMB classification matches ground truth (r > 0.90)
- [ ] Frontend displays TMB with validation badge
- [ ] File upload calculates TMB automatically
- [ ] IO eligibility updates mechanism vector
- [ ] Trial matching prioritizes IO trials for TMB-H patients
- [ ] All unit tests pass

---

## Success Metrics

| Metric | Target | Validation |
|--------|--------|------------|
| TMB Correlation | r > 0.90 | Against TCGA ground truth |
| Classification Accuracy | > 95% | TMB-H/TMB-L classification |
| API Response Time | < 500ms | For 200 mutations |
| Frontend Load Time | < 2s | With TMB calculation |
| Test Coverage | > 80% | Backend tests |

---

## Notes for Agent

1. **Backend is in main repo**: `/Users/fahadkiani/Desktop/development/crispr-assistant-main/oncology-coPilot/oncology-backend/`
2. **Frontend is in main repo**: `/Users/fahadkiani/Desktop/development/crispr-assistant-main/oncology-coPilot/oncology-frontend/`
3. **Use existing patterns**: Follow existing router structure (oracle.py, forge.py)
4. **Validation is key**: Always show r=0.933, 95.4% accuracy prominently
5. **Test with real data**: Use TCGA mutations for validation

---
---

## Mission Objective

Build TMB (Tumor Mutational Burden) prediction as a **production-ready feature** integrated across the full stack: backend API â†’ frontend UI â†’ clinical workflow.

---

## Architecture Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           TMB PREDICTION FLOW                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  Frontend (oncology-frontend)                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ TumorQuickIntake.jsx    â”‚ OR â”‚ NGS Upload Component                    â”‚ â”‚
â”‚  â”‚ (Manual TMB entry)      â”‚    â”‚ (Upload VCF/MAF â†’ Auto-calculate TMB)   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚               â”‚                                     â”‚                       â”‚
â”‚               â–¼                                     â–¼                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                    SporadicContext (tumorContext)                       â”‚â”‚
â”‚  â”‚  {                                                                      â”‚â”‚
â”‚  â”‚    tmb: 12.3,                    // â† Calculated value                  â”‚â”‚
â”‚  â”‚    tmb_source: "calculated",     // â† NEW: "manual" | "calculated"      â”‚â”‚
â”‚  â”‚    tmb_validation: {             // â† NEW: Validation metadata          â”‚â”‚
â”‚  â”‚      correlation: 0.933,                                                â”‚â”‚
â”‚  â”‚      accuracy: 0.954,                                                   â”‚â”‚
â”‚  â”‚      source: "TCGA Pan-Immune"                                          â”‚â”‚
â”‚  â”‚    },                                                                   â”‚â”‚
â”‚  â”‚    io_eligible: true,            // â† NEW: TMB â‰¥10 â†’ IO eligible        â”‚â”‚
â”‚  â”‚    msi_status: "MSS",                                                   â”‚â”‚
â”‚  â”‚    hrd_score: 42.0                                                      â”‚â”‚
â”‚  â”‚  }                                                                      â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚               â”‚                                                             â”‚
â”‚               â–¼                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ BiomarkerSummaryWidget.jsx                                              â”‚â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚â”‚
â”‚  â”‚ â”‚ TMB: 12.3 mut/Mb â”‚ â”‚ MSI: MSS         â”‚ â”‚ HRD: 42.0        â”‚         â”‚â”‚
â”‚  â”‚ â”‚ âœ“ TMB-H (â‰¥10)    â”‚ â”‚ âœ— Not MSI-H      â”‚ â”‚ âœ“ HRD-High       â”‚         â”‚â”‚
â”‚  â”‚ â”‚ ðŸ“Š Validated     â”‚ â”‚                  â”‚ â”‚                  â”‚         â”‚â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚               â”‚                                                             â”‚
â”‚               â–¼                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ Trial Matching & IO Eligibility                                         â”‚â”‚
â”‚  â”‚ - IO trials boosted for TMB-H patients                                  â”‚â”‚
â”‚  â”‚ - Mechanism vector: IO pathway = 1.0 if TMB â‰¥10                         â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  Backend (oncology-backend)                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ NEW: POST /api/biomarkers/tmb                                           â”‚â”‚
â”‚  â”‚                                                                         â”‚â”‚
â”‚  â”‚ Request:                                                                â”‚â”‚
â”‚  â”‚ {                                                                       â”‚â”‚
â”‚  â”‚   "mutations": [                                                        â”‚â”‚
â”‚  â”‚     {"gene": "TP53", "variant_classification": "Missense_Mutation"},    â”‚â”‚
â”‚  â”‚     {"gene": "KRAS", "variant_classification": "Frame_Shift_Del"},      â”‚â”‚
â”‚  â”‚     ...                                                                 â”‚â”‚
â”‚  â”‚   ],                                                                    â”‚â”‚
â”‚  â”‚   "exome_size_mb": 38.0  // Optional                                    â”‚â”‚
â”‚  â”‚ }                                                                       â”‚â”‚
â”‚  â”‚                                                                         â”‚â”‚
â”‚  â”‚ Response:                                                               â”‚â”‚
â”‚  â”‚ {                                                                       â”‚â”‚
â”‚  â”‚   "tmb": 12.3,                                                          â”‚â”‚
â”‚  â”‚   "tmb_classification": "TMB-H",                                        â”‚â”‚
â”‚  â”‚   "io_eligible": true,                                                  â”‚â”‚
â”‚  â”‚   "nonsynonymous_count": 468,                                           â”‚â”‚
â”‚  â”‚   "validation": {                                                       â”‚â”‚
â”‚  â”‚     "pearson_r": 0.933,                                                 â”‚â”‚
â”‚  â”‚     "accuracy": 0.954,                                                  â”‚â”‚
â”‚  â”‚     "source": "TCGA Pan-Immune (n=1,895)"                               â”‚â”‚
â”‚  â”‚   },                                                                    â”‚â”‚
â”‚  â”‚   "mechanism_vector_update": {                                          â”‚â”‚
â”‚  â”‚     "io_pathway": 1.0                                                   â”‚â”‚
â”‚  â”‚   }                                                                     â”‚â”‚
â”‚  â”‚ }                                                                       â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Deliverables

### Phase 1: Backend API (2-3 hours)

#### 1.1 Create Biomarker Router

**Location**: `oncology-coPilot/oncology-backend/backend/api/biomarkers.py`

```python
from fastapi import APIRouter, HTTPException
from pydantic import BaseModel, Field
from typing import List, Optional, Dict, Any

router = APIRouter()

# Constants
TMB_HIGH_THRESHOLD = 10.0  # Mutations per Mb
TCGA_EXOME_SIZE_MB = 38.0

# Validated metrics from TCGA Pan-Immune validation
VALIDATION_METRICS = {
    "pearson_r": 0.933,
    "spearman_rho": 0.877,
    "accuracy": 0.954,
    "sensitivity": 0.960,
    "specificity": 0.952,
    "source": "TCGA Pan-Immune (n=1,895)",
    "ground_truth_file": "mutation-load_updated.txt"
}

NONSYNONYMOUS_CLASSIFICATIONS = {
    "Missense_Mutation", "Nonsense_Mutation", "Frame_Shift_Del",
    "Frame_Shift_Ins", "In_Frame_Del", "In_Frame_Ins",
    "Splice_Site", "Splice_Region", "Translation_Start_Site",
    "Nonstop_Mutation"
}

class MutationInput(BaseModel):
    gene: str
    variant_classification: str
    protein_change: Optional[str] = None
    hgvs_p: Optional[str] = None

class TMBRequest(BaseModel):
    mutations: List[MutationInput]
    exome_size_mb: Optional[float] = Field(default=TCGA_EXOME_SIZE_MB)

class TMBResponse(BaseModel):
    tmb: float
    tmb_classification: str
    io_eligible: bool
    nonsynonymous_count: int
    total_mutations: int
    exome_size_mb: float
    validation: Dict[str, Any]
    mechanism_vector_update: Dict[str, float]

def count_nonsynonymous_mutations(mutations: List[MutationInput]) -> int:
    """Count nonsynonymous mutations using validated methodology."""
    count = 0
    for mut in mutations:
        classification = mut.variant_classification.strip()
        protein_change = mut.protein_change or mut.hgvs_p or ""
        
        # Check MAF-style classifications
        if classification in NONSYNONYMOUS_CLASSIFICATIONS:
            count += 1
            continue
        
        # Handle simplified classifications (cBioPortal format)
        if protein_change and protein_change.strip():
            if "=" in protein_change:  # Silent mutation
                continue
            classification_upper = classification.upper()
            if classification_upper in ["SNP", "DEL", "INS", "ONP"]:
                count += 1
    
    return count

@router.post("/tmb", response_model=TMBResponse)
async def calculate_tmb(request: TMBRequest):
    """
    Calculate TMB from mutation list.
    
    Validated against TCGA Pan-Immune ground truth (r=0.933, 95.4% accuracy).
    """
    try:
        nonsynonymous_count = count_nonsynonymous_mutations(request.mutations)
        tmb = nonsynonymous_count / request.exome_size_mb
        tmb_classification = "TMB-H" if tmb >= TMB_HIGH_THRESHOLD else "TMB-L"
        io_eligible = tmb >= TMB_HIGH_THRESHOLD
        
        return TMBResponse(
            tmb=round(tmb, 2),
            tmb_classification=tmb_classification,
            io_eligible=io_eligible,
            nonsynonymous_count=nonsynonymous_count,
            total_mutations=len(request.mutations),
            exome_size_mb=request.exome_size_mb,
            validation=VALIDATION_METRICS,
            mechanism_vector_update={
                "io_pathway": 1.0 if io_eligible else 0.0
            }
        )
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"TMB calculation failed: {str(e)}")

@router.get("/tmb/validation")
async def get_tmb_validation_metrics():
    """Return TMB validation metrics for transparency."""
    return {
        "validation": VALIDATION_METRICS,
        "methodology": {
            "exome_size": "38 Mb (TCGA standard)",
            "threshold": "10 mut/Mb (FDA-approved pembrolizumab cutoff)",
            "classifications_counted": list(NONSYNONYMOUS_CLASSIFICATIONS)
        }
    }
```

#### 1.2 Register Router in main.py

**Location**: `oncology-coPilot/oncology-backend/main.py`

```python
# Add import
from backend.api import biomarkers as biomarkers_router

# Add router registration (near other router registrations)
app.include_router(biomarkers_router.router, prefix="/api/biomarkers", tags=["biomarkers"])
```

#### 1.3 Create TMB Calculator Service

**Location**: `oncology-coPilot/oncology-backend/backend/services/tmb_calculator.py`

```python
"""
TMB Calculator Service - Production Implementation

Validated against TCGA Pan-Immune ground truth:
- Pearson r: 0.933
- Classification accuracy: 95.4%
"""

from typing import List, Dict, Optional

NONSYNONYMOUS_CLASSIFICATIONS = {
    "Missense_Mutation", "Nonsense_Mutation", "Frame_Shift_Del",
    "Frame_Shift_Ins", "In_Frame_Del", "In_Frame_Ins",
    "Splice_Site", "Splice_Region", "Translation_Start_Site",
    "Nonstop_Mutation"
}

class TMBCalculator:
    def __init__(self, exome_size_mb: float = 38.0):
        self.exome_size_mb = exome_size_mb
        self.tmb_high_threshold = 10.0
        self.tmb_very_high_threshold = 20.0
    
    def count_nonsynonymous(self, mutations: List[Dict]) -> int:
        """Count nonsynonymous mutations."""
        count = 0
        for mut in mutations:
            classification = mut.get("variant_classification", "").strip()
            protein_change = mut.get("protein_change", "") or mut.get("hgvs_p", "")
            
            if classification in NONSYNONYMOUS_CLASSIFICATIONS:
                count += 1
                continue
            
            if protein_change and protein_change.strip() and "=" not in protein_change:
                if classification.upper() in ["SNP", "DEL", "INS", "ONP"]:
                    count += 1
        
        return count
    
    def calculate(self, mutations: List[Dict]) -> Dict:
        """Calculate TMB and return classification."""
        nonsynonymous_count = self.count_nonsynonymous(mutations)
        tmb = nonsynonymous_count / self.exome_size_mb
        
        if tmb >= self.tmb_very_high_threshold:
            classification = "TMB-Very-High"
        elif tmb >= self.tmb_high_threshold:
            classification = "TMB-H"
        else:
            classification = "TMB-L"
        
        return {
            "tmb": round(tmb, 2),
            "classification": classification,
            "io_eligible": tmb >= self.tmb_high_threshold,
            "nonsynonymous_count": nonsynonymous_count,
            "total_mutations": len(mutations),
            "exome_size_mb": self.exome_size_mb
        }
```

---

### Phase 2: Frontend Integration (2-3 hours)

#### 2.1 Create useTMBCalculation Hook

**Location**: `oncology-coPilot/oncology-frontend/src/hooks/useTMBCalculation.js`

```javascript
import { useState, useCallback } from 'react';
import { useApiClient } from './useApiClient';

/**
 * Hook for TMB calculation from mutations
 * Integrates with backend /api/biomarkers/tmb endpoint
 */
export const useTMBCalculation = () => {
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);
  const [result, setResult] = useState(null);
  const api = useApiClient();

  const calculateTMB = useCallback(async (mutations, exomeSizeMb = 38.0) => {
    setLoading(true);
    setError(null);
    
    try {
      const response = await api.post('/api/biomarkers/tmb', {
        mutations: mutations.map(m => ({
          gene: m.gene || m.Hugo_Symbol,
          variant_classification: m.variant_classification || m.Variant_Classification,
          protein_change: m.protein_change || m.HGVSp_Short,
          hgvs_p: m.hgvs_p
        })),
        exome_size_mb: exomeSizeMb
      });
      
      setResult(response.data);
      return response.data;
    } catch (err) {
      setError(err.message || 'TMB calculation failed');
      throw err;
    } finally {
      setLoading(false);
    }
  }, [api]);

  const reset = useCallback(() => {
    setResult(null);
    setError(null);
  }, []);

  return {
    calculateTMB,
    result,
    loading,
    error,
    reset,
    // Computed
    isIOEligible: result?.io_eligible || false,
    tmbClassification: result?.tmb_classification || null,
    validation: result?.validation || null
  };
};
```

#### 2.2 Create TMBValidationBadge Component

**Location**: `oncology-coPilot/oncology-frontend/src/components/sporadic/TMBValidationBadge.jsx`

```jsx
import React from 'react';
import { Chip, Tooltip, Box, Typography } from '@mui/material';
import VerifiedIcon from '@mui/icons-material/Verified';
import CalculateIcon from '@mui/icons-material/Calculate';

/**
 * TMBValidationBadge - Shows TMB calculation source and validation status
 * 
 * Props:
 * - tmbSource: "manual" | "calculated"
 * - validation: { pearson_r, accuracy, source } from API
 */
export default function TMBValidationBadge({ tmbSource, validation }) {
  if (tmbSource === 'manual') {
    return (
      <Chip
        icon={<CalculateIcon />}
        label="Manual Entry"
        size="small"
        variant="outlined"
        sx={{ fontSize: '0.7rem' }}
      />
    );
  }

  if (tmbSource === 'calculated' && validation) {
    return (
      <Tooltip
        title={
          <Box sx={{ p: 1 }}>
            <Typography variant="subtitle2" sx={{ fontWeight: 600, mb: 1 }}>
              ðŸ”¬ Validated TMB Calculation
            </Typography>
            <Typography variant="body2">
              Pearson r: {validation.pearson_r?.toFixed(3) || 'N/A'}
            </Typography>
            <Typography variant="body2">
              Accuracy: {((validation.accuracy || 0) * 100).toFixed(1)}%
            </Typography>
            <Typography variant="body2" sx={{ mt: 1, fontSize: '0.75rem', color: 'text.secondary' }}>
              Source: {validation.source}
            </Typography>
          </Box>
        }
      >
        <Chip
          icon={<VerifiedIcon />}
          label="Validated (r=0.93)"
          size="small"
          color="success"
          sx={{ fontSize: '0.7rem' }}
        />
      </Tooltip>
    );
  }

  return null;
}
```

#### 2.3 Update BiomarkerSummaryWidget

**Location**: `oncology-coPilot/oncology-frontend/src/components/sporadic/BiomarkerSummaryWidget.jsx`

Add TMB validation badge:

```jsx
// Import the new badge
import TMBValidationBadge from './TMBValidationBadge';

// In the TMB section, add:
<Box sx={{ minWidth: 150 }}>
  <Typography variant="caption" color="text.secondary" sx={{ display: 'block', mb: 0.5 }}>
    TMB (mutations/Mb)
  </Typography>
  <Stack direction="row" spacing={1} alignItems="center">
    <Chip
      label={tmb !== null && tmb !== undefined ? `${tmb.toFixed(1)} - ${tmbCategory.label}` : 'Unknown'}
      size="small"
      color={tmbCategory.color}
      sx={{ fontSize: '0.75rem' }}
    />
    <TMBValidationBadge 
      tmbSource={tumorContext?.tmb_source} 
      validation={tumorContext?.tmb_validation}
    />
  </Stack>
</Box>
```

#### 2.4 Create MutationUpload Component

**Location**: `oncology-coPilot/oncology-frontend/src/components/sporadic/MutationUpload.jsx`

```jsx
import React, { useState, useCallback } from 'react';
import { 
  Box, Button, Typography, Paper, CircularProgress,
  Alert, Stack, Chip
} from '@mui/material';
import CloudUploadIcon from '@mui/icons-material/CloudUpload';
import { useTMBCalculation } from '../../hooks/useTMBCalculation';
import { useSporadic } from '../../context/SporadicContext';

/**
 * MutationUpload - Upload VCF/MAF file for automatic TMB calculation
 */
export default function MutationUpload() {
  const [file, setFile] = useState(null);
  const [parsedMutations, setParsedMutations] = useState([]);
  const { calculateTMB, result, loading, error } = useTMBCalculation();
  const { updateTumorContext, tumorContext } = useSporadic();

  const handleFileChange = useCallback(async (event) => {
    const uploadedFile = event.target.files[0];
    if (!uploadedFile) return;
    
    setFile(uploadedFile);
    
    // Parse MAF/VCF file
    const text = await uploadedFile.text();
    const mutations = parseMAF(text); // Implement parser
    setParsedMutations(mutations);
    
    // Calculate TMB
    try {
      const tmbResult = await calculateTMB(mutations);
      
      // Update tumor context with calculated TMB
      updateTumorContext({
        ...tumorContext,
        tumor_context: {
          ...tumorContext,
          tmb: tmbResult.tmb,
          tmb_source: 'calculated',
          tmb_validation: tmbResult.validation,
          io_eligible: tmbResult.io_eligible
        }
      });
    } catch (err) {
      console.error('TMB calculation failed:', err);
    }
  }, [calculateTMB, updateTumorContext, tumorContext]);

  return (
    <Paper sx={{ p: 3, mb: 3 }}>
      <Typography variant="h6" gutterBottom>
        ðŸ§¬ Upload Mutation Data for TMB Calculation
      </Typography>
      
      <Typography variant="body2" color="text.secondary" sx={{ mb: 2 }}>
        Upload a MAF or VCF file to automatically calculate TMB.
        Validated against TCGA (r=0.93, 95.4% accuracy).
      </Typography>

      <Box sx={{ display: 'flex', alignItems: 'center', gap: 2 }}>
        <Button
          variant="outlined"
          component="label"
          startIcon={<CloudUploadIcon />}
          disabled={loading}
        >
          Upload MAF/VCF
          <input
            type="file"
            hidden
            accept=".maf,.vcf,.tsv"
            onChange={handleFileChange}
          />
        </Button>
        
        {loading && <CircularProgress size={24} />}
        
        {file && (
          <Typography variant="body2" color="text.secondary">
            {file.name} ({parsedMutations.length} mutations)
          </Typography>
        )}
      </Box>

      {error && (
        <Alert severity="error" sx={{ mt: 2 }}>
          {error}
        </Alert>
      )}

      {result && (
        <Alert severity="success" sx={{ mt: 2 }}>
          <Stack direction="row" spacing={2} alignItems="center">
            <Typography variant="body2">
              TMB: <strong>{result.tmb.toFixed(1)} mut/Mb</strong>
            </Typography>
            <Chip 
              label={result.tmb_classification} 
              color={result.io_eligible ? 'success' : 'default'}
              size="small"
            />
            {result.io_eligible && (
              <Chip label="IO Eligible" color="success" variant="outlined" size="small" />
            )}
          </Stack>
        </Alert>
      )}
    </Paper>
  );
}

// Simple MAF parser
function parseMAF(text) {
  const lines = text.split('\n');
  const mutations = [];
  let headers = [];
  
  for (const line of lines) {
    if (line.startsWith('#')) continue;
    if (line.startsWith('Hugo_Symbol') || line.startsWith('gene')) {
      headers = line.split('\t');
      continue;
    }
    
    const values = line.split('\t');
    if (values.length < 2) continue;
    
    const mutation = {};
    headers.forEach((h, i) => {
      mutation[h] = values[i];
    });
    
    mutations.push({
      gene: mutation.Hugo_Symbol || mutation.gene,
      variant_classification: mutation.Variant_Classification || mutation.variant_classification,
      protein_change: mutation.HGVSp_Short || mutation.protein_change
    });
  }
  
  return mutations;
}
```

#### 2.5 Update SporadicContext

**Location**: `oncology-coPilot/oncology-frontend/src/context/SporadicContext.jsx`

Add TMB-related fields:

```jsx
// Add to tumorContext state shape
const [tumorContext, setTumorContext] = useState({
  tmb: null,
  tmb_source: null,  // "manual" | "calculated"
  tmb_validation: null,  // { pearson_r, accuracy, source }
  io_eligible: false,
  msi_status: null,
  hrd_score: null,
  completeness_score: 0
});
```

---

### Phase 3: Integration & Testing (1-2 hours)

#### 3.1 Mechanism Vector Integration

**Location**: `oncology-coPilot/oncology-backend/backend/services/pathway_to_mechanism_vector.py`

Update to use validated TMB:

```python
def convert_pathway_scores_to_mechanism_vector(
    pathway_scores: Dict,
    tmb: Optional[float] = None,
    msi_status: Optional[str] = None
) -> List[float]:
    """
    Convert pathway scores to 7D mechanism vector.
    Uses validated TMB for IO pathway.
    """
    ddr = pathway_scores.get('ddr', 0.0)
    mapk = pathway_scores.get('mapk', 0.0)
    pi3k = pathway_scores.get('pi3k', 0.0)
    vegf = pathway_scores.get('vegf', 0.0)
    her2 = pathway_scores.get('her2', 0.0)
    efflux = pathway_scores.get('efflux', 0.0)
    
    # IO pathway from validated TMB calculation
    io_eligible_tmb = tmb is not None and tmb >= 10.0
    io_eligible_msi = msi_status in ['MSI-H', 'MSI-High']
    io_score = 1.0 if (io_eligible_tmb or io_eligible_msi) else 0.0
    
    return [ddr, mapk, pi3k, vegf, her2, io_score, efflux]
```

#### 3.2 Trial Matching Integration

**Location**: Update trial matching to boost IO trials for TMB-H patients

```python
# In trial ranking logic
if patient_tmb and patient_tmb >= 10.0:
    # Boost IO trials
    if trial_is_immunotherapy(trial):
        trial['io_boost'] = 1.5
        trial['io_eligibility_reason'] = f"TMB-H ({patient_tmb:.1f} mut/Mb) â†’ IO Eligible"
```

#### 3.3 Unit Tests

**Location**: `oncology-coPilot/oncology-backend/tests/test_biomarkers.py`

```python
import pytest
from backend.api.biomarkers import count_nonsynonymous_mutations, TMBRequest, MutationInput

def test_tmb_calculation_basic():
    """Test basic TMB calculation."""
    mutations = [
        MutationInput(gene="TP53", variant_classification="Missense_Mutation"),
        MutationInput(gene="KRAS", variant_classification="Frame_Shift_Del"),
    ]
    request = TMBRequest(mutations=mutations, exome_size_mb=38.0)
    
    count = count_nonsynonymous_mutations(mutations)
    assert count == 2
    
    tmb = count / request.exome_size_mb
    assert abs(tmb - 0.053) < 0.001

def test_tmb_high_classification():
    """Test TMB-H classification at threshold."""
    # 380 mutations / 38 Mb = 10.0 mut/Mb = TMB-H
    mutations = [
        MutationInput(gene=f"GENE{i}", variant_classification="Missense_Mutation")
        for i in range(380)
    ]
    
    count = count_nonsynonymous_mutations(mutations)
    tmb = count / 38.0
    
    assert tmb >= 10.0
    assert "TMB-H" == ("TMB-H" if tmb >= 10.0 else "TMB-L")

def test_silent_mutations_excluded():
    """Test that silent mutations are excluded."""
    mutations = [
        MutationInput(gene="TP53", variant_classification="Silent"),
        MutationInput(gene="KRAS", variant_classification="Missense_Mutation"),
    ]
    
    count = count_nonsynonymous_mutations(mutations)
    assert count == 1  # Only the missense mutation
```

---

## Implementation Checklist

### Backend
- [ ] Create `backend/api/biomarkers.py` with TMB endpoint
- [ ] Create `backend/services/tmb_calculator.py` service
- [ ] Register biomarkers router in `main.py`
- [ ] Add validation metrics constant
- [ ] Write unit tests for TMB calculation
- [ ] Update pathway_to_mechanism_vector.py with TMB integration

### Frontend
- [ ] Create `hooks/useTMBCalculation.js`
- [ ] Create `components/sporadic/TMBValidationBadge.jsx`
- [ ] Create `components/sporadic/MutationUpload.jsx`
- [ ] Update `BiomarkerSummaryWidget.jsx` with validation badge
- [ ] Update `SporadicContext.jsx` with TMB fields
- [ ] Add MAF/VCF parser utility

### Integration
- [ ] Update trial matching to use TMB
- [ ] Update mechanism vector generation
- [ ] End-to-end test: Upload â†’ Calculate â†’ Display â†’ Trial Matching

### Documentation
- [ ] API documentation for /api/biomarkers/tmb
- [ ] Update README with TMB feature
- [ ] Add validation methodology documentation

---

## Files to Create

| File | Type | Description |
|------|------|-------------|
| `backend/api/biomarkers.py` | Backend | TMB API endpoint |
| `backend/services/tmb_calculator.py` | Backend | TMB calculation service |
| `tests/test_biomarkers.py` | Backend | Unit tests |
| `src/hooks/useTMBCalculation.js` | Frontend | TMB calculation hook |
| `src/components/sporadic/TMBValidationBadge.jsx` | Frontend | Validation badge component |
| `src/components/sporadic/MutationUpload.jsx` | Frontend | File upload component |

## Files to Modify

| File | Type | Changes |
|------|------|---------|
| `main.py` | Backend | Add biomarkers router |
| `pathway_to_mechanism_vector.py` | Backend | Add TMB parameter |
| `BiomarkerSummaryWidget.jsx` | Frontend | Add validation badge |
| `SporadicContext.jsx` | Frontend | Add TMB fields |

---

## Acceptance Criteria

- [ ] POST /api/biomarkers/tmb returns correct TMB for test mutations
- [ ] TMB classification matches ground truth (r > 0.90)
- [ ] Frontend displays TMB with validation badge
- [ ] File upload calculates TMB automatically
- [ ] IO eligibility updates mechanism vector
- [ ] Trial matching prioritizes IO trials for TMB-H patients
- [ ] All unit tests pass

---

## Success Metrics

| Metric | Target | Validation |
|--------|--------|------------|
| TMB Correlation | r > 0.90 | Against TCGA ground truth |
| Classification Accuracy | > 95% | TMB-H/TMB-L classification |
| API Response Time | < 500ms | For 200 mutations |
| Frontend Load Time | < 2s | With TMB calculation |
| Test Coverage | > 80% | Backend tests |

---

## Notes for Agent

1. **Backend is in main repo**: `/Users/fahadkiani/Desktop/development/crispr-assistant-main/oncology-coPilot/oncology-backend/`
2. **Frontend is in main repo**: `/Users/fahadkiani/Desktop/development/crispr-assistant-main/oncology-coPilot/oncology-frontend/`
3. **Use existing patterns**: Follow existing router structure (oracle.py, forge.py)
4. **Validation is key**: Always show r=0.933, 95.4% accuracy prominently
5. **Test with real data**: Use TCGA mutations for validation

---
---

## Mission Objective

Build TMB (Tumor Mutational Burden) prediction as a **production-ready feature** integrated across the full stack: backend API â†’ frontend UI â†’ clinical workflow.

---

## Architecture Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           TMB PREDICTION FLOW                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  Frontend (oncology-frontend)                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ TumorQuickIntake.jsx    â”‚ OR â”‚ NGS Upload Component                    â”‚ â”‚
â”‚  â”‚ (Manual TMB entry)      â”‚    â”‚ (Upload VCF/MAF â†’ Auto-calculate TMB)   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚               â”‚                                     â”‚                       â”‚
â”‚               â–¼                                     â–¼                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                    SporadicContext (tumorContext)                       â”‚â”‚
â”‚  â”‚  {                                                                      â”‚â”‚
â”‚  â”‚    tmb: 12.3,                    // â† Calculated value                  â”‚â”‚
â”‚  â”‚    tmb_source: "calculated",     // â† NEW: "manual" | "calculated"      â”‚â”‚
â”‚  â”‚    tmb_validation: {             // â† NEW: Validation metadata          â”‚â”‚
â”‚  â”‚      correlation: 0.933,                                                â”‚â”‚
â”‚  â”‚      accuracy: 0.954,                                                   â”‚â”‚
â”‚  â”‚      source: "TCGA Pan-Immune"                                          â”‚â”‚
â”‚  â”‚    },                                                                   â”‚â”‚
â”‚  â”‚    io_eligible: true,            // â† NEW: TMB â‰¥10 â†’ IO eligible        â”‚â”‚
â”‚  â”‚    msi_status: "MSS",                                                   â”‚â”‚
â”‚  â”‚    hrd_score: 42.0                                                      â”‚â”‚
â”‚  â”‚  }                                                                      â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚               â”‚                                                             â”‚
â”‚               â–¼                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ BiomarkerSummaryWidget.jsx                                              â”‚â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚â”‚
â”‚  â”‚ â”‚ TMB: 12.3 mut/Mb â”‚ â”‚ MSI: MSS         â”‚ â”‚ HRD: 42.0        â”‚         â”‚â”‚
â”‚  â”‚ â”‚ âœ“ TMB-H (â‰¥10)    â”‚ â”‚ âœ— Not MSI-H      â”‚ â”‚ âœ“ HRD-High       â”‚         â”‚â”‚
â”‚  â”‚ â”‚ ðŸ“Š Validated     â”‚ â”‚                  â”‚ â”‚                  â”‚         â”‚â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚               â”‚                                                             â”‚
â”‚               â–¼                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ Trial Matching & IO Eligibility                                         â”‚â”‚
â”‚  â”‚ - IO trials boosted for TMB-H patients                                  â”‚â”‚
â”‚  â”‚ - Mechanism vector: IO pathway = 1.0 if TMB â‰¥10                         â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  Backend (oncology-backend)                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ NEW: POST /api/biomarkers/tmb                                           â”‚â”‚
â”‚  â”‚                                                                         â”‚â”‚
â”‚  â”‚ Request:                                                                â”‚â”‚
â”‚  â”‚ {                                                                       â”‚â”‚
â”‚  â”‚   "mutations": [                                                        â”‚â”‚
â”‚  â”‚     {"gene": "TP53", "variant_classification": "Missense_Mutation"},    â”‚â”‚
â”‚  â”‚     {"gene": "KRAS", "variant_classification": "Frame_Shift_Del"},      â”‚â”‚
â”‚  â”‚     ...                                                                 â”‚â”‚
â”‚  â”‚   ],                                                                    â”‚â”‚
â”‚  â”‚   "exome_size_mb": 38.0  // Optional                                    â”‚â”‚
â”‚  â”‚ }                                                                       â”‚â”‚
â”‚  â”‚                                                                         â”‚â”‚
â”‚  â”‚ Response:                                                               â”‚â”‚
â”‚  â”‚ {                                                                       â”‚â”‚
â”‚  â”‚   "tmb": 12.3,                                                          â”‚â”‚
â”‚  â”‚   "tmb_classification": "TMB-H",                                        â”‚â”‚
â”‚  â”‚   "io_eligible": true,                                                  â”‚â”‚
â”‚  â”‚   "nonsynonymous_count": 468,                                           â”‚â”‚
â”‚  â”‚   "validation": {                                                       â”‚â”‚
â”‚  â”‚     "pearson_r": 0.933,                                                 â”‚â”‚
â”‚  â”‚     "accuracy": 0.954,                                                  â”‚â”‚
â”‚  â”‚     "source": "TCGA Pan-Immune (n=1,895)"                               â”‚â”‚
â”‚  â”‚   },                                                                    â”‚â”‚
â”‚  â”‚   "mechanism_vector_update": {                                          â”‚â”‚
â”‚  â”‚     "io_pathway": 1.0                                                   â”‚â”‚
â”‚  â”‚   }                                                                     â”‚â”‚
â”‚  â”‚ }                                                                       â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Deliverables

### Phase 1: Backend API (2-3 hours)

#### 1.1 Create Biomarker Router

**Location**: `oncology-coPilot/oncology-backend/backend/api/biomarkers.py`

```python
from fastapi import APIRouter, HTTPException
from pydantic import BaseModel, Field
from typing import List, Optional, Dict, Any

router = APIRouter()

# Constants
TMB_HIGH_THRESHOLD = 10.0  # Mutations per Mb
TCGA_EXOME_SIZE_MB = 38.0

# Validated metrics from TCGA Pan-Immune validation
VALIDATION_METRICS = {
    "pearson_r": 0.933,
    "spearman_rho": 0.877,
    "accuracy": 0.954,
    "sensitivity": 0.960,
    "specificity": 0.952,
    "source": "TCGA Pan-Immune (n=1,895)",
    "ground_truth_file": "mutation-load_updated.txt"
}

NONSYNONYMOUS_CLASSIFICATIONS = {
    "Missense_Mutation", "Nonsense_Mutation", "Frame_Shift_Del",
    "Frame_Shift_Ins", "In_Frame_Del", "In_Frame_Ins",
    "Splice_Site", "Splice_Region", "Translation_Start_Site",
    "Nonstop_Mutation"
}

class MutationInput(BaseModel):
    gene: str
    variant_classification: str
    protein_change: Optional[str] = None
    hgvs_p: Optional[str] = None

class TMBRequest(BaseModel):
    mutations: List[MutationInput]
    exome_size_mb: Optional[float] = Field(default=TCGA_EXOME_SIZE_MB)

class TMBResponse(BaseModel):
    tmb: float
    tmb_classification: str
    io_eligible: bool
    nonsynonymous_count: int
    total_mutations: int
    exome_size_mb: float
    validation: Dict[str, Any]
    mechanism_vector_update: Dict[str, float]

def count_nonsynonymous_mutations(mutations: List[MutationInput]) -> int:
    """Count nonsynonymous mutations using validated methodology."""
    count = 0
    for mut in mutations:
        classification = mut.variant_classification.strip()
        protein_change = mut.protein_change or mut.hgvs_p or ""
        
        # Check MAF-style classifications
        if classification in NONSYNONYMOUS_CLASSIFICATIONS:
            count += 1
            continue
        
        # Handle simplified classifications (cBioPortal format)
        if protein_change and protein_change.strip():
            if "=" in protein_change:  # Silent mutation
                continue
            classification_upper = classification.upper()
            if classification_upper in ["SNP", "DEL", "INS", "ONP"]:
                count += 1
    
    return count

@router.post("/tmb", response_model=TMBResponse)
async def calculate_tmb(request: TMBRequest):
    """
    Calculate TMB from mutation list.
    
    Validated against TCGA Pan-Immune ground truth (r=0.933, 95.4% accuracy).
    """
    try:
        nonsynonymous_count = count_nonsynonymous_mutations(request.mutations)
        tmb = nonsynonymous_count / request.exome_size_mb
        tmb_classification = "TMB-H" if tmb >= TMB_HIGH_THRESHOLD else "TMB-L"
        io_eligible = tmb >= TMB_HIGH_THRESHOLD
        
        return TMBResponse(
            tmb=round(tmb, 2),
            tmb_classification=tmb_classification,
            io_eligible=io_eligible,
            nonsynonymous_count=nonsynonymous_count,
            total_mutations=len(request.mutations),
            exome_size_mb=request.exome_size_mb,
            validation=VALIDATION_METRICS,
            mechanism_vector_update={
                "io_pathway": 1.0 if io_eligible else 0.0
            }
        )
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"TMB calculation failed: {str(e)}")

@router.get("/tmb/validation")
async def get_tmb_validation_metrics():
    """Return TMB validation metrics for transparency."""
    return {
        "validation": VALIDATION_METRICS,
        "methodology": {
            "exome_size": "38 Mb (TCGA standard)",
            "threshold": "10 mut/Mb (FDA-approved pembrolizumab cutoff)",
            "classifications_counted": list(NONSYNONYMOUS_CLASSIFICATIONS)
        }
    }
```

#### 1.2 Register Router in main.py

**Location**: `oncology-coPilot/oncology-backend/main.py`

```python
# Add import
from backend.api import biomarkers as biomarkers_router

# Add router registration (near other router registrations)
app.include_router(biomarkers_router.router, prefix="/api/biomarkers", tags=["biomarkers"])
```

#### 1.3 Create TMB Calculator Service

**Location**: `oncology-coPilot/oncology-backend/backend/services/tmb_calculator.py`

```python
"""
TMB Calculator Service - Production Implementation

Validated against TCGA Pan-Immune ground truth:
- Pearson r: 0.933
- Classification accuracy: 95.4%
"""

from typing import List, Dict, Optional

NONSYNONYMOUS_CLASSIFICATIONS = {
    "Missense_Mutation", "Nonsense_Mutation", "Frame_Shift_Del",
    "Frame_Shift_Ins", "In_Frame_Del", "In_Frame_Ins",
    "Splice_Site", "Splice_Region", "Translation_Start_Site",
    "Nonstop_Mutation"
}

class TMBCalculator:
    def __init__(self, exome_size_mb: float = 38.0):
        self.exome_size_mb = exome_size_mb
        self.tmb_high_threshold = 10.0
        self.tmb_very_high_threshold = 20.0
    
    def count_nonsynonymous(self, mutations: List[Dict]) -> int:
        """Count nonsynonymous mutations."""
        count = 0
        for mut in mutations:
            classification = mut.get("variant_classification", "").strip()
            protein_change = mut.get("protein_change", "") or mut.get("hgvs_p", "")
            
            if classification in NONSYNONYMOUS_CLASSIFICATIONS:
                count += 1
                continue
            
            if protein_change and protein_change.strip() and "=" not in protein_change:
                if classification.upper() in ["SNP", "DEL", "INS", "ONP"]:
                    count += 1
        
        return count
    
    def calculate(self, mutations: List[Dict]) -> Dict:
        """Calculate TMB and return classification."""
        nonsynonymous_count = self.count_nonsynonymous(mutations)
        tmb = nonsynonymous_count / self.exome_size_mb
        
        if tmb >= self.tmb_very_high_threshold:
            classification = "TMB-Very-High"
        elif tmb >= self.tmb_high_threshold:
            classification = "TMB-H"
        else:
            classification = "TMB-L"
        
        return {
            "tmb": round(tmb, 2),
            "classification": classification,
            "io_eligible": tmb >= self.tmb_high_threshold,
            "nonsynonymous_count": nonsynonymous_count,
            "total_mutations": len(mutations),
            "exome_size_mb": self.exome_size_mb
        }
```

---

### Phase 2: Frontend Integration (2-3 hours)

#### 2.1 Create useTMBCalculation Hook

**Location**: `oncology-coPilot/oncology-frontend/src/hooks/useTMBCalculation.js`

```javascript
import { useState, useCallback } from 'react';
import { useApiClient } from './useApiClient';

/**
 * Hook for TMB calculation from mutations
 * Integrates with backend /api/biomarkers/tmb endpoint
 */
export const useTMBCalculation = () => {
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);
  const [result, setResult] = useState(null);
  const api = useApiClient();

  const calculateTMB = useCallback(async (mutations, exomeSizeMb = 38.0) => {
    setLoading(true);
    setError(null);
    
    try {
      const response = await api.post('/api/biomarkers/tmb', {
        mutations: mutations.map(m => ({
          gene: m.gene || m.Hugo_Symbol,
          variant_classification: m.variant_classification || m.Variant_Classification,
          protein_change: m.protein_change || m.HGVSp_Short,
          hgvs_p: m.hgvs_p
        })),
        exome_size_mb: exomeSizeMb
      });
      
      setResult(response.data);
      return response.data;
    } catch (err) {
      setError(err.message || 'TMB calculation failed');
      throw err;
    } finally {
      setLoading(false);
    }
  }, [api]);

  const reset = useCallback(() => {
    setResult(null);
    setError(null);
  }, []);

  return {
    calculateTMB,
    result,
    loading,
    error,
    reset,
    // Computed
    isIOEligible: result?.io_eligible || false,
    tmbClassification: result?.tmb_classification || null,
    validation: result?.validation || null
  };
};
```

#### 2.2 Create TMBValidationBadge Component

**Location**: `oncology-coPilot/oncology-frontend/src/components/sporadic/TMBValidationBadge.jsx`

```jsx
import React from 'react';
import { Chip, Tooltip, Box, Typography } from '@mui/material';
import VerifiedIcon from '@mui/icons-material/Verified';
import CalculateIcon from '@mui/icons-material/Calculate';

/**
 * TMBValidationBadge - Shows TMB calculation source and validation status
 * 
 * Props:
 * - tmbSource: "manual" | "calculated"
 * - validation: { pearson_r, accuracy, source } from API
 */
export default function TMBValidationBadge({ tmbSource, validation }) {
  if (tmbSource === 'manual') {
    return (
      <Chip
        icon={<CalculateIcon />}
        label="Manual Entry"
        size="small"
        variant="outlined"
        sx={{ fontSize: '0.7rem' }}
      />
    );
  }

  if (tmbSource === 'calculated' && validation) {
    return (
      <Tooltip
        title={
          <Box sx={{ p: 1 }}>
            <Typography variant="subtitle2" sx={{ fontWeight: 600, mb: 1 }}>
              ðŸ”¬ Validated TMB Calculation
            </Typography>
            <Typography variant="body2">
              Pearson r: {validation.pearson_r?.toFixed(3) || 'N/A'}
            </Typography>
            <Typography variant="body2">
              Accuracy: {((validation.accuracy || 0) * 100).toFixed(1)}%
            </Typography>
            <Typography variant="body2" sx={{ mt: 1, fontSize: '0.75rem', color: 'text.secondary' }}>
              Source: {validation.source}
            </Typography>
          </Box>
        }
      >
        <Chip
          icon={<VerifiedIcon />}
          label="Validated (r=0.93)"
          size="small"
          color="success"
          sx={{ fontSize: '0.7rem' }}
        />
      </Tooltip>
    );
  }

  return null;
}
```

#### 2.3 Update BiomarkerSummaryWidget

**Location**: `oncology-coPilot/oncology-frontend/src/components/sporadic/BiomarkerSummaryWidget.jsx`

Add TMB validation badge:

```jsx
// Import the new badge
import TMBValidationBadge from './TMBValidationBadge';

// In the TMB section, add:
<Box sx={{ minWidth: 150 }}>
  <Typography variant="caption" color="text.secondary" sx={{ display: 'block', mb: 0.5 }}>
    TMB (mutations/Mb)
  </Typography>
  <Stack direction="row" spacing={1} alignItems="center">
    <Chip
      label={tmb !== null && tmb !== undefined ? `${tmb.toFixed(1)} - ${tmbCategory.label}` : 'Unknown'}
      size="small"
      color={tmbCategory.color}
      sx={{ fontSize: '0.75rem' }}
    />
    <TMBValidationBadge 
      tmbSource={tumorContext?.tmb_source} 
      validation={tumorContext?.tmb_validation}
    />
  </Stack>
</Box>
```

#### 2.4 Create MutationUpload Component

**Location**: `oncology-coPilot/oncology-frontend/src/components/sporadic/MutationUpload.jsx`

```jsx
import React, { useState, useCallback } from 'react';
import { 
  Box, Button, Typography, Paper, CircularProgress,
  Alert, Stack, Chip
} from '@mui/material';
import CloudUploadIcon from '@mui/icons-material/CloudUpload';
import { useTMBCalculation } from '../../hooks/useTMBCalculation';
import { useSporadic } from '../../context/SporadicContext';

/**
 * MutationUpload - Upload VCF/MAF file for automatic TMB calculation
 */
export default function MutationUpload() {
  const [file, setFile] = useState(null);
  const [parsedMutations, setParsedMutations] = useState([]);
  const { calculateTMB, result, loading, error } = useTMBCalculation();
  const { updateTumorContext, tumorContext } = useSporadic();

  const handleFileChange = useCallback(async (event) => {
    const uploadedFile = event.target.files[0];
    if (!uploadedFile) return;
    
    setFile(uploadedFile);
    
    // Parse MAF/VCF file
    const text = await uploadedFile.text();
    const mutations = parseMAF(text); // Implement parser
    setParsedMutations(mutations);
    
    // Calculate TMB
    try {
      const tmbResult = await calculateTMB(mutations);
      
      // Update tumor context with calculated TMB
      updateTumorContext({
        ...tumorContext,
        tumor_context: {
          ...tumorContext,
          tmb: tmbResult.tmb,
          tmb_source: 'calculated',
          tmb_validation: tmbResult.validation,
          io_eligible: tmbResult.io_eligible
        }
      });
    } catch (err) {
      console.error('TMB calculation failed:', err);
    }
  }, [calculateTMB, updateTumorContext, tumorContext]);

  return (
    <Paper sx={{ p: 3, mb: 3 }}>
      <Typography variant="h6" gutterBottom>
        ðŸ§¬ Upload Mutation Data for TMB Calculation
      </Typography>
      
      <Typography variant="body2" color="text.secondary" sx={{ mb: 2 }}>
        Upload a MAF or VCF file to automatically calculate TMB.
        Validated against TCGA (r=0.93, 95.4% accuracy).
      </Typography>

      <Box sx={{ display: 'flex', alignItems: 'center', gap: 2 }}>
        <Button
          variant="outlined"
          component="label"
          startIcon={<CloudUploadIcon />}
          disabled={loading}
        >
          Upload MAF/VCF
          <input
            type="file"
            hidden
            accept=".maf,.vcf,.tsv"
            onChange={handleFileChange}
          />
        </Button>
        
        {loading && <CircularProgress size={24} />}
        
        {file && (
          <Typography variant="body2" color="text.secondary">
            {file.name} ({parsedMutations.length} mutations)
          </Typography>
        )}
      </Box>

      {error && (
        <Alert severity="error" sx={{ mt: 2 }}>
          {error}
        </Alert>
      )}

      {result && (
        <Alert severity="success" sx={{ mt: 2 }}>
          <Stack direction="row" spacing={2} alignItems="center">
            <Typography variant="body2">
              TMB: <strong>{result.tmb.toFixed(1)} mut/Mb</strong>
            </Typography>
            <Chip 
              label={result.tmb_classification} 
              color={result.io_eligible ? 'success' : 'default'}
              size="small"
            />
            {result.io_eligible && (
              <Chip label="IO Eligible" color="success" variant="outlined" size="small" />
            )}
          </Stack>
        </Alert>
      )}
    </Paper>
  );
}

// Simple MAF parser
function parseMAF(text) {
  const lines = text.split('\n');
  const mutations = [];
  let headers = [];
  
  for (const line of lines) {
    if (line.startsWith('#')) continue;
    if (line.startsWith('Hugo_Symbol') || line.startsWith('gene')) {
      headers = line.split('\t');
      continue;
    }
    
    const values = line.split('\t');
    if (values.length < 2) continue;
    
    const mutation = {};
    headers.forEach((h, i) => {
      mutation[h] = values[i];
    });
    
    mutations.push({
      gene: mutation.Hugo_Symbol || mutation.gene,
      variant_classification: mutation.Variant_Classification || mutation.variant_classification,
      protein_change: mutation.HGVSp_Short || mutation.protein_change
    });
  }
  
  return mutations;
}
```

#### 2.5 Update SporadicContext

**Location**: `oncology-coPilot/oncology-frontend/src/context/SporadicContext.jsx`

Add TMB-related fields:

```jsx
// Add to tumorContext state shape
const [tumorContext, setTumorContext] = useState({
  tmb: null,
  tmb_source: null,  // "manual" | "calculated"
  tmb_validation: null,  // { pearson_r, accuracy, source }
  io_eligible: false,
  msi_status: null,
  hrd_score: null,
  completeness_score: 0
});
```

---

### Phase 3: Integration & Testing (1-2 hours)

#### 3.1 Mechanism Vector Integration

**Location**: `oncology-coPilot/oncology-backend/backend/services/pathway_to_mechanism_vector.py`

Update to use validated TMB:

```python
def convert_pathway_scores_to_mechanism_vector(
    pathway_scores: Dict,
    tmb: Optional[float] = None,
    msi_status: Optional[str] = None
) -> List[float]:
    """
    Convert pathway scores to 7D mechanism vector.
    Uses validated TMB for IO pathway.
    """
    ddr = pathway_scores.get('ddr', 0.0)
    mapk = pathway_scores.get('mapk', 0.0)
    pi3k = pathway_scores.get('pi3k', 0.0)
    vegf = pathway_scores.get('vegf', 0.0)
    her2 = pathway_scores.get('her2', 0.0)
    efflux = pathway_scores.get('efflux', 0.0)
    
    # IO pathway from validated TMB calculation
    io_eligible_tmb = tmb is not None and tmb >= 10.0
    io_eligible_msi = msi_status in ['MSI-H', 'MSI-High']
    io_score = 1.0 if (io_eligible_tmb or io_eligible_msi) else 0.0
    
    return [ddr, mapk, pi3k, vegf, her2, io_score, efflux]
```

#### 3.2 Trial Matching Integration

**Location**: Update trial matching to boost IO trials for TMB-H patients

```python
# In trial ranking logic
if patient_tmb and patient_tmb >= 10.0:
    # Boost IO trials
    if trial_is_immunotherapy(trial):
        trial['io_boost'] = 1.5
        trial['io_eligibility_reason'] = f"TMB-H ({patient_tmb:.1f} mut/Mb) â†’ IO Eligible"
```

#### 3.3 Unit Tests

**Location**: `oncology-coPilot/oncology-backend/tests/test_biomarkers.py`

```python
import pytest
from backend.api.biomarkers import count_nonsynonymous_mutations, TMBRequest, MutationInput

def test_tmb_calculation_basic():
    """Test basic TMB calculation."""
    mutations = [
        MutationInput(gene="TP53", variant_classification="Missense_Mutation"),
        MutationInput(gene="KRAS", variant_classification="Frame_Shift_Del"),
    ]
    request = TMBRequest(mutations=mutations, exome_size_mb=38.0)
    
    count = count_nonsynonymous_mutations(mutations)
    assert count == 2
    
    tmb = count / request.exome_size_mb
    assert abs(tmb - 0.053) < 0.001

def test_tmb_high_classification():
    """Test TMB-H classification at threshold."""
    # 380 mutations / 38 Mb = 10.0 mut/Mb = TMB-H
    mutations = [
        MutationInput(gene=f"GENE{i}", variant_classification="Missense_Mutation")
        for i in range(380)
    ]
    
    count = count_nonsynonymous_mutations(mutations)
    tmb = count / 38.0
    
    assert tmb >= 10.0
    assert "TMB-H" == ("TMB-H" if tmb >= 10.0 else "TMB-L")

def test_silent_mutations_excluded():
    """Test that silent mutations are excluded."""
    mutations = [
        MutationInput(gene="TP53", variant_classification="Silent"),
        MutationInput(gene="KRAS", variant_classification="Missense_Mutation"),
    ]
    
    count = count_nonsynonymous_mutations(mutations)
    assert count == 1  # Only the missense mutation
```

---

## Implementation Checklist

### Backend
- [ ] Create `backend/api/biomarkers.py` with TMB endpoint
- [ ] Create `backend/services/tmb_calculator.py` service
- [ ] Register biomarkers router in `main.py`
- [ ] Add validation metrics constant
- [ ] Write unit tests for TMB calculation
- [ ] Update pathway_to_mechanism_vector.py with TMB integration

### Frontend
- [ ] Create `hooks/useTMBCalculation.js`
- [ ] Create `components/sporadic/TMBValidationBadge.jsx`
- [ ] Create `components/sporadic/MutationUpload.jsx`
- [ ] Update `BiomarkerSummaryWidget.jsx` with validation badge
- [ ] Update `SporadicContext.jsx` with TMB fields
- [ ] Add MAF/VCF parser utility

### Integration
- [ ] Update trial matching to use TMB
- [ ] Update mechanism vector generation
- [ ] End-to-end test: Upload â†’ Calculate â†’ Display â†’ Trial Matching

### Documentation
- [ ] API documentation for /api/biomarkers/tmb
- [ ] Update README with TMB feature
- [ ] Add validation methodology documentation

---

## Files to Create

| File | Type | Description |
|------|------|-------------|
| `backend/api/biomarkers.py` | Backend | TMB API endpoint |
| `backend/services/tmb_calculator.py` | Backend | TMB calculation service |
| `tests/test_biomarkers.py` | Backend | Unit tests |
| `src/hooks/useTMBCalculation.js` | Frontend | TMB calculation hook |
| `src/components/sporadic/TMBValidationBadge.jsx` | Frontend | Validation badge component |
| `src/components/sporadic/MutationUpload.jsx` | Frontend | File upload component |

## Files to Modify

| File | Type | Changes |
|------|------|---------|
| `main.py` | Backend | Add biomarkers router |
| `pathway_to_mechanism_vector.py` | Backend | Add TMB parameter |
| `BiomarkerSummaryWidget.jsx` | Frontend | Add validation badge |
| `SporadicContext.jsx` | Frontend | Add TMB fields |

---

## Acceptance Criteria

- [ ] POST /api/biomarkers/tmb returns correct TMB for test mutations
- [ ] TMB classification matches ground truth (r > 0.90)
- [ ] Frontend displays TMB with validation badge
- [ ] File upload calculates TMB automatically
- [ ] IO eligibility updates mechanism vector
- [ ] Trial matching prioritizes IO trials for TMB-H patients
- [ ] All unit tests pass

---

## Success Metrics

| Metric | Target | Validation |
|--------|--------|------------|
| TMB Correlation | r > 0.90 | Against TCGA ground truth |
| Classification Accuracy | > 95% | TMB-H/TMB-L classification |
| API Response Time | < 500ms | For 200 mutations |
| Frontend Load Time | < 2s | With TMB calculation |
| Test Coverage | > 80% | Backend tests |

---

## Notes for Agent

1. **Backend is in main repo**: `/Users/fahadkiani/Desktop/development/crispr-assistant-main/oncology-coPilot/oncology-backend/`
2. **Frontend is in main repo**: `/Users/fahadkiani/Desktop/development/crispr-assistant-main/oncology-coPilot/oncology-frontend/`
3. **Use existing patterns**: Follow existing router structure (oracle.py, forge.py)
4. **Validation is key**: Always show r=0.933, 95.4% accuracy prominently
5. **Test with real data**: Use TCGA mutations for validation

---
---

## Mission Objective

Build TMB (Tumor Mutational Burden) prediction as a **production-ready feature** integrated across the full stack: backend API â†’ frontend UI â†’ clinical workflow.

---

## Architecture Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           TMB PREDICTION FLOW                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  Frontend (oncology-frontend)                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ TumorQuickIntake.jsx    â”‚ OR â”‚ NGS Upload Component                    â”‚ â”‚
â”‚  â”‚ (Manual TMB entry)      â”‚    â”‚ (Upload VCF/MAF â†’ Auto-calculate TMB)   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚               â”‚                                     â”‚                       â”‚
â”‚               â–¼                                     â–¼                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                    SporadicContext (tumorContext)                       â”‚â”‚
â”‚  â”‚  {                                                                      â”‚â”‚
â”‚  â”‚    tmb: 12.3,                    // â† Calculated value                  â”‚â”‚
â”‚  â”‚    tmb_source: "calculated",     // â† NEW: "manual" | "calculated"      â”‚â”‚
â”‚  â”‚    tmb_validation: {             // â† NEW: Validation metadata          â”‚â”‚
â”‚  â”‚      correlation: 0.933,                                                â”‚â”‚
â”‚  â”‚      accuracy: 0.954,                                                   â”‚â”‚
â”‚  â”‚      source: "TCGA Pan-Immune"                                          â”‚â”‚
â”‚  â”‚    },                                                                   â”‚â”‚
â”‚  â”‚    io_eligible: true,            // â† NEW: TMB â‰¥10 â†’ IO eligible        â”‚â”‚
â”‚  â”‚    msi_status: "MSS",                                                   â”‚â”‚
â”‚  â”‚    hrd_score: 42.0                                                      â”‚â”‚
â”‚  â”‚  }                                                                      â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚               â”‚                                                             â”‚
â”‚               â–¼                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ BiomarkerSummaryWidget.jsx                                              â”‚â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚â”‚
â”‚  â”‚ â”‚ TMB: 12.3 mut/Mb â”‚ â”‚ MSI: MSS         â”‚ â”‚ HRD: 42.0        â”‚         â”‚â”‚
â”‚  â”‚ â”‚ âœ“ TMB-H (â‰¥10)    â”‚ â”‚ âœ— Not MSI-H      â”‚ â”‚ âœ“ HRD-High       â”‚         â”‚â”‚
â”‚  â”‚ â”‚ ðŸ“Š Validated     â”‚ â”‚                  â”‚ â”‚                  â”‚         â”‚â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚               â”‚                                                             â”‚
â”‚               â–¼                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ Trial Matching & IO Eligibility                                         â”‚â”‚
â”‚  â”‚ - IO trials boosted for TMB-H patients                                  â”‚â”‚
â”‚  â”‚ - Mechanism vector: IO pathway = 1.0 if TMB â‰¥10                         â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  Backend (oncology-backend)                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ NEW: POST /api/biomarkers/tmb                                           â”‚â”‚
â”‚  â”‚                                                                         â”‚â”‚
â”‚  â”‚ Request:                                                                â”‚â”‚
â”‚  â”‚ {                                                                       â”‚â”‚
â”‚  â”‚   "mutations": [                                                        â”‚â”‚
â”‚  â”‚     {"gene": "TP53", "variant_classification": "Missense_Mutation"},    â”‚â”‚
â”‚  â”‚     {"gene": "KRAS", "variant_classification": "Frame_Shift_Del"},      â”‚â”‚
â”‚  â”‚     ...                                                                 â”‚â”‚
â”‚  â”‚   ],                                                                    â”‚â”‚
â”‚  â”‚   "exome_size_mb": 38.0  // Optional                                    â”‚â”‚
â”‚  â”‚ }                                                                       â”‚â”‚
â”‚  â”‚                                                                         â”‚â”‚
â”‚  â”‚ Response:                                                               â”‚â”‚
â”‚  â”‚ {                                                                       â”‚â”‚
â”‚  â”‚   "tmb": 12.3,                                                          â”‚â”‚
â”‚  â”‚   "tmb_classification": "TMB-H",                                        â”‚â”‚
â”‚  â”‚   "io_eligible": true,                                                  â”‚â”‚
â”‚  â”‚   "nonsynonymous_count": 468,                                           â”‚â”‚
â”‚  â”‚   "validation": {                                                       â”‚â”‚
â”‚  â”‚     "pearson_r": 0.933,                                                 â”‚â”‚
â”‚  â”‚     "accuracy": 0.954,                                                  â”‚â”‚
â”‚  â”‚     "source": "TCGA Pan-Immune (n=1,895)"                               â”‚â”‚
â”‚  â”‚   },                                                                    â”‚â”‚
â”‚  â”‚   "mechanism_vector_update": {                                          â”‚â”‚
â”‚  â”‚     "io_pathway": 1.0                                                   â”‚â”‚
â”‚  â”‚   }                                                                     â”‚â”‚
â”‚  â”‚ }                                                                       â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Deliverables

### Phase 1: Backend API (2-3 hours)

#### 1.1 Create Biomarker Router

**Location**: `oncology-coPilot/oncology-backend/backend/api/biomarkers.py`

```python
from fastapi import APIRouter, HTTPException
from pydantic import BaseModel, Field
from typing import List, Optional, Dict, Any

router = APIRouter()

# Constants
TMB_HIGH_THRESHOLD = 10.0  # Mutations per Mb
TCGA_EXOME_SIZE_MB = 38.0

# Validated metrics from TCGA Pan-Immune validation
VALIDATION_METRICS = {
    "pearson_r": 0.933,
    "spearman_rho": 0.877,
    "accuracy": 0.954,
    "sensitivity": 0.960,
    "specificity": 0.952,
    "source": "TCGA Pan-Immune (n=1,895)",
    "ground_truth_file": "mutation-load_updated.txt"
}

NONSYNONYMOUS_CLASSIFICATIONS = {
    "Missense_Mutation", "Nonsense_Mutation", "Frame_Shift_Del",
    "Frame_Shift_Ins", "In_Frame_Del", "In_Frame_Ins",
    "Splice_Site", "Splice_Region", "Translation_Start_Site",
    "Nonstop_Mutation"
}

class MutationInput(BaseModel):
    gene: str
    variant_classification: str
    protein_change: Optional[str] = None
    hgvs_p: Optional[str] = None

class TMBRequest(BaseModel):
    mutations: List[MutationInput]
    exome_size_mb: Optional[float] = Field(default=TCGA_EXOME_SIZE_MB)

class TMBResponse(BaseModel):
    tmb: float
    tmb_classification: str
    io_eligible: bool
    nonsynonymous_count: int
    total_mutations: int
    exome_size_mb: float
    validation: Dict[str, Any]
    mechanism_vector_update: Dict[str, float]

def count_nonsynonymous_mutations(mutations: List[MutationInput]) -> int:
    """Count nonsynonymous mutations using validated methodology."""
    count = 0
    for mut in mutations:
        classification = mut.variant_classification.strip()
        protein_change = mut.protein_change or mut.hgvs_p or ""
        
        # Check MAF-style classifications
        if classification in NONSYNONYMOUS_CLASSIFICATIONS:
            count += 1
            continue
        
        # Handle simplified classifications (cBioPortal format)
        if protein_change and protein_change.strip():
            if "=" in protein_change:  # Silent mutation
                continue
            classification_upper = classification.upper()
            if classification_upper in ["SNP", "DEL", "INS", "ONP"]:
                count += 1
    
    return count

@router.post("/tmb", response_model=TMBResponse)
async def calculate_tmb(request: TMBRequest):
    """
    Calculate TMB from mutation list.
    
    Validated against TCGA Pan-Immune ground truth (r=0.933, 95.4% accuracy).
    """
    try:
        nonsynonymous_count = count_nonsynonymous_mutations(request.mutations)
        tmb = nonsynonymous_count / request.exome_size_mb
        tmb_classification = "TMB-H" if tmb >= TMB_HIGH_THRESHOLD else "TMB-L"
        io_eligible = tmb >= TMB_HIGH_THRESHOLD
        
        return TMBResponse(
            tmb=round(tmb, 2),
            tmb_classification=tmb_classification,
            io_eligible=io_eligible,
            nonsynonymous_count=nonsynonymous_count,
            total_mutations=len(request.mutations),
            exome_size_mb=request.exome_size_mb,
            validation=VALIDATION_METRICS,
            mechanism_vector_update={
                "io_pathway": 1.0 if io_eligible else 0.0
            }
        )
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"TMB calculation failed: {str(e)}")

@router.get("/tmb/validation")
async def get_tmb_validation_metrics():
    """Return TMB validation metrics for transparency."""
    return {
        "validation": VALIDATION_METRICS,
        "methodology": {
            "exome_size": "38 Mb (TCGA standard)",
            "threshold": "10 mut/Mb (FDA-approved pembrolizumab cutoff)",
            "classifications_counted": list(NONSYNONYMOUS_CLASSIFICATIONS)
        }
    }
```

#### 1.2 Register Router in main.py

**Location**: `oncology-coPilot/oncology-backend/main.py`

```python
# Add import
from backend.api import biomarkers as biomarkers_router

# Add router registration (near other router registrations)
app.include_router(biomarkers_router.router, prefix="/api/biomarkers", tags=["biomarkers"])
```

#### 1.3 Create TMB Calculator Service

**Location**: `oncology-coPilot/oncology-backend/backend/services/tmb_calculator.py`

```python
"""
TMB Calculator Service - Production Implementation

Validated against TCGA Pan-Immune ground truth:
- Pearson r: 0.933
- Classification accuracy: 95.4%
"""

from typing import List, Dict, Optional

NONSYNONYMOUS_CLASSIFICATIONS = {
    "Missense_Mutation", "Nonsense_Mutation", "Frame_Shift_Del",
    "Frame_Shift_Ins", "In_Frame_Del", "In_Frame_Ins",
    "Splice_Site", "Splice_Region", "Translation_Start_Site",
    "Nonstop_Mutation"
}

class TMBCalculator:
    def __init__(self, exome_size_mb: float = 38.0):
        self.exome_size_mb = exome_size_mb
        self.tmb_high_threshold = 10.0
        self.tmb_very_high_threshold = 20.0
    
    def count_nonsynonymous(self, mutations: List[Dict]) -> int:
        """Count nonsynonymous mutations."""
        count = 0
        for mut in mutations:
            classification = mut.get("variant_classification", "").strip()
            protein_change = mut.get("protein_change", "") or mut.get("hgvs_p", "")
            
            if classification in NONSYNONYMOUS_CLASSIFICATIONS:
                count += 1
                continue
            
            if protein_change and protein_change.strip() and "=" not in protein_change:
                if classification.upper() in ["SNP", "DEL", "INS", "ONP"]:
                    count += 1
        
        return count
    
    def calculate(self, mutations: List[Dict]) -> Dict:
        """Calculate TMB and return classification."""
        nonsynonymous_count = self.count_nonsynonymous(mutations)
        tmb = nonsynonymous_count / self.exome_size_mb
        
        if tmb >= self.tmb_very_high_threshold:
            classification = "TMB-Very-High"
        elif tmb >= self.tmb_high_threshold:
            classification = "TMB-H"
        else:
            classification = "TMB-L"
        
        return {
            "tmb": round(tmb, 2),
            "classification": classification,
            "io_eligible": tmb >= self.tmb_high_threshold,
            "nonsynonymous_count": nonsynonymous_count,
            "total_mutations": len(mutations),
            "exome_size_mb": self.exome_size_mb
        }
```

---

### Phase 2: Frontend Integration (2-3 hours)

#### 2.1 Create useTMBCalculation Hook

**Location**: `oncology-coPilot/oncology-frontend/src/hooks/useTMBCalculation.js`

```javascript
import { useState, useCallback } from 'react';
import { useApiClient } from './useApiClient';

/**
 * Hook for TMB calculation from mutations
 * Integrates with backend /api/biomarkers/tmb endpoint
 */
export const useTMBCalculation = () => {
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);
  const [result, setResult] = useState(null);
  const api = useApiClient();

  const calculateTMB = useCallback(async (mutations, exomeSizeMb = 38.0) => {
    setLoading(true);
    setError(null);
    
    try {
      const response = await api.post('/api/biomarkers/tmb', {
        mutations: mutations.map(m => ({
          gene: m.gene || m.Hugo_Symbol,
          variant_classification: m.variant_classification || m.Variant_Classification,
          protein_change: m.protein_change || m.HGVSp_Short,
          hgvs_p: m.hgvs_p
        })),
        exome_size_mb: exomeSizeMb
      });
      
      setResult(response.data);
      return response.data;
    } catch (err) {
      setError(err.message || 'TMB calculation failed');
      throw err;
    } finally {
      setLoading(false);
    }
  }, [api]);

  const reset = useCallback(() => {
    setResult(null);
    setError(null);
  }, []);

  return {
    calculateTMB,
    result,
    loading,
    error,
    reset,
    // Computed
    isIOEligible: result?.io_eligible || false,
    tmbClassification: result?.tmb_classification || null,
    validation: result?.validation || null
  };
};
```

#### 2.2 Create TMBValidationBadge Component

**Location**: `oncology-coPilot/oncology-frontend/src/components/sporadic/TMBValidationBadge.jsx`

```jsx
import React from 'react';
import { Chip, Tooltip, Box, Typography } from '@mui/material';
import VerifiedIcon from '@mui/icons-material/Verified';
import CalculateIcon from '@mui/icons-material/Calculate';

/**
 * TMBValidationBadge - Shows TMB calculation source and validation status
 * 
 * Props:
 * - tmbSource: "manual" | "calculated"
 * - validation: { pearson_r, accuracy, source } from API
 */
export default function TMBValidationBadge({ tmbSource, validation }) {
  if (tmbSource === 'manual') {
    return (
      <Chip
        icon={<CalculateIcon />}
        label="Manual Entry"
        size="small"
        variant="outlined"
        sx={{ fontSize: '0.7rem' }}
      />
    );
  }

  if (tmbSource === 'calculated' && validation) {
    return (
      <Tooltip
        title={
          <Box sx={{ p: 1 }}>
            <Typography variant="subtitle2" sx={{ fontWeight: 600, mb: 1 }}>
              ðŸ”¬ Validated TMB Calculation
            </Typography>
            <Typography variant="body2">
              Pearson r: {validation.pearson_r?.toFixed(3) || 'N/A'}
            </Typography>
            <Typography variant="body2">
              Accuracy: {((validation.accuracy || 0) * 100).toFixed(1)}%
            </Typography>
            <Typography variant="body2" sx={{ mt: 1, fontSize: '0.75rem', color: 'text.secondary' }}>
              Source: {validation.source}
            </Typography>
          </Box>
        }
      >
        <Chip
          icon={<VerifiedIcon />}
          label="Validated (r=0.93)"
          size="small"
          color="success"
          sx={{ fontSize: '0.7rem' }}
        />
      </Tooltip>
    );
  }

  return null;
}
```

#### 2.3 Update BiomarkerSummaryWidget

**Location**: `oncology-coPilot/oncology-frontend/src/components/sporadic/BiomarkerSummaryWidget.jsx`

Add TMB validation badge:

```jsx
// Import the new badge
import TMBValidationBadge from './TMBValidationBadge';

// In the TMB section, add:
<Box sx={{ minWidth: 150 }}>
  <Typography variant="caption" color="text.secondary" sx={{ display: 'block', mb: 0.5 }}>
    TMB (mutations/Mb)
  </Typography>
  <Stack direction="row" spacing={1} alignItems="center">
    <Chip
      label={tmb !== null && tmb !== undefined ? `${tmb.toFixed(1)} - ${tmbCategory.label}` : 'Unknown'}
      size="small"
      color={tmbCategory.color}
      sx={{ fontSize: '0.75rem' }}
    />
    <TMBValidationBadge 
      tmbSource={tumorContext?.tmb_source} 
      validation={tumorContext?.tmb_validation}
    />
  </Stack>
</Box>
```

#### 2.4 Create MutationUpload Component

**Location**: `oncology-coPilot/oncology-frontend/src/components/sporadic/MutationUpload.jsx`

```jsx
import React, { useState, useCallback } from 'react';
import { 
  Box, Button, Typography, Paper, CircularProgress,
  Alert, Stack, Chip
} from '@mui/material';
import CloudUploadIcon from '@mui/icons-material/CloudUpload';
import { useTMBCalculation } from '../../hooks/useTMBCalculation';
import { useSporadic } from '../../context/SporadicContext';

/**
 * MutationUpload - Upload VCF/MAF file for automatic TMB calculation
 */
export default function MutationUpload() {
  const [file, setFile] = useState(null);
  const [parsedMutations, setParsedMutations] = useState([]);
  const { calculateTMB, result, loading, error } = useTMBCalculation();
  const { updateTumorContext, tumorContext } = useSporadic();

  const handleFileChange = useCallback(async (event) => {
    const uploadedFile = event.target.files[0];
    if (!uploadedFile) return;
    
    setFile(uploadedFile);
    
    // Parse MAF/VCF file
    const text = await uploadedFile.text();
    const mutations = parseMAF(text); // Implement parser
    setParsedMutations(mutations);
    
    // Calculate TMB
    try {
      const tmbResult = await calculateTMB(mutations);
      
      // Update tumor context with calculated TMB
      updateTumorContext({
        ...tumorContext,
        tumor_context: {
          ...tumorContext,
          tmb: tmbResult.tmb,
          tmb_source: 'calculated',
          tmb_validation: tmbResult.validation,
          io_eligible: tmbResult.io_eligible
        }
      });
    } catch (err) {
      console.error('TMB calculation failed:', err);
    }
  }, [calculateTMB, updateTumorContext, tumorContext]);

  return (
    <Paper sx={{ p: 3, mb: 3 }}>
      <Typography variant="h6" gutterBottom>
        ðŸ§¬ Upload Mutation Data for TMB Calculation
      </Typography>
      
      <Typography variant="body2" color="text.secondary" sx={{ mb: 2 }}>
        Upload a MAF or VCF file to automatically calculate TMB.
        Validated against TCGA (r=0.93, 95.4% accuracy).
      </Typography>

      <Box sx={{ display: 'flex', alignItems: 'center', gap: 2 }}>
        <Button
          variant="outlined"
          component="label"
          startIcon={<CloudUploadIcon />}
          disabled={loading}
        >
          Upload MAF/VCF
          <input
            type="file"
            hidden
            accept=".maf,.vcf,.tsv"
            onChange={handleFileChange}
          />
        </Button>
        
        {loading && <CircularProgress size={24} />}
        
        {file && (
          <Typography variant="body2" color="text.secondary">
            {file.name} ({parsedMutations.length} mutations)
          </Typography>
        )}
      </Box>

      {error && (
        <Alert severity="error" sx={{ mt: 2 }}>
          {error}
        </Alert>
      )}

      {result && (
        <Alert severity="success" sx={{ mt: 2 }}>
          <Stack direction="row" spacing={2} alignItems="center">
            <Typography variant="body2">
              TMB: <strong>{result.tmb.toFixed(1)} mut/Mb</strong>
            </Typography>
            <Chip 
              label={result.tmb_classification} 
              color={result.io_eligible ? 'success' : 'default'}
              size="small"
            />
            {result.io_eligible && (
              <Chip label="IO Eligible" color="success" variant="outlined" size="small" />
            )}
          </Stack>
        </Alert>
      )}
    </Paper>
  );
}

// Simple MAF parser
function parseMAF(text) {
  const lines = text.split('\n');
  const mutations = [];
  let headers = [];
  
  for (const line of lines) {
    if (line.startsWith('#')) continue;
    if (line.startsWith('Hugo_Symbol') || line.startsWith('gene')) {
      headers = line.split('\t');
      continue;
    }
    
    const values = line.split('\t');
    if (values.length < 2) continue;
    
    const mutation = {};
    headers.forEach((h, i) => {
      mutation[h] = values[i];
    });
    
    mutations.push({
      gene: mutation.Hugo_Symbol || mutation.gene,
      variant_classification: mutation.Variant_Classification || mutation.variant_classification,
      protein_change: mutation.HGVSp_Short || mutation.protein_change
    });
  }
  
  return mutations;
}
```

#### 2.5 Update SporadicContext

**Location**: `oncology-coPilot/oncology-frontend/src/context/SporadicContext.jsx`

Add TMB-related fields:

```jsx
// Add to tumorContext state shape
const [tumorContext, setTumorContext] = useState({
  tmb: null,
  tmb_source: null,  // "manual" | "calculated"
  tmb_validation: null,  // { pearson_r, accuracy, source }
  io_eligible: false,
  msi_status: null,
  hrd_score: null,
  completeness_score: 0
});
```

---

### Phase 3: Integration & Testing (1-2 hours)

#### 3.1 Mechanism Vector Integration

**Location**: `oncology-coPilot/oncology-backend/backend/services/pathway_to_mechanism_vector.py`

Update to use validated TMB:

```python
def convert_pathway_scores_to_mechanism_vector(
    pathway_scores: Dict,
    tmb: Optional[float] = None,
    msi_status: Optional[str] = None
) -> List[float]:
    """
    Convert pathway scores to 7D mechanism vector.
    Uses validated TMB for IO pathway.
    """
    ddr = pathway_scores.get('ddr', 0.0)
    mapk = pathway_scores.get('mapk', 0.0)
    pi3k = pathway_scores.get('pi3k', 0.0)
    vegf = pathway_scores.get('vegf', 0.0)
    her2 = pathway_scores.get('her2', 0.0)
    efflux = pathway_scores.get('efflux', 0.0)
    
    # IO pathway from validated TMB calculation
    io_eligible_tmb = tmb is not None and tmb >= 10.0
    io_eligible_msi = msi_status in ['MSI-H', 'MSI-High']
    io_score = 1.0 if (io_eligible_tmb or io_eligible_msi) else 0.0
    
    return [ddr, mapk, pi3k, vegf, her2, io_score, efflux]
```

#### 3.2 Trial Matching Integration

**Location**: Update trial matching to boost IO trials for TMB-H patients

```python
# In trial ranking logic
if patient_tmb and patient_tmb >= 10.0:
    # Boost IO trials
    if trial_is_immunotherapy(trial):
        trial['io_boost'] = 1.5
        trial['io_eligibility_reason'] = f"TMB-H ({patient_tmb:.1f} mut/Mb) â†’ IO Eligible"
```

#### 3.3 Unit Tests

**Location**: `oncology-coPilot/oncology-backend/tests/test_biomarkers.py`

```python
import pytest
from backend.api.biomarkers import count_nonsynonymous_mutations, TMBRequest, MutationInput

def test_tmb_calculation_basic():
    """Test basic TMB calculation."""
    mutations = [
        MutationInput(gene="TP53", variant_classification="Missense_Mutation"),
        MutationInput(gene="KRAS", variant_classification="Frame_Shift_Del"),
    ]
    request = TMBRequest(mutations=mutations, exome_size_mb=38.0)
    
    count = count_nonsynonymous_mutations(mutations)
    assert count == 2
    
    tmb = count / request.exome_size_mb
    assert abs(tmb - 0.053) < 0.001

def test_tmb_high_classification():
    """Test TMB-H classification at threshold."""
    # 380 mutations / 38 Mb = 10.0 mut/Mb = TMB-H
    mutations = [
        MutationInput(gene=f"GENE{i}", variant_classification="Missense_Mutation")
        for i in range(380)
    ]
    
    count = count_nonsynonymous_mutations(mutations)
    tmb = count / 38.0
    
    assert tmb >= 10.0
    assert "TMB-H" == ("TMB-H" if tmb >= 10.0 else "TMB-L")

def test_silent_mutations_excluded():
    """Test that silent mutations are excluded."""
    mutations = [
        MutationInput(gene="TP53", variant_classification="Silent"),
        MutationInput(gene="KRAS", variant_classification="Missense_Mutation"),
    ]
    
    count = count_nonsynonymous_mutations(mutations)
    assert count == 1  # Only the missense mutation
```

---

## Implementation Checklist

### Backend
- [ ] Create `backend/api/biomarkers.py` with TMB endpoint
- [ ] Create `backend/services/tmb_calculator.py` service
- [ ] Register biomarkers router in `main.py`
- [ ] Add validation metrics constant
- [ ] Write unit tests for TMB calculation
- [ ] Update pathway_to_mechanism_vector.py with TMB integration

### Frontend
- [ ] Create `hooks/useTMBCalculation.js`
- [ ] Create `components/sporadic/TMBValidationBadge.jsx`
- [ ] Create `components/sporadic/MutationUpload.jsx`
- [ ] Update `BiomarkerSummaryWidget.jsx` with validation badge
- [ ] Update `SporadicContext.jsx` with TMB fields
- [ ] Add MAF/VCF parser utility

### Integration
- [ ] Update trial matching to use TMB
- [ ] Update mechanism vector generation
- [ ] End-to-end test: Upload â†’ Calculate â†’ Display â†’ Trial Matching

### Documentation
- [ ] API documentation for /api/biomarkers/tmb
- [ ] Update README with TMB feature
- [ ] Add validation methodology documentation

---

## Files to Create

| File | Type | Description |
|------|------|-------------|
| `backend/api/biomarkers.py` | Backend | TMB API endpoint |
| `backend/services/tmb_calculator.py` | Backend | TMB calculation service |
| `tests/test_biomarkers.py` | Backend | Unit tests |
| `src/hooks/useTMBCalculation.js` | Frontend | TMB calculation hook |
| `src/components/sporadic/TMBValidationBadge.jsx` | Frontend | Validation badge component |
| `src/components/sporadic/MutationUpload.jsx` | Frontend | File upload component |

## Files to Modify

| File | Type | Changes |
|------|------|---------|
| `main.py` | Backend | Add biomarkers router |
| `pathway_to_mechanism_vector.py` | Backend | Add TMB parameter |
| `BiomarkerSummaryWidget.jsx` | Frontend | Add validation badge |
| `SporadicContext.jsx` | Frontend | Add TMB fields |

---

## Acceptance Criteria

- [ ] POST /api/biomarkers/tmb returns correct TMB for test mutations
- [ ] TMB classification matches ground truth (r > 0.90)
- [ ] Frontend displays TMB with validation badge
- [ ] File upload calculates TMB automatically
- [ ] IO eligibility updates mechanism vector
- [ ] Trial matching prioritizes IO trials for TMB-H patients
- [ ] All unit tests pass

---

## Success Metrics

| Metric | Target | Validation |
|--------|--------|------------|
| TMB Correlation | r > 0.90 | Against TCGA ground truth |
| Classification Accuracy | > 95% | TMB-H/TMB-L classification |
| API Response Time | < 500ms | For 200 mutations |
| Frontend Load Time | < 2s | With TMB calculation |
| Test Coverage | > 80% | Backend tests |

---

## Notes for Agent

1. **Backend is in main repo**: `/Users/fahadkiani/Desktop/development/crispr-assistant-main/oncology-coPilot/oncology-backend/`
2. **Frontend is in main repo**: `/Users/fahadkiani/Desktop/development/crispr-assistant-main/oncology-coPilot/oncology-frontend/`
3. **Use existing patterns**: Follow existing router structure (oracle.py, forge.py)
4. **Validation is key**: Always show r=0.933, 95.4% accuracy prominently
5. **Test with real data**: Use TCGA mutations for validation

---
---

## Mission Objective

Build TMB (Tumor Mutational Burden) prediction as a **production-ready feature** integrated across the full stack: backend API â†’ frontend UI â†’ clinical workflow.

---

## Architecture Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           TMB PREDICTION FLOW                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  Frontend (oncology-frontend)                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ TumorQuickIntake.jsx    â”‚ OR â”‚ NGS Upload Component                    â”‚ â”‚
â”‚  â”‚ (Manual TMB entry)      â”‚    â”‚ (Upload VCF/MAF â†’ Auto-calculate TMB)   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚               â”‚                                     â”‚                       â”‚
â”‚               â–¼                                     â–¼                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                    SporadicContext (tumorContext)                       â”‚â”‚
â”‚  â”‚  {                                                                      â”‚â”‚
â”‚  â”‚    tmb: 12.3,                    // â† Calculated value                  â”‚â”‚
â”‚  â”‚    tmb_source: "calculated",     // â† NEW: "manual" | "calculated"      â”‚â”‚
â”‚  â”‚    tmb_validation: {             // â† NEW: Validation metadata          â”‚â”‚
â”‚  â”‚      correlation: 0.933,                                                â”‚â”‚
â”‚  â”‚      accuracy: 0.954,                                                   â”‚â”‚
â”‚  â”‚      source: "TCGA Pan-Immune"                                          â”‚â”‚
â”‚  â”‚    },                                                                   â”‚â”‚
â”‚  â”‚    io_eligible: true,            // â† NEW: TMB â‰¥10 â†’ IO eligible        â”‚â”‚
â”‚  â”‚    msi_status: "MSS",                                                   â”‚â”‚
â”‚  â”‚    hrd_score: 42.0                                                      â”‚â”‚
â”‚  â”‚  }                                                                      â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚               â”‚                                                             â”‚
â”‚               â–¼                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ BiomarkerSummaryWidget.jsx                                              â”‚â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚â”‚
â”‚  â”‚ â”‚ TMB: 12.3 mut/Mb â”‚ â”‚ MSI: MSS         â”‚ â”‚ HRD: 42.0        â”‚         â”‚â”‚
â”‚  â”‚ â”‚ âœ“ TMB-H (â‰¥10)    â”‚ â”‚ âœ— Not MSI-H      â”‚ â”‚ âœ“ HRD-High       â”‚         â”‚â”‚
â”‚  â”‚ â”‚ ðŸ“Š Validated     â”‚ â”‚                  â”‚ â”‚                  â”‚         â”‚â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚               â”‚                                                             â”‚
â”‚               â–¼                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ Trial Matching & IO Eligibility                                         â”‚â”‚
â”‚  â”‚ - IO trials boosted for TMB-H patients                                  â”‚â”‚
â”‚  â”‚ - Mechanism vector: IO pathway = 1.0 if TMB â‰¥10                         â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  Backend (oncology-backend)                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ NEW: POST /api/biomarkers/tmb                                           â”‚â”‚
â”‚  â”‚                                                                         â”‚â”‚
â”‚  â”‚ Request:                                                                â”‚â”‚
â”‚  â”‚ {                                                                       â”‚â”‚
â”‚  â”‚   "mutations": [                                                        â”‚â”‚
â”‚  â”‚     {"gene": "TP53", "variant_classification": "Missense_Mutation"},    â”‚â”‚
â”‚  â”‚     {"gene": "KRAS", "variant_classification": "Frame_Shift_Del"},      â”‚â”‚
â”‚  â”‚     ...                                                                 â”‚â”‚
â”‚  â”‚   ],                                                                    â”‚â”‚
â”‚  â”‚   "exome_size_mb": 38.0  // Optional                                    â”‚â”‚
â”‚  â”‚ }                                                                       â”‚â”‚
â”‚  â”‚                                                                         â”‚â”‚
â”‚  â”‚ Response:                                                               â”‚â”‚
â”‚  â”‚ {                                                                       â”‚â”‚
â”‚  â”‚   "tmb": 12.3,                                                          â”‚â”‚
â”‚  â”‚   "tmb_classification": "TMB-H",                                        â”‚â”‚
â”‚  â”‚   "io_eligible": true,                                                  â”‚â”‚
â”‚  â”‚   "nonsynonymous_count": 468,                                           â”‚â”‚
â”‚  â”‚   "validation": {                                                       â”‚â”‚
â”‚  â”‚     "pearson_r": 0.933,                                                 â”‚â”‚
â”‚  â”‚     "accuracy": 0.954,                                                  â”‚â”‚
â”‚  â”‚     "source": "TCGA Pan-Immune (n=1,895)"                               â”‚â”‚
â”‚  â”‚   },                                                                    â”‚â”‚
â”‚  â”‚   "mechanism_vector_update": {                                          â”‚â”‚
â”‚  â”‚     "io_pathway": 1.0                                                   â”‚â”‚
â”‚  â”‚   }                                                                     â”‚â”‚
â”‚  â”‚ }                                                                       â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Deliverables

### Phase 1: Backend API (2-3 hours)

#### 1.1 Create Biomarker Router

**Location**: `oncology-coPilot/oncology-backend/backend/api/biomarkers.py`

```python
from fastapi import APIRouter, HTTPException
from pydantic import BaseModel, Field
from typing import List, Optional, Dict, Any

router = APIRouter()

# Constants
TMB_HIGH_THRESHOLD = 10.0  # Mutations per Mb
TCGA_EXOME_SIZE_MB = 38.0

# Validated metrics from TCGA Pan-Immune validation
VALIDATION_METRICS = {
    "pearson_r": 0.933,
    "spearman_rho": 0.877,
    "accuracy": 0.954,
    "sensitivity": 0.960,
    "specificity": 0.952,
    "source": "TCGA Pan-Immune (n=1,895)",
    "ground_truth_file": "mutation-load_updated.txt"
}

NONSYNONYMOUS_CLASSIFICATIONS = {
    "Missense_Mutation", "Nonsense_Mutation", "Frame_Shift_Del",
    "Frame_Shift_Ins", "In_Frame_Del", "In_Frame_Ins",
    "Splice_Site", "Splice_Region", "Translation_Start_Site",
    "Nonstop_Mutation"
}

class MutationInput(BaseModel):
    gene: str
    variant_classification: str
    protein_change: Optional[str] = None
    hgvs_p: Optional[str] = None

class TMBRequest(BaseModel):
    mutations: List[MutationInput]
    exome_size_mb: Optional[float] = Field(default=TCGA_EXOME_SIZE_MB)

class TMBResponse(BaseModel):
    tmb: float
    tmb_classification: str
    io_eligible: bool
    nonsynonymous_count: int
    total_mutations: int
    exome_size_mb: float
    validation: Dict[str, Any]
    mechanism_vector_update: Dict[str, float]

def count_nonsynonymous_mutations(mutations: List[MutationInput]) -> int:
    """Count nonsynonymous mutations using validated methodology."""
    count = 0
    for mut in mutations:
        classification = mut.variant_classification.strip()
        protein_change = mut.protein_change or mut.hgvs_p or ""
        
        # Check MAF-style classifications
        if classification in NONSYNONYMOUS_CLASSIFICATIONS:
            count += 1
            continue
        
        # Handle simplified classifications (cBioPortal format)
        if protein_change and protein_change.strip():
            if "=" in protein_change:  # Silent mutation
                continue
            classification_upper = classification.upper()
            if classification_upper in ["SNP", "DEL", "INS", "ONP"]:
                count += 1
    
    return count

@router.post("/tmb", response_model=TMBResponse)
async def calculate_tmb(request: TMBRequest):
    """
    Calculate TMB from mutation list.
    
    Validated against TCGA Pan-Immune ground truth (r=0.933, 95.4% accuracy).
    """
    try:
        nonsynonymous_count = count_nonsynonymous_mutations(request.mutations)
        tmb = nonsynonymous_count / request.exome_size_mb
        tmb_classification = "TMB-H" if tmb >= TMB_HIGH_THRESHOLD else "TMB-L"
        io_eligible = tmb >= TMB_HIGH_THRESHOLD
        
        return TMBResponse(
            tmb=round(tmb, 2),
            tmb_classification=tmb_classification,
            io_eligible=io_eligible,
            nonsynonymous_count=nonsynonymous_count,
            total_mutations=len(request.mutations),
            exome_size_mb=request.exome_size_mb,
            validation=VALIDATION_METRICS,
            mechanism_vector_update={
                "io_pathway": 1.0 if io_eligible else 0.0
            }
        )
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"TMB calculation failed: {str(e)}")

@router.get("/tmb/validation")
async def get_tmb_validation_metrics():
    """Return TMB validation metrics for transparency."""
    return {
        "validation": VALIDATION_METRICS,
        "methodology": {
            "exome_size": "38 Mb (TCGA standard)",
            "threshold": "10 mut/Mb (FDA-approved pembrolizumab cutoff)",
            "classifications_counted": list(NONSYNONYMOUS_CLASSIFICATIONS)
        }
    }
```

#### 1.2 Register Router in main.py

**Location**: `oncology-coPilot/oncology-backend/main.py`

```python
# Add import
from backend.api import biomarkers as biomarkers_router

# Add router registration (near other router registrations)
app.include_router(biomarkers_router.router, prefix="/api/biomarkers", tags=["biomarkers"])
```

#### 1.3 Create TMB Calculator Service

**Location**: `oncology-coPilot/oncology-backend/backend/services/tmb_calculator.py`

```python
"""
TMB Calculator Service - Production Implementation

Validated against TCGA Pan-Immune ground truth:
- Pearson r: 0.933
- Classification accuracy: 95.4%
"""

from typing import List, Dict, Optional

NONSYNONYMOUS_CLASSIFICATIONS = {
    "Missense_Mutation", "Nonsense_Mutation", "Frame_Shift_Del",
    "Frame_Shift_Ins", "In_Frame_Del", "In_Frame_Ins",
    "Splice_Site", "Splice_Region", "Translation_Start_Site",
    "Nonstop_Mutation"
}

class TMBCalculator:
    def __init__(self, exome_size_mb: float = 38.0):
        self.exome_size_mb = exome_size_mb
        self.tmb_high_threshold = 10.0
        self.tmb_very_high_threshold = 20.0
    
    def count_nonsynonymous(self, mutations: List[Dict]) -> int:
        """Count nonsynonymous mutations."""
        count = 0
        for mut in mutations:
            classification = mut.get("variant_classification", "").strip()
            protein_change = mut.get("protein_change", "") or mut.get("hgvs_p", "")
            
            if classification in NONSYNONYMOUS_CLASSIFICATIONS:
                count += 1
                continue
            
            if protein_change and protein_change.strip() and "=" not in protein_change:
                if classification.upper() in ["SNP", "DEL", "INS", "ONP"]:
                    count += 1
        
        return count
    
    def calculate(self, mutations: List[Dict]) -> Dict:
        """Calculate TMB and return classification."""
        nonsynonymous_count = self.count_nonsynonymous(mutations)
        tmb = nonsynonymous_count / self.exome_size_mb
        
        if tmb >= self.tmb_very_high_threshold:
            classification = "TMB-Very-High"
        elif tmb >= self.tmb_high_threshold:
            classification = "TMB-H"
        else:
            classification = "TMB-L"
        
        return {
            "tmb": round(tmb, 2),
            "classification": classification,
            "io_eligible": tmb >= self.tmb_high_threshold,
            "nonsynonymous_count": nonsynonymous_count,
            "total_mutations": len(mutations),
            "exome_size_mb": self.exome_size_mb
        }
```

---

### Phase 2: Frontend Integration (2-3 hours)

#### 2.1 Create useTMBCalculation Hook

**Location**: `oncology-coPilot/oncology-frontend/src/hooks/useTMBCalculation.js`

```javascript
import { useState, useCallback } from 'react';
import { useApiClient } from './useApiClient';

/**
 * Hook for TMB calculation from mutations
 * Integrates with backend /api/biomarkers/tmb endpoint
 */
export const useTMBCalculation = () => {
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);
  const [result, setResult] = useState(null);
  const api = useApiClient();

  const calculateTMB = useCallback(async (mutations, exomeSizeMb = 38.0) => {
    setLoading(true);
    setError(null);
    
    try {
      const response = await api.post('/api/biomarkers/tmb', {
        mutations: mutations.map(m => ({
          gene: m.gene || m.Hugo_Symbol,
          variant_classification: m.variant_classification || m.Variant_Classification,
          protein_change: m.protein_change || m.HGVSp_Short,
          hgvs_p: m.hgvs_p
        })),
        exome_size_mb: exomeSizeMb
      });
      
      setResult(response.data);
      return response.data;
    } catch (err) {
      setError(err.message || 'TMB calculation failed');
      throw err;
    } finally {
      setLoading(false);
    }
  }, [api]);

  const reset = useCallback(() => {
    setResult(null);
    setError(null);
  }, []);

  return {
    calculateTMB,
    result,
    loading,
    error,
    reset,
    // Computed
    isIOEligible: result?.io_eligible || false,
    tmbClassification: result?.tmb_classification || null,
    validation: result?.validation || null
  };
};
```

#### 2.2 Create TMBValidationBadge Component

**Location**: `oncology-coPilot/oncology-frontend/src/components/sporadic/TMBValidationBadge.jsx`

```jsx
import React from 'react';
import { Chip, Tooltip, Box, Typography } from '@mui/material';
import VerifiedIcon from '@mui/icons-material/Verified';
import CalculateIcon from '@mui/icons-material/Calculate';

/**
 * TMBValidationBadge - Shows TMB calculation source and validation status
 * 
 * Props:
 * - tmbSource: "manual" | "calculated"
 * - validation: { pearson_r, accuracy, source } from API
 */
export default function TMBValidationBadge({ tmbSource, validation }) {
  if (tmbSource === 'manual') {
    return (
      <Chip
        icon={<CalculateIcon />}
        label="Manual Entry"
        size="small"
        variant="outlined"
        sx={{ fontSize: '0.7rem' }}
      />
    );
  }

  if (tmbSource === 'calculated' && validation) {
    return (
      <Tooltip
        title={
          <Box sx={{ p: 1 }}>
            <Typography variant="subtitle2" sx={{ fontWeight: 600, mb: 1 }}>
              ðŸ”¬ Validated TMB Calculation
            </Typography>
            <Typography variant="body2">
              Pearson r: {validation.pearson_r?.toFixed(3) || 'N/A'}
            </Typography>
            <Typography variant="body2">
              Accuracy: {((validation.accuracy || 0) * 100).toFixed(1)}%
            </Typography>
            <Typography variant="body2" sx={{ mt: 1, fontSize: '0.75rem', color: 'text.secondary' }}>
              Source: {validation.source}
            </Typography>
          </Box>
        }
      >
        <Chip
          icon={<VerifiedIcon />}
          label="Validated (r=0.93)"
          size="small"
          color="success"
          sx={{ fontSize: '0.7rem' }}
        />
      </Tooltip>
    );
  }

  return null;
}
```

#### 2.3 Update BiomarkerSummaryWidget

**Location**: `oncology-coPilot/oncology-frontend/src/components/sporadic/BiomarkerSummaryWidget.jsx`

Add TMB validation badge:

```jsx
// Import the new badge
import TMBValidationBadge from './TMBValidationBadge';

// In the TMB section, add:
<Box sx={{ minWidth: 150 }}>
  <Typography variant="caption" color="text.secondary" sx={{ display: 'block', mb: 0.5 }}>
    TMB (mutations/Mb)
  </Typography>
  <Stack direction="row" spacing={1} alignItems="center">
    <Chip
      label={tmb !== null && tmb !== undefined ? `${tmb.toFixed(1)} - ${tmbCategory.label}` : 'Unknown'}
      size="small"
      color={tmbCategory.color}
      sx={{ fontSize: '0.75rem' }}
    />
    <TMBValidationBadge 
      tmbSource={tumorContext?.tmb_source} 
      validation={tumorContext?.tmb_validation}
    />
  </Stack>
</Box>
```

#### 2.4 Create MutationUpload Component

**Location**: `oncology-coPilot/oncology-frontend/src/components/sporadic/MutationUpload.jsx`

```jsx
import React, { useState, useCallback } from 'react';
import { 
  Box, Button, Typography, Paper, CircularProgress,
  Alert, Stack, Chip
} from '@mui/material';
import CloudUploadIcon from '@mui/icons-material/CloudUpload';
import { useTMBCalculation } from '../../hooks/useTMBCalculation';
import { useSporadic } from '../../context/SporadicContext';

/**
 * MutationUpload - Upload VCF/MAF file for automatic TMB calculation
 */
export default function MutationUpload() {
  const [file, setFile] = useState(null);
  const [parsedMutations, setParsedMutations] = useState([]);
  const { calculateTMB, result, loading, error } = useTMBCalculation();
  const { updateTumorContext, tumorContext } = useSporadic();

  const handleFileChange = useCallback(async (event) => {
    const uploadedFile = event.target.files[0];
    if (!uploadedFile) return;
    
    setFile(uploadedFile);
    
    // Parse MAF/VCF file
    const text = await uploadedFile.text();
    const mutations = parseMAF(text); // Implement parser
    setParsedMutations(mutations);
    
    // Calculate TMB
    try {
      const tmbResult = await calculateTMB(mutations);
      
      // Update tumor context with calculated TMB
      updateTumorContext({
        ...tumorContext,
        tumor_context: {
          ...tumorContext,
          tmb: tmbResult.tmb,
          tmb_source: 'calculated',
          tmb_validation: tmbResult.validation,
          io_eligible: tmbResult.io_eligible
        }
      });
    } catch (err) {
      console.error('TMB calculation failed:', err);
    }
  }, [calculateTMB, updateTumorContext, tumorContext]);

  return (
    <Paper sx={{ p: 3, mb: 3 }}>
      <Typography variant="h6" gutterBottom>
        ðŸ§¬ Upload Mutation Data for TMB Calculation
      </Typography>
      
      <Typography variant="body2" color="text.secondary" sx={{ mb: 2 }}>
        Upload a MAF or VCF file to automatically calculate TMB.
        Validated against TCGA (r=0.93, 95.4% accuracy).
      </Typography>

      <Box sx={{ display: 'flex', alignItems: 'center', gap: 2 }}>
        <Button
          variant="outlined"
          component="label"
          startIcon={<CloudUploadIcon />}
          disabled={loading}
        >
          Upload MAF/VCF
          <input
            type="file"
            hidden
            accept=".maf,.vcf,.tsv"
            onChange={handleFileChange}
          />
        </Button>
        
        {loading && <CircularProgress size={24} />}
        
        {file && (
          <Typography variant="body2" color="text.secondary">
            {file.name} ({parsedMutations.length} mutations)
          </Typography>
        )}
      </Box>

      {error && (
        <Alert severity="error" sx={{ mt: 2 }}>
          {error}
        </Alert>
      )}

      {result && (
        <Alert severity="success" sx={{ mt: 2 }}>
          <Stack direction="row" spacing={2} alignItems="center">
            <Typography variant="body2">
              TMB: <strong>{result.tmb.toFixed(1)} mut/Mb</strong>
            </Typography>
            <Chip 
              label={result.tmb_classification} 
              color={result.io_eligible ? 'success' : 'default'}
              size="small"
            />
            {result.io_eligible && (
              <Chip label="IO Eligible" color="success" variant="outlined" size="small" />
            )}
          </Stack>
        </Alert>
      )}
    </Paper>
  );
}

// Simple MAF parser
function parseMAF(text) {
  const lines = text.split('\n');
  const mutations = [];
  let headers = [];
  
  for (const line of lines) {
    if (line.startsWith('#')) continue;
    if (line.startsWith('Hugo_Symbol') || line.startsWith('gene')) {
      headers = line.split('\t');
      continue;
    }
    
    const values = line.split('\t');
    if (values.length < 2) continue;
    
    const mutation = {};
    headers.forEach((h, i) => {
      mutation[h] = values[i];
    });
    
    mutations.push({
      gene: mutation.Hugo_Symbol || mutation.gene,
      variant_classification: mutation.Variant_Classification || mutation.variant_classification,
      protein_change: mutation.HGVSp_Short || mutation.protein_change
    });
  }
  
  return mutations;
}
```

#### 2.5 Update SporadicContext

**Location**: `oncology-coPilot/oncology-frontend/src/context/SporadicContext.jsx`

Add TMB-related fields:

```jsx
// Add to tumorContext state shape
const [tumorContext, setTumorContext] = useState({
  tmb: null,
  tmb_source: null,  // "manual" | "calculated"
  tmb_validation: null,  // { pearson_r, accuracy, source }
  io_eligible: false,
  msi_status: null,
  hrd_score: null,
  completeness_score: 0
});
```

---

### Phase 3: Integration & Testing (1-2 hours)

#### 3.1 Mechanism Vector Integration

**Location**: `oncology-coPilot/oncology-backend/backend/services/pathway_to_mechanism_vector.py`

Update to use validated TMB:

```python
def convert_pathway_scores_to_mechanism_vector(
    pathway_scores: Dict,
    tmb: Optional[float] = None,
    msi_status: Optional[str] = None
) -> List[float]:
    """
    Convert pathway scores to 7D mechanism vector.
    Uses validated TMB for IO pathway.
    """
    ddr = pathway_scores.get('ddr', 0.0)
    mapk = pathway_scores.get('mapk', 0.0)
    pi3k = pathway_scores.get('pi3k', 0.0)
    vegf = pathway_scores.get('vegf', 0.0)
    her2 = pathway_scores.get('her2', 0.0)
    efflux = pathway_scores.get('efflux', 0.0)
    
    # IO pathway from validated TMB calculation
    io_eligible_tmb = tmb is not None and tmb >= 10.0
    io_eligible_msi = msi_status in ['MSI-H', 'MSI-High']
    io_score = 1.0 if (io_eligible_tmb or io_eligible_msi) else 0.0
    
    return [ddr, mapk, pi3k, vegf, her2, io_score, efflux]
```

#### 3.2 Trial Matching Integration

**Location**: Update trial matching to boost IO trials for TMB-H patients

```python
# In trial ranking logic
if patient_tmb and patient_tmb >= 10.0:
    # Boost IO trials
    if trial_is_immunotherapy(trial):
        trial['io_boost'] = 1.5
        trial['io_eligibility_reason'] = f"TMB-H ({patient_tmb:.1f} mut/Mb) â†’ IO Eligible"
```

#### 3.3 Unit Tests

**Location**: `oncology-coPilot/oncology-backend/tests/test_biomarkers.py`

```python
import pytest
from backend.api.biomarkers import count_nonsynonymous_mutations, TMBRequest, MutationInput

def test_tmb_calculation_basic():
    """Test basic TMB calculation."""
    mutations = [
        MutationInput(gene="TP53", variant_classification="Missense_Mutation"),
        MutationInput(gene="KRAS", variant_classification="Frame_Shift_Del"),
    ]
    request = TMBRequest(mutations=mutations, exome_size_mb=38.0)
    
    count = count_nonsynonymous_mutations(mutations)
    assert count == 2
    
    tmb = count / request.exome_size_mb
    assert abs(tmb - 0.053) < 0.001

def test_tmb_high_classification():
    """Test TMB-H classification at threshold."""
    # 380 mutations / 38 Mb = 10.0 mut/Mb = TMB-H
    mutations = [
        MutationInput(gene=f"GENE{i}", variant_classification="Missense_Mutation")
        for i in range(380)
    ]
    
    count = count_nonsynonymous_mutations(mutations)
    tmb = count / 38.0
    
    assert tmb >= 10.0
    assert "TMB-H" == ("TMB-H" if tmb >= 10.0 else "TMB-L")

def test_silent_mutations_excluded():
    """Test that silent mutations are excluded."""
    mutations = [
        MutationInput(gene="TP53", variant_classification="Silent"),
        MutationInput(gene="KRAS", variant_classification="Missense_Mutation"),
    ]
    
    count = count_nonsynonymous_mutations(mutations)
    assert count == 1  # Only the missense mutation
```

---

## Implementation Checklist

### Backend
- [ ] Create `backend/api/biomarkers.py` with TMB endpoint
- [ ] Create `backend/services/tmb_calculator.py` service
- [ ] Register biomarkers router in `main.py`
- [ ] Add validation metrics constant
- [ ] Write unit tests for TMB calculation
- [ ] Update pathway_to_mechanism_vector.py with TMB integration

### Frontend
- [ ] Create `hooks/useTMBCalculation.js`
- [ ] Create `components/sporadic/TMBValidationBadge.jsx`
- [ ] Create `components/sporadic/MutationUpload.jsx`
- [ ] Update `BiomarkerSummaryWidget.jsx` with validation badge
- [ ] Update `SporadicContext.jsx` with TMB fields
- [ ] Add MAF/VCF parser utility

### Integration
- [ ] Update trial matching to use TMB
- [ ] Update mechanism vector generation
- [ ] End-to-end test: Upload â†’ Calculate â†’ Display â†’ Trial Matching

### Documentation
- [ ] API documentation for /api/biomarkers/tmb
- [ ] Update README with TMB feature
- [ ] Add validation methodology documentation

---

## Files to Create

| File | Type | Description |
|------|------|-------------|
| `backend/api/biomarkers.py` | Backend | TMB API endpoint |
| `backend/services/tmb_calculator.py` | Backend | TMB calculation service |
| `tests/test_biomarkers.py` | Backend | Unit tests |
| `src/hooks/useTMBCalculation.js` | Frontend | TMB calculation hook |
| `src/components/sporadic/TMBValidationBadge.jsx` | Frontend | Validation badge component |
| `src/components/sporadic/MutationUpload.jsx` | Frontend | File upload component |

## Files to Modify

| File | Type | Changes |
|------|------|---------|
| `main.py` | Backend | Add biomarkers router |
| `pathway_to_mechanism_vector.py` | Backend | Add TMB parameter |
| `BiomarkerSummaryWidget.jsx` | Frontend | Add validation badge |
| `SporadicContext.jsx` | Frontend | Add TMB fields |

---

## Acceptance Criteria

- [ ] POST /api/biomarkers/tmb returns correct TMB for test mutations
- [ ] TMB classification matches ground truth (r > 0.90)
- [ ] Frontend displays TMB with validation badge
- [ ] File upload calculates TMB automatically
- [ ] IO eligibility updates mechanism vector
- [ ] Trial matching prioritizes IO trials for TMB-H patients
- [ ] All unit tests pass

---

## Success Metrics

| Metric | Target | Validation |
|--------|--------|------------|
| TMB Correlation | r > 0.90 | Against TCGA ground truth |
| Classification Accuracy | > 95% | TMB-H/TMB-L classification |
| API Response Time | < 500ms | For 200 mutations |
| Frontend Load Time | < 2s | With TMB calculation |
| Test Coverage | > 80% | Backend tests |

---

## Notes for Agent

1. **Backend is in main repo**: `/Users/fahadkiani/Desktop/development/crispr-assistant-main/oncology-coPilot/oncology-backend/`
2. **Frontend is in main repo**: `/Users/fahadkiani/Desktop/development/crispr-assistant-main/oncology-coPilot/oncology-frontend/`
3. **Use existing patterns**: Follow existing router structure (oracle.py, forge.py)
4. **Validation is key**: Always show r=0.933, 95.4% accuracy prominently
5. **Test with real data**: Use TCGA mutations for validation

---