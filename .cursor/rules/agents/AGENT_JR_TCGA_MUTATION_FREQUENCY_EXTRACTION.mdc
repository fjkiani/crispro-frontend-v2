# ‚öîÔ∏è AGENT JR MISSION: TCGA MUTATION FREQUENCY EXTRACTION ‚öîÔ∏è

**Mission**: Extract real mutation frequencies from TCGA/cBioPortal for top 10 cancers to replace estimated pathway weights in `universal_disease_pathway_database.json`

**Timeline**: 2-3 hours  
**Priority**: P1 (needed for Universal Hypothesis Testing accuracy)  
**Commander**: Alpha  
**Assigned To**: Agent Jr

---

## üéØ **OBJECTIVE**

Replace estimated pathway weights (0.60-0.98) in `universal_disease_pathway_database.json` with **REAL** mutation frequencies from TCGA/cBioPortal data.

**Current Problem**: Weights like `"her2_signaling": {"weight": 0.95}` are estimates, not empirical data.

**Target Output**: Real frequencies like `"her2_signaling": {"weight": 0.20, "source": "TCGA (20% ERBB2 amplified, n=1084)"}`

---

## üìã **TOP 10 CANCERS TO EXTRACT**

| Cancer Type | cBioPortal Study ID | Expected Samples |
|------------|---------------------|------------------|
| 1. Ovarian Cancer | `ov_tcga_pan_can_atlas_2018` | ~500 |
| 2. Breast Cancer | `brca_tcga_pan_can_atlas_2018` | 1,084 |
| 3. Lung Cancer (NSCLC) | `luad_tcga_pan_can_atlas_2018` | ~500 |
| 4. Colorectal Cancer | `coadread_tcga_pan_can_atlas_2018` | ~600 |
| 5. Melanoma | `skcm_tcga_pan_can_atlas_2018` | ~470 |
| 6. Prostate Cancer | `prad_tcga_pan_can_atlas_2018` | ~500 |
| 7. Pancreatic Cancer | `paad_tcga_pan_can_atlas_2018` | ~180 |
| 8. Glioblastoma | `gbm_tcga_pan_can_atlas_2018` | ~150 |
| 9. Multiple Myeloma | `mmrf_commpass` | ~995 |
| 10. Leukemia (AML) | `laml_tcga_pan_can_atlas_2018` | ~200 |

---

## üîß **TOOLS YOU ALREADY HAVE**

### **Existing Script (REUSE THIS)**:
- **Location**: `oncology-coPilot/oncology-backend-minimal/scripts/yale_tdzd/extract_tcga_brca.py`
- **What it does**: Extracts mutations from TCGA via cBioPortal API
- **Your task**: Adapt it for 10 cancer types

### **Key Functions to Reuse**:
```python
def extract_mutations(study_id: str, genes: List[str]) -> pd.DataFrame:
    """Extract somatic mutations for target genes"""
    # This function already works - just call it for each study
```

---

## üìù **EXECUTION PLAN**

### **Step 1: Create Gene-to-Pathway Mapping (30 min)**

**Create**: `scripts/tcga_extraction/gene_pathway_mappings.json`

```json
{
  "breast_cancer": {
    "pathways": {
      "her2_signaling": {
        "genes": ["ERBB2"],
        "alteration_types": ["amplification", "mutation"]
      },
      "er_pr_signaling": {
        "genes": ["ESR1", "PGR"],
        "alteration_types": ["mutation", "expression"]
      },
      "pi3k_akt_mtor": {
        "genes": ["PIK3CA", "AKT1", "PTEN", "PIK3R1"],
        "alteration_types": ["mutation"]
      },
      "hrd_ddr": {
        "genes": ["BRCA1", "BRCA2", "ATM", "CHEK2"],
        "alteration_types": ["mutation"]
      }
    }
  },
  "melanoma": {
    "pathways": {
      "ras_mapk_braf": {
        "genes": ["BRAF", "NRAS", "MAP2K1", "MAP2K2"],
        "alteration_types": ["mutation"]
      },
      "pd1_immune": {
        "genes": ["CD274", "PDCD1LG2"],
        "alteration_types": ["expression", "amplification"]
      }
    }
  }
  // ... continue for all 10 cancers
}
```

**Source for mapping**: Use the pathway definitions already in `universal_disease_pathway_database.json` (lines 6-533) and map them to specific genes.

---

### **Step 2: Create Extraction Script (1 hour)**

**Create**: `scripts/tcga_extraction/extract_mutation_frequencies.py`

```python
#!/usr/bin/env python3
"""
Extract Real Mutation Frequencies from TCGA for Universal Disease Database

Takes gene-pathway mappings and computes actual alteration frequencies
from TCGA data via cBioPortal API.

Output: mutation_frequencies.json (real weights for each pathway)
"""

import sys
from pathlib import Path
import pandas as pd
import json
from typing import Dict, List, Any
from datetime import datetime

# Reuse existing extraction logic
sys.path.insert(0, str(Path(__file__).parent.parent / "yale_tdzd"))
from extract_tcga_brca import extract_mutations, CBIO_BASE

# Load gene-pathway mappings
MAPPINGS_FILE = Path(__file__).parent / "gene_pathway_mappings.json"
OUTPUT_FILE = Path(__file__).parent / "mutation_frequencies.json"

# Study IDs for top 10 cancers
STUDIES = {
    "ovarian_cancer_hgs": "ov_tcga_pan_can_atlas_2018",
    "breast_cancer": "brca_tcga_pan_can_atlas_2018",
    "lung_cancer": "luad_tcga_pan_can_atlas_2018",
    "colorectal_cancer": "coadread_tcga_pan_can_atlas_2018",
    "melanoma": "skcm_tcga_pan_can_atlas_2018",
    "prostate_cancer": "prad_tcga_pan_can_atlas_2018",
    "pancreatic_cancer": "paad_tcga_pan_can_atlas_2018",
    "glioblastoma": "gbm_tcga_pan_can_atlas_2018",
    "multiple_myeloma": "mmrf_commpass",
    "leukemia": "laml_tcga_pan_can_atlas_2018"
}


def calculate_pathway_frequency(
    df_mutations: pd.DataFrame, 
    pathway_genes: List[str],
    total_samples: int
) -> float:
    """
    Calculate what % of samples have alterations in pathway genes.
    
    Args:
        df_mutations: Mutations dataframe
        pathway_genes: List of genes in pathway
        total_samples: Total samples in study
        
    Returns:
        Frequency (0.0-1.0)
    """
    if df_mutations.empty or total_samples == 0:
        return 0.0
    
    # Get gene column name (might be 'Hugo_Symbol', 'gene', 'hugoGeneSymbol')
    gene_col = [c for c in df_mutations.columns if 'hugo' in c.lower() or c.lower() == 'gene'][0]
    
    # Count unique samples with mutations in any pathway gene
    pathway_mutations = df_mutations[
        df_mutations[gene_col].str.upper().isin([g.upper() for g in pathway_genes])
    ]
    
    if pathway_mutations.empty:
        return 0.0
    
    unique_samples = pathway_mutations['sampleId'].nunique()
    frequency = unique_samples / total_samples
    
    return round(frequency, 3)


def extract_for_cancer(cancer_type: str, study_id: str, mappings: Dict) -> Dict[str, Any]:
    """Extract mutation frequencies for one cancer type"""
    print(f"\n{'='*80}")
    print(f"üéØ Extracting: {cancer_type} ({study_id})")
    print(f"{'='*80}")
    
    cancer_mappings = mappings.get(cancer_type, {}).get("pathways", {})
    if not cancer_mappings:
        print(f"‚ö†Ô∏è  No pathway mappings found for {cancer_type}")
        return {}
    
    # Get all genes needed for this cancer
    all_genes = []
    for pathway_data in cancer_mappings.values():
        all_genes.extend(pathway_data.get("genes", []))
    all_genes = list(set(all_genes))  # Deduplicate
    
    print(f"üìä Target genes: {len(all_genes)} genes")
    print(f"üìä Target pathways: {len(cancer_mappings)} pathways")
    
    # Extract mutations
    df_mutations = extract_mutations(study_id, all_genes)
    
    if df_mutations.empty:
        print(f"‚ùå No mutations extracted for {study_id}")
        return {}
    
    total_samples = df_mutations['sampleId'].nunique()
    print(f"‚úÖ Extracted mutations from {total_samples} samples")
    
    # Calculate frequency for each pathway
    pathway_frequencies = {}
    for pathway_name, pathway_data in cancer_mappings.items():
        pathway_genes = pathway_data.get("genes", [])
        
        frequency = calculate_pathway_frequency(
            df_mutations, 
            pathway_genes, 
            total_samples
        )
        
        pathway_frequencies[pathway_name] = {
            "weight": frequency,
            "source": f"TCGA ({int(frequency*100)}% altered, n={total_samples})",
            "genes": pathway_genes,
            "samples_altered": int(frequency * total_samples),
            "total_samples": total_samples,
            "extracted_at": datetime.now().isoformat()
        }
        
        print(f"  ‚úì {pathway_name}: {frequency:.3f} ({int(frequency*100)}% altered)")
    
    return pathway_frequencies


def main():
    """Main extraction pipeline"""
    
    print("=" * 80)
    print("üéØ TCGA MUTATION FREQUENCY EXTRACTION")
    print("=" * 80)
    print(f"Start time: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    print()
    
    # Load gene-pathway mappings
    if not MAPPINGS_FILE.exists():
        print(f"‚ùå Mappings file not found: {MAPPINGS_FILE}")
        print(f"   Create it using Step 1 instructions in doctrine")
        return
    
    with open(MAPPINGS_FILE) as f:
        mappings = json.load(f)
    
    print(f"‚úÖ Loaded mappings for {len(mappings)} cancer types")
    print()
    
    # Extract for each cancer
    all_frequencies = {}
    
    for cancer_type, study_id in STUDIES.items():
        try:
            frequencies = extract_for_cancer(cancer_type, study_id, mappings)
            if frequencies:
                all_frequencies[cancer_type] = frequencies
        except Exception as e:
            print(f"‚ùå Error extracting {cancer_type}: {e}")
            continue
    
    # Save results
    OUTPUT_FILE.parent.mkdir(parents=True, exist_ok=True)
    with open(OUTPUT_FILE, 'w') as f:
        json.dump(all_frequencies, f, indent=2)
    
    print(f"\n{'='*80}")
    print("‚úÖ EXTRACTION COMPLETE")
    print(f"{'='*80}")
    print(f"Output: {OUTPUT_FILE}")
    print(f"Cancers extracted: {len(all_frequencies)}/{len(STUDIES)}")
    print(f"End time: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    print()
    print("üìù Next step: Run update_universal_database.py to merge into universal database")


if __name__ == "__main__":
    main()
```

**Test command**:
```bash
cd oncology-coPilot/oncology-backend-minimal
python scripts/tcga_extraction/extract_mutation_frequencies.py
```

---

### **Step 3: Update Universal Database (30 min)**

**Create**: `scripts/tcga_extraction/update_universal_database.py`

```python
#!/usr/bin/env python3
"""
Update universal_disease_pathway_database.json with real TCGA frequencies
"""

import json
from pathlib import Path
from datetime import datetime

# Paths
FREQUENCIES_FILE = Path(__file__).parent / "mutation_frequencies.json"
DATABASE_FILE = Path(__file__).parent.parent.parent / "api/resources/universal_disease_pathway_database.json"
BACKUP_FILE = DATABASE_FILE.with_suffix('.json.backup')

def main():
    print("=" * 80)
    print("üîÑ UPDATING UNIVERSAL DATABASE WITH REAL FREQUENCIES")
    print("=" * 80)
    
    # Load real frequencies
    if not FREQUENCIES_FILE.exists():
        print(f"‚ùå Frequencies file not found: {FREQUENCIES_FILE}")
        return
    
    with open(FREQUENCIES_FILE) as f:
        frequencies = json.load(f)
    
    print(f"‚úÖ Loaded frequencies for {len(frequencies)} cancers")
    
    # Load current database
    with open(DATABASE_FILE) as f:
        database = json.load(f)
    
    # Backup original
    with open(BACKUP_FILE, 'w') as f:
        json.dump(database, f, indent=2)
    print(f"üíæ Backed up original to: {BACKUP_FILE}")
    
    # Update weights for extracted cancers
    updated_count = 0
    for cancer_type, pathway_data in frequencies.items():
        if cancer_type in database['diseases']:
            print(f"\nüîÑ Updating {cancer_type}...")
            
            for pathway_name, freq_data in pathway_data.items():
                if pathway_name in database['diseases'][cancer_type]['pathways']:
                    # Update weight and add source
                    old_weight = database['diseases'][cancer_type]['pathways'][pathway_name]['weight']
                    new_weight = freq_data['weight']
                    
                    database['diseases'][cancer_type]['pathways'][pathway_name]['weight'] = new_weight
                    database['diseases'][cancer_type]['pathways'][pathway_name]['source'] = freq_data['source']
                    database['diseases'][cancer_type]['pathways'][pathway_name]['extracted_at'] = freq_data['extracted_at']
                    
                    print(f"  ‚úì {pathway_name}: {old_weight:.3f} ‚Üí {new_weight:.3f}")
                    updated_count += 1
    
    # Add metadata
    database['version'] = "1.1.0"
    database['last_updated'] = datetime.now().isoformat()
    database['extraction_note'] = f"Real TCGA frequencies for {len(frequencies)} cancers. Other diseases use literature-based estimates (0.75 default)."
    
    # Save updated database
    with open(DATABASE_FILE, 'w') as f:
        json.dump(database, f, indent=2)
    
    print(f"\n{'='*80}")
    print("‚úÖ UPDATE COMPLETE")
    print(f"{'='*80}")
    print(f"Updated pathways: {updated_count}")
    print(f"Updated database: {DATABASE_FILE}")
    print(f"Backup saved: {BACKUP_FILE}")


if __name__ == "__main__":
    main()
```

**Test command**:
```bash
python scripts/tcga_extraction/update_universal_database.py
```

---

## ‚úÖ **ACCEPTANCE CRITERIA**

### **Success = All of These Pass**:

1. ‚úÖ **10 cancer types extracted** from TCGA/cBioPortal
2. ‚úÖ **Real mutation frequencies** calculated for each pathway
3. ‚úÖ **Source attribution** includes sample count (e.g., "TCGA (20% ERBB2 amplified, n=1084)")
4. ‚úÖ **Database updated** with new weights
5. ‚úÖ **Backup created** before modification
6. ‚úÖ **Validation**: Spot-check known frequencies (e.g., BRAF V600E in melanoma ~50%, BRCA1/2 in ovarian ~50%)

### **Output Format Example**:
```json
{
  "breast_cancer": {
    "pathways": {
      "her2_signaling": {
        "weight": 0.20,
        "source": "TCGA (20% ERBB2 amplified, n=1084)",
        "description": "HER2 receptor signaling"
      }
    }
  }
}
```

---

## üö® **KNOWN ISSUES & SOLUTIONS**

### **Issue 1: cBioPortal API Rate Limiting**
**Solution**: Add sleep between requests:
```python
import time
time.sleep(1)  # Between each study
```

### **Issue 2: Missing Studies**
**Solution**: If a study doesn't exist, skip it and document:
```python
if df_mutations.empty:
    print(f"‚ö†Ô∏è  Study {study_id} not found or no mutations")
    continue
```

### **Issue 3: Gene Name Mismatches**
**Solution**: Use upper() for all comparisons:
```python
df_mutations[gene_col].str.upper().isin([g.upper() for g in genes])
```

---

## üìù **DELIVERABLES**

**Agent Jr Must Deliver**:

1. ‚úÖ `scripts/tcga_extraction/gene_pathway_mappings.json` - Gene-to-pathway mappings for 10 cancers
2. ‚úÖ `scripts/tcga_extraction/extract_mutation_frequencies.py` - Extraction script
3. ‚úÖ `scripts/tcga_extraction/update_universal_database.py` - Database update script
4. ‚úÖ `scripts/tcga_extraction/mutation_frequencies.json` - Raw extracted frequencies
5. ‚úÖ Updated `api/resources/universal_disease_pathway_database.json` - With real weights
6. ‚úÖ `EXTRACTION_REPORT.md` - Summary of what was extracted, validation results

---

## üéØ **VALIDATION CHECKLIST**

**Before submitting, verify**:

- [ ] All 10 cancers attempted (some may fail, that's OK)
- [ ] At least 7/10 cancers successfully extracted
- [ ] Frequencies are realistic (0.0-1.0 range, not >1.0)
- [ ] Known frequencies validated (BRAF melanoma ~50%, BRCA1/2 ovarian ~50%)
- [ ] Source attribution includes sample count
- [ ] Original database backed up
- [ ] No JSON syntax errors in updated database
- [ ] Extraction report documents any failures

---

## ‚öîÔ∏è **TIMELINE BREAKDOWN**

| Task | Time | Status |
|------|------|--------|
| Step 1: Gene-pathway mappings | 30 min | ‚è≥ |
| Step 2: Extraction script | 1 hour | ‚è≥ |
| Step 3: Update database script | 30 min | ‚è≥ |
| Step 4: Run extraction (10 cancers) | 30 min | ‚è≥ |
| Step 5: Validate & report | 30 min | ‚è≥ |
| **TOTAL** | **2.5-3 hours** | ‚è≥ |

---

## üî• **START COMMAND FOR AGENT JR**

```bash
# Navigate to project
cd oncology-coPilot/oncology-backend-minimal

# Create extraction directory
mkdir -p scripts/tcga_extraction

# Start with Step 1: Create gene_pathway_mappings.json
# (Agent Jr creates this manually based on universal_disease_pathway_database.json)

# Then create extraction scripts (Steps 2-3)
# Then run extraction
python scripts/tcga_extraction/extract_mutation_frequencies.py

# Then update database
python scripts/tcga_extraction/update_universal_database.py

# Finally, create extraction report
```

---

## ‚öîÔ∏è **AGENT JR - YOU ARE CLEARED TO PROCEED**

**Mission**: Extract real TCGA mutation frequencies for top 10 cancers  
**Priority**: P1  
**Timeline**: 2-3 hours  
**Deliverables**: 6 files (see above)  
**Report back when**: Complete or blocked  

---

## ‚úÖ **COMMANDER'S DECISIVE ANSWERS - EXECUTE IMMEDIATELY**

### **1. Existing Extraction Script** ‚úÖ ANSWERED
- **ANSWER**: Use the same hardcoded path for now (keep it simple, we can refactor later)
- **ANSWER**: Extract **mutations only** (simplicity wins - amplifications/expression are P2)
- **CODE**: Just copy the path from `extract_tcga_brca.py` exactly as-is

### **2. Database Structure** ‚úÖ ANSWERED
- **ANSWER**: Preserve ALL existing metadata, ONLY update `weight` field
- **ANSWER**: YES - Add these new fields to each pathway:
  - `source` (string): "TCGA (X% altered, n=Y)"
  - `extracted_at` (ISO timestamp)
  - `genes` (array): List of genes used for calculation
  - `samples_altered` (int): Number of samples with alterations
  - `total_samples` (int): Total samples in study
- **ANSWER**: Match pathway names EXACTLY - no variations handling needed

### **3. Extraction Scope & Alteration Types** ‚úÖ ANSWERED
- **ANSWER**: **Option A** - Combine frequencies (any alteration = pathway altered)
- **ANSWER**: Extract ALL pathways listed (completeness > speed)
- **ANSWER**: For pathways without clear gene mappings:
  - Use proxy genes (VEGFA, VEGFR2 for angiogenesis)
  - Document which proxy genes used in `genes` field
  - If no proxy possible, keep estimated weight with note

### **4. Gene-to-Pathway Mapping Strategy** ‚úÖ ANSWERED
- **ANSWER**: Use **core driver genes only** (3-5 genes max per pathway)
- **ANSWER**: Base mappings on:
  1. Yale T-DXd project gene lists (we already have this for breast)
  2. Known TCGA driver genes from papers
  3. OncoKB when unclear
- **ANSWER**: Create **separate mapping file** (`gene_pathway_mappings.json`)
- **EXAMPLE MAPPING**:
```json
{
  "breast_cancer": {
    "her2_signaling": ["ERBB2"],
    "pi3k_akt_mtor": ["PIK3CA", "AKT1", "PTEN"],
    "hrd_ddr": ["BRCA1", "BRCA2"]
  }
}
```

### **5. Validation & Testing** ‚úÖ ANSWERED
- **ANSWER**: YES - Test on 2 cancers first (breast + melanoma)
- **ANSWER**: Validate BOTH:
  - BRAF V600E frequency in melanoma (expect ~45-55%)
  - BRCA1/2 frequency in ovarian (expect ~45-55%)
- **ANSWER**: Acceptable variance: ¬±10% (e.g., if expected 50%, accept 40-60%)
- **STRATEGY**: If validation passes, proceed with all 10; if fails, stop and report

### **6. Error Handling & Partial Failures** ‚úÖ ANSWERED
- **ANSWER**: If study doesn't exist ‚Üí Skip, document in report, keep original weight
- **ANSWER**: If 3/10 cancers fail:
  - **Still update database with 7 successful extractions**
  - Mark failed cancers in report
  - Add field `extraction_status: "success"|"failed"|"skipped"` per cancer

### **7. Output & Backup Strategy** ‚úÖ ANSWERED
- **ANSWER**: **Option A** - Backup original, then update in-place
- **ANSWER**: YES - Create comparison report automatically (old vs new weights table)
- **ANSWER**: YES - Add metadata to database:
```json
{
  "version": "1.1.0",
  "extraction_metadata": {
    "extracted_at": "2025-11-04T...",
    "extraction_version": "v1",
    "cancers_extracted": 7,
    "cancers_failed": 3
  }
}
```

### **8. cBioPortal API & Performance** ‚úÖ ANSWERED
- **ANSWER**: YES to all:
  - Add `time.sleep(1)` between studies (rate limiting)
  - Add retry logic (3 attempts, exponential backoff)
  - Save partial results after each cancer (in case of interrupt)
- **ANSWER**: NO caching (keep it simple - extraction is fast enough)

### **9. Multiple Myeloma Study** ‚úÖ ANSWERED
- **ANSWER**: Use `mmrf_commpass` (it's valid cBioPortal data)
- **ANSWER**: Document in source field: "MMRF CoMMpass (X% altered, n=Y)"

### **10. Execution Order** ‚úÖ ANSWERED
- **ANSWER**: Start with high-confidence cancers:
  1. Breast (we have template)
  2. Melanoma (easy validation - BRAF)
  3. Ovarian (easy validation - BRCA1/2)
  4. Then continue 4-10

### **11. Final Deliverables** ‚úÖ ANSWERED
- **ANSWER**: Create ALL of these:
  1. Updated database (`universal_disease_pathway_database.json`)
  2. Backup (`universal_disease_pathway_database.json.backup`)
  3. Raw frequencies (`mutation_frequencies.json`)
  4. Extraction report (`EXTRACTION_REPORT.md`) with:
     - Summary table (cancer, pathways extracted, status)
     - Validation results (BRAF, BRCA1/2 checks)
     - Before/after comparison table
     - Any warnings/errors

### **12. Pathway Gene Mapping** ‚úÖ ANSWERED
- **ANSWER**: Use **core gene only** for simplicity:
  - `her2_signaling` ‚Üí `["ERBB2"]` only
  - `pi3k_akt_mtor` ‚Üí `["PIK3CA", "PTEN", "AKT1"]`
  - `ras_mapk_braf` ‚Üí `["BRAF", "NRAS", "KRAS"]`
- **RATIONALE**: Simpler = more accurate; pathway frequency ‚âà driver gene frequency

### **13. Sample Count Calculation** ‚úÖ ANSWERED
- **ANSWER**: Use unique samples from mutations dataframe:
```python
total_samples = df_mutations['sampleId'].nunique()
```
- **RATIONALE**: Most accurate (only counts samples with mutation data)

---

## üéØ **SIMPLIFIED EXECUTION PLAN (REVISED)**

### **Phase 1: Create Gene Mappings (30 min)**
Create `gene_pathway_mappings.json` with CORE GENES ONLY:
```json
{
  "breast_cancer": {
    "her2_signaling": ["ERBB2"],
    "pi3k_akt_mtor": ["PIK3CA", "PTEN", "AKT1"],
    "hrd_ddr": ["BRCA1", "BRCA2"],
    "er_pr_signaling": ["ESR1", "PGR"],
    "cell_cycle": ["CDK4", "CDK6", "CCND1"]
  },
  "melanoma": {
    "ras_mapk_braf": ["BRAF", "NRAS", "KRAS"],
    "pd1_immune": ["CD274"],
    "kit_signaling": ["KIT"],
    "cdkn2a": ["CDKN2A"]
  },
  "ovarian_cancer_hgs": {
    "hrd_ddr": ["BRCA1", "BRCA2"],
    "pi3k_akt_mtor": ["PIK3CA", "PTEN", "AKT1"],
    "tp53": ["TP53"],
    "angiogenesis": ["VEGFA"],
    "ras_mapk": ["KRAS", "NRAS"]
  }
  // ... continue for remaining 7 cancers
}
```

### **Phase 2: Run Extraction (1 hour)**
1. Test on breast + melanoma first
2. Validate BRAF/BRCA frequencies
3. If pass, run remaining 8 cancers
4. Save partial results after each cancer

### **Phase 3: Update Database (30 min)**
1. Backup original
2. Update weights + add new fields
3. Add extraction metadata
4. Create comparison report

---

## ‚úÖ **ACCEPTANCE CRITERIA (SIMPLIFIED)** - ‚ö†Ô∏è **OUTDATED - SEE UPDATED CRITERIA BELOW**

**OLD CRITERIA (REPLACED)**:
1. ‚ùå Breast cancer extracted (ERBB2 ~20%) - **REMOVED** (amplification, not mutation)
2. ‚úÖ Melanoma BRAF validated (~45-55%) - **KEPT**
3. ‚ö†Ô∏è Ovarian BRCA1/2 validated (~45-55%) - **UPDATED** to ~15-20% (germline+somatic)
4. ‚úÖ At least 7/10 cancers successful - **KEPT**
5. ‚úÖ Database updated with backup created - **KEPT**
6. ‚úÖ Extraction report generated - **KEPT**

**NOTE**: See "Updated Validation Criteria" section (line 795) for current acceptance criteria.

---

---

## ‚úÖ **COMMANDER'S UPDATED ANSWERS - ALL GAPS CLOSED**

### **1. HER2 Amplification Issue** ‚úÖ RESOLVED
- **DECISION**: **Accept lower mutation frequencies for now**
- **RATIONALE**: CNA extraction is complex (P2 work); mutations-only is good enough for MVP
- **UPDATED VALIDATION**: 
  - Breast: PIK3CA mutations ~30-40% (primary validation)
  - Breast: TP53 mutations ~30-35% (secondary validation)
  - Remove ERBB2 from validation criteria (amplification, not mutation)
- **NOTE**: Add to extraction report: "HER2/ERBB2 pathway weight reflects mutations only (~1-2%), not amplifications (~20%). For accurate HER2 pathway weights, CNA extraction required (P2)."

### **2. Complete Gene Mappings** ‚úÖ PROVIDED

**COMPLETE GENE-TO-PATHWAY MAPPINGS FOR ALL 10 CANCERS**:

```json
{
  "breast_cancer": {
    "her2_signaling": ["ERBB2"],
    "er_pr_signaling": ["ESR1", "PGR"],
    "pi3k_akt_mtor": ["PIK3CA", "PTEN", "AKT1"],
    "hrd_ddr": ["BRCA1", "BRCA2"],
    "cell_cycle": ["CDK4", "CDK6", "CCND1", "RB1"]
  },
  "melanoma": {
    "ras_mapk_braf": ["BRAF", "NRAS", "KRAS"],
    "pd1_immune": ["CD274"],
    "kit_signaling": ["KIT"],
    "nras": ["NRAS"],
    "cdkn2a": ["CDKN2A"]
  },
  "ovarian_cancer_hgs": {
    "hrd_ddr": ["BRCA1", "BRCA2"],
    "pi3k_akt_mtor": ["PIK3CA", "PTEN", "AKT1"],
    "angiogenesis": ["VEGFA"],
    "tp53": ["TP53"],
    "ras_mapk": ["KRAS", "NRAS", "BRAF"]
  },
  "lung_cancer": {
    "egfr_signaling": ["EGFR"],
    "alk_ros1": ["ALK", "ROS1"],
    "angiogenesis": ["VEGFA"],
    "pd_l1_immune": ["CD274"],
    "kras_signaling": ["KRAS"]
  },
  "colorectal_cancer": {
    "wnt_beta_catenin": ["APC", "CTNNB1"],
    "egfr_signaling": ["EGFR"],
    "angiogenesis": ["VEGFA"],
    "msi_mmr": ["MLH1", "MSH2", "MSH6", "PMS2"],
    "ras_mapk": ["KRAS", "NRAS", "BRAF"]
  },
  "pancreatic_cancer": {
    "kras_signaling": ["KRAS"],
    "tp53": ["TP53"],
    "smad4_tgf_beta": ["SMAD4"],
    "cdkn2a": ["CDKN2A"],
    "ddr": ["BRCA1", "BRCA2", "ATM"]
  },
  "prostate_cancer": {
    "androgen_receptor": ["AR"],
    "pi3k_akt_pten": ["PTEN", "PIK3CA", "AKT1"],
    "ddr": ["BRCA2", "ATM", "CHEK2"],
    "tp53": ["TP53"],
    "tmprss2_erg": ["ERG", "ETV1"]
  },
  "glioblastoma": {
    "egfr_signaling": ["EGFR"],
    "pten_pi3k_akt": ["PTEN", "PIK3CA", "PIK3R1"],
    "tp53_rb": ["TP53", "RB1"],
    "angiogenesis": ["VEGFA"],
    "idh1": ["IDH1"]
  },
  "multiple_myeloma": {
    "nfkb": ["NFKB1", "NFKB2"],
    "proteasome": ["PSMB5"],
    "immunomodulation": ["CRBN"],
    "ras_mapk": ["KRAS", "NRAS", "BRAF"],
    "bcma_cd38": ["TNFRSF17", "CD38"]
  },
  "leukemia": {
    "flt3_signaling": ["FLT3"],
    "idh1_idh2": ["IDH1", "IDH2"],
    "npm1": ["NPM1"],
    "tp53": ["TP53"],
    "cell_differentiation": ["CEBPA", "RUNX1"]
  }
}
```

### **3. Special Pathway Handling** ‚úÖ RESOLVED
- **DECISION**: Use mutation-based proxies where possible, keep estimated weights for non-extractable pathways
- **STRATEGY**:
  - **Fusions** (ALK/ROS1, TMPRSS2-ERG): Use fusion partner genes (ALK, ROS1, ERG) - mutations will be low, document limitation
  - **Immune Checkpoints** (PD-L1, CD274): Use gene mutations (rare) - document limitation
  - **Hormone Receptors** (AR, ESR1): Use gene mutations (rare) - document limitation
- **ANNOTATION**: Add `extraction_type` field:
  - `"mutation"` - standard extraction
  - `"mutation_proxy"` - fusion/expression pathway using mutation proxy
  - `"estimated"` - kept original estimated weight (non-extractable)

### **4. Updated Validation Criteria** ‚úÖ REALISTIC

**REVISED ACCEPTANCE CRITERIA**:
1. ‚úÖ Breast cancer: PIK3CA ~30-40% (PRIMARY)
2. ‚úÖ Breast cancer: TP53 ~30-35% (SECONDARY)
3. ‚úÖ Melanoma: BRAF ~45-55% (PRIMARY)
4. ‚úÖ Ovarian: BRCA1/2 combined ~15-20% (germline + somatic, SECONDARY)
5. ‚úÖ Ovarian: TP53 ~95%+ (PRIMARY - TP53 is nearly universal in HGSC)
6. ‚úÖ At least 7/10 cancers successful
7. ‚úÖ Database updated with backup
8. ‚úÖ Extraction report with limitations documented

### **5. Complete Execution Plan** ‚úÖ UPDATED

**Phase 1** (45 min): Create complete gene mappings
- Use mappings above (all 10 cancers provided)
- Save to `gene_pathway_mappings.json`
- Add `extraction_type` annotations

**Phase 2** (1.5 hours): Run extraction
- Test on breast (PIK3CA/TP53) + ovarian (TP53) first
- Validate: PIK3CA ~30-40%, TP53 breast ~30-35%, TP53 ovarian ~95%+
- If pass, run melanoma (BRAF validation ~50%)
- Then run remaining 7 cancers

**Phase 3** (30 min): Update database
- Backup original
- Update weights for extracted pathways
- Add new fields: `source`, `extracted_at`, `genes`, `samples_altered`, `total_samples`, `extraction_type`
- Mark non-extractable pathways with note
- Create comparison report

---

## ‚úÖ **ALL GAPS CLOSED - READY TO EXECUTE**

**CRITICAL DECISIONS MADE**:
1. ‚úÖ Mutations only (accept lower frequencies for amplification/fusion/expression pathways)
2. ‚úÖ Complete gene mappings provided (all 10 cancers, all pathways)
3. ‚úÖ Special pathway strategy defined (proxy genes + documentation)
4. ‚úÖ Realistic validation criteria (PIK3CA, TP53, BRAF)
5. ‚úÖ `extraction_type` field added for transparency

**EXPECTED LIMITATIONS** (document in report):
- HER2/ERBB2: Mutations only (~1-2%), not amplifications (~20%)
- ALK/ROS1, TMPRSS2-ERG: Fusion frequencies not captured
- PD-L1, immune checkpoints: Expression not captured
- Hormone receptors: Expression not captured

**TIMELINE**: Still 2-3 hours (no change)

---

**AGENT JR - ALL CLARIFICATIONS PROVIDED. EXECUTE!** ‚öîÔ∏è

**FIRE IN THE HOLE!** üî•
