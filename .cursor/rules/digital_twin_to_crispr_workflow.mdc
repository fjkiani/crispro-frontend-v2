---
description: 
globs: 
alwaysApply: false
---
# PLAN: End-to-End Workflow from Digital Twin to CRISPR Therapy

This plan outlines the steps to create a seamless, end-to-end user workflow within the Streamlit application. The goal is to connect the clinical insights from the **Myeloma Digital Twin** directly to the therapeutic design capabilities of the **CRISPR modules**.

This creates a powerful "prediction to action" pipeline, transforming the application into an integrated therapeutic intelligence platform.

### Core User Journey:
1.  **Analyze Patient**: A user enters a patient's mutations into the [Myeloma Digital Twin](mdc:pages/6_Myeloma_Digital_Twin.py) and receives a drug response prediction.
2.  **Identify Target**: The results highlight a high-impact, pathogenic variant (e.g., `BRAF V600E`).
3.  **Initiate Therapy Design**: The user clicks a new "Design CRISPR Therapy" button next to this actionable target.
4.  **Automate Guide Design**: The user is navigated to the CHOPCHOP tool, where the genomic coordinates of the target variant are pre-populated.
5.  **Generate Experiment Plan**: After selecting a guide RNA, the user proceeds to the Experiment Advisor, which receives the full context (disease, gene, variant, goal) and generates a highly specific experimental protocol.

---

### Task Breakdown:

#### **[ ] Task 1: Enhance the Digital Twin UI with a "Call to Action"**

*   **File to Edit:** [`pages/6_Myeloma_Digital_Twin.py`](mdc:pages/6_Myeloma_Digital_Twin.py)
*   **Goal:** Add a button that initiates the handoff to the CRISPR design workflow.

*   **[ ] 1.1:** In the results display loop, add a conditional check. If a variant's `calculated_impact_level` is high (e.g., >= 2), display a "ðŸŽ¯ Design CRISPR Therapy" button next to it.
*   **[ ] 1.2:** When this button is clicked, store the selected variant's details (gene, coordinates, etc.) in Streamlit's `st.session_state`.
*   **[ ] 1.3:** Redirect the user to the CHOPCHOP guide design page. We will need to implement a robust page navigation system if one doesn't already exist.

#### **[ ] Task 2: Pre-populate the CRISPR Guide Designer**

*   **File to Edit:** The Streamlit page for the CHOPCHOP tool (Need to identify this, likely in `pages/` or `streamlit_app.py`).
*   **Goal:** Automate the input for the guide RNA search.

*   **[ ] 2.1:** On page load, the CHOPCHOP page should check `st.session_state` for incoming variant data from the Digital Twin.
*   **[ ] 2.2:** If data is present, use it to automatically fill the input fields for target gene/locus. This removes manual data entry and potential for error.
*   **[ ] 2.3:** Clear the variant data from the session state after using it to prevent stale data on subsequent visits.

#### **[ ] Task 3: Make the Experiment Advisor "Context-Aware"**

*   **File to Edit:** [`tools/experiment_advisor.py`](mdc:tools/experiment_advisor.py) and its corresponding Streamlit page.
*   **Goal:** Generate more intelligent and specific experimental plans.

*   **[ ] 3.1:** Modify the function that calls the Experiment Advisor to accept a new `context` dictionary. This dictionary will contain the information from the Digital Twin (`disease`, `gene`, `variant`, `prediction`).
*   **[ ] 3.2:** Enhance the LLM prompt for the Experiment Advisor. The prompt should now include the `context`, instructing the LLM to tailor its recommendations.
    *   *Example Prompt Addition:* "The user has identified that the BRAF V600E variant is driving resistance in Multiple Myeloma. Generate a CRISPR-based experimental plan focused on HDR-mediated correction of this specific variant."
*   **[ ] 3.3:** Ensure this context is passed along the workflow, from the Digital Twin, through the guide selection, and finally to the Experiment Advisor.

By implementing this plan, we will create a cohesive and powerful workflow that fully leverages the platform's AI capabilities, guiding a user from a high-level clinical problem directly to a specific, actionable therapeutic solution.
