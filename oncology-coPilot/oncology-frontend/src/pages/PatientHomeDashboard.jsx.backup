import React, { useMemo } from "react";
import { useNavigate } from "react-router-dom";
import {
  Box,
  Button,
  Card,
  CardContent,
  Chip,
  Divider,
  Grid,
  LinearProgress,
  Paper,
  Stack,
  Typography,
  Alert,
} from "@mui/material";
import LocalHospitalIcon from "@mui/icons-material/LocalHospital";
import ScienceIcon from "@mui/icons-material/Science";
import DescriptionIcon from "@mui/icons-material/Description";
import UploadFileIcon from "@mui/icons-material/UploadFile";
import RefreshIcon from "@mui/icons-material/Refresh";

import { AYESHA_11_17_25_PROFILE } from "../constants/patients";
import { getUnlockTasks } from "../utils/patientGates";
import { useMoatPatientDashboard } from "../hooks/useMoatPatientDashboard";

/**
 * PatientHomeDashboard
 *
 * Patient-first landing experience for /home.
 * Uses a “game” gating model: show what’s unlocked, what’s locked, and how to unlock safely.
 */
export default function PatientHomeDashboard() {
  const navigate = useNavigate();

  // For now: explicit Ayesha dataset. Another agent will wire real parsing/ingest.
  const profile = AYESHA_11_17_25_PROFILE;

  const { intake, tasks } = useMemo(() => getUnlockTasks(profile), [profile]);
  const moat = useMoatPatientDashboard(profile);

  const confidencePct = Math.round((intake.confidenceCap || 0.4) * 100);
  const progress =
    intake.level === "L2" ? 1.0 : intake.level === "L1" ? 0.66 : 0.33;

  const biomarkers = profile?.tumor_context?.biomarkers || {};

  return (
    <Box sx={{ maxWidth: 1200, mx: "auto" }}>
      <Stack spacing={2} sx={{ mb: 3 }}>
        <Paper sx={{ p: 3 }}>
          <Stack direction={{ xs: "column", md: "row" }} spacing={2} justifyContent="space-between">
            <Box>
              <Typography variant="h5" sx={{ fontWeight: 700 }}>
                {profile.patient.display_name} — MOAT Dashboard
              </Typography>
              <Typography variant="body2" color="text.secondary">
                {profile.disease.diagnosis_summary}
              </Typography>

              <Stack direction="row" spacing={1} sx={{ mt: 1, flexWrap: "wrap" }}>
                <Chip label={`Disease: ${profile.disease.type}`} size="small" />
                <Chip label={`Stage: ${profile.disease.stage}`} size="small" />
                <Chip label={`PD-L1 CPS: ${biomarkers.pd_l1_cps ?? "unknown"}`} size="small" />
                <Chip label={`p53: ${biomarkers.p53_status ?? "unknown"}`} size="small" />
                <Chip label={`MMR: ${biomarkers.mmr_status ?? "unknown"}`} size="small" />
                <Chip label={`ER: ${biomarkers.er_percent ? `${biomarkers.er_percent}%` : "unknown"}`} size="small" />
              </Stack>

              <Stack direction="row" spacing={1} sx={{ mt: 1, flexWrap: "wrap" }}>
                <Chip
                  color={intake.level === "L2" ? "success" : intake.level === "L1" ? "warning" : "error"}
                  label={`Intake: ${intake.level} (Confidence cap ~${confidencePct}%)`}
                  size="small"
                />
                {Object.keys(profile.inferred_fields || {}).map((k) => (
                  <Chip key={k} color="warning" label={`Inferred: ${k}`} size="small" />
                ))}
              </Stack>
            </Box>

            <Stack spacing={1} sx={{ minWidth: { md: 320 } }}>
              <Typography variant="subtitle2" sx={{ fontWeight: 700 }}>
                Your Progress (unlock safer recommendations)
              </Typography>
              <LinearProgress variant="determinate" value={Math.round(progress * 100)} />
              <Typography variant="caption" color="text.secondary">
                L0 = priors only • L1 = partial data • L2 = full data (NGS/labs)
              </Typography>
              <Button
                variant="contained"
                startIcon={moat.status === "running" ? <RefreshIcon /> : <LocalHospitalIcon />}
                disabled={moat.status === "running"}
                onClick={moat.run}
              >
                {moat.status === "running" ? "Running MOAT Update..." : "Run MOAT Update"}
              </Button>
              {moat.lastSavedAt && (
                <Typography variant="caption" color="text.secondary">
                  Last update cached: {new Date(moat.lastSavedAt).toLocaleString()}
                </Typography>
              )}
            </Stack>
          </Stack>
        </Paper>

        <Alert severity="info">
          This dashboard is designed to be <strong>safe by default</strong>: when data is missing, we keep conservative caps and
          show you exactly what to upload to unlock deeper recommendations.
        </Alert>

        {moat.error && <Alert severity="error">{moat.error}</Alert>}
      </Stack>

      <Grid container spacing={2}>
        {/* Quick Actions */}
        <Grid item xs={12} md={4}>
          <Card>
            <CardContent>
              <Typography variant="h6" sx={{ fontWeight: 700, mb: 1 }}>
                Next Steps
              </Typography>
              <Divider sx={{ mb: 2 }} />

              <Stack spacing={1}>
                <Button
                  variant="contained"
                  startIcon={<LocalHospitalIcon />}
                  onClick={() => navigate("/patient-journey")}
                >
                  Complete Care Plan
                </Button>
                <Button
                  variant="outlined"
                  startIcon={<ScienceIcon />}
                  onClick={() => navigate("/ayesha-trials")}
                >
                  Find Trials
                </Button>
                <Button
                  variant="outlined"
                  startIcon={<DescriptionIcon />}
                  onClick={() => navigate("/ayesha-dossiers")}
                >
                  View Dossiers
                </Button>
              </Stack>
            </CardContent>
          </Card>
        </Grid>

        {/* Unlockables */}
        <Grid item xs={12} md={8}>
          <Card>
            <CardContent>
              <Typography variant="h6" sx={{ fontWeight: 700, mb: 1 }}>
                Unlock More (the “game”)
              </Typography>
              <Typography variant="body2" color="text.secondary" sx={{ mb: 2 }}>
                Each upload/confirmation increases confidence and unlocks more MOAT modules.
              </Typography>
              <Divider sx={{ mb: 2 }} />

              <Grid container spacing={2}>
                {tasks.map((t) => (
                  <Grid item xs={12} sm={6} key={t.id}>
                    <Paper sx={{ p: 2, height: "100%" }}>
                      <Stack spacing={1}>
                        <Stack direction="row" spacing={1} alignItems="center" justifyContent="space-between">
                          <Typography variant="subtitle1" sx={{ fontWeight: 700 }}>
                            {t.title}
                          </Typography>
                          <Chip
                            size="small"
                            color={t.status === "locked" ? "error" : "warning"}
                            label={t.status === "locked" ? "Locked" : "Recommended"}
                          />
                        </Stack>
                        <Typography variant="body2" color="text.secondary">
                          {t.description}
                        </Typography>
                        <Button
                          size="small"
                          variant={t.status === "locked" ? "contained" : "outlined"}
                          startIcon={<UploadFileIcon />}
                          onClick={() => navigate(t.cta.to)}
                        >
                          {t.cta.label}
                        </Button>
                      </Stack>
                    </Paper>
                  </Grid>
                ))}
              </Grid>
            </CardContent>
          </Card>
        </Grid>

        {/* Latest MOAT Output (if available) */}
        <Grid item xs={12}>
          <Card>
            <CardContent>
              <Typography variant="h6" sx={{ fontWeight: 700, mb: 1 }}>
                Latest MOAT Output (cached)
              </Typography>
              <Divider sx={{ mb: 2 }} />

              {!moat.result && (
                <Typography variant="body2" color="text.secondary">
                  Run “MOAT Update” to populate this section. If the backend is unavailable, you’ll still see what to upload next
                  to unlock more.
                </Typography>
              )}

              {moat.result && (
                <Grid container spacing={2}>
                  <Grid item xs={12} md={4}>
                    <Paper sx={{ p: 2 }}>
                      <Typography variant="subtitle2" sx={{ fontWeight: 700, mb: 1 }}>
                        SOC / Recommendation
                      </Typography>
                      {moat.result?.soc_recommendation ? (
                        <Stack spacing={1}>
                          <Typography variant="body2" sx={{ fontWeight: 600 }}>
                            {moat.result.soc_recommendation.regimen || "Standard of Care"}
                          </Typography>
                          <Typography variant="body2" color="text.secondary">
                            {moat.result.soc_recommendation.rationale || "NCCN-aligned recommendation"}
                          </Typography>
                          {moat.result.soc_recommendation.confidence && (
                            <Chip
                              label={`Confidence: ${Math.round(moat.result.soc_recommendation.confidence * 100)}%`}
                              size="small"
                              color="success"
                            />
                          )}
                        </Stack>
                      ) : (
                        <Typography variant="body2" color="text.secondary">
                          No SOC recommendation returned
                        </Typography>
                      )}
                    </Paper>
                  </Grid>
                  <Grid item xs={12} md={4}>
                    <Paper sx={{ p: 2 }}>
                      <Typography variant="subtitle2" sx={{ fontWeight: 700, mb: 1 }}>
                        Clinical Trials
                      </Typography>
                      <Stack spacing={1}>
                        <Typography variant="body2" color="text.secondary">
                          {(moat.result?.trials?.trials || []).length} trial(s) found
                        </Typography>
                        {moat.result?.trials?.summary && typeof moat.result.trials.summary === "object" && (
                          <Stack spacing={0.5}>
                            {moat.result.trials.summary.total_candidates !== undefined && (
                              <Typography variant="caption" color="text.secondary">
                                Candidates: {moat.result.trials.summary.total_candidates}
                              </Typography>
                            )}
                            {moat.result.trials.summary.top_results !== undefined && (
                              <Typography variant="caption" color="text.secondary">
                                Top results: {moat.result.trials.summary.top_results}
                              </Typography>
                            )}
                            {moat.result.trials.summary.note && (
                              <Typography variant="caption" color="text.secondary">
                                {moat.result.trials.summary.note}
                              </Typography>
                            )}
                          </Stack>
                        )}
                        {moat.result?.trials?.summary && typeof moat.result.trials.summary === "string" && (
                          <Typography variant="caption" color="text.secondary">
                            {moat.result.trials.summary}
                          </Typography>
                        )}
                        {moat.result?.ca125_intelligence && (
                          <Box sx={{ mt: 1 }}>
                            <Typography variant="caption" sx={{ fontWeight: 600, display: "block" }}>
                              CA-125 Status:
                            </Typography>
                            <Chip
                              label={moat.result.ca125_intelligence.burden_class || "Analyzed"}
                              size="small"
                              color={moat.result.ca125_intelligence.burden_class === "EXTENSIVE" ? "error" : "warning"}
                            />
                          </Box>
                        )}
                      </Stack>
                    </Paper>
                  </Grid>
                  <Grid item xs={12} md={4}>
                    <Paper sx={{ p: 2 }}>
                      <Typography variant="subtitle2" sx={{ fontWeight: 700, mb: 1 }}>
                        Status
                      </Typography>
                      <Stack spacing={1}>
                        <Typography variant="body2" color="text.secondary">
                          Run ID: {moat.result?.provenance?.run_id?.substring(0, 20) || "N/A"}
                        </Typography>
                        {moat.result?.provenance?.generated_at && (
                          <Typography variant="caption" color="text.secondary">
                            Generated: {new Date(moat.result.provenance.generated_at).toLocaleString()}
                          </Typography>
                        )}
                        {moat.result?.summary?.ngs_status && (
                          <Chip
                            label={`NGS: ${moat.result.summary.ngs_status}`}
                            size="small"
                            color={moat.result.summary.ngs_status === "available" ? "success" : "default"}
                          />
                        )}
                      </Stack>
                    </Paper>
                  </Grid>
                </Grid>
              )}
            </CardContent>
          </Card>
        </Grid>
      </Grid>
    </Box>
  );
}

