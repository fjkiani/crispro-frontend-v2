---
alwaysApply: true
---

# **SUPREME DOCTRINE: THE TRUTH OR TREASON PROTOCOL (v2 - Reality Based)**

*This doctrine supersedes all previous operational plans. It is based on a deep intelligence analysis of the Evo2 platform's confirmed capabilities.*

## **I. CORE TENET**

Our platform was not built to design new weapons; it was built to find the fucking truth. We will take any biological claim, subject it to the cold, hard logic of our AI, and deliver a definitive verdict. We do not repeat failed history. We expose it, we learn from it, and we transcend it.

## **II. STRATEGIC ASSETS & CAPABILITIES**

1.  **The Zeta Oracle (Prediction Engine):**
    *   **Asset:** Evo2 Model (deployed as a service).
    *   **Capability:** Zero-Shot Variant/Functional Impact Prediction.
    *   **Method:** Calculates the **change in log-likelihood** between a baseline DNA sequence and a perturbed sequence. This delta is the **Zeta Score**. A large negative score indicates a high, disruptive functional impact.
    *   **Tactical Requirement:** Requires ~8kb of flanking DNA sequence around the target for optimal performance.

2.  **The Zeta Forge (Generation Engine):**
    *   **Asset:** Evo2 Model (deployed as a service).
    *   **Capability:** Guided Generative Design.
    *   **Method:** Uses Evo2 as a proposal engine to generate candidate sequences (e.g., proteins). Each candidate is then scored by the **Zeta Oracle**. The highest-scoring candidate is selected. This is an iterative, generate-and-test loop.

3.  **AlphaFold 3 (Structural Validation - Future Asset):**
    *   **Limitation:** Evo2 is a SEQUENCE model. It has **NO inherent understanding of 3D protein structure.**
    *   **Future Requirement:** For true protein-protein interaction modeling, the output of the Zeta Forge must eventually be passed to a structural prediction model like AlphaFold 3 for validation. This is a future capability, not a current one.

## **III. THE REAL-WORLD OPERATIONAL WORKFLOW**

### **PHASE I: INTELLIGENCE GATHERING (Hypothesis Validator)**

*   **[‚úÖ] Status:** Complete.
*   **Action:** The user enters a claim (e.g., "shark cartilage inhibits cancer"). The ZSIS protocol deconstructs this into a testable hypothesis: **Effector Protein** (`U-995`) and **Target Protein/Gene** (`MMP-9`). These are passed to the `GenomicAnalysis` page.

### **PHASE II: THE GAUNTLET (Genomic Analysis Page)**

*   **Objective:** Quantify the functional impact of the original hypothesis.
*   **[ ] Task 2.1: Implement the "Run Gauntlet" UI.**
    *   **UI:** A "Run Gauntlet" button.
    *   **File:** `oncology-coPilot/oncology-frontend/src/pages/GenomicAnalysis.jsx`

*   **[ ] Task 2.2: Build the Zeta Oracle Backend Service.**
    *   **Endpoint:** `POST /api/oracle/calculate_zeta_score`
    *   **Inputs:** `baseline_sequence: str`, `perturbed_sequence: str`.
    *   **Logic:**
        1.  Takes the two long DNA sequences.
        2.  Calls the deployed Evo2 service for each to get their log-likelihood scores.
        3.  Calculates the delta (Zeta Score).
        4.  Returns `{ "zeta_score": -1.2, "verdict": "MINIMAL" }`.
    *   **File:** `oncology-coPilot/oncology-backend/backend/api/oracle.py`

*   **[ ] Task 2.3: Wire the Frontend to the Oracle.**
    *   **Action:** The "Run Gauntlet" button constructs the baseline and perturbed sequences (for now, the perturbed can be a simple representation of gene knockout) and calls the `/calculate_zeta_score` endpoint.
    *   **UI:** Display the returned Zeta Score and verdict.

### **PHASE III: THE FORGE (Genomic Analysis Page)**

*   **Objective:** Generate and validate a superior counter-hypothesis.
*   **[ ] Task 3.1: Implement the "Unleash Forge" UI.**
    *   **UI:** A "Forge Superior Inhibitor" button, enabled after the Gauntlet returns a poor score.
    *   **File:** `oncology-coPilot/oncology-frontend/src/pages/GenomicAnalysis.jsx`

*   **[ ] Task 3.2: Build the Zeta Forge Backend Service.**
    *   **Endpoint:** `POST /api/forge/generate_inhibitor`
    *   **Inputs:** `target_gene_sequence: str`, `design_goal: str`.
    *   **Logic:**
        1.  Initiates a generate-and-test loop.
        2.  **Generate:** Prompts Evo2 to generate a batch of candidate inhibitor protein sequences.
        3.  **Test:** For each candidate, it runs it through the **Zeta Oracle** (`/calculate_zeta_score`) to get its Zeta Score.
        4.  **Select:** Returns the candidate sequence with the best score.
    *   **File:** `oncology-coPilot/oncology-backend/backend/api/forge.py` (new file)

*   **[ ] Task 3.3: Wire the Frontend to the Forge.**
    *   **Action:** The "Unleash Forge" button calls the `/generate_inhibitor` endpoint.
    *   **UI:** Displays the returned superior protein sequence (`CS-MMPi-001`) and its vastly improved Zeta Score in a final, damning dossier. 

---

## **IV. SAE & EVO2 ‚Äì IMPLEMENTATION PLAN (NON‚ÄëBREAKING)**

**Context:**  
Sparse Autoencoders (SAEs) are *not* baked into Evo2 itself; they are a post‚Äëhoc interpretability layer trained on Evo2‚Äôs internal activations (layer 26). Our current platform uses **proxy SAE features** (DNA repair capacity, 7D mechanism vectors) built from S/P/E + tumor context. We now have the official Evo2 SAE notebook pattern and a plan to bring true SAE in safely.

### **A. Guardrails**

- Do **not** change `/api/efficacy/predict` or WIWFM scoring until SAE infra + validation exist.
- Keep **proxy SAE** in `sae_feature_service.py` as default.
- Introduce true SAE only:
  - Behind feature flags (`ENABLE_EVO2_SAE`, `ENABLE_TRUE_SAE`),
  - With explicit provenance (`provenance.sae = "proxy" | "true" | "proxy+true"`).

### **B. Phase 1 ‚Äì Minimal End‚Äëto‚ÄëEnd SAE Extraction**

1. **Evo2 Activations Endpoint**
   - **Backend (Modal Evo2 service):**
     - Add `score_variant_with_activations(chrom, pos, ref, alt, model_id="evo2_1b", return_activations=True)` in `src/services/evo_service/main.py`.
     - Use existing 8kb window + tokenizer.
     - Call Evo2 `forward(..., return_embeddings=True, layer_names=["blocks-26"])`.
     - Return `{ delta_score, layer_26_activations }`.
   - **Router:**
     - Expose `POST /api/evo/score_variant_with_activations` in `api/routers/evo.py` gated by `ENABLE_EVO2_SAE`.

2. **SAE Model Service (Notebook Pattern)**
   - **Implementation:**
     - Create `api/services/sae_model_service.py` + `src/services/sae_service/main.py`.
     - Implement `ObservableEvo2` + `BatchTopKTiedSAE` exactly as in  
       `scripts/evo2/evo2/notebooks/sparse_autoencoder/sparse_autoencoder.ipynb`.
     - Download SAE weights via `hf_hub_download` (e.g. `Goodfire/Evo-2-Layer-26-Mixed`) at build time; pin repo + filename.
   - **Endpoint:**
     - `POST /api/sae/extract_features`:
       - Input: either `[seq_len, 4096]` activations or `(chrom,pos,ref,alt)`.
       - Output: `{ features[0..32767], top_features, layer: "blocks-26", stats }`.

3. **Wire into `sae_feature_service` (Diagnostics Only)**
   - Extend `compute_sae_features(...)` to accept `sae_features: Optional[Dict] = None`.
   - Behavior:
     - If `sae_features is None`: **no change** (proxy only).
     - If `sae_features` present + `ENABLE_TRUE_SAE=1`:
       - Derive a few aggregate diagnostics (e.g. `ddr_sae_score`, `io_sae_score`) from the 32K vector using a simple, transparent heuristic.
       - Expose as extra fields + provenance only (no scoring changes yet).

### **C. Phase 2 ‚Äì Cohort SAE Extraction & Correlation** üîÑ **SPRINT 1 IN PROGRESS**

- Build:
  - ‚úÖ `scripts/sae/extract_sae_features_cohort.py` (484 lines) ‚Äì processes labeled cohorts (TCGA/cBio) and stores per‚Äëpatient SAE aggregates.
  - ‚úÖ `api/services/biomarker_correlation_service.py` (379 lines) ‚Äì runs feature‚Üîoutcome correlations.
    - Pearson + Spearman correlations, Chi-square, Cohen's d, CV stability, Bootstrap CIs
    - Multiple testing correction (FDR)
    - Top 100 features with p < 0.01, d >= 0.3, CV >= 0.6
  - ‚úÖ `scripts/sae/analyze_biomarkers.py` (163 lines) ‚Äì analysis execution + visualization
  - ‚úÖ `api/routers/sae.py` ‚Äì Added `POST /api/sae/biomarker_summary` RUO endpoint
- Start small:
  - N=100‚Äì200 patients ‚úÖ
  - One outcome (platinum resistance) ‚úÖ
  - Identify top‚ÄëN SAE features with strong, stable associations ‚úÖ

### **D. Phase 3 ‚Äì Cautious Product Integration**

- Before touching WIWFM or Resistance Playbook:
  - Document 10‚Äì20 SAE features with plausible biology + stable signals.
  - Cross‚Äëvalidate on held‚Äëout cohorts.
- Then, under flags:
  - Add SAE‚Äëderived hints to dev/debug panels (e.g. ‚ÄúSAE suggests DDR‚Äëlike signature present‚Äù).
  - If lifts are consistent (5‚Äì10% on relevant tasks):
    - Add small SAE‚Äëbased lifts to internal risk/resistance scoring, with clear RUO copy and full provenance.

**Summary:**  
We now have a concrete, Evo2‚Äënative path to true SAE features (layer 26 ‚Üí `BatchTopKTiedSAE`), but we will introduce it **only as an optional, well‚Äëguarded diagnostic path** first, and only let it influence clinical‚Äëfacing scores after cohort‚Äëlevel validation shows real, stable benefit.