<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CrisPro: Oncology Co-Pilot</title>
  </head>
  <body>
    <div id="root"></div>
    <!-- CRITICAL: Response.headers protection must run BEFORE any modules load -->
    <script>
      // Protect Response.headers access at the earliest possible moment
      // This runs before any ES modules are loaded to catch initialization errors
      (function() {
        'use strict';
        
        if (typeof Response !== 'undefined' && Response.prototype) {
          // Store original headers descriptor if it exists
          const originalDescriptor = Object.getOwnPropertyDescriptor(Response.prototype, 'headers');
          
          // Override headers getter to always return a valid Headers object
          Object.defineProperty(Response.prototype, 'headers', {
            get: function() {
              // Safety check: if this is not a valid Response, return empty Headers
              if (!this || typeof this !== 'object') {
                return new Headers();
              }
              
              // Try to get original headers
              try {
                if (originalDescriptor && originalDescriptor.get) {
                  const headers = originalDescriptor.get.call(this);
                  return headers || new Headers();
                }
                // Fallback: if no original getter, check if headers property exists
                if (this._headers) {
                  return this._headers;
                }
              } catch (e) {
                // If accessing headers fails, return empty Headers
                console.warn('[Response.headers protection] Error accessing headers:', e);
              }
              
              // Last resort: return empty Headers
              return new Headers();
            },
            configurable: true,
            enumerable: true
          });
        }
        
        // Also protect fetch to ensure all responses have headers
        if (typeof window !== 'undefined' && window.fetch) {
          const originalFetch = window.fetch;
          window.fetch = function(...args) {
            const promise = originalFetch.apply(this, args);
            return promise.then(function(response) {
              // Ensure response has headers property
              if (response && !response.headers) {
                try {
                  Object.defineProperty(response, 'headers', {
                    value: new Headers(),
                    writable: false,
                    configurable: true
                  });
                } catch (e) {
                  console.warn('[Fetch protection] Could not add headers to response:', e);
                }
              }
              return response;
            }).catch(function(error) {
              console.error('[Fetch protection] Fetch error:', error);
              throw error;
            });
          };
        }
      })();
    </script>
    <script type="module" src="/src/main.jsx"></script>
  </body>
</html>
