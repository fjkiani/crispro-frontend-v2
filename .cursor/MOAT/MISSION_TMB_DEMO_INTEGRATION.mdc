# Mission: TMB Prediction Demo Integration

> **Priority**: High | **Estimated Time**: 2-4 hours | **Dependencies**: None

---

## Mission Objective

Create a demo-ready TMB (Tumor Mutational Burden) prediction feature that showcases our validated biomarker calculation capability. Integrate into existing MOAT demo infrastructure.

---

## Background

TMB prediction has been validated against external TCGA ground truth:
- **Pearson r**: 0.933
- **Classification Accuracy**: 95.4%
- **Source**: TCGA Pan-Immune Publication (`mutation-load_updated.txt`)

This capability enables IO (immunotherapy) eligibility prediction and enhances trial matching.

---

## Deliverables

### 1. Streamlit Demo Enhancement

**File**: `demos/moat_demo.py` (enhance existing) OR `demos/tmb_demo.py` (new)

**Features**:
```python
# Tab: TMB Prediction
st.header("ðŸ§¬ TMB Prediction")

# Input: Upload mutations or use sample
mutation_input = st.selectbox("Sample Patient", [
    "Ayesha (MBD4+TP53)",
    "High-TMB Melanoma", 
    "Low-TMB Ovarian",
    "Custom Input"
])

# Output: TMB calculation with validation badge
st.metric("TMB", f"{tmb:.2f} mut/Mb", delta="TMB-H" if tmb >= 10 else "TMB-L")
st.success("âœ… Validated: r=0.933, Accuracy=95.4%")

# Visualization: Cancer-type breakdown
fig = px.bar(cancer_type_df, x='cancer_type', y='correlation', 
             title='Validation by Cancer Type')
st.plotly_chart(fig)
```

### 2. API Endpoint

**File**: `api/routers/biomarkers.py` (new)

**Endpoint**:
```python
@router.post("/api/biomarkers/tmb")
async def calculate_tmb(request: TMBRequest):
    """
    Calculate TMB from mutation list.
    
    Request:
        mutations: List[MutationDict]
        exome_size_mb: Optional[float] = 38.0
    
    Response:
        tmb: float
        tmb_classification: str ("TMB-H" or "TMB-L")
        io_eligible: bool
        confidence: float
        validation_source: str
    """
    tmb = calculate_tmb_from_mutations(request.mutations, request.exome_size_mb)
    return {
        "tmb": tmb,
        "tmb_classification": "TMB-H" if tmb >= 10.0 else "TMB-L",
        "io_eligible": tmb >= 10.0,
        "confidence": 0.954,
        "validation_source": "TCGA Pan-Immune (r=0.933)"
    }
```

### 3. Validation Visualization Component

**File**: `demos/components/tmb_validation_chart.py` (new)

**Features**:
- Correlation scatter plot (Our TMB vs Ground Truth TMB)
- Confusion matrix heatmap
- Cancer-type breakdown bar chart
- ROC curve (if applicable)

### 4. Integration with Mechanism Vector

**File**: `api/services/pathway_to_mechanism_vector.py` (enhance)

**Enhancement**:
```python
def convert_pathway_scores_to_mechanism_vector(
    pathway_scores: Dict,
    tmb: Optional[float] = None,  # NEW: Use validated TMB
    msi_status: Optional[str] = None
) -> List[float]:
    # ...existing code...
    
    # IO pathway from validated TMB
    io_score = 1.0 if (tmb and tmb >= 10.0) or msi_status == "MSI-High" else 0.0
    
    return [ddr, mapk, pi3k, vegf, her2, io_score, efflux]
```

---

## Implementation Steps

### Step 1: Extend Streamlit Demo (30 min)

1. Open `demos/moat_demo.py`
2. Add new tab: "ðŸ§¬ TMB Prediction"
3. Implement TMB calculation UI
4. Add validation badge
5. Add sample patients (Ayesha, high-TMB, low-TMB)

### Step 2: Create API Endpoint (30 min)

1. Create `api/routers/biomarkers.py`
2. Define `TMBRequest` and `TMBResponse` models
3. Implement `/api/biomarkers/tmb` endpoint
4. Wire to existing `tmb_calculator.py`
5. Add to router in `api/main.py`

### Step 3: Create Validation Visualization (45 min)

1. Create `demos/components/` directory if not exists
2. Create `tmb_validation_chart.py`
3. Load validation results from `data/validation/tmb_validation_results.json`
4. Create Plotly visualizations:
   - Scatter plot: Our TMB vs GT TMB
   - Bar chart: Cancer-type breakdown
   - Confusion matrix heatmap
5. Integrate into Streamlit demo

### Step 4: Integrate with Mechanism Vector (30 min)

1. Open `api/services/pathway_to_mechanism_vector.py`
2. Add `tmb` parameter to conversion function
3. Set IO pathway = 1.0 if TMB â‰¥ 10.0
4. Update callers to pass TMB

### Step 5: Create Demo Data (15 min)

1. Create sample patient files:
   - `demos/data/ayesha_mutations.json`
   - `demos/data/high_tmb_melanoma.json`
   - `demos/data/low_tmb_ovarian.json`
2. Include ~50-200 mutations per patient
3. Pre-calculate expected TMB for validation

### Step 6: Test & Document (30 min)

1. Run Streamlit demo locally
2. Test all sample patients
3. Verify validation metrics display
4. Update `demos/README.md`
5. Add screenshots for documentation

---

## Files to Create/Modify

| File | Action | Description |
|------|--------|-------------|
| `demos/moat_demo.py` | Modify | Add TMB tab |
| `api/routers/biomarkers.py` | Create | TMB API endpoint |
| `demos/components/tmb_validation_chart.py` | Create | Validation visualizations |
| `api/services/pathway_to_mechanism_vector.py` | Modify | Add TMB parameter |
| `demos/data/ayesha_mutations.json` | Create | Sample patient data |
| `demos/data/high_tmb_melanoma.json` | Create | Sample patient data |
| `demos/data/low_tmb_ovarian.json` | Create | Sample patient data |
| `demos/README.md` | Modify | Update documentation |

---

## Dependencies

**Python Packages** (already in `demos/requirements_demo.txt`):
- streamlit
- numpy
- plotly (add if not present)
- pandas

**Internal Modules**:
- `scripts/data_acquisition/utils/tmb_calculator.py`
- `data/validation/tmb_validation_results.json`

---

## Acceptance Criteria

- [ ] TMB demo tab visible in Streamlit app
- [ ] Sample patients load correctly
- [ ] TMB calculation matches expected values
- [ ] Validation metrics (r=0.933, 95.4%) displayed
- [ ] Cancer-type breakdown chart renders
- [ ] API endpoint returns correct response
- [ ] Mechanism vector includes validated IO pathway
- [ ] Documentation updated

---

## Sample Demo Output

```
ðŸ§¬ TMB PREDICTION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Patient: Ayesha (MBD4 + TP53)
Mutations: 156 nonsynonymous mutations
Exome Size: 38 Mb

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  TMB: 4.11 mut/Mb                                           â”‚
â”‚  Classification: TMB-L                                      â”‚
â”‚  IO Eligible: No                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

âœ… Validated against TCGA Pan-Immune (n=1,895)
   Pearson r: 0.933 | Accuracy: 95.4%

ðŸ“Š Validation by Cancer Type:
   Colorectal:  r=+0.989, Acc=100.0%
   Endometrial: r=+0.946, Acc=98.3%
   Melanoma:    r=+0.843, Acc=83.8%
   Ovarian:     r=+0.475, Acc=99.5%

ðŸ”— Mechanism Vector Integration:
   IO Pathway: 0.0 (TMB-L â†’ IO not eligible)
   Trial Matching: Checkpoint inhibitor trials deprioritized
```

---

## Notes for Agent

1. **Prioritize Streamlit demo** - Most visible for application/demo
2. **Use existing infrastructure** - Build on `tmb_calculator.py`, don't recreate
3. **Show validation prominently** - The r=0.933 is the key differentiator
4. **Keep it simple** - Focus on TMB-H/TMB-L classification, not complex stats
5. **Test with real data** - Use Ayesha's mutation profile as primary example

---

## Related Documents

- `.cursor/ayesha/IO_VALIDATION_PLAN.md` - Full validation methodology
- `.cursor/MOAT/Platform-capabilities.md` - Capability overview
- `scripts/validation/validate_tmb_against_ground_truth.py` - Validation script
- `data/validation/tmb_validation_results.json` - Validation results

---
---

## Mission Objective

Create a demo-ready TMB (Tumor Mutational Burden) prediction feature that showcases our validated biomarker calculation capability. Integrate into existing MOAT demo infrastructure.

---

## Background

TMB prediction has been validated against external TCGA ground truth:
- **Pearson r**: 0.933
- **Classification Accuracy**: 95.4%
- **Source**: TCGA Pan-Immune Publication (`mutation-load_updated.txt`)

This capability enables IO (immunotherapy) eligibility prediction and enhances trial matching.

---

## Deliverables

### 1. Streamlit Demo Enhancement

**File**: `demos/moat_demo.py` (enhance existing) OR `demos/tmb_demo.py` (new)

**Features**:
```python
# Tab: TMB Prediction
st.header("ðŸ§¬ TMB Prediction")

# Input: Upload mutations or use sample
mutation_input = st.selectbox("Sample Patient", [
    "Ayesha (MBD4+TP53)",
    "High-TMB Melanoma", 
    "Low-TMB Ovarian",
    "Custom Input"
])

# Output: TMB calculation with validation badge
st.metric("TMB", f"{tmb:.2f} mut/Mb", delta="TMB-H" if tmb >= 10 else "TMB-L")
st.success("âœ… Validated: r=0.933, Accuracy=95.4%")

# Visualization: Cancer-type breakdown
fig = px.bar(cancer_type_df, x='cancer_type', y='correlation', 
             title='Validation by Cancer Type')
st.plotly_chart(fig)
```

### 2. API Endpoint

**File**: `api/routers/biomarkers.py` (new)

**Endpoint**:
```python
@router.post("/api/biomarkers/tmb")
async def calculate_tmb(request: TMBRequest):
    """
    Calculate TMB from mutation list.
    
    Request:
        mutations: List[MutationDict]
        exome_size_mb: Optional[float] = 38.0
    
    Response:
        tmb: float
        tmb_classification: str ("TMB-H" or "TMB-L")
        io_eligible: bool
        confidence: float
        validation_source: str
    """
    tmb = calculate_tmb_from_mutations(request.mutations, request.exome_size_mb)
    return {
        "tmb": tmb,
        "tmb_classification": "TMB-H" if tmb >= 10.0 else "TMB-L",
        "io_eligible": tmb >= 10.0,
        "confidence": 0.954,
        "validation_source": "TCGA Pan-Immune (r=0.933)"
    }
```

### 3. Validation Visualization Component

**File**: `demos/components/tmb_validation_chart.py` (new)

**Features**:
- Correlation scatter plot (Our TMB vs Ground Truth TMB)
- Confusion matrix heatmap
- Cancer-type breakdown bar chart
- ROC curve (if applicable)

### 4. Integration with Mechanism Vector

**File**: `api/services/pathway_to_mechanism_vector.py` (enhance)

**Enhancement**:
```python
def convert_pathway_scores_to_mechanism_vector(
    pathway_scores: Dict,
    tmb: Optional[float] = None,  # NEW: Use validated TMB
    msi_status: Optional[str] = None
) -> List[float]:
    # ...existing code...
    
    # IO pathway from validated TMB
    io_score = 1.0 if (tmb and tmb >= 10.0) or msi_status == "MSI-High" else 0.0
    
    return [ddr, mapk, pi3k, vegf, her2, io_score, efflux]
```

---

## Implementation Steps

### Step 1: Extend Streamlit Demo (30 min)

1. Open `demos/moat_demo.py`
2. Add new tab: "ðŸ§¬ TMB Prediction"
3. Implement TMB calculation UI
4. Add validation badge
5. Add sample patients (Ayesha, high-TMB, low-TMB)

### Step 2: Create API Endpoint (30 min)

1. Create `api/routers/biomarkers.py`
2. Define `TMBRequest` and `TMBResponse` models
3. Implement `/api/biomarkers/tmb` endpoint
4. Wire to existing `tmb_calculator.py`
5. Add to router in `api/main.py`

### Step 3: Create Validation Visualization (45 min)

1. Create `demos/components/` directory if not exists
2. Create `tmb_validation_chart.py`
3. Load validation results from `data/validation/tmb_validation_results.json`
4. Create Plotly visualizations:
   - Scatter plot: Our TMB vs GT TMB
   - Bar chart: Cancer-type breakdown
   - Confusion matrix heatmap
5. Integrate into Streamlit demo

### Step 4: Integrate with Mechanism Vector (30 min)

1. Open `api/services/pathway_to_mechanism_vector.py`
2. Add `tmb` parameter to conversion function
3. Set IO pathway = 1.0 if TMB â‰¥ 10.0
4. Update callers to pass TMB

### Step 5: Create Demo Data (15 min)

1. Create sample patient files:
   - `demos/data/ayesha_mutations.json`
   - `demos/data/high_tmb_melanoma.json`
   - `demos/data/low_tmb_ovarian.json`
2. Include ~50-200 mutations per patient
3. Pre-calculate expected TMB for validation

### Step 6: Test & Document (30 min)

1. Run Streamlit demo locally
2. Test all sample patients
3. Verify validation metrics display
4. Update `demos/README.md`
5. Add screenshots for documentation

---

## Files to Create/Modify

| File | Action | Description |
|------|--------|-------------|
| `demos/moat_demo.py` | Modify | Add TMB tab |
| `api/routers/biomarkers.py` | Create | TMB API endpoint |
| `demos/components/tmb_validation_chart.py` | Create | Validation visualizations |
| `api/services/pathway_to_mechanism_vector.py` | Modify | Add TMB parameter |
| `demos/data/ayesha_mutations.json` | Create | Sample patient data |
| `demos/data/high_tmb_melanoma.json` | Create | Sample patient data |
| `demos/data/low_tmb_ovarian.json` | Create | Sample patient data |
| `demos/README.md` | Modify | Update documentation |

---

## Dependencies

**Python Packages** (already in `demos/requirements_demo.txt`):
- streamlit
- numpy
- plotly (add if not present)
- pandas

**Internal Modules**:
- `scripts/data_acquisition/utils/tmb_calculator.py`
- `data/validation/tmb_validation_results.json`

---

## Acceptance Criteria

- [ ] TMB demo tab visible in Streamlit app
- [ ] Sample patients load correctly
- [ ] TMB calculation matches expected values
- [ ] Validation metrics (r=0.933, 95.4%) displayed
- [ ] Cancer-type breakdown chart renders
- [ ] API endpoint returns correct response
- [ ] Mechanism vector includes validated IO pathway
- [ ] Documentation updated

---

## Sample Demo Output

```
ðŸ§¬ TMB PREDICTION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Patient: Ayesha (MBD4 + TP53)
Mutations: 156 nonsynonymous mutations
Exome Size: 38 Mb

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  TMB: 4.11 mut/Mb                                           â”‚
â”‚  Classification: TMB-L                                      â”‚
â”‚  IO Eligible: No                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

âœ… Validated against TCGA Pan-Immune (n=1,895)
   Pearson r: 0.933 | Accuracy: 95.4%

ðŸ“Š Validation by Cancer Type:
   Colorectal:  r=+0.989, Acc=100.0%
   Endometrial: r=+0.946, Acc=98.3%
   Melanoma:    r=+0.843, Acc=83.8%
   Ovarian:     r=+0.475, Acc=99.5%

ðŸ”— Mechanism Vector Integration:
   IO Pathway: 0.0 (TMB-L â†’ IO not eligible)
   Trial Matching: Checkpoint inhibitor trials deprioritized
```

---

## Notes for Agent

1. **Prioritize Streamlit demo** - Most visible for application/demo
2. **Use existing infrastructure** - Build on `tmb_calculator.py`, don't recreate
3. **Show validation prominently** - The r=0.933 is the key differentiator
4. **Keep it simple** - Focus on TMB-H/TMB-L classification, not complex stats
5. **Test with real data** - Use Ayesha's mutation profile as primary example

---

## Related Documents

- `.cursor/ayesha/IO_VALIDATION_PLAN.md` - Full validation methodology
- `.cursor/MOAT/Platform-capabilities.md` - Capability overview
- `scripts/validation/validate_tmb_against_ground_truth.py` - Validation script
- `data/validation/tmb_validation_results.json` - Validation results

---
---

## Mission Objective

Create a demo-ready TMB (Tumor Mutational Burden) prediction feature that showcases our validated biomarker calculation capability. Integrate into existing MOAT demo infrastructure.

---

## Background

TMB prediction has been validated against external TCGA ground truth:
- **Pearson r**: 0.933
- **Classification Accuracy**: 95.4%
- **Source**: TCGA Pan-Immune Publication (`mutation-load_updated.txt`)

This capability enables IO (immunotherapy) eligibility prediction and enhances trial matching.

---

## Deliverables

### 1. Streamlit Demo Enhancement

**File**: `demos/moat_demo.py` (enhance existing) OR `demos/tmb_demo.py` (new)

**Features**:
```python
# Tab: TMB Prediction
st.header("ðŸ§¬ TMB Prediction")

# Input: Upload mutations or use sample
mutation_input = st.selectbox("Sample Patient", [
    "Ayesha (MBD4+TP53)",
    "High-TMB Melanoma", 
    "Low-TMB Ovarian",
    "Custom Input"
])

# Output: TMB calculation with validation badge
st.metric("TMB", f"{tmb:.2f} mut/Mb", delta="TMB-H" if tmb >= 10 else "TMB-L")
st.success("âœ… Validated: r=0.933, Accuracy=95.4%")

# Visualization: Cancer-type breakdown
fig = px.bar(cancer_type_df, x='cancer_type', y='correlation', 
             title='Validation by Cancer Type')
st.plotly_chart(fig)
```

### 2. API Endpoint

**File**: `api/routers/biomarkers.py` (new)

**Endpoint**:
```python
@router.post("/api/biomarkers/tmb")
async def calculate_tmb(request: TMBRequest):
    """
    Calculate TMB from mutation list.
    
    Request:
        mutations: List[MutationDict]
        exome_size_mb: Optional[float] = 38.0
    
    Response:
        tmb: float
        tmb_classification: str ("TMB-H" or "TMB-L")
        io_eligible: bool
        confidence: float
        validation_source: str
    """
    tmb = calculate_tmb_from_mutations(request.mutations, request.exome_size_mb)
    return {
        "tmb": tmb,
        "tmb_classification": "TMB-H" if tmb >= 10.0 else "TMB-L",
        "io_eligible": tmb >= 10.0,
        "confidence": 0.954,
        "validation_source": "TCGA Pan-Immune (r=0.933)"
    }
```

### 3. Validation Visualization Component

**File**: `demos/components/tmb_validation_chart.py` (new)

**Features**:
- Correlation scatter plot (Our TMB vs Ground Truth TMB)
- Confusion matrix heatmap
- Cancer-type breakdown bar chart
- ROC curve (if applicable)

### 4. Integration with Mechanism Vector

**File**: `api/services/pathway_to_mechanism_vector.py` (enhance)

**Enhancement**:
```python
def convert_pathway_scores_to_mechanism_vector(
    pathway_scores: Dict,
    tmb: Optional[float] = None,  # NEW: Use validated TMB
    msi_status: Optional[str] = None
) -> List[float]:
    # ...existing code...
    
    # IO pathway from validated TMB
    io_score = 1.0 if (tmb and tmb >= 10.0) or msi_status == "MSI-High" else 0.0
    
    return [ddr, mapk, pi3k, vegf, her2, io_score, efflux]
```

---

## Implementation Steps

### Step 1: Extend Streamlit Demo (30 min)

1. Open `demos/moat_demo.py`
2. Add new tab: "ðŸ§¬ TMB Prediction"
3. Implement TMB calculation UI
4. Add validation badge
5. Add sample patients (Ayesha, high-TMB, low-TMB)

### Step 2: Create API Endpoint (30 min)

1. Create `api/routers/biomarkers.py`
2. Define `TMBRequest` and `TMBResponse` models
3. Implement `/api/biomarkers/tmb` endpoint
4. Wire to existing `tmb_calculator.py`
5. Add to router in `api/main.py`

### Step 3: Create Validation Visualization (45 min)

1. Create `demos/components/` directory if not exists
2. Create `tmb_validation_chart.py`
3. Load validation results from `data/validation/tmb_validation_results.json`
4. Create Plotly visualizations:
   - Scatter plot: Our TMB vs GT TMB
   - Bar chart: Cancer-type breakdown
   - Confusion matrix heatmap
5. Integrate into Streamlit demo

### Step 4: Integrate with Mechanism Vector (30 min)

1. Open `api/services/pathway_to_mechanism_vector.py`
2. Add `tmb` parameter to conversion function
3. Set IO pathway = 1.0 if TMB â‰¥ 10.0
4. Update callers to pass TMB

### Step 5: Create Demo Data (15 min)

1. Create sample patient files:
   - `demos/data/ayesha_mutations.json`
   - `demos/data/high_tmb_melanoma.json`
   - `demos/data/low_tmb_ovarian.json`
2. Include ~50-200 mutations per patient
3. Pre-calculate expected TMB for validation

### Step 6: Test & Document (30 min)

1. Run Streamlit demo locally
2. Test all sample patients
3. Verify validation metrics display
4. Update `demos/README.md`
5. Add screenshots for documentation

---

## Files to Create/Modify

| File | Action | Description |
|------|--------|-------------|
| `demos/moat_demo.py` | Modify | Add TMB tab |
| `api/routers/biomarkers.py` | Create | TMB API endpoint |
| `demos/components/tmb_validation_chart.py` | Create | Validation visualizations |
| `api/services/pathway_to_mechanism_vector.py` | Modify | Add TMB parameter |
| `demos/data/ayesha_mutations.json` | Create | Sample patient data |
| `demos/data/high_tmb_melanoma.json` | Create | Sample patient data |
| `demos/data/low_tmb_ovarian.json` | Create | Sample patient data |
| `demos/README.md` | Modify | Update documentation |

---

## Dependencies

**Python Packages** (already in `demos/requirements_demo.txt`):
- streamlit
- numpy
- plotly (add if not present)
- pandas

**Internal Modules**:
- `scripts/data_acquisition/utils/tmb_calculator.py`
- `data/validation/tmb_validation_results.json`

---

## Acceptance Criteria

- [ ] TMB demo tab visible in Streamlit app
- [ ] Sample patients load correctly
- [ ] TMB calculation matches expected values
- [ ] Validation metrics (r=0.933, 95.4%) displayed
- [ ] Cancer-type breakdown chart renders
- [ ] API endpoint returns correct response
- [ ] Mechanism vector includes validated IO pathway
- [ ] Documentation updated

---

## Sample Demo Output

```
ðŸ§¬ TMB PREDICTION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Patient: Ayesha (MBD4 + TP53)
Mutations: 156 nonsynonymous mutations
Exome Size: 38 Mb

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  TMB: 4.11 mut/Mb                                           â”‚
â”‚  Classification: TMB-L                                      â”‚
â”‚  IO Eligible: No                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

âœ… Validated against TCGA Pan-Immune (n=1,895)
   Pearson r: 0.933 | Accuracy: 95.4%

ðŸ“Š Validation by Cancer Type:
   Colorectal:  r=+0.989, Acc=100.0%
   Endometrial: r=+0.946, Acc=98.3%
   Melanoma:    r=+0.843, Acc=83.8%
   Ovarian:     r=+0.475, Acc=99.5%

ðŸ”— Mechanism Vector Integration:
   IO Pathway: 0.0 (TMB-L â†’ IO not eligible)
   Trial Matching: Checkpoint inhibitor trials deprioritized
```

---

## Notes for Agent

1. **Prioritize Streamlit demo** - Most visible for application/demo
2. **Use existing infrastructure** - Build on `tmb_calculator.py`, don't recreate
3. **Show validation prominently** - The r=0.933 is the key differentiator
4. **Keep it simple** - Focus on TMB-H/TMB-L classification, not complex stats
5. **Test with real data** - Use Ayesha's mutation profile as primary example

---

## Related Documents

- `.cursor/ayesha/IO_VALIDATION_PLAN.md` - Full validation methodology
- `.cursor/MOAT/Platform-capabilities.md` - Capability overview
- `scripts/validation/validate_tmb_against_ground_truth.py` - Validation script
- `data/validation/tmb_validation_results.json` - Validation results

---
---

## Mission Objective

Create a demo-ready TMB (Tumor Mutational Burden) prediction feature that showcases our validated biomarker calculation capability. Integrate into existing MOAT demo infrastructure.

---

## Background

TMB prediction has been validated against external TCGA ground truth:
- **Pearson r**: 0.933
- **Classification Accuracy**: 95.4%
- **Source**: TCGA Pan-Immune Publication (`mutation-load_updated.txt`)

This capability enables IO (immunotherapy) eligibility prediction and enhances trial matching.

---

## Deliverables

### 1. Streamlit Demo Enhancement

**File**: `demos/moat_demo.py` (enhance existing) OR `demos/tmb_demo.py` (new)

**Features**:
```python
# Tab: TMB Prediction
st.header("ðŸ§¬ TMB Prediction")

# Input: Upload mutations or use sample
mutation_input = st.selectbox("Sample Patient", [
    "Ayesha (MBD4+TP53)",
    "High-TMB Melanoma", 
    "Low-TMB Ovarian",
    "Custom Input"
])

# Output: TMB calculation with validation badge
st.metric("TMB", f"{tmb:.2f} mut/Mb", delta="TMB-H" if tmb >= 10 else "TMB-L")
st.success("âœ… Validated: r=0.933, Accuracy=95.4%")

# Visualization: Cancer-type breakdown
fig = px.bar(cancer_type_df, x='cancer_type', y='correlation', 
             title='Validation by Cancer Type')
st.plotly_chart(fig)
```

### 2. API Endpoint

**File**: `api/routers/biomarkers.py` (new)

**Endpoint**:
```python
@router.post("/api/biomarkers/tmb")
async def calculate_tmb(request: TMBRequest):
    """
    Calculate TMB from mutation list.
    
    Request:
        mutations: List[MutationDict]
        exome_size_mb: Optional[float] = 38.0
    
    Response:
        tmb: float
        tmb_classification: str ("TMB-H" or "TMB-L")
        io_eligible: bool
        confidence: float
        validation_source: str
    """
    tmb = calculate_tmb_from_mutations(request.mutations, request.exome_size_mb)
    return {
        "tmb": tmb,
        "tmb_classification": "TMB-H" if tmb >= 10.0 else "TMB-L",
        "io_eligible": tmb >= 10.0,
        "confidence": 0.954,
        "validation_source": "TCGA Pan-Immune (r=0.933)"
    }
```

### 3. Validation Visualization Component

**File**: `demos/components/tmb_validation_chart.py` (new)

**Features**:
- Correlation scatter plot (Our TMB vs Ground Truth TMB)
- Confusion matrix heatmap
- Cancer-type breakdown bar chart
- ROC curve (if applicable)

### 4. Integration with Mechanism Vector

**File**: `api/services/pathway_to_mechanism_vector.py` (enhance)

**Enhancement**:
```python
def convert_pathway_scores_to_mechanism_vector(
    pathway_scores: Dict,
    tmb: Optional[float] = None,  # NEW: Use validated TMB
    msi_status: Optional[str] = None
) -> List[float]:
    # ...existing code...
    
    # IO pathway from validated TMB
    io_score = 1.0 if (tmb and tmb >= 10.0) or msi_status == "MSI-High" else 0.0
    
    return [ddr, mapk, pi3k, vegf, her2, io_score, efflux]
```

---

## Implementation Steps

### Step 1: Extend Streamlit Demo (30 min)

1. Open `demos/moat_demo.py`
2. Add new tab: "ðŸ§¬ TMB Prediction"
3. Implement TMB calculation UI
4. Add validation badge
5. Add sample patients (Ayesha, high-TMB, low-TMB)

### Step 2: Create API Endpoint (30 min)

1. Create `api/routers/biomarkers.py`
2. Define `TMBRequest` and `TMBResponse` models
3. Implement `/api/biomarkers/tmb` endpoint
4. Wire to existing `tmb_calculator.py`
5. Add to router in `api/main.py`

### Step 3: Create Validation Visualization (45 min)

1. Create `demos/components/` directory if not exists
2. Create `tmb_validation_chart.py`
3. Load validation results from `data/validation/tmb_validation_results.json`
4. Create Plotly visualizations:
   - Scatter plot: Our TMB vs GT TMB
   - Bar chart: Cancer-type breakdown
   - Confusion matrix heatmap
5. Integrate into Streamlit demo

### Step 4: Integrate with Mechanism Vector (30 min)

1. Open `api/services/pathway_to_mechanism_vector.py`
2. Add `tmb` parameter to conversion function
3. Set IO pathway = 1.0 if TMB â‰¥ 10.0
4. Update callers to pass TMB

### Step 5: Create Demo Data (15 min)

1. Create sample patient files:
   - `demos/data/ayesha_mutations.json`
   - `demos/data/high_tmb_melanoma.json`
   - `demos/data/low_tmb_ovarian.json`
2. Include ~50-200 mutations per patient
3. Pre-calculate expected TMB for validation

### Step 6: Test & Document (30 min)

1. Run Streamlit demo locally
2. Test all sample patients
3. Verify validation metrics display
4. Update `demos/README.md`
5. Add screenshots for documentation

---

## Files to Create/Modify

| File | Action | Description |
|------|--------|-------------|
| `demos/moat_demo.py` | Modify | Add TMB tab |
| `api/routers/biomarkers.py` | Create | TMB API endpoint |
| `demos/components/tmb_validation_chart.py` | Create | Validation visualizations |
| `api/services/pathway_to_mechanism_vector.py` | Modify | Add TMB parameter |
| `demos/data/ayesha_mutations.json` | Create | Sample patient data |
| `demos/data/high_tmb_melanoma.json` | Create | Sample patient data |
| `demos/data/low_tmb_ovarian.json` | Create | Sample patient data |
| `demos/README.md` | Modify | Update documentation |

---

## Dependencies

**Python Packages** (already in `demos/requirements_demo.txt`):
- streamlit
- numpy
- plotly (add if not present)
- pandas

**Internal Modules**:
- `scripts/data_acquisition/utils/tmb_calculator.py`
- `data/validation/tmb_validation_results.json`

---

## Acceptance Criteria

- [ ] TMB demo tab visible in Streamlit app
- [ ] Sample patients load correctly
- [ ] TMB calculation matches expected values
- [ ] Validation metrics (r=0.933, 95.4%) displayed
- [ ] Cancer-type breakdown chart renders
- [ ] API endpoint returns correct response
- [ ] Mechanism vector includes validated IO pathway
- [ ] Documentation updated

---

## Sample Demo Output

```
ðŸ§¬ TMB PREDICTION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Patient: Ayesha (MBD4 + TP53)
Mutations: 156 nonsynonymous mutations
Exome Size: 38 Mb

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  TMB: 4.11 mut/Mb                                           â”‚
â”‚  Classification: TMB-L                                      â”‚
â”‚  IO Eligible: No                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

âœ… Validated against TCGA Pan-Immune (n=1,895)
   Pearson r: 0.933 | Accuracy: 95.4%

ðŸ“Š Validation by Cancer Type:
   Colorectal:  r=+0.989, Acc=100.0%
   Endometrial: r=+0.946, Acc=98.3%
   Melanoma:    r=+0.843, Acc=83.8%
   Ovarian:     r=+0.475, Acc=99.5%

ðŸ”— Mechanism Vector Integration:
   IO Pathway: 0.0 (TMB-L â†’ IO not eligible)
   Trial Matching: Checkpoint inhibitor trials deprioritized
```

---

## Notes for Agent

1. **Prioritize Streamlit demo** - Most visible for application/demo
2. **Use existing infrastructure** - Build on `tmb_calculator.py`, don't recreate
3. **Show validation prominently** - The r=0.933 is the key differentiator
4. **Keep it simple** - Focus on TMB-H/TMB-L classification, not complex stats
5. **Test with real data** - Use Ayesha's mutation profile as primary example

---

## Related Documents

- `.cursor/ayesha/IO_VALIDATION_PLAN.md` - Full validation methodology
- `.cursor/MOAT/Platform-capabilities.md` - Capability overview
- `scripts/validation/validate_tmb_against_ground_truth.py` - Validation script
- `data/validation/tmb_validation_results.json` - Validation results

---
---

## Mission Objective

Create a demo-ready TMB (Tumor Mutational Burden) prediction feature that showcases our validated biomarker calculation capability. Integrate into existing MOAT demo infrastructure.

---

## Background

TMB prediction has been validated against external TCGA ground truth:
- **Pearson r**: 0.933
- **Classification Accuracy**: 95.4%
- **Source**: TCGA Pan-Immune Publication (`mutation-load_updated.txt`)

This capability enables IO (immunotherapy) eligibility prediction and enhances trial matching.

---

## Deliverables

### 1. Streamlit Demo Enhancement

**File**: `demos/moat_demo.py` (enhance existing) OR `demos/tmb_demo.py` (new)

**Features**:
```python
# Tab: TMB Prediction
st.header("ðŸ§¬ TMB Prediction")

# Input: Upload mutations or use sample
mutation_input = st.selectbox("Sample Patient", [
    "Ayesha (MBD4+TP53)",
    "High-TMB Melanoma", 
    "Low-TMB Ovarian",
    "Custom Input"
])

# Output: TMB calculation with validation badge
st.metric("TMB", f"{tmb:.2f} mut/Mb", delta="TMB-H" if tmb >= 10 else "TMB-L")
st.success("âœ… Validated: r=0.933, Accuracy=95.4%")

# Visualization: Cancer-type breakdown
fig = px.bar(cancer_type_df, x='cancer_type', y='correlation', 
             title='Validation by Cancer Type')
st.plotly_chart(fig)
```

### 2. API Endpoint

**File**: `api/routers/biomarkers.py` (new)

**Endpoint**:
```python
@router.post("/api/biomarkers/tmb")
async def calculate_tmb(request: TMBRequest):
    """
    Calculate TMB from mutation list.
    
    Request:
        mutations: List[MutationDict]
        exome_size_mb: Optional[float] = 38.0
    
    Response:
        tmb: float
        tmb_classification: str ("TMB-H" or "TMB-L")
        io_eligible: bool
        confidence: float
        validation_source: str
    """
    tmb = calculate_tmb_from_mutations(request.mutations, request.exome_size_mb)
    return {
        "tmb": tmb,
        "tmb_classification": "TMB-H" if tmb >= 10.0 else "TMB-L",
        "io_eligible": tmb >= 10.0,
        "confidence": 0.954,
        "validation_source": "TCGA Pan-Immune (r=0.933)"
    }
```

### 3. Validation Visualization Component

**File**: `demos/components/tmb_validation_chart.py` (new)

**Features**:
- Correlation scatter plot (Our TMB vs Ground Truth TMB)
- Confusion matrix heatmap
- Cancer-type breakdown bar chart
- ROC curve (if applicable)

### 4. Integration with Mechanism Vector

**File**: `api/services/pathway_to_mechanism_vector.py` (enhance)

**Enhancement**:
```python
def convert_pathway_scores_to_mechanism_vector(
    pathway_scores: Dict,
    tmb: Optional[float] = None,  # NEW: Use validated TMB
    msi_status: Optional[str] = None
) -> List[float]:
    # ...existing code...
    
    # IO pathway from validated TMB
    io_score = 1.0 if (tmb and tmb >= 10.0) or msi_status == "MSI-High" else 0.0
    
    return [ddr, mapk, pi3k, vegf, her2, io_score, efflux]
```

---

## Implementation Steps

### Step 1: Extend Streamlit Demo (30 min)

1. Open `demos/moat_demo.py`
2. Add new tab: "ðŸ§¬ TMB Prediction"
3. Implement TMB calculation UI
4. Add validation badge
5. Add sample patients (Ayesha, high-TMB, low-TMB)

### Step 2: Create API Endpoint (30 min)

1. Create `api/routers/biomarkers.py`
2. Define `TMBRequest` and `TMBResponse` models
3. Implement `/api/biomarkers/tmb` endpoint
4. Wire to existing `tmb_calculator.py`
5. Add to router in `api/main.py`

### Step 3: Create Validation Visualization (45 min)

1. Create `demos/components/` directory if not exists
2. Create `tmb_validation_chart.py`
3. Load validation results from `data/validation/tmb_validation_results.json`
4. Create Plotly visualizations:
   - Scatter plot: Our TMB vs GT TMB
   - Bar chart: Cancer-type breakdown
   - Confusion matrix heatmap
5. Integrate into Streamlit demo

### Step 4: Integrate with Mechanism Vector (30 min)

1. Open `api/services/pathway_to_mechanism_vector.py`
2. Add `tmb` parameter to conversion function
3. Set IO pathway = 1.0 if TMB â‰¥ 10.0
4. Update callers to pass TMB

### Step 5: Create Demo Data (15 min)

1. Create sample patient files:
   - `demos/data/ayesha_mutations.json`
   - `demos/data/high_tmb_melanoma.json`
   - `demos/data/low_tmb_ovarian.json`
2. Include ~50-200 mutations per patient
3. Pre-calculate expected TMB for validation

### Step 6: Test & Document (30 min)

1. Run Streamlit demo locally
2. Test all sample patients
3. Verify validation metrics display
4. Update `demos/README.md`
5. Add screenshots for documentation

---

## Files to Create/Modify

| File | Action | Description |
|------|--------|-------------|
| `demos/moat_demo.py` | Modify | Add TMB tab |
| `api/routers/biomarkers.py` | Create | TMB API endpoint |
| `demos/components/tmb_validation_chart.py` | Create | Validation visualizations |
| `api/services/pathway_to_mechanism_vector.py` | Modify | Add TMB parameter |
| `demos/data/ayesha_mutations.json` | Create | Sample patient data |
| `demos/data/high_tmb_melanoma.json` | Create | Sample patient data |
| `demos/data/low_tmb_ovarian.json` | Create | Sample patient data |
| `demos/README.md` | Modify | Update documentation |

---

## Dependencies

**Python Packages** (already in `demos/requirements_demo.txt`):
- streamlit
- numpy
- plotly (add if not present)
- pandas

**Internal Modules**:
- `scripts/data_acquisition/utils/tmb_calculator.py`
- `data/validation/tmb_validation_results.json`

---

## Acceptance Criteria

- [ ] TMB demo tab visible in Streamlit app
- [ ] Sample patients load correctly
- [ ] TMB calculation matches expected values
- [ ] Validation metrics (r=0.933, 95.4%) displayed
- [ ] Cancer-type breakdown chart renders
- [ ] API endpoint returns correct response
- [ ] Mechanism vector includes validated IO pathway
- [ ] Documentation updated

---

## Sample Demo Output

```
ðŸ§¬ TMB PREDICTION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Patient: Ayesha (MBD4 + TP53)
Mutations: 156 nonsynonymous mutations
Exome Size: 38 Mb

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  TMB: 4.11 mut/Mb                                           â”‚
â”‚  Classification: TMB-L                                      â”‚
â”‚  IO Eligible: No                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

âœ… Validated against TCGA Pan-Immune (n=1,895)
   Pearson r: 0.933 | Accuracy: 95.4%

ðŸ“Š Validation by Cancer Type:
   Colorectal:  r=+0.989, Acc=100.0%
   Endometrial: r=+0.946, Acc=98.3%
   Melanoma:    r=+0.843, Acc=83.8%
   Ovarian:     r=+0.475, Acc=99.5%

ðŸ”— Mechanism Vector Integration:
   IO Pathway: 0.0 (TMB-L â†’ IO not eligible)
   Trial Matching: Checkpoint inhibitor trials deprioritized
```

---

## Notes for Agent

1. **Prioritize Streamlit demo** - Most visible for application/demo
2. **Use existing infrastructure** - Build on `tmb_calculator.py`, don't recreate
3. **Show validation prominently** - The r=0.933 is the key differentiator
4. **Keep it simple** - Focus on TMB-H/TMB-L classification, not complex stats
5. **Test with real data** - Use Ayesha's mutation profile as primary example

---

## Related Documents

- `.cursor/ayesha/IO_VALIDATION_PLAN.md` - Full validation methodology
- `.cursor/MOAT/Platform-capabilities.md` - Capability overview
- `scripts/validation/validate_tmb_against_ground_truth.py` - Validation script
- `data/validation/tmb_validation_results.json` - Validation results

---
---

## Mission Objective

Create a demo-ready TMB (Tumor Mutational Burden) prediction feature that showcases our validated biomarker calculation capability. Integrate into existing MOAT demo infrastructure.

---

## Background

TMB prediction has been validated against external TCGA ground truth:
- **Pearson r**: 0.933
- **Classification Accuracy**: 95.4%
- **Source**: TCGA Pan-Immune Publication (`mutation-load_updated.txt`)

This capability enables IO (immunotherapy) eligibility prediction and enhances trial matching.

---

## Deliverables

### 1. Streamlit Demo Enhancement

**File**: `demos/moat_demo.py` (enhance existing) OR `demos/tmb_demo.py` (new)

**Features**:
```python
# Tab: TMB Prediction
st.header("ðŸ§¬ TMB Prediction")

# Input: Upload mutations or use sample
mutation_input = st.selectbox("Sample Patient", [
    "Ayesha (MBD4+TP53)",
    "High-TMB Melanoma", 
    "Low-TMB Ovarian",
    "Custom Input"
])

# Output: TMB calculation with validation badge
st.metric("TMB", f"{tmb:.2f} mut/Mb", delta="TMB-H" if tmb >= 10 else "TMB-L")
st.success("âœ… Validated: r=0.933, Accuracy=95.4%")

# Visualization: Cancer-type breakdown
fig = px.bar(cancer_type_df, x='cancer_type', y='correlation', 
             title='Validation by Cancer Type')
st.plotly_chart(fig)
```

### 2. API Endpoint

**File**: `api/routers/biomarkers.py` (new)

**Endpoint**:
```python
@router.post("/api/biomarkers/tmb")
async def calculate_tmb(request: TMBRequest):
    """
    Calculate TMB from mutation list.
    
    Request:
        mutations: List[MutationDict]
        exome_size_mb: Optional[float] = 38.0
    
    Response:
        tmb: float
        tmb_classification: str ("TMB-H" or "TMB-L")
        io_eligible: bool
        confidence: float
        validation_source: str
    """
    tmb = calculate_tmb_from_mutations(request.mutations, request.exome_size_mb)
    return {
        "tmb": tmb,
        "tmb_classification": "TMB-H" if tmb >= 10.0 else "TMB-L",
        "io_eligible": tmb >= 10.0,
        "confidence": 0.954,
        "validation_source": "TCGA Pan-Immune (r=0.933)"
    }
```

### 3. Validation Visualization Component

**File**: `demos/components/tmb_validation_chart.py` (new)

**Features**:
- Correlation scatter plot (Our TMB vs Ground Truth TMB)
- Confusion matrix heatmap
- Cancer-type breakdown bar chart
- ROC curve (if applicable)

### 4. Integration with Mechanism Vector

**File**: `api/services/pathway_to_mechanism_vector.py` (enhance)

**Enhancement**:
```python
def convert_pathway_scores_to_mechanism_vector(
    pathway_scores: Dict,
    tmb: Optional[float] = None,  # NEW: Use validated TMB
    msi_status: Optional[str] = None
) -> List[float]:
    # ...existing code...
    
    # IO pathway from validated TMB
    io_score = 1.0 if (tmb and tmb >= 10.0) or msi_status == "MSI-High" else 0.0
    
    return [ddr, mapk, pi3k, vegf, her2, io_score, efflux]
```

---

## Implementation Steps

### Step 1: Extend Streamlit Demo (30 min)

1. Open `demos/moat_demo.py`
2. Add new tab: "ðŸ§¬ TMB Prediction"
3. Implement TMB calculation UI
4. Add validation badge
5. Add sample patients (Ayesha, high-TMB, low-TMB)

### Step 2: Create API Endpoint (30 min)

1. Create `api/routers/biomarkers.py`
2. Define `TMBRequest` and `TMBResponse` models
3. Implement `/api/biomarkers/tmb` endpoint
4. Wire to existing `tmb_calculator.py`
5. Add to router in `api/main.py`

### Step 3: Create Validation Visualization (45 min)

1. Create `demos/components/` directory if not exists
2. Create `tmb_validation_chart.py`
3. Load validation results from `data/validation/tmb_validation_results.json`
4. Create Plotly visualizations:
   - Scatter plot: Our TMB vs GT TMB
   - Bar chart: Cancer-type breakdown
   - Confusion matrix heatmap
5. Integrate into Streamlit demo

### Step 4: Integrate with Mechanism Vector (30 min)

1. Open `api/services/pathway_to_mechanism_vector.py`
2. Add `tmb` parameter to conversion function
3. Set IO pathway = 1.0 if TMB â‰¥ 10.0
4. Update callers to pass TMB

### Step 5: Create Demo Data (15 min)

1. Create sample patient files:
   - `demos/data/ayesha_mutations.json`
   - `demos/data/high_tmb_melanoma.json`
   - `demos/data/low_tmb_ovarian.json`
2. Include ~50-200 mutations per patient
3. Pre-calculate expected TMB for validation

### Step 6: Test & Document (30 min)

1. Run Streamlit demo locally
2. Test all sample patients
3. Verify validation metrics display
4. Update `demos/README.md`
5. Add screenshots for documentation

---

## Files to Create/Modify

| File | Action | Description |
|------|--------|-------------|
| `demos/moat_demo.py` | Modify | Add TMB tab |
| `api/routers/biomarkers.py` | Create | TMB API endpoint |
| `demos/components/tmb_validation_chart.py` | Create | Validation visualizations |
| `api/services/pathway_to_mechanism_vector.py` | Modify | Add TMB parameter |
| `demos/data/ayesha_mutations.json` | Create | Sample patient data |
| `demos/data/high_tmb_melanoma.json` | Create | Sample patient data |
| `demos/data/low_tmb_ovarian.json` | Create | Sample patient data |
| `demos/README.md` | Modify | Update documentation |

---

## Dependencies

**Python Packages** (already in `demos/requirements_demo.txt`):
- streamlit
- numpy
- plotly (add if not present)
- pandas

**Internal Modules**:
- `scripts/data_acquisition/utils/tmb_calculator.py`
- `data/validation/tmb_validation_results.json`

---

## Acceptance Criteria

- [ ] TMB demo tab visible in Streamlit app
- [ ] Sample patients load correctly
- [ ] TMB calculation matches expected values
- [ ] Validation metrics (r=0.933, 95.4%) displayed
- [ ] Cancer-type breakdown chart renders
- [ ] API endpoint returns correct response
- [ ] Mechanism vector includes validated IO pathway
- [ ] Documentation updated

---

## Sample Demo Output

```
ðŸ§¬ TMB PREDICTION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Patient: Ayesha (MBD4 + TP53)
Mutations: 156 nonsynonymous mutations
Exome Size: 38 Mb

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  TMB: 4.11 mut/Mb                                           â”‚
â”‚  Classification: TMB-L                                      â”‚
â”‚  IO Eligible: No                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

âœ… Validated against TCGA Pan-Immune (n=1,895)
   Pearson r: 0.933 | Accuracy: 95.4%

ðŸ“Š Validation by Cancer Type:
   Colorectal:  r=+0.989, Acc=100.0%
   Endometrial: r=+0.946, Acc=98.3%
   Melanoma:    r=+0.843, Acc=83.8%
   Ovarian:     r=+0.475, Acc=99.5%

ðŸ”— Mechanism Vector Integration:
   IO Pathway: 0.0 (TMB-L â†’ IO not eligible)
   Trial Matching: Checkpoint inhibitor trials deprioritized
```

---

## Notes for Agent

1. **Prioritize Streamlit demo** - Most visible for application/demo
2. **Use existing infrastructure** - Build on `tmb_calculator.py`, don't recreate
3. **Show validation prominently** - The r=0.933 is the key differentiator
4. **Keep it simple** - Focus on TMB-H/TMB-L classification, not complex stats
5. **Test with real data** - Use Ayesha's mutation profile as primary example

---

## Related Documents

- `.cursor/ayesha/IO_VALIDATION_PLAN.md` - Full validation methodology
- `.cursor/MOAT/Platform-capabilities.md` - Capability overview
- `scripts/validation/validate_tmb_against_ground_truth.py` - Validation script
- `data/validation/tmb_validation_results.json` - Validation results

---
---

## Mission Objective

Create a demo-ready TMB (Tumor Mutational Burden) prediction feature that showcases our validated biomarker calculation capability. Integrate into existing MOAT demo infrastructure.

---

## Background

TMB prediction has been validated against external TCGA ground truth:
- **Pearson r**: 0.933
- **Classification Accuracy**: 95.4%
- **Source**: TCGA Pan-Immune Publication (`mutation-load_updated.txt`)

This capability enables IO (immunotherapy) eligibility prediction and enhances trial matching.

---

## Deliverables

### 1. Streamlit Demo Enhancement

**File**: `demos/moat_demo.py` (enhance existing) OR `demos/tmb_demo.py` (new)

**Features**:
```python
# Tab: TMB Prediction
st.header("ðŸ§¬ TMB Prediction")

# Input: Upload mutations or use sample
mutation_input = st.selectbox("Sample Patient", [
    "Ayesha (MBD4+TP53)",
    "High-TMB Melanoma", 
    "Low-TMB Ovarian",
    "Custom Input"
])

# Output: TMB calculation with validation badge
st.metric("TMB", f"{tmb:.2f} mut/Mb", delta="TMB-H" if tmb >= 10 else "TMB-L")
st.success("âœ… Validated: r=0.933, Accuracy=95.4%")

# Visualization: Cancer-type breakdown
fig = px.bar(cancer_type_df, x='cancer_type', y='correlation', 
             title='Validation by Cancer Type')
st.plotly_chart(fig)
```

### 2. API Endpoint

**File**: `api/routers/biomarkers.py` (new)

**Endpoint**:
```python
@router.post("/api/biomarkers/tmb")
async def calculate_tmb(request: TMBRequest):
    """
    Calculate TMB from mutation list.
    
    Request:
        mutations: List[MutationDict]
        exome_size_mb: Optional[float] = 38.0
    
    Response:
        tmb: float
        tmb_classification: str ("TMB-H" or "TMB-L")
        io_eligible: bool
        confidence: float
        validation_source: str
    """
    tmb = calculate_tmb_from_mutations(request.mutations, request.exome_size_mb)
    return {
        "tmb": tmb,
        "tmb_classification": "TMB-H" if tmb >= 10.0 else "TMB-L",
        "io_eligible": tmb >= 10.0,
        "confidence": 0.954,
        "validation_source": "TCGA Pan-Immune (r=0.933)"
    }
```

### 3. Validation Visualization Component

**File**: `demos/components/tmb_validation_chart.py` (new)

**Features**:
- Correlation scatter plot (Our TMB vs Ground Truth TMB)
- Confusion matrix heatmap
- Cancer-type breakdown bar chart
- ROC curve (if applicable)

### 4. Integration with Mechanism Vector

**File**: `api/services/pathway_to_mechanism_vector.py` (enhance)

**Enhancement**:
```python
def convert_pathway_scores_to_mechanism_vector(
    pathway_scores: Dict,
    tmb: Optional[float] = None,  # NEW: Use validated TMB
    msi_status: Optional[str] = None
) -> List[float]:
    # ...existing code...
    
    # IO pathway from validated TMB
    io_score = 1.0 if (tmb and tmb >= 10.0) or msi_status == "MSI-High" else 0.0
    
    return [ddr, mapk, pi3k, vegf, her2, io_score, efflux]
```

---

## Implementation Steps

### Step 1: Extend Streamlit Demo (30 min)

1. Open `demos/moat_demo.py`
2. Add new tab: "ðŸ§¬ TMB Prediction"
3. Implement TMB calculation UI
4. Add validation badge
5. Add sample patients (Ayesha, high-TMB, low-TMB)

### Step 2: Create API Endpoint (30 min)

1. Create `api/routers/biomarkers.py`
2. Define `TMBRequest` and `TMBResponse` models
3. Implement `/api/biomarkers/tmb` endpoint
4. Wire to existing `tmb_calculator.py`
5. Add to router in `api/main.py`

### Step 3: Create Validation Visualization (45 min)

1. Create `demos/components/` directory if not exists
2. Create `tmb_validation_chart.py`
3. Load validation results from `data/validation/tmb_validation_results.json`
4. Create Plotly visualizations:
   - Scatter plot: Our TMB vs GT TMB
   - Bar chart: Cancer-type breakdown
   - Confusion matrix heatmap
5. Integrate into Streamlit demo

### Step 4: Integrate with Mechanism Vector (30 min)

1. Open `api/services/pathway_to_mechanism_vector.py`
2. Add `tmb` parameter to conversion function
3. Set IO pathway = 1.0 if TMB â‰¥ 10.0
4. Update callers to pass TMB

### Step 5: Create Demo Data (15 min)

1. Create sample patient files:
   - `demos/data/ayesha_mutations.json`
   - `demos/data/high_tmb_melanoma.json`
   - `demos/data/low_tmb_ovarian.json`
2. Include ~50-200 mutations per patient
3. Pre-calculate expected TMB for validation

### Step 6: Test & Document (30 min)

1. Run Streamlit demo locally
2. Test all sample patients
3. Verify validation metrics display
4. Update `demos/README.md`
5. Add screenshots for documentation

---

## Files to Create/Modify

| File | Action | Description |
|------|--------|-------------|
| `demos/moat_demo.py` | Modify | Add TMB tab |
| `api/routers/biomarkers.py` | Create | TMB API endpoint |
| `demos/components/tmb_validation_chart.py` | Create | Validation visualizations |
| `api/services/pathway_to_mechanism_vector.py` | Modify | Add TMB parameter |
| `demos/data/ayesha_mutations.json` | Create | Sample patient data |
| `demos/data/high_tmb_melanoma.json` | Create | Sample patient data |
| `demos/data/low_tmb_ovarian.json` | Create | Sample patient data |
| `demos/README.md` | Modify | Update documentation |

---

## Dependencies

**Python Packages** (already in `demos/requirements_demo.txt`):
- streamlit
- numpy
- plotly (add if not present)
- pandas

**Internal Modules**:
- `scripts/data_acquisition/utils/tmb_calculator.py`
- `data/validation/tmb_validation_results.json`

---

## Acceptance Criteria

- [ ] TMB demo tab visible in Streamlit app
- [ ] Sample patients load correctly
- [ ] TMB calculation matches expected values
- [ ] Validation metrics (r=0.933, 95.4%) displayed
- [ ] Cancer-type breakdown chart renders
- [ ] API endpoint returns correct response
- [ ] Mechanism vector includes validated IO pathway
- [ ] Documentation updated

---

## Sample Demo Output

```
ðŸ§¬ TMB PREDICTION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Patient: Ayesha (MBD4 + TP53)
Mutations: 156 nonsynonymous mutations
Exome Size: 38 Mb

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  TMB: 4.11 mut/Mb                                           â”‚
â”‚  Classification: TMB-L                                      â”‚
â”‚  IO Eligible: No                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

âœ… Validated against TCGA Pan-Immune (n=1,895)
   Pearson r: 0.933 | Accuracy: 95.4%

ðŸ“Š Validation by Cancer Type:
   Colorectal:  r=+0.989, Acc=100.0%
   Endometrial: r=+0.946, Acc=98.3%
   Melanoma:    r=+0.843, Acc=83.8%
   Ovarian:     r=+0.475, Acc=99.5%

ðŸ”— Mechanism Vector Integration:
   IO Pathway: 0.0 (TMB-L â†’ IO not eligible)
   Trial Matching: Checkpoint inhibitor trials deprioritized
```

---

## Notes for Agent

1. **Prioritize Streamlit demo** - Most visible for application/demo
2. **Use existing infrastructure** - Build on `tmb_calculator.py`, don't recreate
3. **Show validation prominently** - The r=0.933 is the key differentiator
4. **Keep it simple** - Focus on TMB-H/TMB-L classification, not complex stats
5. **Test with real data** - Use Ayesha's mutation profile as primary example

---

## Related Documents

- `.cursor/ayesha/IO_VALIDATION_PLAN.md` - Full validation methodology
- `.cursor/MOAT/Platform-capabilities.md` - Capability overview
- `scripts/validation/validate_tmb_against_ground_truth.py` - Validation script
- `data/validation/tmb_validation_results.json` - Validation results

---
---

## Mission Objective

Create a demo-ready TMB (Tumor Mutational Burden) prediction feature that showcases our validated biomarker calculation capability. Integrate into existing MOAT demo infrastructure.

---

## Background

TMB prediction has been validated against external TCGA ground truth:
- **Pearson r**: 0.933
- **Classification Accuracy**: 95.4%
- **Source**: TCGA Pan-Immune Publication (`mutation-load_updated.txt`)

This capability enables IO (immunotherapy) eligibility prediction and enhances trial matching.

---

## Deliverables

### 1. Streamlit Demo Enhancement

**File**: `demos/moat_demo.py` (enhance existing) OR `demos/tmb_demo.py` (new)

**Features**:
```python
# Tab: TMB Prediction
st.header("ðŸ§¬ TMB Prediction")

# Input: Upload mutations or use sample
mutation_input = st.selectbox("Sample Patient", [
    "Ayesha (MBD4+TP53)",
    "High-TMB Melanoma", 
    "Low-TMB Ovarian",
    "Custom Input"
])

# Output: TMB calculation with validation badge
st.metric("TMB", f"{tmb:.2f} mut/Mb", delta="TMB-H" if tmb >= 10 else "TMB-L")
st.success("âœ… Validated: r=0.933, Accuracy=95.4%")

# Visualization: Cancer-type breakdown
fig = px.bar(cancer_type_df, x='cancer_type', y='correlation', 
             title='Validation by Cancer Type')
st.plotly_chart(fig)
```

### 2. API Endpoint

**File**: `api/routers/biomarkers.py` (new)

**Endpoint**:
```python
@router.post("/api/biomarkers/tmb")
async def calculate_tmb(request: TMBRequest):
    """
    Calculate TMB from mutation list.
    
    Request:
        mutations: List[MutationDict]
        exome_size_mb: Optional[float] = 38.0
    
    Response:
        tmb: float
        tmb_classification: str ("TMB-H" or "TMB-L")
        io_eligible: bool
        confidence: float
        validation_source: str
    """
    tmb = calculate_tmb_from_mutations(request.mutations, request.exome_size_mb)
    return {
        "tmb": tmb,
        "tmb_classification": "TMB-H" if tmb >= 10.0 else "TMB-L",
        "io_eligible": tmb >= 10.0,
        "confidence": 0.954,
        "validation_source": "TCGA Pan-Immune (r=0.933)"
    }
```

### 3. Validation Visualization Component

**File**: `demos/components/tmb_validation_chart.py` (new)

**Features**:
- Correlation scatter plot (Our TMB vs Ground Truth TMB)
- Confusion matrix heatmap
- Cancer-type breakdown bar chart
- ROC curve (if applicable)

### 4. Integration with Mechanism Vector

**File**: `api/services/pathway_to_mechanism_vector.py` (enhance)

**Enhancement**:
```python
def convert_pathway_scores_to_mechanism_vector(
    pathway_scores: Dict,
    tmb: Optional[float] = None,  # NEW: Use validated TMB
    msi_status: Optional[str] = None
) -> List[float]:
    # ...existing code...
    
    # IO pathway from validated TMB
    io_score = 1.0 if (tmb and tmb >= 10.0) or msi_status == "MSI-High" else 0.0
    
    return [ddr, mapk, pi3k, vegf, her2, io_score, efflux]
```

---

## Implementation Steps

### Step 1: Extend Streamlit Demo (30 min)

1. Open `demos/moat_demo.py`
2. Add new tab: "ðŸ§¬ TMB Prediction"
3. Implement TMB calculation UI
4. Add validation badge
5. Add sample patients (Ayesha, high-TMB, low-TMB)

### Step 2: Create API Endpoint (30 min)

1. Create `api/routers/biomarkers.py`
2. Define `TMBRequest` and `TMBResponse` models
3. Implement `/api/biomarkers/tmb` endpoint
4. Wire to existing `tmb_calculator.py`
5. Add to router in `api/main.py`

### Step 3: Create Validation Visualization (45 min)

1. Create `demos/components/` directory if not exists
2. Create `tmb_validation_chart.py`
3. Load validation results from `data/validation/tmb_validation_results.json`
4. Create Plotly visualizations:
   - Scatter plot: Our TMB vs GT TMB
   - Bar chart: Cancer-type breakdown
   - Confusion matrix heatmap
5. Integrate into Streamlit demo

### Step 4: Integrate with Mechanism Vector (30 min)

1. Open `api/services/pathway_to_mechanism_vector.py`
2. Add `tmb` parameter to conversion function
3. Set IO pathway = 1.0 if TMB â‰¥ 10.0
4. Update callers to pass TMB

### Step 5: Create Demo Data (15 min)

1. Create sample patient files:
   - `demos/data/ayesha_mutations.json`
   - `demos/data/high_tmb_melanoma.json`
   - `demos/data/low_tmb_ovarian.json`
2. Include ~50-200 mutations per patient
3. Pre-calculate expected TMB for validation

### Step 6: Test & Document (30 min)

1. Run Streamlit demo locally
2. Test all sample patients
3. Verify validation metrics display
4. Update `demos/README.md`
5. Add screenshots for documentation

---

## Files to Create/Modify

| File | Action | Description |
|------|--------|-------------|
| `demos/moat_demo.py` | Modify | Add TMB tab |
| `api/routers/biomarkers.py` | Create | TMB API endpoint |
| `demos/components/tmb_validation_chart.py` | Create | Validation visualizations |
| `api/services/pathway_to_mechanism_vector.py` | Modify | Add TMB parameter |
| `demos/data/ayesha_mutations.json` | Create | Sample patient data |
| `demos/data/high_tmb_melanoma.json` | Create | Sample patient data |
| `demos/data/low_tmb_ovarian.json` | Create | Sample patient data |
| `demos/README.md` | Modify | Update documentation |

---

## Dependencies

**Python Packages** (already in `demos/requirements_demo.txt`):
- streamlit
- numpy
- plotly (add if not present)
- pandas

**Internal Modules**:
- `scripts/data_acquisition/utils/tmb_calculator.py`
- `data/validation/tmb_validation_results.json`

---

## Acceptance Criteria

- [ ] TMB demo tab visible in Streamlit app
- [ ] Sample patients load correctly
- [ ] TMB calculation matches expected values
- [ ] Validation metrics (r=0.933, 95.4%) displayed
- [ ] Cancer-type breakdown chart renders
- [ ] API endpoint returns correct response
- [ ] Mechanism vector includes validated IO pathway
- [ ] Documentation updated

---

## Sample Demo Output

```
ðŸ§¬ TMB PREDICTION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Patient: Ayesha (MBD4 + TP53)
Mutations: 156 nonsynonymous mutations
Exome Size: 38 Mb

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  TMB: 4.11 mut/Mb                                           â”‚
â”‚  Classification: TMB-L                                      â”‚
â”‚  IO Eligible: No                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

âœ… Validated against TCGA Pan-Immune (n=1,895)
   Pearson r: 0.933 | Accuracy: 95.4%

ðŸ“Š Validation by Cancer Type:
   Colorectal:  r=+0.989, Acc=100.0%
   Endometrial: r=+0.946, Acc=98.3%
   Melanoma:    r=+0.843, Acc=83.8%
   Ovarian:     r=+0.475, Acc=99.5%

ðŸ”— Mechanism Vector Integration:
   IO Pathway: 0.0 (TMB-L â†’ IO not eligible)
   Trial Matching: Checkpoint inhibitor trials deprioritized
```

---

## Notes for Agent

1. **Prioritize Streamlit demo** - Most visible for application/demo
2. **Use existing infrastructure** - Build on `tmb_calculator.py`, don't recreate
3. **Show validation prominently** - The r=0.933 is the key differentiator
4. **Keep it simple** - Focus on TMB-H/TMB-L classification, not complex stats
5. **Test with real data** - Use Ayesha's mutation profile as primary example

---

## Related Documents

- `.cursor/ayesha/IO_VALIDATION_PLAN.md` - Full validation methodology
- `.cursor/MOAT/Platform-capabilities.md` - Capability overview
- `scripts/validation/validate_tmb_against_ground_truth.py` - Validation script
- `data/validation/tmb_validation_results.json` - Validation results

---