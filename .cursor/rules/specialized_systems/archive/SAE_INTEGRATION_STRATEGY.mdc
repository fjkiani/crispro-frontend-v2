---
alwaysApply: false
description: Complete SAE (Sparse Autoencoder) integration strategy - what it is, where it fits with P1 toxicity/off-target, and how it lifts confidence + explainability
---

# âš”ï¸ SAE INTEGRATION STRATEGY - THE MISSING PIECE

## **ğŸ¯ WHAT IS SAE?**

**SAE (Sparse Autoencoder)** = Interpretable features extracted from Evo2 embeddings

**Think of it as**: Translating Evo2's "black box" neural network into human-understandable biological concepts

### **How It Works (Evo2 Paper Insight)**
1. Evo2 generates sequence embeddings (high-dimensional vectors)
2. SAE decomposes embeddings into sparse, interpretable features
3. Each feature represents a biological concept (e.g., "exon boundary", "transcription factor binding", "protein secondary structure", "mutation severity")
4. Features activate when relevant patterns are detected in the sequence

### **Evo2 Paper Results (What SAE Revealed)**
- **Exon/Intron Detection**: SAE features learned to distinguish coding vs. non-coding regions
- **Transcription Factor Binding**: Features activated at known TF binding sites
- **Protein Secondary Structure**: Features corresponding to alpha-helices, beta-sheets
- **Prophage Regions**: Features detecting viral DNA integration
- **Mutation Severity**: Features correlating with pathogenicity scores

---

## **âš”ï¸ WHERE SAE FITS WITH P1 (TOXICITY + OFF-TARGET)**

### **Current P1 Status (What We Have)** âœ…
```
User runs "Deep Analysis"
  â†“
Backend returns:
  â”œâ”€â”€ Efficacy: S/P/E scores + confidence
  â”œâ”€â”€ Toxicity: risk_score + factors (germline, pathway)
  â””â”€â”€ Off-Target: heuristic_score (GC, homopolymer)

Frontend displays:
  â”œâ”€â”€ Confidence: 0.45â€“0.85 (aggregated)
  â”œâ”€â”€ Toxicity Risk: 0.0â€“1.0 (with reason)
  â””â”€â”€ Off-Target Risk: Low/Moderate/High
```

**Problem**: Users see **numbers without mechanistic explanation**
- *"Why is confidence 0.65 and not 0.85?"*
- *"What biological feature is driving this toxicity risk?"*
- *"Which part of the guide RNA is causing off-target concerns?"*

### **P2 With SAE (What We Would Add)** ğŸš€
```
User runs "Deep Analysis"
  â†“
Backend returns:
  â”œâ”€â”€ Efficacy: S/P/E scores + confidence + SAE features
  â”‚   â””â”€â”€ SAE: ["exon_disruption: 0.92", "splice_site_proximity: 0.15", "hotspot_mutation: 0.88"]
  â”œâ”€â”€ Toxicity: risk_score + factors + SAE attribution
  â”‚   â””â”€â”€ SAE: ["DNA_repair_burden: 0.78", "metabolic_capacity: 0.32"]
  â””â”€â”€ Off-Target: heuristic_score + SAE guide analysis
      â””â”€â”€ SAE: ["seed_quality: 0.55", "homopolymer_tract: 0.90", "GC_extremity: 0.72"]

Frontend displays:
  â”œâ”€â”€ Confidence: 0.65 with SAE chips showing WHY
  â”‚   â””â”€â”€ "High: Exon disruption (0.92), Hotspot mutation (0.88)"
  â”‚   â””â”€â”€ "Low: Splice site proximity (0.15)"
  â”œâ”€â”€ Toxicity Risk: 0.7 with SAE attribution
  â”‚   â””â”€â”€ "DNA repair pathway burden (0.78) + Low metabolic capacity (0.32)"
  â””â”€â”€ Off-Target Risk: Moderate with SAE guide features
      â””â”€â”€ "Homopolymer tract (0.90), GC extremity (0.72) â†’ Reduce GC to 50-60%"
```

**Value**: Users get **interpretable biological features** explaining the scores

---

## **ğŸ”¥ SAE USE CASES (CONCRETE EXAMPLES)**

### **Use Case 1: Confidence Explanation**

**Without SAE (Current)**:
```
Drug: Platinum Agent
Efficacy Score: 0.72
Confidence: 0.65
Rationale: "Sequence disruption (0.60), Pathway alignment (0.70), Evidence (0.65)"
```
**User Question**: *"Why isn't confidence higher? What's holding it back?"*

**With SAE (P2)**:
```
Drug: Platinum Agent
Efficacy Score: 0.72
Confidence: 0.65
SAE Attribution:
  âœ… Strengths (boosting confidence):
    - Exon disruption detected (0.92) â†’ Strong functional impact
    - Hotspot mutation recognized (0.88) â†’ Known pathogenic pattern
    - DNA repair pathway disrupted (0.78) â†’ Platinum mechanism match
  
  âš ï¸ Weaknesses (lowering confidence):
    - Splice site proximity low (0.15) â†’ No splicing impact
    - Essentiality signal weak (0.35) â†’ Not in critical dependency region
    - Limited cohort overlap (0.22) â†’ Sparse real-world validation
```
**User Insight**: *"Ah, confidence is capped because the variant isn't essential and we lack cohort data. Makes sense!"*

---

### **Use Case 2: Toxicity Risk Explanation**

**Without SAE (Current)**:
```
Toxicity Risk: 0.7 (High)
Reason: "Germline pharmacogene variants detected (DPYD)"
Factors: [{"type": "germline", "weight": 0.4, "detail": "DPYD variant"}]
```
**User Question**: *"But HOW does DPYD cause toxicity? What's the mechanism?"*

**With SAE (P2)**:
```
Toxicity Risk: 0.7 (High)
Reason: "Germline pharmacogene variants detected (DPYD)"
SAE Mechanistic Features:
  - DNA_repair_capacity_reduced (0.85) â†’ Platinum-DNA adducts persist longer
  - Metabolic_enzyme_deficiency (0.78) â†’ 50% slower drug clearance
  - Inflammation_pathway_primed (0.62) â†’ Higher cytokine response
  - Myelosuppression_risk (0.70) â†’ Bone marrow sensitivity increased
```
**User Insight**: *"Got it - DPYD reduces DNA repair AND slows clearance. Need to monitor for myelosuppression and consider dose reduction."*

---

### **Use Case 3: Off-Target Guide Optimization**

**Without SAE (Current)**:
```
Guide: AGCTGCTAGCTGCTAGCTGC
GC Content: 60%
Homopolymer: No
Heuristic Score: 0.85 (Safe)
```
**User Question**: *"This looks safe, but are there specific regions I should worry about?"*

**With SAE (P2)**:
```
Guide: AGCTGCTAGCTGCTAGCTGC
Heuristic Score: 0.85 (Safe)
SAE Guide Features:
  âœ… Seed region (12-20bp from PAM):
    - Seed_uniqueness: 0.92 â†’ Highly specific
    - Seed_complexity: 0.88 â†’ No simple repeats
  
  âœ… PAM-proximal region:
    - GC_balance: 0.80 â†’ Within optimal range
    - Secondary_structure_risk: 0.15 â†’ Minimal hairpin formation
  
  âš ï¸ PAM-distal region (1-11bp):
    - Homopolymer_tract: 0.60 â†’ Short G-tract detected (position 3-5)
    - Potential off-target hotspot: chr7:140753000-140754000 (43% similarity)
```
**User Insight**: *"Good to know - seed is solid, but there's a G-tract early on. I'll validate chr7 off-target experimentally."*

---

## **ğŸ“Š SAE INTEGRATION ARCHITECTURE**

### **Backend Flow**

```
POST /api/clinical_genomics/analyze_variant
  â†“
Efficacy Orchestrator
  â”œâ”€â”€ Call Evo2 for delta scoring
  â”‚   â†“
  â”‚   NEW: Extract Evo2 embeddings (512-dim vector)
  â”‚   â†“
  â”‚   NEW: Pass embeddings to SAE service
  â”‚   â†“
  â”‚   SAE Service returns sparse features:
  â”‚     - Feature ID: exon_disruption
  â”‚     - Activation: 0.92
  â”‚     - Interpretation: "Variant disrupts exon structure"
  â”‚
  â”œâ”€â”€ Compute S/P/E scores (existing)
  â”œâ”€â”€ NEW: Annotate with SAE features
  â”‚   â””â”€â”€ Map SAE features to confidence components:
  â”‚       - exon_disruption (0.92) â†’ Boosts S confidence
  â”‚       - splice_site_proximity (0.15) â†’ Lowers S confidence
  â”‚       - DNA_repair_burden (0.78) â†’ Relevant for toxicity
  â”‚
  â””â”€â”€ Return response with SAE attribution:
      {
        "efficacy_score": 0.72,
        "confidence": 0.65,
        "sae_features": [
          {
            "id": "exon_disruption",
            "activation": 0.92,
            "impact": "positive",
            "explanation": "Variant disrupts exon structure, indicating high functional impact"
          },
          {
            "id": "splice_site_proximity",
            "activation": 0.15,
            "impact": "negative",
            "explanation": "Variant not near splice sites, limiting regulatory impact"
          }
        ],
        "confidence_breakdown": {
          "boosting_features": ["exon_disruption", "hotspot_mutation"],
          "limiting_features": ["splice_site_proximity", "cohort_overlap"]
        }
      }
```

### **Frontend Display**

```jsx
<SAEFeaturesCard result={result}>
  <Typography variant="h6">Why This Confidence Score?</Typography>
  
  {/* Boosting Features (Green) */}
  <Box sx={{ mb: 2 }}>
    <Typography variant="subtitle2" color="success.main">
      âœ… Strengths (Boosting Confidence):
    </Typography>
    {result.sae_features
      .filter(f => f.impact === "positive")
      .map(feature => (
        <Chip 
          key={feature.id}
          label={`${feature.explanation} (${(feature.activation * 100).toFixed(0)}%)`}
          color="success"
          variant="outlined"
          icon={<CheckCircleIcon />}
        />
      ))}
  </Box>
  
  {/* Limiting Features (Yellow) */}
  <Box>
    <Typography variant="subtitle2" color="warning.main">
      âš ï¸ Weaknesses (Lowering Confidence):
    </Typography>
    {result.sae_features
      .filter(f => f.impact === "negative")
      .map(feature => (
        <Chip 
          key={feature.id}
          label={`${feature.explanation} (${(feature.activation * 100).toFixed(0)}%)`}
          color="warning"
          variant="outlined"
          icon={<WarningIcon />}
        />
      ))}
  </Box>
</SAEFeaturesCard>
```

---

## **ğŸ”§ IMPLEMENTATION PLAN (4 HOURS)**

### **Hour 1: SAE Service Stub (Backend)**
- **File**: `oncology-backend-minimal/api/services/sae_service.py`
- **Functions**:
  ```python
  def extract_sae_features(evo_embeddings: np.ndarray, variant_context: dict) -> List[SAEFeature]:
      """
      Extract interpretable features from Evo2 embeddings.
      
      P2 STUB: Returns mock features based on variant consequence.
      Future: Call actual SAE model trained on Evo2 embeddings.
      """
      # Mock features based on consequence type
      if variant_context.get("consequence") == "missense_variant":
          return [
              SAEFeature(
                  id="exon_disruption",
                  activation=0.92,
                  impact="positive",
                  explanation="Variant disrupts exon structure, indicating high functional impact"
              ),
              SAEFeature(
                  id="splice_site_proximity",
                  activation=0.15,
                  impact="negative",
                  explanation="Variant not near splice sites, limiting regulatory impact"
              )
          ]
      elif variant_context.get("consequence") == "frameshift_variant":
          return [
              SAEFeature(
                  id="protein_truncation",
                  activation=0.98,
                  impact="positive",
                  explanation="Frameshift causes premature stop codon"
              )
          ]
      # ... more consequence-based mocks
  ```

### **Hour 2: Efficacy Orchestrator Integration**
- **File**: `oncology-backend-minimal/api/services/efficacy_orchestrator/orchestrator.py`
- **Modify**: `predict()` method
  ```python
  # After computing S/P/E scores
  if options.get("include_sae_features"):
      # Extract Evo2 embeddings (if available from scoring)
      evo_embeddings = sequence_result.get("embeddings")
      
      # Extract SAE features
      sae_features = extract_sae_features(
          evo_embeddings, 
          {"consequence": mutations[0].get("consequence"), "gene": mutations[0].get("gene")}
      )
      
      # Annotate response with SAE features
      response.sae_features = sae_features
      
      # Map SAE to confidence breakdown
      response.provenance["confidence_breakdown"]["sae_attribution"] = {
          "boosting": [f.id for f in sae_features if f.impact == "positive"],
          "limiting": [f.id for f in sae_features if f.impact == "negative"]
      }
  ```

### **Hour 3: Frontend Components**
- **File**: `oncology-frontend/src/components/ClinicalGenomicsCommandCenter/cards/SAEFeaturesCard.jsx`
- **Component**: Display SAE features with green/yellow chips
- **Props**: `{ result, loading, error }`
- **Display**:
  - "Why This Confidence Score?" heading
  - Boosting features (green chips with checkmarks)
  - Limiting features (yellow chips with warnings)
  - Expandable details with activation scores

### **Hour 4: CoPilot Integration**
- **File**: `integrations/ClinicalGenomicsCoPilotIntegration.jsx`
- **Add**: `askAboutSAEFeatures()` method
  ```javascript
  const askAboutSAEFeatures = () => {
    if (!results.sae_features || results.sae_features.length === 0) return;
    
    const top_feature = results.sae_features
      .sort((a, b) => b.activation - a.activation)[0];
    
    const question = `What does the SAE feature "${top_feature.id}" (activation: ${(top_feature.activation * 100).toFixed(0)}%) mean biologically? How does it affect confidence?`;
    
    setIsOpen(true);
    setChatHistory(prev => [...prev, {
      role: 'user',
      content: question,
      timestamp: new Date().toISOString(),
      context: { sae_features: results.sae_features }
    }]);
  };
  ```
- **Add**: "Explain features?" chip to Quick Actions
  ```javascript
  {results.sae_features?.length > 0 && (
    <Chip 
      label="Explain features?"
      size="small"
      variant="outlined"
      color="secondary"
      onClick={copilot.askAboutSAEFeatures}
      sx={{ cursor: 'pointer' }}
    />
  )}
  ```

---

## **ğŸ¯ SAE VALUE PROPOSITIONS**

### **For Users**
- **Transparency**: See exactly which biological features drive confidence
- **Actionability**: Understand what to improve (e.g., "Get more cohort data to lift confidence")
- **Trust**: Mechanistic explanations build confidence in AI predictions

### **For Researchers**
- **Hypothesis Generation**: SAE features reveal novel biology (e.g., "Why does this variant have high toxicity despite low pathway overlap?")
- **Model Debugging**: Identify when model is relying on spurious features
- **Feature Discovery**: SAE may reveal unknown biological patterns

### **For Platform**
- **Differentiation**: NO other platform has interpretable SAE features for genomics
- **Publication**: SAE feature discovery is publishable (Evo2 paper precedent)
- **IP**: Novel use of SAE for therapeutic decision support (patent opportunity)

---

## **âš”ï¸ P1 â†’ P2 EVOLUTION**

### **P1 (Current - Complete)** âœ…
```
Clinical Genomics Command Center
â”œâ”€â”€ Efficacy: S/P/E scores + confidence
â”œâ”€â”€ Toxicity: Risk score + factors
â”œâ”€â”€ Off-Target: Heuristic preview
â””â”€â”€ CoPilot: 7 quick actions (4 existing + 3 new)
```

**User Question**: *"Why is confidence 0.65? What's limiting it?"*
**Answer**: *"Sequence disruption (0.60), Pathway alignment (0.70), Evidence (0.65)"*

### **P2 With SAE (Proposed - 4 hours)** ğŸš€
```
Clinical Genomics Command Center
â”œâ”€â”€ Efficacy: S/P/E scores + confidence + SAE features
â”œâ”€â”€ Toxicity: Risk score + factors + SAE attribution
â”œâ”€â”€ Off-Target: Heuristic + SAE guide analysis
â”œâ”€â”€ CoPilot: 8 quick actions (+ "Explain features?")
â””â”€â”€ NEW: SAE Features Card showing boosting/limiting factors
```

**User Question**: *"Why is confidence 0.65? What's limiting it?"*
**Answer**: *"Boosting: Exon disruption (0.92), Hotspot (0.88). Limiting: Splice proximity (0.15), Cohort overlap (0.22). â†’ Add cohort data to lift confidence to 0.80+"*

---

## **ğŸ”¥ STRATEGIC DECISION POINT**

**Commander Alpha, the choice is:**

**Option A: Demo P1 Now** (Recommended)
- Show off toxicity + off-target + CoPilot integration
- Get user feedback on what they care about most
- Decide if SAE interpretability is a priority

**Option B: Add SAE P2** (4 hours)
- Complete the mechanistic explanation story
- Make confidence scores fully transparent
- Differentiate from all competitors (nobody has SAE for genomics)

**Option C: Hybrid** (1 hour)
- Add SAE stub with mock features (quick win)
- Demo the UX and user reaction
- Implement real SAE later if demand is high

---

**Awaiting your command, Commander!** âš”ï¸ğŸ”¥ğŸ’€

What should we prioritize: **Demo P1**, **Add SAE P2**, or **SAE Stub Hybrid**?
