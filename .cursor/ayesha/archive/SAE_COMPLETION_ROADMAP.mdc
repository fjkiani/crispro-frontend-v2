---
alwaysApply: false
description: SAE Completion Roadmap for Ayesha - What's done, what's left, and how it fits into the doctor workflow
---

# ‚öîÔ∏è SAE COMPLETION ROADMAP FOR AYESHA

## **üéØ MISSION OBJECTIVE**

**Complete SAE integration to enable doctor explainability**: "Why is confidence 0.73 for PARP inhibitors in Ayesha's case?"

**Alignment**: Agent X's `ayesha_plan.mdc` explicitly requires SAE features in EvidenceBand (line 47) and test commands (line 61).

---

## **üìä CURRENT STATUS - BACKEND 60% COMPLETE**

### **‚úÖ COMPLETED (Backend)**

#### **1. SAE Service Core (DONE - 363 lines)**
**File**: `oncology-coPilot/oncology-backend-minimal/api/services/sae_service.py`

**What's Implemented**:
- ‚úÖ `SAEFeature` dataclass (id, name, activation, impact, explanation, provenance, threshold, raw_value)
- ‚úÖ `SAEBundle` dataclass (features, boosting_features, limiting_features, overall_impact, provenance)
- ‚úÖ `extract_sae_features_from_real_data()` function (lines 60-330)
  - ‚úÖ Feature 1: `exon_disruption` (Evo2 delta + hotspot floor)
  - ‚úÖ Feature 2: `hotspot_mutation` (AlphaMissense/hotspot/ClinVar)
  - ‚úÖ Feature 3: `essentiality_signal` (Insights essentiality)
  - ‚úÖ Feature 4: `DNA_repair_capacity` (Toxicity pathway overlap)
  - ‚úÖ Feature 5: `seed_region_quality` (Off-target heuristics)
  - ‚úÖ Feature 6: `cohort_overlap` (Cohort signals)
- ‚úÖ `sae_features_to_dict()` helper for JSON serialization (lines 333-362)
- ‚úÖ Logging for all feature extractions
- ‚úÖ Missing data handling (show "N/A" gracefully)
- ‚úÖ Provenance tracking (inline per feature)

**Test Example**:
```bash
# Backend SAE extraction works (integrated into efficacy)
curl -X POST http://127.0.0.1:8000/api/clinical_genomics/analyze_variant \
  -H 'Content-Type: application/json' \
  -d '{"mutations":[{"gene":"BRAF","chrom":"7","pos":140753336,"ref":"T","alt":"A"}],"profile":"richer","options":{"include_sae_features":true}}' \
  | python3 -m json.tool | grep -A 20 "sae_features"
```

#### **2. Efficacy Orchestrator Integration (DONE - Partial)**
**File**: `oncology-coPilot/oncology-backend-minimal/api/services/efficacy_orchestrator/orchestrator.py`

**What's Implemented**:
- ‚úÖ Gate: `if (request.options or {}).get("include_sae_features")` (line 218)
- ‚úÖ Import: `from api.services.sae_service import extract_sae_features_from_real_data, sae_features_to_dict` (line 220)
- ‚úÖ Call: `sae_bundle = extract_sae_features_from_real_data(...)` (line 223)
- ‚úÖ Response: `response.sae_features = sae_features_to_dict(sae_bundle)` (line 246)

**File**: `oncology-coPilot/oncology-backend-minimal/api/services/efficacy_orchestrator/models.py`
- ‚úÖ Schema: `sae_features: Optional[Dict[str, Any]] = None` (line 39)

---

### **‚ùå INCOMPLETE (Backend 40%)**

#### **Missing: SAE Attribution in Confidence Breakdown**
**File**: `oncology-coPilot/oncology-backend-minimal/api/services/efficacy_orchestrator/orchestrator.py`

**What's Missing**:
```python
# Need to add this AFTER sae_features assignment (around line 246):

if sae_bundle and "confidence_breakdown" in response.provenance:
    response.provenance["confidence_breakdown"]["sae_attribution"] = {
        "boosting_features": sae_bundle.boosting_features,
        "limiting_features": sae_bundle.limiting_features,
        "overall_impact": sae_bundle.overall_impact
    }
```

**Why It Matters**:
- Frontend `SAEFeaturesCard` expects `provenance.confidence_breakdown.sae_attribution` to classify features
- Without this, frontend won't know which features are boosting vs limiting
- Agent X's plan (line 47) requires "confidence breakdown (S/P/E + SAE features)"

**Time to Complete**: 5 minutes

---

## **‚ùå INCOMPLETE (Frontend 0%)**

### **Missing Component 1: SAEFeaturesCard.jsx**
**File**: `oncology-coPilot/oncology-frontend/src/components/ClinicalGenomicsCommandCenter/cards/SAEFeaturesCard.jsx` ‚ùå **DOES NOT EXIST**

**What Needs to be Built**:
- Display boosting features (green chips with CheckCircle icon)
- Display limiting features (yellow chips with Warning icon)
- Provenance tooltips (show data source + activation %)
- Net SAE impact display
- RUO disclaimer banner
- Loading/error states

**Code Pattern** (from doctrine lines 503-676):
```jsx
import React from 'react';
import { Card, CardContent, Typography, Box, Chip, Tooltip, Alert, Divider } from '@mui/material';
import { CheckCircle as CheckCircleIcon, Warning as WarningIcon, Info as InfoIcon } from '@mui/icons-material';

export const SAEFeaturesCard = ({ result, loading, error }) => {
  // Extract SAE features and attribution
  const { sae_features, provenance } = result || {};
  const sae_attribution = provenance?.confidence_breakdown?.sae_attribution || {};
  
  const boostingFeatures = sae_features?.filter(f => 
    sae_attribution.boosting_features?.includes(f.id)
  ) || [];
  
  const limitingFeatures = sae_features?.filter(f => 
    sae_attribution.limiting_features?.includes(f.id)
  ) || [];

  // Render green chips for boosting, yellow for limiting
  // Show tooltips with provenance + activation
  // Display net impact at bottom
};
```

**Time to Complete**: 1 hour

---

### **Missing Component 2: MechanisticEvidenceTab Integration**
**File**: `oncology-coPilot/oncology-frontend/src/components/ClinicalGenomicsCommandCenter/tabs/MechanisticEvidenceTab.jsx`

**What Needs to be Added**:
1. Import `SAEFeaturesCard`
2. Pass `include_sae_features: true` in efficacy request options
3. Render `<SAEFeaturesCard result={efficacyResult} loading={efficacyLoading} error={efficacyError} />`

**Code Changes**:
```jsx
// Add to imports
import { SAEFeaturesCard } from '../cards/SAEFeaturesCard';

// Modify handleDeepAnalysis to include SAE flag
const handleDeepAnalysis = async () => {
  // ... existing code
  const result = await runEfficacy(
    selectedVariant, 
    profile,
    { include_sae_features: true }  // <-- ADD THIS
  );
  // ...
};

// Add to render (after EvidenceBand)
<SAEFeaturesCard 
  result={efficacyResult} 
  loading={efficacyLoading} 
  error={efficacyError} 
/>
```

**Time to Complete**: 30 minutes

---

### **Missing Component 3: CoPilot Integration**
**File**: `oncology-coPilot/oncology-frontend/src/components/ClinicalGenomicsCommandCenter/integrations/ClinicalGenomicsCoPilotIntegration.jsx`

**What Needs to be Added**:
1. Add `askAboutSAEFeatures()` method
2. Add "Explain features?" chip in `ClinicalGenomicsQuickActions`

**Code Pattern** (from doctrine lines 687-748):
```javascript
const askAboutSAEFeatures = () => {
  if (!contextResults?.sae_features || contextResults.sae_features.length === 0) return;
  
  const boosting = contextResults.sae_features.filter(f => 
    contextResults.provenance?.confidence_breakdown?.sae_attribution?.boosting_features?.includes(f.id)
  );
  
  const limiting = contextResults.sae_features.filter(f => 
    contextResults.provenance?.confidence_breakdown?.sae_attribution?.limiting_features?.includes(f.id)
  );
  
  const top_boost = boosting.sort((a, b) => b.activation - a.activation)[0];
  const top_limit = limiting.sort((a, b) => a.activation - b.activation)[0];
  
  let question = `My confidence score is ${(contextResults.efficacy?.drugs?.[0]?.confidence || 0).toFixed(2)}. `;
  
  if (top_boost) {
    question += `It's boosted by: ${top_boost.explanation} (${(top_boost.activation * 100).toFixed(0)}%). `;
  }
  
  if (top_limit) {
    question += `But limited by: ${top_limit.explanation} (${(top_limit.activation * 100).toFixed(0)}%). `;
  }
  
  question += `How can I improve this confidence score?`;
  
  // Send to CoPilot with full SAE context
  // ...
};
```

**Time to Complete**: 1 hour

---

### **Missing Component 4: Testing & Validation**
**File**: `oncology-coPilot/oncology-backend-minimal/tests/test_sae_service.py` ‚ùå **DOES NOT EXIST**

**What Needs to be Written**:
1. `test_exon_disruption_feature()` - BRAF V600E with delta/calibrated scores
2. `test_hotspot_mutation_feature()` - AlphaMissense coverage
3. `test_essentiality_signal_feature()` - Insights essentiality
4. `test_dna_repair_capacity_feature()` - Toxicity factors
5. `test_missing_data_handling()` - Graceful degradation

**Code Pattern** (from doctrine lines 757-809):
```python
import pytest
from api.services.sae_service import extract_sae_features_from_real_data, SAEFeature

def test_exon_disruption_feature():
    """Test exon disruption feature extraction from Evo2 scores."""
    result = extract_sae_features_from_real_data(
        variant={"gene": "BRAF", "pos": 140753336},
        evo_scores={"delta": -0.00006628, "calibrated_seq_percentile": 0.88}
    )
    
    exon_feature = next((f for f in result.features if f.id == "exon_disruption"), None)
    assert exon_feature is not None
    assert exon_feature.activation == 0.88
    assert exon_feature.impact == "positive"

# ... 4 more tests
```

**Time to Complete**: 1.5 hours

---

## **üéØ COMPLETE EXECUTION PLAN FOR AYESHA**

### **‚úÖ Hour 1: Backend Completion (ALREADY DONE)**
**Status**: ‚úÖ **100% COMPLETE**

**Discovered**: SAE attribution code is ALREADY IMPLEMENTED in `orchestrator.py` (lines 248-254)

**File**: `oncology-coPilot/oncology-backend-minimal/api/services/efficacy_orchestrator/orchestrator.py`

**Code** (lines 248-254):
```python
# Add SAE attribution to confidence breakdown
if "confidence_breakdown" in response.provenance:
    response.provenance["confidence_breakdown"]["sae_attribution"] = {
        "boosting_features": sae_bundle.boosting_features,
        "limiting_features": sae_bundle.limiting_features,
        "overall_impact": sae_bundle.overall_impact
    }
```

**Test**:
```bash
curl -X POST http://127.0.0.1:8000/api/clinical_genomics/analyze_variant \
  -H 'Content-Type: application/json' \
  -d '{"mutations":[{"gene":"BRAF","chrom":"7","pos":140753336,"ref":"T","alt":"A"}],"profile":"richer","options":{"include_sae_features":true}}' \
  | python3 -m json.tool | grep -A 5 "sae_attribution"
```

**Expected Output**:
```json
"sae_attribution": {
  "boosting_features": ["exon_disruption", "hotspot_mutation"],
  "limiting_features": ["essentiality_signal"],
  "overall_impact": 0.567
}
```

**‚úÖ BACKEND IS 100% COMPLETE - NO WORK NEEDED**

---

### **Hour 2: SAEFeaturesCard Component (1 hour)**
**Task**: Build frontend card component

**File**: Create `oncology-coPilot/oncology-frontend/src/components/ClinicalGenomicsCommandCenter/cards/SAEFeaturesCard.jsx`

**Actions**:
1. Import MUI components (Card, Chip, Tooltip, Alert, etc.)
2. Extract `sae_features` and `sae_attribution` from props
3. Filter boosting vs limiting features
4. Render green chips for boosting (CheckCircle icon)
5. Render yellow chips for limiting (Warning icon)
6. Add tooltips with provenance + activation %
7. Display net SAE impact at bottom
8. Add RUO disclaimer banner
9. Handle loading/error/empty states

**Test** (after frontend starts):
- Navigate to Clinical Genomics Command Center
- Run "Deep Analysis" with BRAF V600E
- Verify SAEFeaturesCard renders with boosting features

---

### **Hour 3: MechanisticEvidenceTab Integration (30 min)**
**Task**: Wire SAEFeaturesCard into tab

**File**: `oncology-coPilot/oncology-frontend/src/components/ClinicalGenomicsCommandCenter/tabs/MechanisticEvidenceTab.jsx`

**Actions**:
1. Import `SAEFeaturesCard`
2. Modify `handleDeepAnalysis` to pass `include_sae_features: true`
3. Add `<SAEFeaturesCard />` render below `EvidenceBand`

**Test**:
- Run "Deep Analysis"
- Verify SAE card appears below EvidenceBand
- Verify features display correctly

---

### **Hour 4: CoPilot Integration (1 hour)**
**Task**: Add "Explain features?" quick action

**File**: `oncology-coPilot/oncology-frontend/src/components/ClinicalGenomicsCommandCenter/integrations/ClinicalGenomicsCoPilotIntegration.jsx`

**Actions**:
1. Add `askAboutSAEFeatures()` method
2. Extract top boosting/limiting features
3. Construct question with confidence + top features
4. Add "Explain features?" chip in `ClinicalGenomicsQuickActions`

**Test**:
- Run analysis with SAE features
- Click "Explain features?" chip
- Verify CoPilot opens with contextualized question

---

### **Hour 5: Testing & Validation (1.5 hours)**
**Task**: Write unit tests and smoke tests

**Files**:
1. Create `oncology-coPilot/oncology-backend-minimal/tests/test_sae_service.py`
2. Write 5 unit tests (exon, hotspot, essentiality, DNA repair, missing data)
3. Run backend smoke test (BRAF V600E with SAE)
4. Run frontend smoke test (render SAEFeaturesCard)

**Commands**:
```bash
# Backend unit tests
cd oncology-coPilot/oncology-backend-minimal
PYTHONPATH=. venv/bin/pytest tests/test_sae_service.py -v

# Backend smoke test
curl -X POST http://127.0.0.1:8000/api/clinical_genomics/analyze_variant \
  -H 'Content-Type: application/json' \
  -d '{"mutations":[{"gene":"BRAF","chrom":"7","pos":140753336,"ref":"T","alt":"A"}],"profile":"richer","options":{"include_sae_features":true}}' \
  | python3 -m json.tool > /tmp/sae_braf_test.json

# Verify 3 boosting features
grep -A 3 "boosting_features" /tmp/sae_braf_test.json
```

---

## **üìã FINAL CHECKLIST FOR AYESHA**

### **Backend (100% when complete)**
- [X] `sae_service.py` with 6 core features (DONE)
- [X] Orchestrator integration with `include_sae_features` gate (DONE)
- [ ] **SAE attribution in confidence breakdown** (5 min) ‚Üê **DO THIS FIRST**
- [ ] Unit tests (`test_sae_service.py`) (1.5h)

### **Frontend (100% when complete)**
- [ ] `SAEFeaturesCard.jsx` component (1h)
- [ ] `MechanisticEvidenceTab` integration (30m)
- [ ] CoPilot "Explain features?" action (1h)

### **Validation (100% when complete)**
- [ ] Backend smoke test: BRAF V600E shows 3 boosting features
- [ ] Frontend smoke test: SAEFeaturesCard renders correctly
- [ ] CoPilot smoke test: "Explain features?" opens with context

---

## **üéØ ALIGNMENT WITH AYESHA_PLAN.MDC**

**Agent X's Requirements (from `ayesha_plan.mdc`)**:

| Requirement | Line | Status |
|---|---|---|
| SAE feature extraction service | 16-18 | ‚úÖ DONE (backend) |
| Provenance confidence breakdown | 18 | ‚ùå MISSING (5 min fix) |
| EvidenceBand with S/P/E + SAE | 47 | ‚ùå NEEDS FRONTEND |
| Test command with `include_sae_features: true` | 61 | ‚úÖ WORKS (backend) |
| Doctor sees "why" confidence is 0.73 | 85 | ‚ùå NEEDS FRONTEND |

**Priority**: Complete backend fix (5 min) ‚Üí Build frontend (2.5h) ‚Üí Test (1.5h)

---

## **‚öîÔ∏è TOTAL TIME TO COMPLETE: 4 HOURS** (Backend DONE - 2.5h Frontend + 1.5h Testing)

**Breakdown**:
1. ‚úÖ Backend completion: **ALREADY DONE** (0 minutes)
2. SAEFeaturesCard: 1 hour
3. MechanisticEvidenceTab: 30 minutes
4. CoPilot: 1 hour
5. Testing: 1.5 hours

**CRITICAL UPDATE**: Backend is 100% complete. All 4 hours are frontend + testing only.

**DELIVERABLE**: Complete SAE integration for Ayesha's doctor workflow - "Why is confidence 0.73?" answered with transparent, real-data features.

---

## **üöÄ ACCEPTANCE CRITERIA FOR AYESHA**

**Backend**:
- ‚úÖ SAE features extract from real data (Evo2, Insights, Toxicity, AM, ClinVar)
- ‚úÖ Provenance includes `sae_attribution` with boosting/limiting lists
- ‚úÖ Unit tests pass (5/5)

**Frontend**:
- ‚úÖ Doctor sees green chips for strengths (exon disruption, hotspot, essentiality)
- ‚úÖ Doctor sees yellow chips for weaknesses (if any)
- ‚úÖ Tooltips show data sources (Evo2, AlphaMissense, etc.)
- ‚úÖ CoPilot "Explain features?" opens with contextualized question

**End-to-End**:
- ‚úÖ BRAF V600E shows: "Confidence 0.73 because: BRCA2 hotspot (0.92) + DNA repair burden (0.78) + exon disruption (0.88)"
- ‚úÖ DPYD variant shows: "Toxicity risk: Metabolic enzyme deficiency (DPYD) detected"
- ‚úÖ Doctor trusts platform due to transparent explainability

‚öîÔ∏èüíÄ **ROADMAP COMPLETE - READY TO EXECUTE** üíÄ‚öîÔ∏è
