---
description: Publication output package – what we produced, how we produced it, where files live, and how to reproduce for figures/tables
---

### Metastasis Interception – Publication Output Summary

This rule documents the publication artifacts we generated (figures, tables, datasets), the exact code paths that produced them, environment prerequisites (ENFORMER/BORZOI), and how to re‑run everything end‑to‑end. It is the single reference for reviewers/authors to understand outputs, provenance, and reproduction commands.

### Key Outputs (Publication Package)
- Figures (PNG 300 DPI + SVG), copied to `publication/figures/`:
  - F2 Target Lock Heatmap: [`figures/F2_target_lock_heatmap.png`](mdc:figures/F2_target_lock_heatmap.png), [`figures/F2_target_lock_heatmap.svg`](mdc:figures/F2_target_lock_heatmap.svg)
  - F2 Supplement (component scores): [`figures/F2_supp_component_scores.png`](mdc:figures/F2_supp_component_scores.png), [`figures/F2_supp_component_scores.svg`](mdc:figures/F2_supp_component_scores.svg)
  - F3 Efficacy Distribution: [`figures/F3_efficacy_distribution.png`](mdc:figures/F3_efficacy_distribution.png), [`figures/F3_efficacy_distribution.svg`](mdc:figures/F3_efficacy_distribution.svg)
  - F4 Safety Distribution: [`figures/F4_safety_distribution.png`](mdc:figures/F4_safety_distribution.png), [`figures/F4_safety_distribution.svg`](mdc:figures/F4_safety_distribution.svg)
  - F5 Assassin Score Distribution: [`figures/F5_assassin_score_distribution.png`](mdc:figures/F5_assassin_score_distribution.png), [`figures/F5_assassin_score_distribution.svg`](mdc:figures/F5_assassin_score_distribution.svg)

- Tables and datasets (copied to `publication/tables/` and `publication/data/`):
  - Table 2 (Performance Metrics): [`data/table2_performance_metrics.csv`](mdc:data/table2_performance_metrics.csv), [`data/table2_performance_metrics.tex`](mdc:data/table2_performance_metrics.tex)
  - Target‑lock datasets (synthetic + real ClinVar): [`data/target_lock_heatmap_data.csv`](mdc:data/target_lock_heatmap_data.csv), [`data/real_target_lock_data.csv`](mdc:data/real_target_lock_data.csv)
  - Guide validation datasets: [`data/guide_validation_dataset.csv`](mdc:data/guide_validation_dataset.csv), [`data/real_guide_validation_dataset.csv`](mdc:data/real_guide_validation_dataset.csv)

### How We Produced the Outputs

#### Scripts (entry points)
- Synthetic/fast heatmap (direct insights): [`scripts/generate_target_lock_data_v2.py`](mdc:scripts/generate_target_lock_data_v2.py)
  - Calls insights endpoints directly to compute Functionality/Essentiality/Chromatin/Regulatory per gene, then computes Target‑Lock score using ruleset weights.

- Real pathogenic variants (ClinVar‑like) for heatmap + guides: [`scripts/generate_publication_data_real.py`](mdc:scripts/generate_publication_data_real.py)
  - Uses curated pathogenic coordinates (e.g., BRAF V600E, KRAS G12D) to compute insights and generate per‑mission guides via `/api/metastasis/intercept`.

- Guide dataset + figures (F3–F5) + Table 2: [`scripts/generate_guide_validation_data.py`](mdc:scripts/generate_guide_validation_data.py)
  - Aggregates efficacy (Evo2 delta→sigmoid), safety (minimap2/BLAST), assassin score, and renders F3–F5; emits Table 2 CSV/LaTeX.

#### Backend endpoints used
- Insights Router: [`api/routers/insights.py`](mdc:oncology-coPilot/oncology-backend-minimal/api/routers/insights.py)
  - `POST /api/insights/predict_gene_essentiality` – Evo2 multi/exon magnitudes + calibration
  - `POST /api/insights/predict_protein_functionality_change` – now accepts top‑level or `mutations[]`; richer Evo2 (multi + exon 8kb) lift
  - `POST /api/insights/predict_chromatin_accessibility` – now accepts top‑level or `mutations[]`; prefers ENFORMER_URL then BORZOI_URL; otherwise heuristic
  - `POST /api/insights/predict_splicing_regulatory`

- Design Router: `POST /api/design/predict_crispr_spacer_efficacy` (Evo2 delta→sigmoid)
- Metastasis Intercept Router: `POST /api/metastasis/intercept` (orchestrates target‑lock → design → safety → assassin score)

#### Chromatin model stubs (wired)
- Enformer stub server: [`tools/chromatin/enformer_server.py`](mdc:tools/chromatin/enformer_server.py) → run on port 9001
- Borzoi stub server: [`tools/chromatin/borzoi_server.py`](mdc:tools/chromatin/borzoi_server.py) → run on port 9002
- Environment variables consumed in backend config: `ENFORMER_URL`, `BORZOI_URL` (see [`api/config.py`](mdc:oncology-coPilot/oncology-backend-minimal/api/config.py))

### Environment & Commands (Reproducibility)

1) Start backend (FastAPI):
```bash
cd oncology-coPilot/oncology-backend-minimal
../../venv/bin/python -m uvicorn api.main:app --host 127.0.0.1 --port 8000 --reload
```

2) Start chromatin stubs (separate shells):
```bash
./venv/bin/python -m uvicorn tools.chromatin.enformer_server:app --host 127.0.0.1 --port 9001 &
./venv/bin/python -m uvicorn tools.chromatin.borzoi_server:app   --host 127.0.0.1 --port 9002 &
```

3) Export model URLs (same shell as backend or via .env):
```bash
export ENFORMER_URL=http://127.0.0.1:9001
export BORZOI_URL=http://127.0.0.1:9002
```

4) Generate outputs:
```bash
# Heatmap (synthetic fast path)
./venv/bin/python scripts/generate_target_lock_data_v2.py

# Heatmap + guides with REAL ClinVar‑like variants
./venv/bin/python scripts/generate_publication_data_real.py

# Guide figures (F3–F5) + Table 2
./venv/bin/python scripts/generate_guide_validation_data.py
```

5) Publication packaging (already automated in scripts):
- Figures copied to `publication/figures/`
- Tables copied to `publication/tables/`
- Datasets copied to `publication/data/`

### Results Summary (for Manuscript)
- Target‑Lock scores (synthetic vs real): nearly identical mean ≈ 0.138 (consistent methodology)
- Guide efficacy (real): ~0.55 ± 0.13; safety: ~0.81 ± 0.21; assassin: ~0.54 ± 0.11
- Chromatin (after Enformer wiring): mean ≈ 0.56–0.57; provenance = enformer; confidence = 0.6
- Functionality: modest lift with richer Evo2 (multi + exon 8kb) baseline ≈ 0.55; hotspot domain adds small lift

### What This Means for Publication
- Demonstrates a stage‑aware CRISPR guide design framework with multi‑modal scoring
- Uses real cancer drivers (BRAF V600E, KRAS G12D, NRAS Q61R, MET exon14 context) for clinical relevance
- All figures, tables, and datasets are reproducible via provided scripts and stubs
- Clear provenance in API responses (methods, model ids, feature flags)

### What We Present (Figure/Table Mapping)
- Figure 2: Mission step × gene Target‑Lock heatmap (plus component score supplement)
- Figure 3: Guide efficacy distributions per mission
- Figure 4: Guide safety distributions per mission (off‑target)
- Figure 5: Assassin composite score distributions per mission
- Table 2: Summary metrics (mean ± SD, min/max, medians)

### Key Implementation Edits (Traceability)
- Insights contract upgrade (accept `mutations[]` or top‑level): [`insights.py`](mdc:oncology-coPilot/oncology-backend-minimal/api/routers/insights.py)
- Functionality: richer Evo2 context (multi + exon flank 8kb), domain lift
- Chromatin: wired to Enformer→Borzoi with heuristic fallback
- Interception modularization: new package [`api/services/interception/`](mdc:oncology-coPilot/oncology-backend-minimal/api/services/interception/__init__.py)

### Limitations & Next Steps
- Enformer/Borzoi are stubbed; production wiring can replace stubs with real services
- Functionality lift remains conservative; enabling richer Evo2 profiles (disable delta‑only, add symmetry/transcript sweeps) may increase signal at higher cost
- ANGIO exon windows can be hardcoded for demo stability as needed

### Source Files (primary)
- Insights Router: [`api/routers/insights.py`](mdc:oncology-coPilot/oncology-backend-minimal/api/routers/insights.py)
- Interception Service (modular): [`api/services/interception/orchestrator.py`](mdc:oncology-coPilot/oncology-backend-minimal/api/services/interception/orchestrator.py)
- Safety Service (off‑targets): [`api/services/safety_service.py`](mdc:oncology-coPilot/oncology-backend-minimal/api/services/safety_service.py)
- Ruleset Config: [`api/config/metastasis_interception_rules.json`](mdc:oncology-coPilot/oncology-backend-minimal/api/config/metastasis_interception_rules.json)

