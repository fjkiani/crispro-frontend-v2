---
alwaysApply: true
description: "MASTER PAYLOAD SPECIFICATION: The Single Source of Truth for Ayesha Care Plan V2"
globs: ["api/services/ayesha_care_plan/schemas.py", "oncology-frontend/src/**/*.js", "oncology-frontend/src/**/*.jsx"]
---

# MASTER PAYLOAD DOCTRINE: The "God Object"
**Version**: 2.0 (Feb 2026)
**Manager**: Nyx (Agentic AI)
**Status**: ENFORCED

## 1. The Core Contract (`CompleteCareV2Request`)
This payload is the **lifeblood** of the system. If the Frontend does not send this structure exactly, the Backend features (Trials, Holistic Score, Resistance Prophet) will fail or degrade to "Earth Rules" defaults.

### 1.1 Mandatory Fields (The "Identity")
| Field | Type | Description | Example |
|---|---|---|---|
| `disease` | `str` | **CRITICAL**. Must match backend enum (e.g., `ovarian_cancer_hgs`). | `"ovarian_cancer_hgs"` |
| `stage` | `str` | Clinical stage. | `"IVB"` |
| `treatment_line` | `str` | Current line of therapy. | `"recurrent"` |
| `germline_status` | `str` | `positive` \| `negative` \| `unknown`. Drives PARP Logic. | `"negative"` |

### 1.2 The "Intelligence" Inputs (Biomarkers)
*Note: These drive the Scoring Gates and Mechanism Map.*

| Field | Type | Required? | Impact |
|---|---|---|---|
| `tumor_context` | `Dict` | **YES** | Contains `hrd_score`, `tmb`, `msi_status`, `mutations`. |
| `ca125_value` | `float` | No | If present, triggers `Ca125Intelligence`. |
| `germline_variants` | `List` | No | Specific variants for precision matching (e.g. `BRCA1`). |

### 1.3 The "Capability Flags" (Feature Toggles)
*Send these `true` to activate specific engines.*

| Flag | Default | System Activated |
|---|---|---|
| `include_trials` | `True` | **Trials V2 Engine** (Strict Filtering). |
| `include_wiwfm` | `True` | **Holistic Score Engine** (Evo2 + Guidance). |
| `include_resistance` | `False` | **Resistance Playbook** (Strategic Planning). |
| `include_resistance_prediction` | `False` | **Resistance Prophet** (Risk Prediction). |

---

## 2. Strict Input Validation Rules (The "Mars Rules")

### Rule 1: CA-125 Coercion
> "No", "None", "N/A" must be coerced to `null` (None).
> **Rationale**: A string value of "No" crashes the floating-point trend analyzer.
> **Enforcement**: `schemas.py::parse_ca125_value`.

### Rule 2: Treatment History Structure
> Must be a List of Objects: `[{ "regimen": "Carboplatin/Taxol", "response": "PR", "dates": "..." }]`.
> **Rationale**: Resistance Prophet needs structured history to calculate `platinum_free_interval`.

### Rule 3: The "Drug Query" Bypass
> If `drug_query` is present, the system enters **WIWFM Mode** for that specific drug.
> **Rationale**: Allows "What If" analysis for specific agents (e.g., "What about Olaparib?").

---

## 3. The Extraction Target (`ClinicalParser`)
*When CoPilot reads a PDF, it produces this Intermediate Representation:*

```json
{
  "disease": "str",
  "stage": "str",
  "treatment_line": "int",
  "germline_status": "str (POSITIVE/NEGATIVE)",
  "biomarkers": {
    "mmr_status": "str",
    "hrd_score": "float"
  },
  "platinum_response": "str"
}
```

**Manager's Note**: The Frontend is responsible for merging this Intermediate Representation into the Master Payload before sending it to `/api/ayesha/complete_care_plan`.

---

## 4. Audit Checklist (Do Not Ship Without Checking)

- [ ] **Frontend**: `useAyeshaCareData.js` must construct the `tumor_context` correctly.
- [ ] **Frontend**: `ProfileEditor` must sanitize `ca125` inputs.
- [ ] **Backend**: `schemas.py` must match this specification 1:1.
- [ ] **Data**: `hrd_score` must be a `float` (e.g. `42.0`), not a string.

**Signed**,
*Nyx (Manager)*
