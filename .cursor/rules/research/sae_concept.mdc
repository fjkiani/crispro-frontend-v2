---
alwaysApply: false
description: SAE Intelligence – Interpretable Features from Evo2. Plain-language description of Sparse Autoencoder (SAE) capabilities, TRUE vs PROXY SAE distinction, validated use cases (MM resistance), and integration points (resistance prediction, mechanism-based trial matching).
globs: 
---

export const coPilotDetailsData: Record<string, CoPilotDetailContent> = {
  "sae-intelligence": {
    slug: "sae-intelligence",
    pageTitle: "SAE Intelligence: Interpretable Features from Evo2",
    heroSubtitle: "Extracts interpretable biological features from Evo2 layer-26 activations. Provides DNA repair capacity, mechanism vectors, and pathway burdens for resistance prediction and trial matching (research-mode).",
    vision: "Transform Evo2's black box into interpretable biological features that power resistance prediction, mechanism-based trial matching, and early resistance detection.",

    valueProps: [
      {
        audience: 'For Medical Oncologists',
        icon: 'Activity',
        points: [
          'DNA repair capacity scores for PARP eligibility assessment.',
          'Mechanism vectors (7D) for mechanism-based trial matching.',
          'Resistance risk prediction using validated gene-level markers (DIS3, TP53).'
        ]
      },
      {
        audience: 'For Researchers',
        icon: 'Beaker',
        points: [
          'TRUE SAE: 32K-dim sparse features from Evo2 layer-26 activations (extracted, not yet in production).',
          'PROXY SAE: Gene-level pathway scores → mechanism vectors (production-ready, validated).',
          'Complete provenance tracking (method, validation source, feature dimensions).'
        ]
      }
    ],

    buildsOn: "Core Capabilities",
    buildsOnStackPoints: [
      "**Evo2 Foundation Model:** Layer-26 activations (4,096-dim) → SAE model → 32K sparse features.",
      "**Pathway Aggregation:** Gene mutations → pathway scores (DDR, MAPK, PI3K, VEGF, HER2) → mechanism vector.",
      "**Insights Integration:** Functionality, essentiality, chromatin, regulatory signals enhance SAE features."
    ],

    kpis: [
      { label: 'TRUE SAE Features', value: '32,768-dim sparse vectors' },
      { label: 'PROXY SAE Status', value: '✅ Production (validated)' },
      { label: 'TRUE SAE Status', value: '⚠️ Extracted, blocked by mapping' },
      { label: 'Validated Markers', value: 'DIS3 (RR=2.08, p=0.0145), TP53 (RR=1.90)' }
    ],

    observedOutcomes: [
      {
        title: "PROXY SAE (Production)",
        keyMetric: "✅ Validated",
        description: "Gene-level pathway scores → 7D mechanism vector. Validated for MM resistance prediction (DIS3 p=0.0145). Used in resistance prediction, trial matching, early detection.",
        icon: "CheckCircle",
        color: "green"
      },
      {
        title: "TRUE SAE (Extracted)",
        keyMetric: "32K features",
        description: "32,768-dim sparse features from Evo2 layer-26 activations. Extracted for 66 patients (2,897 variants). Blocked from production by Feature→Pathway Mapping.",
        icon: "Layers",
        color: "blue"
      },
      {
        title: "Resistance Prediction",
        keyMetric: "MM validated",
        description: "Multiple Myeloma resistance prediction using PROXY SAE (gene-level markers). DIS3 mutation: RR=2.08, p=0.0145. TP53: RR=1.90 (clinical trend).",
        icon: "TrendingDown",
        color: "red"
      },
      {
        title: "Mechanism-Based Trial Matching",
        keyMetric: "7D vector",
        description: "Mechanism fit ranking using PROXY SAE mechanism vector (DDR, MAPK, PI3K, VEGF, HER2, IO, Efflux). Formula: 0.7×eligibility + 0.3×mechanism_fit.",
        icon: "Target",
        color: "purple"
      }
    ],

    genomicInsightsOverview: "SAE Intelligence extracts interpretable features from Evo2 for resistance prediction and mechanism-based trial matching. PROXY SAE (gene-level) is production-ready and validated. TRUE SAE (32K-dim) is extracted but blocked from production by Feature→Pathway Mapping.",
    coreProblemIntro: "Evo2's internal representations are a black box. SAE decomposes these into interpretable biological features for clinical decision support.",
    coreProblemPoints: [
      "Need interpretable features from Evo2 for resistance prediction.",
      "Require mechanism vectors for trial matching (DDR, MAPK, PI3K, etc.).",
      "Must distinguish TRUE SAE (32K-dim) vs PROXY SAE (gene-level) for transparency."
    ],

    genomicUseCasesGrid: [
      { label: "Resistance prediction", iconName: "TrendingDown", color: "text-red-400" },
      { label: "Mechanism trial matching", iconName: "Target", color: "text-purple-400" },
      { label: "DNA repair capacity", iconName: "Activity", color: "text-blue-400" },
      { label: "Early resistance detection", iconName: "AlertTriangle", color: "text-orange-400" }
    ],

    keyCapabilities: [
      {
        title: "PROXY SAE Features (Production)",
        technical: {
          title: "Implementation",
          keyMetric: "Gene-Level",
          description: "PROXY SAE features computed from gene mutations → pathway aggregation → mechanism vector. DNA repair capacity: 0.6×DDR + 0.2×HRR + 0.2×exon. Mechanism vector: 7D [DDR, MAPK, PI3K, VEGF, HER2, IO, Efflux] from pathway scores.",
          icon: "Layers",
          color: "green",
          components: [
            {
              title: "Pathway Aggregation",
              subtitle: "Gene mutations → pathway scores (DDR, MAPK, PI3K, VEGF, HER2) via drug_mapping.py",
              iconName: "Map",
              color: "blue"
            },
            {
              title: "Mechanism Vector",
              subtitle: "7D vector [DDR, MAPK, PI3K, VEGF, HER2, IO, Efflux] for mechanism-based trial matching",
              iconName: "Target",
              color: "purple"
            },
            {
              title: "DNA Repair Capacity",
              subtitle: "Formula: 0.6×DDR + 0.2×HRR + 0.2×exon (from pathway scores + insights bundle)",
              iconName: "Activity",
              color: "teal"
            }
          ]
        },
        scientific: {
          title: "Foundation",
          keyMetric: "Validated",
          description: "PROXY SAE validated for MM resistance prediction using MMRF CoMMpass (995 patients, 219 with mutations). DIS3 mutation: RR=2.08, p=0.0145 (statistically significant). TP53: RR=1.90 (clinical trend).",
          icon: "CheckCircle",
          color: "green",
          components: [
            {
              title: "MM Resistance Validation",
              subtitle: "DIS3: RR=2.08, p=0.0145 (38/219 patients). TP53: RR=1.90, p=0.11 (16/219 patients).",
              iconName: "TrendingDown",
              color: "red"
            },
            {
              title: "Gene-Level Markers",
              subtitle: "Validated markers: DIS3 (RNA surveillance), TP53 (genomic instability). No signal: KRAS, NRAS, IKZF1/3.",
              iconName: "Dna",
              color: "blue"
            },
            {
              title: "Production Ready",
              subtitle: "PROXY SAE is the PRIMARY method in production (not a fallback). Used in resistance prediction, trial matching, early detection.",
              iconName: "CheckCircle",
              color: "green"
            }
          ]
        },
        business: {
          title: "Value",
          keyMetric: "Production Ready",
          description: "PROXY SAE provides validated resistance prediction (MM), mechanism-based trial matching, and early resistance detection. High interpretability (gene names) and production-ready.",
          icon: "Target",
          color: "indigo",
          components: [
            {
              title: "Resistance Prediction",
              subtitle: "MM resistance risk: DIS3 (67.5% probability, RR=2.08), TP53 (65.5% probability, RR=1.90)",
              iconName: "TrendingDown",
              color: "red"
            },
            {
              title: "Trial Matching",
              subtitle: "Mechanism fit ranking: 0.7×eligibility + 0.3×mechanism_fit (7D vector cosine similarity)",
              iconName: "Target",
              color: "purple"
            },
            {
              title: "Early Detection",
              subtitle: "2-of-3 trigger rule: HRD drop, DNA repair drop, CA-125 kinetics",
              iconName: "AlertTriangle",
              color: "orange"
            }
          ]
        },
        genomicUseCasesParagraph: "**Built:** PROXY SAE features computed from gene mutations → pathway aggregation → mechanism vector. Validated for MM resistance (DIS3 p=0.0145). Production-ready and used in resistance prediction, trial matching, early detection."
      },
      {
        title: "TRUE SAE Features (Extracted, Blocked)",
        technical: {
          title: "Implementation",
          keyMetric: "32K Features",
          description: "TRUE SAE features extracted from Evo2 layer-26 activations via trained SAE model (Goodfire/Evo-2-Layer-26-Mixed). Input: 4,096-dim activations. Output: 32,768-dim sparse features (only top K=64 active per sample). Status: ✅ Extracted (66 patients, 2,897 variants), ⚠️ Blocked from production by Feature→Pathway Mapping.",
          icon: "Layers",
          color: "blue",
          components: [
            {
              title: "SAE Model",
              subtitle: "BatchTopKTiedSAE trained on Evo2 layer-26 activations (4,096 → 32,768 features)",
              iconName: "Brain",
              color: "blue"
            },
            {
              title: "Feature Extraction",
              subtitle: "Modal service extracts 32K-dim sparse features from Evo2 activations (66 patients extracted)",
              iconName: "Download",
              color: "teal"
            },
            {
              title: "Feature→Pathway Mapping",
              subtitle: "⚠️ BLOCKER: Cannot map 32K-dim SAE features → 7D pathway scores (needs biomarker discovery)",
              iconName: "AlertCircle",
              color: "orange"
            }
          ]
        },
        scientific: {
          title: "Foundation",
          keyMetric: "Extracted",
          description: "TRUE SAE features reveal interpretable biological patterns learned by Evo2: exons, TF motifs, protein structure, prophage regions, CRISPR spacers, mutation severity. Extracted but not yet validated for clinical use.",
          icon: "Microscope",
          color: "blue",
          components: [
            {
              title: "Interpretable Features",
              subtitle: "32K features reveal: exons, TF motifs, protein structure, prophage regions, CRISPR spacers",
              iconName: "Eye",
              color: "blue"
            },
            {
              title: "Sparse Representation",
              subtitle: "Only top K=64 features active per sample (sparse activation pattern)",
              iconName: "Layers",
              color: "teal"
            },
            {
              title: "Variant-Level Specificity",
              subtitle: "TRUE SAE captures variant-level nuances (p.C562Y vs p.D488N) not visible in gene-level PROXY",
              iconName: "Dna",
              color: "purple"
            }
          ]
        },
        business: {
          title: "Value",
          keyMetric: "Future Enhancement",
          description: "TRUE SAE would provide variant-level specificity and more accurate pathway burden for rare combinations (MBD4+TP53). Currently blocked by Feature→Pathway Mapping. When available, will enhance resistance prediction and trial matching.",
          icon: "TrendingUp",
          color: "indigo",
          components: [
            {
              title: "Variant-Level Specificity",
              subtitle: "Captures variant-level nuances (p.C562Y vs p.D488N) for more accurate predictions",
              iconName: "Dna",
              color: "blue"
            },
            {
              title: "Rare Combinations",
              subtitle: "Better pathway burden for rare combinations (MBD4+TP53) via sequence-level patterns",
              iconName: "Target",
              color: "purple"
            },
            {
              title: "Future Enhancement",
              subtitle: "Will replace PROXY SAE when Feature→Pathway Mapping is complete",
              iconName: "ArrowRight",
              color: "teal"
            }
          ]
        },
        genomicUseCasesParagraph: "**Status:** TRUE SAE features extracted (32K-dim from Evo2 layer-26 activations). 66 patients, 2,897 variants processed. ⚠️ Blocked from production by Feature→Pathway Mapping (cannot map 32K-dim → 7D pathway scores). Future enhancement when mapping available."
      },
      {
        title: "Resistance Prediction (MM Validated)",
        technical: {
          title: "Implementation",
          keyMetric: "PROXY SAE",
          description: "MM resistance prediction using PROXY SAE (gene-level markers). Validated markers: DIS3 (RR=2.08, p=0.0145), TP53 (RR=1.90, p=0.11). Endpoint: `POST /api/resistance/predict` with `disease='multiple_myeloma'`. Uses `ResistanceProphetService.predict_mm_resistance()`.",
          icon: "TrendingDown",
          color: "red",
          components: [
            {
              title: "MM Resistance Endpoint",
              subtitle: "POST /api/resistance/predict with disease='multiple_myeloma'",
              iconName: "Activity",
              color: "red"
            },
            {
              title: "Validated Markers",
              subtitle: "DIS3: RR=2.08, p=0.0145 (38/219 patients). TP53: RR=1.90, p=0.11 (16/219 patients).",
              iconName: "CheckCircle",
              color: "green"
            },
            {
              title: "Risk Stratification",
              subtitle: "DIS3: MEDIUM-HIGH risk (67.5% probability). TP53: MEDIUM risk (65.5% probability).",
              iconName: "Gauge",
              color: "orange"
            }
          ]
        },
        scientific: {
          title: "Foundation",
          keyMetric: "MMRF CoMMpass",
          description: "Validated against MMRF CoMMpass (GDC): 995 patients, 219 with mutations, 191 deaths. DIS3 mutation: statistically significant (RR=2.08, p=0.0145). TP53: clinical trend (RR=1.90, p=0.11). No signal: KRAS, NRAS, IKZF1/3.",
          icon: "Database",
          color: "blue",
          components: [
            {
              title: "Ground Truth",
              subtitle: "MMRF CoMMpass (GDC): 995 patients, 219 with mutations, 191 deaths",
              iconName: "Database",
              color: "blue"
            },
            {
              title: "DIS3 Mechanism",
              subtitle: "RNA surveillance deficiency → 2x mortality risk (PI, IMiD resistance)",
              iconName: "TrendingDown",
              color: "red"
            },
            {
              title: "TP53 Mechanism",
              subtitle: "Genomic instability → 1.9x mortality risk (multi-drug resistance)",
              iconName: "AlertTriangle",
              color: "orange"
            }
          ]
        },
        business: {
          title: "Value",
          keyMetric: "Validated",
          description: "MM resistance prediction provides actionable risk stratification. DIS3 mutation: consider intensification, evaluate transplant eligibility, monitor MRD. TP53: consider intensification, novel agents (venetoclax, bispecifics).",
          icon: "Target",
          color: "indigo",
          components: [
            {
              title: "Risk Stratification",
              subtitle: "DIS3: MEDIUM-HIGH (67.5% probability). TP53: MEDIUM (65.5% probability).",
              iconName: "Gauge",
              color: "orange"
            },
            {
              title: "Recommended Actions",
              subtitle: "Intensification, transplant evaluation, MRD monitoring, novel agents",
              iconName: "ListChecks",
              color: "blue"
            },
            {
              title: "Production Ready",
              subtitle: "✅ Validated and operational using PROXY SAE (gene-level markers)",
              iconName: "CheckCircle",
              color: "green"
            }
          ]
        },
        genomicUseCasesParagraph: "**Built:** MM resistance prediction using PROXY SAE (gene-level markers). Validated: DIS3 (RR=2.08, p=0.0145), TP53 (RR=1.90). Production-ready and operational."
      },
      {
        title: "Mechanism-Based Trial Matching",
        technical: {
          title: "Implementation",
          keyMetric: "7D Vector",
          description: "Mechanism fit ranking using PROXY SAE mechanism vector (7D: DDR, MAPK, PI3K, VEGF, HER2, IO, Efflux). Formula: combined_score = 0.7×eligibility + 0.3×mechanism_fit. Cosine similarity between patient vector and trial MoA vector. Endpoint: `POST /api/trials/agent/search` with `mechanism_vector`.",
          icon: "Target",
          color: "purple",
          components: [
            {
              title: "Mechanism Vector",
              subtitle: "7D vector [DDR, MAPK, PI3K, VEGF, HER2, IO, Efflux] from PROXY SAE (pathway scores)",
              iconName: "Target",
              color: "purple"
            },
            {
              title: "Mechanism Fit Ranking",
              subtitle: "Formula: 0.7×eligibility + 0.3×mechanism_fit (cosine similarity, L2-normalized)",
              iconName: "BarChart3",
              color: "blue"
            },
            {
              title: "Trial MoA Vectors",
              subtitle: "47 trials pre-tagged with MoA vectors (DDR, MAPK, PI3K, etc.) via Gemini",
              iconName: "ListChecks",
              color: "teal"
            }
          ]
        },
        scientific: {
          title: "Foundation",
          keyMetric: "Pathway Alignment",
          description: "Mechanism-based trial matching aligns patient pathway burden (DDR, MAPK, PI3K, etc.) with trial drug mechanisms. MBD4+TP53 case: DDR=0.88 → PARP trials rank higher (mechanism fit >0.80). Currently uses PROXY SAE (gene-level), will use TRUE SAE when mapping available.",
          icon: "Map",
          color: "teal",
          components: [
            {
              title: "Pathway Alignment",
              subtitle: "Patient pathway burden (DDR, MAPK, PI3K) matched to trial drug mechanisms",
              iconName: "Target",
              color: "purple"
            },
            {
              title: "MBD4+TP53 Example",
              subtitle: "DDR=0.88 → PARP trials rank higher (mechanism fit >0.80)",
              iconName: "CheckCircle",
              color: "green"
            },
            {
              title: "Future TRUE SAE",
              subtitle: "Will capture variant-level nuances for better pathway burden (DDR=0.92 vs 0.85)",
              iconName: "ArrowRight",
              color: "blue"
            }
          ]
        },
        business: {
          title: "Value",
          keyMetric: "Mechanism Alignment",
          description: "Mechanism-based trial matching ranks trials by mechanism alignment, not just eligibility. DDR-high patients → PARP trials rank higher. Provides transparent rationale (mechanism fit scores, pathway alignment breakdown).",
          icon: "Target",
          color: "indigo",
          components: [
            {
              title: "Ranked Trials",
              subtitle: "Trials sorted by combined score (0.7×eligibility + 0.3×mechanism_fit)",
              iconName: "ListChecks",
              color: "blue"
            },
            {
              title: "Mechanism Alignment",
              subtitle: "Per-pathway breakdown (DDR: 0.92, MAPK: 0.10, etc.) shows why trials match",
              iconName: "Target",
              color: "purple"
            },
            {
              title: "Transparent Rationale",
              subtitle: "Mechanism fit scores and pathway alignment enable informed decision-making",
              iconName: "Eye",
              color: "teal"
            }
          ]
        },
        genomicUseCasesParagraph: "**Built:** Mechanism-based trial matching using PROXY SAE mechanism vector (7D). Formula: 0.7×eligibility + 0.3×mechanism_fit. Operational and integrated into trial search endpoint."
      }
    ],

    valuePropositionSections: [
      {
        audience: "For Medical Oncologists",
        points: [
          "DNA repair capacity scores for PARP eligibility assessment.",
          "Mechanism vectors for mechanism-based trial matching (DDR, MAPK, PI3K, etc.).",
          "Resistance risk prediction using validated markers (DIS3, TP53)."
        ]
      },
      {
        audience: "For Researchers",
        points: [
          "PROXY SAE: Gene-level pathway scores → mechanism vector (production-ready, validated).",
          "TRUE SAE: 32K-dim sparse features from Evo2 (extracted, blocked by mapping).",
          "Complete provenance tracking (method, validation source, feature dimensions)."
        ]
      }
    ],

    conclusion: "SAE Intelligence extracts interpretable features from Evo2 for resistance prediction and mechanism-based trial matching. PROXY SAE (gene-level) is production-ready and validated for MM resistance. TRUE SAE (32K-dim) is extracted but blocked from production by Feature→Pathway Mapping. When mapping is available, TRUE SAE will provide variant-level specificity and more accurate pathway burden.",

    inSilicoOverview: {
      coreConcepts: [
        {
          icon: "Layers",
          title: "PROXY SAE (Production)",
          description: "Gene mutations → pathway aggregation → 7D mechanism vector. Validated for MM resistance (DIS3 p=0.0145). Used in resistance prediction, trial matching, early detection.",
          color: "green"
        },
        {
          icon: "Brain",
          title: "TRUE SAE (Extracted)",
          description: "32K-dim sparse features from Evo2 layer-26 activations. Extracted (66 patients, 2,897 variants) but blocked from production by Feature→Pathway Mapping.",
          color: "blue"
        },
        {
          icon: "Target",
          title: "Mechanism-Based Matching",
          description: "7D mechanism vector [DDR, MAPK, PI3K, VEGF, HER2, IO, Efflux] for trial matching. Formula: 0.7×eligibility + 0.3×mechanism_fit.",
          color: "purple"
        }
      ],
      valuePropositions: [
        {
          icon: "TrendingDown",
          title: "Resistance Prediction",
          description: "MM resistance risk using validated markers (DIS3, TP53)",
          metric: "DIS3: RR=2.08, p=0.0145",
          color: "red"
        },
        {
          icon: "Target",
          title: "Trial Matching",
          description: "Mechanism-based trial ranking using 7D mechanism vector",
          metric: "0.7×eligibility + 0.3×mechanism_fit",
          color: "purple"
        },
        {
          icon: "Activity",
          title: "DNA Repair Capacity",
          description: "Formula: 0.6×DDR + 0.2×HRR + 0.2×exon for PARP eligibility",
          metric: "PROXY SAE",
          color: "blue"
        },
        {
          icon: "Fingerprint",
          title: "Provenance Tracking",
          description: "Complete audit trail (method: proxy/true, validation source, feature dimensions)",
          metric: "✅ Built",
          color: "orange"
        }
      ],
      deliverables: [
        {
          icon: "TrendingDown",
          title: "Resistance Risk",
          description: "MM resistance probability with validated markers (DIS3, TP53) and recommended actions"
        },
        {
          icon: "Target",
          title: "Mechanism Vector",
          description: "7D vector [DDR, MAPK, PI3K, VEGF, HER2, IO, Efflux] for mechanism-based trial matching"
        },
        {
          icon: "Activity",
          title: "DNA Repair Capacity",
          description: "Score (0-1) for PARP eligibility assessment (0.6×DDR + 0.2×HRR + 0.2×exon)"
        }
      ]
    }
  },
};

# SAE Intelligence – Interpretable Features from Evo2

## What We Deliver

**SAE Intelligence extracts interpretable biological features from Evo2 for resistance prediction and mechanism-based trial matching:**

- **PROXY SAE (Production)**: Gene mutations → pathway aggregation → 7D mechanism vector
  - DNA repair capacity: 0.6×DDR + 0.2×HRR + 0.2×exon
  - Mechanism vector: [DDR, MAPK, PI3K, VEGF, HER2, IO, Efflux]
  - Validated for MM resistance (DIS3: RR=2.08, p=0.0145)

- **TRUE SAE (Extracted, Blocked)**: 32K-dim sparse features from Evo2 layer-26 activations
  - Input: 4,096-dim Evo2 activations
  - Output: 32,768-dim sparse features (top K=64 active per sample)
  - Status: ✅ Extracted (66 patients, 2,897 variants), ⚠️ Blocked by Feature→Pathway Mapping

**Output:** SAE features with:
- `dna_repair_capacity` (0-1)
- `mechanism_vector` (7D: DDR, MAPK, PI3K, VEGF, HER2, IO, Efflux)
- `pathway_burdens` (DDR, MAPK, PI3K, VEGF, HER2)
- `resistance_signals` (2-of-3 trigger rule)
- `provenance` (method: proxy/true, validation source, feature dimensions)

## Implementation

**Endpoint:** `POST /api/sae/features` (via `SAEFeatureService`)

**Location:**
- Service: `api/services/sae_feature_service.py`
- Resistance: `api/services/resistance_prophet_service.py`
- Trial Matching: `api/services/mechanism_fit_ranker.py`
- TRUE SAE Extraction: `src/services/sae_service/main.py` (Modal)

**Example:**
```bash
curl -X POST http://127.0.0.1:8000/api/sae/features \
  -H 'Content-Type: application/json' \
  -d '{
    "mutations": [{"gene": "DIS3", "hgvs_p": "p.C562Y"}],
    "pathway_scores": {"ddr": 0.85, "mapk": 0.12},
    "insights_bundle": {"functionality": 0.65, "essentiality": 0.70},
    "tumor_context": {"hrd_score": 0.75, "tmb_score": 15}
  }'
```

## PROXY SAE Formula

```
dna_repair_capacity = 0.6 × pathway_burden_ddr + 0.2 × essentiality_hrr + 0.2 × exon_disruption_score

mechanism_vector = convert_pathway_scores_to_mechanism_vector(
    pathway_scores,  # DDR, MAPK, PI3K, VEGF, HER2
    tumor_context,   # TMB, MSI for IO
    use_7d=True      # [DDR, MAPK, PI3K, VEGF, HER2, IO, Efflux]
)
```

**Components:**
- **Pathway Scores**: From gene mutations → pathway aggregation (via `drug_mapping.py`)
- **Insights Bundle**: Functionality, essentiality, chromatin, regulatory (from insights service)
- **Tumor Context**: HRD, TMB, MSI, somatic mutations

## TRUE SAE Architecture

**SAE Model:**
- **Type**: BatchTopKTiedSAE
- **Input**: Evo2 layer-26 activations (4,096-dim for evo2_7b)
- **Output**: 32,768-dim sparse features (8x overcomplete)
- **Model**: Goodfire/Evo-2-Layer-26-Mixed checkpoint
- **Training**: 1 billion tokens (eukaryotic + prokaryotic genomes)

**Revealed Features:**
- Exon-intron boundaries
- Transcription factor binding motifs
- Protein structural elements (alpha-helices, beta-sheets)
- Prophage regions & mobile genetic elements
- CRISPR spacer sequences
- Mutation severity signatures (frameshift/stop)

**Blocker:**
- **Feature→Pathway Mapping**: Cannot map 32K-dim SAE features → 7D pathway scores
- **Resolution Path**: Biomarker discovery → Feature→Pathway Mapping → SAE→Pathway Score Computation

## Resistance Prediction (MM Validated)

**Validated Markers:**
- **DIS3**: RR=2.08, p=0.0145 (38/219 patients, 17.4%)
  - Mechanism: RNA surveillance deficiency
  - Risk: MEDIUM-HIGH (67.5% probability)
  - Actions: Intensification, transplant evaluation, MRD monitoring

- **TP53**: RR=1.90, p=0.11 (16/219 patients, 7.3%)
  - Mechanism: Genomic instability, multi-drug resistance
  - Risk: MEDIUM (65.5% probability)
  - Actions: Intensification, novel agents (venetoclax, bispecifics)

**No Signal:**
- KRAS, NRAS (common in MM ~40%, but no mortality signal)
- IKZF1/3 (no signal)
- PSMB5/CRBN (low power, n=2-3)

**Ground Truth:** MMRF CoMMpass (GDC) - 995 patients, 219 with mutations, 191 deaths

## Mechanism-Based Trial Matching

**Formula:**
```
combined_score = 0.7 × eligibility_score + 0.3 × mechanism_fit_score

mechanism_fit = cosine_similarity(
    L2_normalize(patient_mechanism_vector),
    L2_normalize(trial_moa_vector)
)
```

**Example (MBD4+TP53):**
- Patient mechanism vector: [0.88, 0.12, 0.15, 0.10, 0.05, 0.0, 0.0] (DDR high)
- PARP trial MoA vector: [0.95, 0.10, 0.05, 0.0, 0.0, 0.0, 0.0]
- Mechanism fit: 0.92 (high alignment)
- Combined score: 0.87 (0.7×0.85 + 0.3×0.92)

**Future TRUE SAE Enhancement:**
- Current (PROXY): DDR=0.85 (from MBD4+TP53 gene mutations)
- Future (TRUE SAE): DDR=0.92 (captures BER+checkpoint synergy from sequence-level patterns)
- Impact: Better trial matching for rare combinations

## Integration

**Resistance Prophet Service:**
- Uses PROXY SAE features (gene-level pathway scores)
- MM resistance endpoint: `POST /api/resistance/predict` with `disease='multiple_myeloma'`
- 2-of-3 trigger rule: HRD drop, DNA repair drop, CA-125 kinetics

**Mechanism Fit Ranker:**
- Uses PROXY SAE mechanism vector (7D)
- Formula: 0.7×eligibility + 0.3×mechanism_fit
- Integrated into trial search: `POST /api/trials/agent/search` with `mechanism_vector`

**Early Resistance Detection:**
- Uses PROXY SAE DNA repair capacity
- 2-of-3 trigger rule: HRD drop, DNA repair drop, CA-125 inadequate
- HR restoration pattern detection

## Critical Distinction: PROXY vs TRUE SAE

| Aspect | PROXY SAE | TRUE SAE |
|--------|-----------|----------|
| **Method** | Gene mutations → pathway scores → mechanism vector | Evo2 layer-26 activations → 32K-dim sparse features |
| **Status** | ✅ **Production (PRIMARY method)** | ⚠️ Extracted, blocked by mapping |
| **Validation** | ✅ DIS3 p=0.0145 (MM resistance) | ⚠️ Not yet validated for clinical use |
| **Interpretability** | High (gene names) | Medium (feature indices, needs mapping) |
| **Variant-Level** | No (gene-level only) | Yes (variant-level specificity) |
| **Production Use** | ✅ Resistance prediction, trial matching, early detection | ❌ Diagnostics only (if `ENABLE_TRUE_SAE=1`) |

**Never Claim**: "SAE features are used in production" without clarifying PROXY vs TRUE. Always state: "Services use PROXY SAE features (gene mutations → pathway scores), not TRUE SAE features (32K-dim Evo2 activations)."

## Future Enhancements

1. **Feature→Pathway Mapping**:
   - Biomarker discovery to map 32K-dim SAE features → 7D pathway scores
   - Will enable TRUE SAE in production

2. **TRUE SAE Validation**:
   - Validate TRUE SAE features for resistance prediction
   - Compare PROXY vs TRUE SAE performance

3. **Variant-Level Specificity**:
   - TRUE SAE will provide variant-level specificity (p.C562Y vs p.D488N)
   - Better pathway burden for rare combinations (MBD4+TP53)

4. **Additional Cohorts**:
   - COMPASS trial data
   - External MM registries
   - Drug-specific resistance (PSMB5 → Bortezomib, CRBN → IMiD)

---

**Summary**: SAE Intelligence extracts interpretable features from Evo2 for resistance prediction and mechanism-based trial matching. **PROXY SAE (gene-level) is production-ready and validated for MM resistance (DIS3 p=0.0145)**. **TRUE SAE (32K-dim) is extracted but blocked from production by Feature→Pathway Mapping**. When mapping is available, TRUE SAE will provide variant-level specificity and more accurate pathway burden.

    heroSubtitle: "Extracts interpretable biological features from Evo2 layer-26 activations. Provides DNA repair capacity, mechanism vectors, and pathway burdens for resistance prediction and trial matching (research-mode).",
    vision: "Transform Evo2's black box into interpretable biological features that power resistance prediction, mechanism-based trial matching, and early resistance detection.",

    valueProps: [
      {
        audience: 'For Medical Oncologists',
        icon: 'Activity',
        points: [
          'DNA repair capacity scores for PARP eligibility assessment.',
          'Mechanism vectors (7D) for mechanism-based trial matching.',
          'Resistance risk prediction using validated gene-level markers (DIS3, TP53).'
        ]
      },
      {
        audience: 'For Researchers',
        icon: 'Beaker',
        points: [
          'TRUE SAE: 32K-dim sparse features from Evo2 layer-26 activations (extracted, not yet in production).',
          'PROXY SAE: Gene-level pathway scores → mechanism vectors (production-ready, validated).',
          'Complete provenance tracking (method, validation source, feature dimensions).'
        ]
      }
    ],

    buildsOn: "Core Capabilities",
    buildsOnStackPoints: [
      "**Evo2 Foundation Model:** Layer-26 activations (4,096-dim) → SAE model → 32K sparse features.",
      "**Pathway Aggregation:** Gene mutations → pathway scores (DDR, MAPK, PI3K, VEGF, HER2) → mechanism vector.",
      "**Insights Integration:** Functionality, essentiality, chromatin, regulatory signals enhance SAE features."
    ],

    kpis: [
      { label: 'TRUE SAE Features', value: '32,768-dim sparse vectors' },
      { label: 'PROXY SAE Status', value: '✅ Production (validated)' },
      { label: 'TRUE SAE Status', value: '⚠️ Extracted, blocked by mapping' },
      { label: 'Validated Markers', value: 'DIS3 (RR=2.08, p=0.0145), TP53 (RR=1.90)' }
    ],

    observedOutcomes: [
      {
        title: "PROXY SAE (Production)",
        keyMetric: "✅ Validated",
        description: "Gene-level pathway scores → 7D mechanism vector. Validated for MM resistance prediction (DIS3 p=0.0145). Used in resistance prediction, trial matching, early detection.",
        icon: "CheckCircle",
        color: "green"
      },
      {
        title: "TRUE SAE (Extracted)",
        keyMetric: "32K features",
        description: "32,768-dim sparse features from Evo2 layer-26 activations. Extracted for 66 patients (2,897 variants). Blocked from production by Feature→Pathway Mapping.",
        icon: "Layers",
        color: "blue"
      },
      {
        title: "Resistance Prediction",
        keyMetric: "MM validated",
        description: "Multiple Myeloma resistance prediction using PROXY SAE (gene-level markers). DIS3 mutation: RR=2.08, p=0.0145. TP53: RR=1.90 (clinical trend).",
        icon: "TrendingDown",
        color: "red"
      },
      {
        title: "Mechanism-Based Trial Matching",
        keyMetric: "7D vector",
        description: "Mechanism fit ranking using PROXY SAE mechanism vector (DDR, MAPK, PI3K, VEGF, HER2, IO, Efflux). Formula: 0.7×eligibility + 0.3×mechanism_fit.",
        icon: "Target",
        color: "purple"
      }
    ],

    genomicInsightsOverview: "SAE Intelligence extracts interpretable features from Evo2 for resistance prediction and mechanism-based trial matching. PROXY SAE (gene-level) is production-ready and validated. TRUE SAE (32K-dim) is extracted but blocked from production by Feature→Pathway Mapping.",
    coreProblemIntro: "Evo2's internal representations are a black box. SAE decomposes these into interpretable biological features for clinical decision support.",
    coreProblemPoints: [
      "Need interpretable features from Evo2 for resistance prediction.",
      "Require mechanism vectors for trial matching (DDR, MAPK, PI3K, etc.).",
      "Must distinguish TRUE SAE (32K-dim) vs PROXY SAE (gene-level) for transparency."
    ],

    genomicUseCasesGrid: [
      { label: "Resistance prediction", iconName: "TrendingDown", color: "text-red-400" },
      { label: "Mechanism trial matching", iconName: "Target", color: "text-purple-400" },
      { label: "DNA repair capacity", iconName: "Activity", color: "text-blue-400" },
      { label: "Early resistance detection", iconName: "AlertTriangle", color: "text-orange-400" }
    ],

    keyCapabilities: [
      {
        title: "PROXY SAE Features (Production)",
        technical: {
          title: "Implementation",
          keyMetric: "Gene-Level",
          description: "PROXY SAE features computed from gene mutations → pathway aggregation → mechanism vector. DNA repair capacity: 0.6×DDR + 0.2×HRR + 0.2×exon. Mechanism vector: 7D [DDR, MAPK, PI3K, VEGF, HER2, IO, Efflux] from pathway scores.",
          icon: "Layers",
          color: "green",
          components: [
            {
              title: "Pathway Aggregation",
              subtitle: "Gene mutations → pathway scores (DDR, MAPK, PI3K, VEGF, HER2) via drug_mapping.py",
              iconName: "Map",
              color: "blue"
            },
            {
              title: "Mechanism Vector",
              subtitle: "7D vector [DDR, MAPK, PI3K, VEGF, HER2, IO, Efflux] for mechanism-based trial matching",
              iconName: "Target",
              color: "purple"
            },
            {
              title: "DNA Repair Capacity",
              subtitle: "Formula: 0.6×DDR + 0.2×HRR + 0.2×exon (from pathway scores + insights bundle)",
              iconName: "Activity",
              color: "teal"
            }
          ]
        },
        scientific: {
          title: "Foundation",
          keyMetric: "Validated",
          description: "PROXY SAE validated for MM resistance prediction using MMRF CoMMpass (995 patients, 219 with mutations). DIS3 mutation: RR=2.08, p=0.0145 (statistically significant). TP53: RR=1.90 (clinical trend).",
          icon: "CheckCircle",
          color: "green",
          components: [
            {
              title: "MM Resistance Validation",
              subtitle: "DIS3: RR=2.08, p=0.0145 (38/219 patients). TP53: RR=1.90, p=0.11 (16/219 patients).",
              iconName: "TrendingDown",
              color: "red"
            },
            {
              title: "Gene-Level Markers",
              subtitle: "Validated markers: DIS3 (RNA surveillance), TP53 (genomic instability). No signal: KRAS, NRAS, IKZF1/3.",
              iconName: "Dna",
              color: "blue"
            },
            {
              title: "Production Ready",
              subtitle: "PROXY SAE is the PRIMARY method in production (not a fallback). Used in resistance prediction, trial matching, early detection.",
              iconName: "CheckCircle",
              color: "green"
            }
          ]
        },
        business: {
          title: "Value",
          keyMetric: "Production Ready",
          description: "PROXY SAE provides validated resistance prediction (MM), mechanism-based trial matching, and early resistance detection. High interpretability (gene names) and production-ready.",
          icon: "Target",
          color: "indigo",
          components: [
            {
              title: "Resistance Prediction",
              subtitle: "MM resistance risk: DIS3 (67.5% probability, RR=2.08), TP53 (65.5% probability, RR=1.90)",
              iconName: "TrendingDown",
              color: "red"
            },
            {
              title: "Trial Matching",
              subtitle: "Mechanism fit ranking: 0.7×eligibility + 0.3×mechanism_fit (7D vector cosine similarity)",
              iconName: "Target",
              color: "purple"
            },
            {
              title: "Early Detection",
              subtitle: "2-of-3 trigger rule: HRD drop, DNA repair drop, CA-125 kinetics",
              iconName: "AlertTriangle",
              color: "orange"
            }
          ]
        },
        genomicUseCasesParagraph: "**Built:** PROXY SAE features computed from gene mutations → pathway aggregation → mechanism vector. Validated for MM resistance (DIS3 p=0.0145). Production-ready and used in resistance prediction, trial matching, early detection."
      },
      {
        title: "TRUE SAE Features (Extracted, Blocked)",
        technical: {
          title: "Implementation",
          keyMetric: "32K Features",
          description: "TRUE SAE features extracted from Evo2 layer-26 activations via trained SAE model (Goodfire/Evo-2-Layer-26-Mixed). Input: 4,096-dim activations. Output: 32,768-dim sparse features (only top K=64 active per sample). Status: ✅ Extracted (66 patients, 2,897 variants), ⚠️ Blocked from production by Feature→Pathway Mapping.",
          icon: "Layers",
          color: "blue",
          components: [
            {
              title: "SAE Model",
              subtitle: "BatchTopKTiedSAE trained on Evo2 layer-26 activations (4,096 → 32,768 features)",
              iconName: "Brain",
              color: "blue"
            },
            {
              title: "Feature Extraction",
              subtitle: "Modal service extracts 32K-dim sparse features from Evo2 activations (66 patients extracted)",
              iconName: "Download",
              color: "teal"
            },
            {
              title: "Feature→Pathway Mapping",
              subtitle: "⚠️ BLOCKER: Cannot map 32K-dim SAE features → 7D pathway scores (needs biomarker discovery)",
              iconName: "AlertCircle",
              color: "orange"
            }
          ]
        },
        scientific: {
          title: "Foundation",
          keyMetric: "Extracted",
          description: "TRUE SAE features reveal interpretable biological patterns learned by Evo2: exons, TF motifs, protein structure, prophage regions, CRISPR spacers, mutation severity. Extracted but not yet validated for clinical use.",
          icon: "Microscope",
          color: "blue",
          components: [
            {
              title: "Interpretable Features",
              subtitle: "32K features reveal: exons, TF motifs, protein structure, prophage regions, CRISPR spacers",
              iconName: "Eye",
              color: "blue"
            },
            {
              title: "Sparse Representation",
              subtitle: "Only top K=64 features active per sample (sparse activation pattern)",
              iconName: "Layers",
              color: "teal"
            },
            {
              title: "Variant-Level Specificity",
              subtitle: "TRUE SAE captures variant-level nuances (p.C562Y vs p.D488N) not visible in gene-level PROXY",
              iconName: "Dna",
              color: "purple"
            }
          ]
        },
        business: {
          title: "Value",
          keyMetric: "Future Enhancement",
          description: "TRUE SAE would provide variant-level specificity and more accurate pathway burden for rare combinations (MBD4+TP53). Currently blocked by Feature→Pathway Mapping. When available, will enhance resistance prediction and trial matching.",
          icon: "TrendingUp",
          color: "indigo",
          components: [
            {
              title: "Variant-Level Specificity",
              subtitle: "Captures variant-level nuances (p.C562Y vs p.D488N) for more accurate predictions",
              iconName: "Dna",
              color: "blue"
            },
            {
              title: "Rare Combinations",
              subtitle: "Better pathway burden for rare combinations (MBD4+TP53) via sequence-level patterns",
              iconName: "Target",
              color: "purple"
            },
            {
              title: "Future Enhancement",
              subtitle: "Will replace PROXY SAE when Feature→Pathway Mapping is complete",
              iconName: "ArrowRight",
              color: "teal"
            }
          ]
        },
        genomicUseCasesParagraph: "**Status:** TRUE SAE features extracted (32K-dim from Evo2 layer-26 activations). 66 patients, 2,897 variants processed. ⚠️ Blocked from production by Feature→Pathway Mapping (cannot map 32K-dim → 7D pathway scores). Future enhancement when mapping available."
      },
      {
        title: "Resistance Prediction (MM Validated)",
        technical: {
          title: "Implementation",
          keyMetric: "PROXY SAE",
          description: "MM resistance prediction using PROXY SAE (gene-level markers). Validated markers: DIS3 (RR=2.08, p=0.0145), TP53 (RR=1.90, p=0.11). Endpoint: `POST /api/resistance/predict` with `disease='multiple_myeloma'`. Uses `ResistanceProphetService.predict_mm_resistance()`.",
          icon: "TrendingDown",
          color: "red",
          components: [
            {
              title: "MM Resistance Endpoint",
              subtitle: "POST /api/resistance/predict with disease='multiple_myeloma'",
              iconName: "Activity",
              color: "red"
            },
            {
              title: "Validated Markers",
              subtitle: "DIS3: RR=2.08, p=0.0145 (38/219 patients). TP53: RR=1.90, p=0.11 (16/219 patients).",
              iconName: "CheckCircle",
              color: "green"
            },
            {
              title: "Risk Stratification",
              subtitle: "DIS3: MEDIUM-HIGH risk (67.5% probability). TP53: MEDIUM risk (65.5% probability).",
              iconName: "Gauge",
              color: "orange"
            }
          ]
        },
        scientific: {
          title: "Foundation",
          keyMetric: "MMRF CoMMpass",
          description: "Validated against MMRF CoMMpass (GDC): 995 patients, 219 with mutations, 191 deaths. DIS3 mutation: statistically significant (RR=2.08, p=0.0145). TP53: clinical trend (RR=1.90, p=0.11). No signal: KRAS, NRAS, IKZF1/3.",
          icon: "Database",
          color: "blue",
          components: [
            {
              title: "Ground Truth",
              subtitle: "MMRF CoMMpass (GDC): 995 patients, 219 with mutations, 191 deaths",
              iconName: "Database",
              color: "blue"
            },
            {
              title: "DIS3 Mechanism",
              subtitle: "RNA surveillance deficiency → 2x mortality risk (PI, IMiD resistance)",
              iconName: "TrendingDown",
              color: "red"
            },
            {
              title: "TP53 Mechanism",
              subtitle: "Genomic instability → 1.9x mortality risk (multi-drug resistance)",
              iconName: "AlertTriangle",
              color: "orange"
            }
          ]
        },
        business: {
          title: "Value",
          keyMetric: "Validated",
          description: "MM resistance prediction provides actionable risk stratification. DIS3 mutation: consider intensification, evaluate transplant eligibility, monitor MRD. TP53: consider intensification, novel agents (venetoclax, bispecifics).",
          icon: "Target",
          color: "indigo",
          components: [
            {
              title: "Risk Stratification",
              subtitle: "DIS3: MEDIUM-HIGH (67.5% probability). TP53: MEDIUM (65.5% probability).",
              iconName: "Gauge",
              color: "orange"
            },
            {
              title: "Recommended Actions",
              subtitle: "Intensification, transplant evaluation, MRD monitoring, novel agents",
              iconName: "ListChecks",
              color: "blue"
            },
            {
              title: "Production Ready",
              subtitle: "✅ Validated and operational using PROXY SAE (gene-level markers)",
              iconName: "CheckCircle",
              color: "green"
            }
          ]
        },
        genomicUseCasesParagraph: "**Built:** MM resistance prediction using PROXY SAE (gene-level markers). Validated: DIS3 (RR=2.08, p=0.0145), TP53 (RR=1.90). Production-ready and operational."
      },
      {
        title: "Mechanism-Based Trial Matching",
        technical: {
          title: "Implementation",
          keyMetric: "7D Vector",
          description: "Mechanism fit ranking using PROXY SAE mechanism vector (7D: DDR, MAPK, PI3K, VEGF, HER2, IO, Efflux). Formula: combined_score = 0.7×eligibility + 0.3×mechanism_fit. Cosine similarity between patient vector and trial MoA vector. Endpoint: `POST /api/trials/agent/search` with `mechanism_vector`.",
          icon: "Target",
          color: "purple",
          components: [
            {
              title: "Mechanism Vector",
              subtitle: "7D vector [DDR, MAPK, PI3K, VEGF, HER2, IO, Efflux] from PROXY SAE (pathway scores)",
              iconName: "Target",
              color: "purple"
            },
            {
              title: "Mechanism Fit Ranking",
              subtitle: "Formula: 0.7×eligibility + 0.3×mechanism_fit (cosine similarity, L2-normalized)",
              iconName: "BarChart3",
              color: "blue"
            },
            {
              title: "Trial MoA Vectors",
              subtitle: "47 trials pre-tagged with MoA vectors (DDR, MAPK, PI3K, etc.) via Gemini",
              iconName: "ListChecks",
              color: "teal"
            }
          ]
        },
        scientific: {
          title: "Foundation",
          keyMetric: "Pathway Alignment",
          description: "Mechanism-based trial matching aligns patient pathway burden (DDR, MAPK, PI3K, etc.) with trial drug mechanisms. MBD4+TP53 case: DDR=0.88 → PARP trials rank higher (mechanism fit >0.80). Currently uses PROXY SAE (gene-level), will use TRUE SAE when mapping available.",
          icon: "Map",
          color: "teal",
          components: [
            {
              title: "Pathway Alignment",
              subtitle: "Patient pathway burden (DDR, MAPK, PI3K) matched to trial drug mechanisms",
              iconName: "Target",
              color: "purple"
            },
            {
              title: "MBD4+TP53 Example",
              subtitle: "DDR=0.88 → PARP trials rank higher (mechanism fit >0.80)",
              iconName: "CheckCircle",
              color: "green"
            },
            {
              title: "Future TRUE SAE",
              subtitle: "Will capture variant-level nuances for better pathway burden (DDR=0.92 vs 0.85)",
              iconName: "ArrowRight",
              color: "blue"
            }
          ]
        },
        business: {
          title: "Value",
          keyMetric: "Mechanism Alignment",
          description: "Mechanism-based trial matching ranks trials by mechanism alignment, not just eligibility. DDR-high patients → PARP trials rank higher. Provides transparent rationale (mechanism fit scores, pathway alignment breakdown).",
          icon: "Target",
          color: "indigo",
          components: [
            {
              title: "Ranked Trials",
              subtitle: "Trials sorted by combined score (0.7×eligibility + 0.3×mechanism_fit)",
              iconName: "ListChecks",
              color: "blue"
            },
            {
              title: "Mechanism Alignment",
              subtitle: "Per-pathway breakdown (DDR: 0.92, MAPK: 0.10, etc.) shows why trials match",
              iconName: "Target",
              color: "purple"
            },
            {
              title: "Transparent Rationale",
              subtitle: "Mechanism fit scores and pathway alignment enable informed decision-making",
              iconName: "Eye",
              color: "teal"
            }
          ]
        },
        genomicUseCasesParagraph: "**Built:** Mechanism-based trial matching using PROXY SAE mechanism vector (7D). Formula: 0.7×eligibility + 0.3×mechanism_fit. Operational and integrated into trial search endpoint."
      }
    ],

    valuePropositionSections: [
      {
        audience: "For Medical Oncologists",
        points: [
          "DNA repair capacity scores for PARP eligibility assessment.",
          "Mechanism vectors for mechanism-based trial matching (DDR, MAPK, PI3K, etc.).",
          "Resistance risk prediction using validated markers (DIS3, TP53)."
        ]
      },
      {
        audience: "For Researchers",
        points: [
          "PROXY SAE: Gene-level pathway scores → mechanism vector (production-ready, validated).",
          "TRUE SAE: 32K-dim sparse features from Evo2 (extracted, blocked by mapping).",
          "Complete provenance tracking (method, validation source, feature dimensions)."
        ]
      }
    ],

    conclusion: "SAE Intelligence extracts interpretable features from Evo2 for resistance prediction and mechanism-based trial matching. PROXY SAE (gene-level) is production-ready and validated for MM resistance. TRUE SAE (32K-dim) is extracted but blocked from production by Feature→Pathway Mapping. When mapping is available, TRUE SAE will provide variant-level specificity and more accurate pathway burden.",

    inSilicoOverview: {
      coreConcepts: [
        {
          icon: "Layers",
          title: "PROXY SAE (Production)",
          description: "Gene mutations → pathway aggregation → 7D mechanism vector. Validated for MM resistance (DIS3 p=0.0145). Used in resistance prediction, trial matching, early detection.",
          color: "green"
        },
        {
          icon: "Brain",
          title: "TRUE SAE (Extracted)",
          description: "32K-dim sparse features from Evo2 layer-26 activations. Extracted (66 patients, 2,897 variants) but blocked from production by Feature→Pathway Mapping.",
          color: "blue"
        },
        {
          icon: "Target",
          title: "Mechanism-Based Matching",
          description: "7D mechanism vector [DDR, MAPK, PI3K, VEGF, HER2, IO, Efflux] for trial matching. Formula: 0.7×eligibility + 0.3×mechanism_fit.",
          color: "purple"
        }
      ],
      valuePropositions: [
        {
          icon: "TrendingDown",
          title: "Resistance Prediction",
          description: "MM resistance risk using validated markers (DIS3, TP53)",
          metric: "DIS3: RR=2.08, p=0.0145",
          color: "red"
        },
        {
          icon: "Target",
          title: "Trial Matching",
          description: "Mechanism-based trial ranking using 7D mechanism vector",
          metric: "0.7×eligibility + 0.3×mechanism_fit",
          color: "purple"
        },
        {
          icon: "Activity",
          title: "DNA Repair Capacity",
          description: "Formula: 0.6×DDR + 0.2×HRR + 0.2×exon for PARP eligibility",
          metric: "PROXY SAE",
          color: "blue"
        },
        {
          icon: "Fingerprint",
          title: "Provenance Tracking",
          description: "Complete audit trail (method: proxy/true, validation source, feature dimensions)",
          metric: "✅ Built",
          color: "orange"
        }
      ],
      deliverables: [
        {
          icon: "TrendingDown",
          title: "Resistance Risk",
          description: "MM resistance probability with validated markers (DIS3, TP53) and recommended actions"
        },
        {
          icon: "Target",
          title: "Mechanism Vector",
          description: "7D vector [DDR, MAPK, PI3K, VEGF, HER2, IO, Efflux] for mechanism-based trial matching"
        },
        {
          icon: "Activity",
          title: "DNA Repair Capacity",
          description: "Score (0-1) for PARP eligibility assessment (0.6×DDR + 0.2×HRR + 0.2×exon)"
        }
      ]
    }
  },
};

# SAE Intelligence – Interpretable Features from Evo2

## What We Deliver

**SAE Intelligence extracts interpretable biological features from Evo2 for resistance prediction and mechanism-based trial matching:**

- **PROXY SAE (Production)**: Gene mutations → pathway aggregation → 7D mechanism vector
  - DNA repair capacity: 0.6×DDR + 0.2×HRR + 0.2×exon
  - Mechanism vector: [DDR, MAPK, PI3K, VEGF, HER2, IO, Efflux]
  - Validated for MM resistance (DIS3: RR=2.08, p=0.0145)

- **TRUE SAE (Extracted, Blocked)**: 32K-dim sparse features from Evo2 layer-26 activations
  - Input: 4,096-dim Evo2 activations
  - Output: 32,768-dim sparse features (top K=64 active per sample)
  - Status: ✅ Extracted (66 patients, 2,897 variants), ⚠️ Blocked by Feature→Pathway Mapping

**Output:** SAE features with:
- `dna_repair_capacity` (0-1)
- `mechanism_vector` (7D: DDR, MAPK, PI3K, VEGF, HER2, IO, Efflux)
- `pathway_burdens` (DDR, MAPK, PI3K, VEGF, HER2)
- `resistance_signals` (2-of-3 trigger rule)
- `provenance` (method: proxy/true, validation source, feature dimensions)

## Implementation

**Endpoint:** `POST /api/sae/features` (via `SAEFeatureService`)

**Location:**
- Service: `api/services/sae_feature_service.py`
- Resistance: `api/services/resistance_prophet_service.py`
- Trial Matching: `api/services/mechanism_fit_ranker.py`
- TRUE SAE Extraction: `src/services/sae_service/main.py` (Modal)

**Example:**
```bash
curl -X POST http://127.0.0.1:8000/api/sae/features \
  -H 'Content-Type: application/json' \
  -d '{
    "mutations": [{"gene": "DIS3", "hgvs_p": "p.C562Y"}],
    "pathway_scores": {"ddr": 0.85, "mapk": 0.12},
    "insights_bundle": {"functionality": 0.65, "essentiality": 0.70},
    "tumor_context": {"hrd_score": 0.75, "tmb_score": 15}
  }'
```

## PROXY SAE Formula

```
dna_repair_capacity = 0.6 × pathway_burden_ddr + 0.2 × essentiality_hrr + 0.2 × exon_disruption_score

mechanism_vector = convert_pathway_scores_to_mechanism_vector(
    pathway_scores,  # DDR, MAPK, PI3K, VEGF, HER2
    tumor_context,   # TMB, MSI for IO
    use_7d=True      # [DDR, MAPK, PI3K, VEGF, HER2, IO, Efflux]
)
```

**Components:**
- **Pathway Scores**: From gene mutations → pathway aggregation (via `drug_mapping.py`)
- **Insights Bundle**: Functionality, essentiality, chromatin, regulatory (from insights service)
- **Tumor Context**: HRD, TMB, MSI, somatic mutations

## TRUE SAE Architecture

**SAE Model:**
- **Type**: BatchTopKTiedSAE
- **Input**: Evo2 layer-26 activations (4,096-dim for evo2_7b)
- **Output**: 32,768-dim sparse features (8x overcomplete)
- **Model**: Goodfire/Evo-2-Layer-26-Mixed checkpoint
- **Training**: 1 billion tokens (eukaryotic + prokaryotic genomes)

**Revealed Features:**
- Exon-intron boundaries
- Transcription factor binding motifs
- Protein structural elements (alpha-helices, beta-sheets)
- Prophage regions & mobile genetic elements
- CRISPR spacer sequences
- Mutation severity signatures (frameshift/stop)

**Blocker:**
- **Feature→Pathway Mapping**: Cannot map 32K-dim SAE features → 7D pathway scores
- **Resolution Path**: Biomarker discovery → Feature→Pathway Mapping → SAE→Pathway Score Computation

## Resistance Prediction (MM Validated)

**Validated Markers:**
- **DIS3**: RR=2.08, p=0.0145 (38/219 patients, 17.4%)
  - Mechanism: RNA surveillance deficiency
  - Risk: MEDIUM-HIGH (67.5% probability)
  - Actions: Intensification, transplant evaluation, MRD monitoring

- **TP53**: RR=1.90, p=0.11 (16/219 patients, 7.3%)
  - Mechanism: Genomic instability, multi-drug resistance
  - Risk: MEDIUM (65.5% probability)
  - Actions: Intensification, novel agents (venetoclax, bispecifics)

**No Signal:**
- KRAS, NRAS (common in MM ~40%, but no mortality signal)
- IKZF1/3 (no signal)
- PSMB5/CRBN (low power, n=2-3)

**Ground Truth:** MMRF CoMMpass (GDC) - 995 patients, 219 with mutations, 191 deaths

## Mechanism-Based Trial Matching

**Formula:**
```
combined_score = 0.7 × eligibility_score + 0.3 × mechanism_fit_score

mechanism_fit = cosine_similarity(
    L2_normalize(patient_mechanism_vector),
    L2_normalize(trial_moa_vector)
)
```

**Example (MBD4+TP53):**
- Patient mechanism vector: [0.88, 0.12, 0.15, 0.10, 0.05, 0.0, 0.0] (DDR high)
- PARP trial MoA vector: [0.95, 0.10, 0.05, 0.0, 0.0, 0.0, 0.0]
- Mechanism fit: 0.92 (high alignment)
- Combined score: 0.87 (0.7×0.85 + 0.3×0.92)

**Future TRUE SAE Enhancement:**
- Current (PROXY): DDR=0.85 (from MBD4+TP53 gene mutations)
- Future (TRUE SAE): DDR=0.92 (captures BER+checkpoint synergy from sequence-level patterns)
- Impact: Better trial matching for rare combinations

## Integration

**Resistance Prophet Service:**
- Uses PROXY SAE features (gene-level pathway scores)
- MM resistance endpoint: `POST /api/resistance/predict` with `disease='multiple_myeloma'`
- 2-of-3 trigger rule: HRD drop, DNA repair drop, CA-125 kinetics

**Mechanism Fit Ranker:**
- Uses PROXY SAE mechanism vector (7D)
- Formula: 0.7×eligibility + 0.3×mechanism_fit
- Integrated into trial search: `POST /api/trials/agent/search` with `mechanism_vector`

**Early Resistance Detection:**
- Uses PROXY SAE DNA repair capacity
- 2-of-3 trigger rule: HRD drop, DNA repair drop, CA-125 inadequate
- HR restoration pattern detection

## Critical Distinction: PROXY vs TRUE SAE

| Aspect | PROXY SAE | TRUE SAE |
|--------|-----------|----------|
| **Method** | Gene mutations → pathway scores → mechanism vector | Evo2 layer-26 activations → 32K-dim sparse features |
| **Status** | ✅ **Production (PRIMARY method)** | ⚠️ Extracted, blocked by mapping |
| **Validation** | ✅ DIS3 p=0.0145 (MM resistance) | ⚠️ Not yet validated for clinical use |
| **Interpretability** | High (gene names) | Medium (feature indices, needs mapping) |
| **Variant-Level** | No (gene-level only) | Yes (variant-level specificity) |
| **Production Use** | ✅ Resistance prediction, trial matching, early detection | ❌ Diagnostics only (if `ENABLE_TRUE_SAE=1`) |

**Never Claim**: "SAE features are used in production" without clarifying PROXY vs TRUE. Always state: "Services use PROXY SAE features (gene mutations → pathway scores), not TRUE SAE features (32K-dim Evo2 activations)."

## Future Enhancements

1. **Feature→Pathway Mapping**:
   - Biomarker discovery to map 32K-dim SAE features → 7D pathway scores
   - Will enable TRUE SAE in production

2. **TRUE SAE Validation**:
   - Validate TRUE SAE features for resistance prediction
   - Compare PROXY vs TRUE SAE performance

3. **Variant-Level Specificity**:
   - TRUE SAE will provide variant-level specificity (p.C562Y vs p.D488N)
   - Better pathway burden for rare combinations (MBD4+TP53)

4. **Additional Cohorts**:
   - COMPASS trial data
   - External MM registries
   - Drug-specific resistance (PSMB5 → Bortezomib, CRBN → IMiD)

---

**Summary**: SAE Intelligence extracts interpretable features from Evo2 for resistance prediction and mechanism-based trial matching. **PROXY SAE (gene-level) is production-ready and validated for MM resistance (DIS3 p=0.0145)**. **TRUE SAE (32K-dim) is extracted but blocked from production by Feature→Pathway Mapping**. When mapping is available, TRUE SAE will provide variant-level specificity and more accurate pathway burden.
