---
alwaysApply: true
description: Platform Architecture Master Doctrine - Complete consolidation of all core architecture files
---

# üèõÔ∏è PLATFORM ARCHITECTURE MASTER DOCTRINE

**Last Updated:** 2025-01-XX  
**Status:** ‚úÖ **CONSOLIDATED SOURCE OF TRUTH**  
**Consolidated From:**
- `mission_control_doctrine.mdc` - Mission Control architecture
- `platform_integration_doctrine.mdc` - Platform integration
- `operational_improvements_doctrine_aug_2025.mdc` - Aug 2025 improvements
- `complete_platform_evolution_doctrine.mdc` - Complete evolution history
- `command_center_doctrine.mdc` - Command Center orchestration
- `population_command_center_doctrine.mdc` - Population-level command center
- `oracle_integration_architecture.mdc` - Oracle integration patterns
- `kingpin_agent_doctrine.mdc` - Predator Protocol/Kingpin agent

---

## üìö TABLE OF CONTENTS

1. [Executive Summary](#executive-summary)
2. [Platform Evolution History](#platform-evolution-history)
3. [Core Architecture Principles](#core-architecture-principles)
4. [Mission Control Architecture](#mission-control-architecture)
5. [Command Center Architecture](#command-center-architecture)
6. [Oracle Integration Architecture](#oracle-integration-architecture)
7. [Operational Improvements (Aug 2025)](#operational-improvements-aug-2025)
8. [Current State & Capabilities](#current-state--capabilities)
9. [Lessons Learned](#lessons-learned)
10. [Future Roadmap](#future-roadmap)
11. [References to Archived Files](#references-to-archived-files)

---

## üéØ EXECUTIVE SUMMARY

### **Mission**
CrisPRO platform is a precision medicine platform that transforms genomic data into actionable therapeutic intelligence through a multi-layered architecture:

- **Mission Control**: Individual patient intelligence and decision support
- **Population Command Center**: Cohort-level strategic analysis
- **Command Center**: Slim orchestration for Oracle (discriminative) and Forge (generative)
- **Oracle Integration**: Battle-tested variant scoring and validation
- **Operational Excellence**: Continuous improvements and hardening

### **Core Philosophy: The Kill Chain**
Our mission is to shorten the kill chain between data and decision. We achieve this by:
- Mirroring the biological journey of the patient
- Providing overwhelming informational superiority at each stage
- Linking every piece of intelligence directly to a decisive action
- **From Intelligence to Action** - no dead ends

### **Architecture Principles**
1. **Multi-Modal Validation**: Never rely on single metrics
2. **Graceful Degradation**: System works even when components fail
3. **Provenance Tracking**: Complete audit trails for reproducibility
4. **Feature Flags**: Environment-based toggles for different operational profiles
5. **Service Separation**: Oracle (discriminative) vs Forge (generative) - never mix

---

## üìö PLATFORM EVOLUTION HISTORY

### **CHAPTER 1: THE DELTA SCORE DELUSION**
- **Initial Assumption**: High `delta_likelihood_score` = high biological impact
- **Reality**: High delta scores often indicated catastrophic mutations (frameshifts, nonsense)
- **Discovery**: Oracle had a fundamental blind spot for truncating mutations
- **Solution**: Triumvirate Protocol - multi-layered validation system

### **CHAPTER 2: THE SHARK CARTILAGE BREAKTHROUGH**
- **Target**: Shark cartilage protein sequences for anti-angiogenic therapy
- **Approach**: Evo2 generation + AlphaFold2 structural validation
- **Key Lesson**: "Wet Noodle" problem - sequences that score well in 1D can fail in 3D
- **Impact**: Established need for multi-modal validation (sequence + structure)

### **CHAPTER 3: THE BOLTZ INTEGRATION REVOLUTION**
- **Problem**: Sequence-level scoring insufficient for protein design
- **Solution**: Integrated Boltz (AlphaFold2) for structural validation
- **Architecture**: Command Center orchestration with parallel processing
- **Pattern**: Service-to-service calls using `modal.Cls.lookup()`

### **CHAPTER 4: THE JUNK DNA EPIPHANY**
- **Problem**: Evo2 generating biologically meaningless sequences
- **Root Cause**: Poor prompt quality and inappropriate generation tasks
- **Discovery**: Oracle's dual nature:
  - **As Scorer (The Sniper)**: Precision instrument for variant effect prediction
  - **As Generator (The Poet)**: Long-form sequence author requiring substantial context
- **Doctrine**: Always pose biologically reasonable questions

### **CHAPTER 5: THE MULTI-MODAL VALIDATION SYSTEM**
- **S/P/E Framework**: Sequence/Pathway/Evidence integration
- **Insights Bundle**: Functionality, Chromatin, Essentiality, Regulatory
- **Confidence Modulation**: Evidence gates + insights lifts
- **Transparent Scoring**: All rationale and provenance tracked

### **CHAPTER 6: THE OPERATIONAL IMPROVEMENTS**
- **Evo2 Stabilization**: Model routing, safety hardening, spam prevention
- **Fusion Engine Integration**: AlphaMissense coverage, caching, fallback logic
- **Data Pipeline Hardening**: ClinVar sources, coordinate validation, error handling

### **CHAPTER 7: THE CLINICAL VALIDATION CAMPAIGNS**
- **Known Enemies Campaign**: Revealed Oracle's blind spot
- **HRD Benchmark Campaign**: TCGA-OV cohort validation
- **Multiple Myeloma WIWFM**: Drug efficacy prediction framework

### **CHAPTER 8: THE PLATFORM ARCHITECTURE**
- Complete backend service inventory
- Frontend component integration
- Data flow architecture
- Legacy codebase foundation

---

## üèóÔ∏è CORE ARCHITECTURE PRINCIPLES

### **1. Service Separation Doctrine**
- **Oracle (Discriminative)**: Use `/api/insights/*` for predictive signals
- **Forge (Generative)**: Use `/api/design/*` for candidate generation
- **Strong Separation**: Insights never generate sequences; Design never sets evidence tiers
- **Orchestrator Composes**: Command Center combines outputs

### **2. Data Pipeline Supremacy**
- **Mandatory Validation**: VCF coordinates validated against genomic reference
- **Sequence Difference Verification**: Always confirm sequences are actually different
- **Coordinate System Standardization**: Document all coordinate systems explicitly
- **Reference File Validation**: Prevent corrupted reference file issues

### **3. Graceful Degradation**
- **Soft-Fail Missing Providers**: Store sentinel values and continue
- **Never Crash End-to-End Runs**: Fault isolation at every layer
- **Placeholder Values**: System works even when services unavailable
- **Retry Logic**: Exponential backoff for transient failures

### **4. Provenance Tracking**
- **Run ID Generation**: UUID-based tracking across all operations
- **Profile Management**: Feature flags for Baseline/Richer S/Fusion modes
- **Audit Trails**: Complete operation history with timestamps and parameters
- **Caching Strategy**: Redis for backend, localStorage for frontend

---

## üéØ MISSION CONTROL ARCHITECTURE

### **Core Philosophy: The Kill Chain**
Mission Control is not a single page; it is a layered, dynamic battlespace with four core components:

### **1. The Phased Progression Bar**
- **Capability**: Master conductor of Mission Control
- **Function**: Visually represents patient journey: Screening ‚Üí Diagnosis ‚Üí Treatment ‚Üí Monitoring ‚Üí Remission/Post-Treatment
- **Responsibility**: Orchestrate entire UI - selecting a stage changes intelligence in Dossiers and weapons in Arsenal
- **Requirements**: Robust frontend state management system

### **2. The SITREP (Situation Report)**
- **Capability**: Instant, top-level situational awareness (5-second intelligence briefing)
- **Components**:
  1. Patient core identity: Name, Diagnosis, Stage
  2. Clinical Intelligence Briefing: High-level summary powered by MedGemma
  3. Conversational AI Interface: "Ask a Clinical Question" for natural language interrogation
- **Requirements**:
  - `GET /api/patients/{patient_id}` - Patient identity
  - `POST /api/summarize-ehr` - MedGemma-powered summary
  - `POST /api/prompt/{patient_id}` - Conversational AI

### **3. The Modular Dossiers**
- **Capability**: Deep, multi-modal intelligence on specific fronts
- **Dynamic Adaptation**: Content adapts based on selected stage
- **Dossiers**:
  - **Genomic Threat Assessment**: Zeta Scores, resistance mutations
  - **Metastatic Map**: 8-Step Metastasis Framework risk assessment
  - **Treatment Timeline & Predictive Response**: Gantt chart, HSI forecasting
  - **Clinical Trial Matcher**: Ranked trials with eligibility scores

### **4. The Arsenal**
- **Capability**: One-click deployment of therapeutic design tools
- **Context-Aware**: Availability changes based on stage and dossier data
- **Weapons**:
  - **Design Interception**: Generate CRISPR guides, repair templates, nanobodies
  - **Run In Silico Simulation**: Complex combination therapy simulations
  - **Initiate Pre-Screening**: Automated clinical trial eligibility review

---

## ‚öôÔ∏è COMMAND CENTER ARCHITECTURE

### **Slim Orchestration Doctrine**
Goal: Keep Oracle (discriminative) and Forge (generative) architecture while deploying a slimmer, reliable orchestrator.

### **Command Center Responsibilities**
1. **Orchestrate Multi-Step Runs**: Async fan-out/fan-in using `asyncio.gather`
2. **Governance**: Enforce feature flags, operational mode, evidence gates
3. **Provenance & Logging**: Attach weights/gates/flags snapshots; persist to Supabase
4. **Fault Isolation**: Soft-fail missing providers; never crash end-to-end runs

### **Proposed Endpoints**
- **File**: `api/routers/command_center.py`
- **Prefix**: `/api/command`

#### **1. POST /api/command/run_evidence_bundle**
- **Input**: `{ model_id, mutations[], options }`
- **Steps** (parallel):
  - Oracle: `/api/efficacy/predict` (S/P/E composite)
  - Insights: `/api/insights/predict_gene_essentiality`, `/predict_protein_functionality_change`
- **Output**: `{ efficacy, insights, provenance, run_signature }`

#### **2. POST /api/command/run_design_bundle**
- **Input**: `{ mutations[], design_options }`
- **Steps** (parallel):
  - Forge: `/api/design/generate_guide_rna`, `/api/design/generate_repair_template`
- **Output**: `{ guides, hdr_templates, provenance, run_signature }`

#### **3. POST /api/command/run_full_pipeline**
- **Input**: Union of evidence + design bundles
- **Steps**: Evidence bundle ‚Üí conditionally run design bundle
- **Output**: `{ efficacy, insights, designs, decision_summary, provenance }`

### **Slim Deployment Strategy**
- Single FastAPI app with modular routers
- Push heavy compute to Oracle (Modal Evo2) via proxies
- Keep Forge logic lightweight (heuristics + context-guided prompts)
- Feature flags: `ENABLE_COMMAND_CENTER`, `ENABLE_INSIGHTS_API`, `ENABLE_DESIGN_API`

---

## üë• POPULATION COMMAND CENTER

### **Mission: The 10,000-Foot View**
Strategic map room providing comprehensive view of entire patient cohort for population-level decision-making.

### **Design Philosophy**
- **Mission Control Aesthetics**: Clean, high-contrast, dark-themed interface
- **Living Data**: Real-time updates via WebSockets
- **Scalable & Fast**: Handle 10,000+ patients with <2s load times

### **Command Center Layout**

#### **Global Controls (Top Navigation)**
- Global Patient Search
- Cohort Filters (cancer type, treatment status, mutation, demographic)
- Date Range Selector

#### **Left Column: At-A-Glance Overview**
- **KPI Grid**: Customizable key performance indicators
- **Population Funnel**: Sankey diagram showing patient flow through stages
- **Endpoints**: `GET /api/population/kpis`, `GET /api/population/flow`

#### **Center Column: Strategic Trend & Risk Analysis**
- **Time-Series Trend Charts**: Critical metrics over time
- **Population Risk Pyramid**: AI-assessed risk stratification
- **Metastasis Threat Heatmap**: 8-Step Framework visualization
- **Population-Wide Threat Matrix**: Top 10-20 pathogenic mutations
- **Endpoints**: `GET /api/population/trends`, `GET /api/population/risk_distribution`, etc.

#### **Right Column: Strategic Priorities & Actions**
- **AI-Generated Strategic Recommendations**: High-level actions
- **High-Priority Triage List**: Top 5-10 patients requiring immediate review
- **Drill-Down Mechanism**: Navigate to individual Mission Control
- **Endpoints**: `GET /api/population/recommendations`, `GET /api/population/triage_list`

### **Navigational Doctrine: From Forest to Tree**
Workflow: Population Command Center ‚Üí Filter cohort ‚Üí Select patient ‚Üí Individual Mission Control

### **Intelligence Fusion Doctrine: The MedGemma Synergy**
Fusion of specialized genomic tools with MedGemma clinical reasoning:
- **Threat Assessor + MedGemma**: Genomic threat + clinical context
- **Metastasis Analyzer + MedGemma**: Genomic prediction + radiology validation
- **Intelligent Guide Finder + MedGemma**: CRISPR design + therapeutic rationale
- **Literature Analyzer + MedGemma**: PubMed abstracts + synthesized briefing
- **Result Interpreter + MedGemma**: Molecular outcome + clinical correlation

---

## üî¨ ORACLE INTEGRATION ARCHITECTURE

### **Doctrine: NEVER REPEAT THE SIEGE FAILURES**
Battle-tested architecture preventing data corruption failures.

### **Mandatory Integration Checklist**

#### **Phase 1: Data Pipeline Validation (CRITICAL)**
1. **Reference Coordinate Validation**
   - Always validate VCF coordinates match genomic reference
   - Verify actual base matches VCF REF allele

2. **Sequence Difference Verification**
   - Always confirm sequences are actually different
   - Raise error if sequences are identical

3. **Coordinate System Standardization**
   - VCF coordinates: 1-based
   - Array indices: 0-based
   - Gene coordinates: NCBI authoritative
   - Document coordinate system in function signatures

#### **Phase 2: Oracle Service Integration**
- **Service Architecture Pattern**: Standard `OracleIntegrationService` class
- **Optimal Window Sizes**: [8000, 15000, 25000, 35000] (proven effective)
- **Magnitude-Based Scoring**: Classify impact based on discovered patterns

#### **Phase 3: Scoring Strategy Implementation**
- **Magnitude-Aware Scoring**: Thresholds for minimal/moderate/significant/massive impact
- **Biological Context Strategy**: Window size selection based on sequence type
- **Classification System**: CATASTROPHIC/MAJOR/MODERATE/MINOR/NO_IMPACT

### **Mandatory Error Prevention Patterns**
1. **Reference File Validation**: Check FASTA format and gene identifier
2. **Oracle Response Validation**: Ensure response meets expected schema
3. **Coordinate System Documentation**: Decorator to enforce documentation

### **Integration with Existing Services**
- CommandCenter: Use validated Oracle integration
- Patient Assessment: Coordinate system verification
- Frontend: Display magnitude-based classifications

---

## üöÄ OPERATIONAL IMPROVEMENTS (AUG 2025)

### **What We Improved**
1. **Essentiality Scoring**: Evo2 multi/exon magnitudes + gene-specific calibration
2. **Splicing/Regulatory Scoring**: New noncoding impact proxy endpoint
3. **Guide RNA Generation**: Evo2 prompt-guided with PAM windowing and safety gates
4. **Safety Hardening**: Viral content guardrails, length checks
5. **Efficacy Orchestration**: Regulatory insight integration, confidence modulation
6. **Domain-Aware Lift**: Protein functionality change gets lift when hotspot domains match

### **Where the Code Lives**
- **Insights Router**: `api/routers/insights.py`
  - `POST /api/insights/predict_gene_essentiality`
  - `POST /api/insights/predict_splicing_regulatory` (new)
  - `POST /api/insights/predict_protein_functionality_change` (lift)
  - `POST /api/insights/predict_chromatin_accessibility`
- **Design Router**: `api/routers/design.py`
  - `POST /api/design/generate_guide_rna` (Evo2 prompt-guided + safety)
- **Evo Proxy**: `api/routers/evo.py`
  - `POST /api/evo/generate` (adds viral content safety gate)
- **Efficacy Orchestrator**: `api/routers/efficacy.py`
  - `POST /api/efficacy/predict` (consumes new insights and adjusts confidence)

### **Configuration and Stability Notes**
- Evo URLs: Set `EVO_URL_1B|7B|40B` in environment for maximum stability
- Calibration preload: Service preloads common genes at startup
- Evidence service: May return sparse results under rate-limit constraints

### **API Contract Changes (Backward-Compatible)**
- `predict_gene_essentiality`: Adds `provenance.method` and `provenance.calibration`
- `predict_splicing_regulatory`: New endpoint returns `regulatory_impact_score`
- `generate_guide_rna`: Returns Evo2-guided candidates with GC/efficacy heuristics
- `efficacy/predict`: `drugs[*].insights` includes `regulatory`

### **Developer Guidance**
- Prefer Evo2 multi/exon magnitudes for sequence-level signal
- Maintain safety gates in any new generation entry points
- Keep lifts modest and transparent in provenance
- Ensure Evo service URLs are present for stability

---

## üìä CURRENT STATE & CAPABILITIES

### **Operational Capabilities**
- **Variant Analysis**: Complete S/P/E + insights bundle
- **Drug Efficacy**: Per-drug ranking with confidence and evidence
- **Cohort Analysis**: Dataset extraction and benchmark execution
- **CRISPR Design**: Guide RNA generation with safety checks
- **Structural Validation**: AlphaFold2 integration for protein design

### **Demo Readiness**
- **MM WIWFM**: Live drug efficacy prediction
- **VUS Explorer**: Unknown variant triage and analysis
- **Cohort Lab**: Dataset extraction and benchmarking
- **Evidence Intelligence**: Multi-modal evidence analysis
- **IND Package**: Regulatory documentation generation

### **Technical Maturity**
- **API Stability**: All endpoints operational with proper error handling
- **Data Pipeline**: Robust extraction and validation workflows
- **Frontend Integration**: Live API calls with fallback handling
- **Provenance System**: Complete audit trails and reproducibility
- **Performance**: Caching and optimization for production use

### **Backend Services - Complete Inventory**
- **Core API Infrastructure**: `api/main.py`
- **Insights Router**: Intelligence engine endpoints
- **Efficacy Orchestrator**: Decision engine (1,429 lines)
- **Evo Proxy**: Sequence oracle proxy
- **Design Router**: Weapon forge endpoints
- **Fusion Engine**: AlphaMissense integration
- **Datasets API**: Cohort intelligence
- **Evidence Services**: Literature intelligence

### **Frontend Integration - Complete Inventory**
- **Myeloma Digital Twin**: Core MM demo
- **Target Dossier**: Variant insights
- **VUS Explorer**: Unknown variant triage
- **Cohort Lab**: Dataset extraction
- **Evidence Intelligence**: Multi-tab analysis
- **Session Management**: Analysis persistence

---

## üí° LESSONS LEARNED

### **Technical Lessons**

#### **Modal Service Communication Patterns**
- **Sync vs Async Context**: Use `.call()` for sync, `.remote()` for async
- **Service Discovery**: `modal.Cls.lookup("app-name")` for service-to-service calls
- **Resource Scaling**: ML workloads need 64GB+ RAM for large models
- **Build Dependencies**: Always include `build-essential` for complex libraries
- **Container Strategy**: NVIDIA CUDA base images for stability
- **Error Handling**: Graceful degradation with placeholder values

#### **Code Architecture Patterns**
- **Router-Based APIs**: FastAPI routers for modular endpoint organization
- **Pydantic Schemas**: Type-safe request/response validation
- **Provenance Tracking**: UUID-based run IDs with complete audit trails
- **Feature Flags**: Environment-based toggles for different operational profiles
- **Caching Strategy**: Redis for backend, localStorage for frontend persistence

#### **Data Pipeline Patterns**
- **Triumvirate Protocol**: Truncation check ‚Üí Oracle analysis ‚Üí Structural validation
- **Multi-Modal Scoring**: S/P/E framework with insights bundle integration
- **Calibration Systems**: Gene-specific percentile conversion for cross-gene comparison
- **Coordinate Validation**: GRCh38 normalization and REF/ALT validation
- **Error Recovery**: Retry logic with exponential backoff and circuit breakers

### **Scientific Lessons**
- **Multi-Modal Validation**: Single metrics are insufficient
- **Context Dependency**: Generation quality depends on prompt quality
- **Structure-Function Relationship**: Sequence likelihood ‚â† structural viability
- **Evidence Integration**: Literature + ClinVar + pathway alignment
- **Calibration Importance**: Gene-specific calibration for cross-gene comparison

### **Operational Lessons**
- **Incremental Development**: Build and test components individually
- **Mock-Driven Enhancement**: Use mocks for frontend development
- **Profile Management**: Feature flags for different risk/cost profiles
- **Provenance Tracking**: Complete audit trails for reproducibility
- **Graceful Degradation**: System works even when components fail

---

## üéØ FUTURE ROADMAP

### **Strategic Implications**
- **Competitive Advantage**: Multi-modal validation beyond single-metric approaches
- **Clinical Integration**: Real-world evidence and validation
- **Platform Co-Invention**: IP royalty model for AI contributions
- **Rapid Iteration**: Hypothesis ‚Üí validation ‚Üí design cycles

### **Market Position**
- **Precision Medicine**: Personalized therapeutic design
- **Research Acceleration**: Faster hypothesis validation
- **Clinical Decision Support**: Evidence-based recommendations
- **Regulatory Compliance**: FDA-grade documentation and validation

### **Future Enhancements**
- **Expanded Drug Classes**: PARP inhibitors, immunotherapy
- **Cross-Study Validation**: Multi-cohort benchmarking
- **Real-Time Updates**: Live evidence integration
- **Global Deployment**: International regulatory compliance

### **Predator Protocol (Kingpin Agent)**
- **Mission**: Autonomous therapeutic design workflow
- **Kill Chain**: Hunt (reconnaissance) ‚Üí Ambush (generation) ‚Üí Triage (validation) ‚Üí Confirmation Kill (biophysical - future)
- **Architecture**: Single CommandCenter endpoint orchestrating entire protocol
- **UI**: Simple input (Target Gene) + "UNLEASH PREDATOR" button with real-time mission tracking

---

## üìñ REFERENCES TO ARCHIVED FILES

All original files have been preserved in `core_architecture/archive/`:

- **Mission Control**: `archive/mission_control_doctrine.mdc`
  - Original: Kill chain philosophy, SITREP, Dossiers, Arsenal architecture
  
- **Platform Integration**: `archive/platform_integration_doctrine.mdc`
  - Original: Platform capability & integration doctrine
  
- **Operational Improvements**: `archive/operational_improvements_doctrine_aug_2025.mdc`
  - Original: Aug 2025 concrete improvements, endpoints, test flows
  
- **Complete Evolution**: `archive/complete_platform_evolution_doctrine.mdc`
  - Original: Complete journey from delta scores to precision medicine (11 chapters)
  
- **Command Center**: `archive/command_center_doctrine.mdc`
  - Original: Slim orchestration doctrine for Oracle/Forge separation
  
- **Population Command Center**: `archive/population_command_center_doctrine.mdc`
  - Original: 10,000-foot view, population-level strategic analysis
  
- **Oracle Integration**: `archive/oracle_integration_architecture.mdc`
  - Original: Battle-tested integration patterns, validation protocols
  
- **Kingpin Agent**: `archive/kingpin_agent_doctrine.mdc`
  - Original: Predator Protocol autonomous therapeutic design

---

## ‚öîÔ∏è DOCTRINE STATUS: ACTIVE

**LAST UPDATED:** 2025-01-XX  
**APPLIES TO:** All platform development, validation, and deployment  
**ENFORCEMENT:** Mandatory across all development and operational activities

**This master doctrine represents the complete consolidation of all core architecture knowledge. Every principle, pattern, and lesson learned is preserved and organized for maximum clarity and actionability.**
